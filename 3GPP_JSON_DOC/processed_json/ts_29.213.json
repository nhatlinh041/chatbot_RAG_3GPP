{
  "metadata": {
    "specification_id": "ts_29.213",
    "version": "18.0.0",
    "title": "3GPP TS 29.213",
    "file_path": "/content/drive/MyDrive/RAG_thesis/data/29_series/29213-i00/29213-i00.docx"
  },
  "export_info": {
    "export_date": "2025-07-26T09:18:30.409302",
    "total_chunks": 97
  },
  "chunks": [
    {
      "chunk_id": "ts_29.213_1",
      "section_id": "1",
      "section_title": "Scope",
      "content": "The present specification adds detailed flows of Policy and Charging Control (PCC) over the Diameter-based Rx, Gx, Gxx, Sd, Sy, S9, Nt, Diameter-based St and Np reference points and their relationship with the bearer level signalling flows over the Gn/Gp, S4, S5/S8, S2a and S2c interfaces.\nThe calls flows depicted in this Technical Specification represent usual cases, i.e. not all situations are covered. Detailed information provided in 3GPP TS 29.212 [9], 3GPP TS 29.214 [10], 3GPP TS 29.215 [22], 3GPP TS 29.217 [36] , 3GPP TS 29.154 [56] and 3GPP TS 29.219 [28] shall be taken into consideration.\nThe present specification also describes the PCC reference architectures for non-roaming and roaming scenarios.\nThe present specification also describes the binding and the mapping of QoS parameters among SDP, UMTS QoS parameters, and QoS authorization parameters.\nThe present specification also describes the PCRF addressing using DRA.\nThe present specification also describes Diameter race condition handling for Gx based applications, i.e Gx, Gxx, Sd and S9.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212",
        "ts_29.214",
        "ts_29.215",
        "ts_29.217",
        "ts_29.154",
        "ts_29.219"
      ]
    },
    {
      "chunk_id": "ts_29.213_2",
      "section_id": "2",
      "section_title": "References",
      "content": "The following documents contain provisions which, through reference in this text, constitute provisions of the present document.\n-\tReferences are either specific (identified by date of publication and/or edition number or version number) or non‑specific.\n-\tFor a specific reference, subsequent revisions do not apply.\n-\tFor a non-specific reference, the latest version applies. In the case of a reference to a 3GPP document (including a GSM document), a non-specific reference implicitly refers to the latest version of that document in the same Release as the present document.\n[1]\t3GPP TR 21.905: “Vocabulary for 3GPP Specifications”.\n[2]\t3GPP TS 23.203: “Policy Control and charging architecture”.\n[3]\t3GPP TS 23.060: “General Packet Radio Service (GPRS); Service description; Stage 2”.\n[4]\t3GPP TS 23.107: “Quality of Service (QoS) concept and architecture”.\n[5]\t3GPP TS 24.229: “IP Multimedia Call Control Protocol based on SIP and SDP; Stage 3”.\n[6]\t3GPP TS 26.234: “End-to-end transparent streaming service; Protocols and codecs”.\n[7]\tVoid.\n[8]\tVoid\n[9]\t3GPP TS 29.212: “Policy and Charging Control (PCC); Reference points”.\n[10]\t3GPP TS 29.214: “Policy and Charging Control over Rx reference point”.\n[11]\tIETF RFC 2327: “SDP: Session Description Protocol”.\n[12]\tIETF RFC 3264: “An Offer/Answer model with the Session Description Protocol (SDP)”.\n[13]\tIETF RFC 3556: “Session Description Protocol (SDP) Bandwidth Modifiers for RTP Control Protocol (RTCP) Bandwidth”.\n[14]\tVoid.\n[15]\tVoid.\n[16]\tIETF RFC 4145: “TCP-Based Media Transport in the Session Description Protocol (SDP)”.\n[17]\tIETF RFC 4975: “The Message Session Relay Protocol (MSRP)”.\n[18]\t3GPP2 C.S0046-0 v1.0: “3G Multimedia Streaming Services”.\n[19]\t3GPP2 C.S0055-A v1.0: “Packet Switched Video Telephony Services (PSVT/MCS)”.\n[20]\tVoid\n[21]\t3GPP TS 23.402: “Architecture Enhancements for non-3GPP accesses”.\n[22]\t3GPP TS 29.215: “Policy and Charging Control over S9 reference point”.\n[23]\tIETF RFC 3890: “A Transport Independent Bandwidth Modifier for the Session Description Protocol (SDP) “.\n[24]\t3GPP TS 24.292: “IP Multimedia (IM) Core Network (CN) subsystem Centralized Services (ICS); Stage 3”.\n[27]\t3GPP TS 23.216: “Single Radio Voice Call Continuity (SRVCC); Stage 2”.\n[28]\t3GPP TS 29.219: “Policy and Charging Control over Sy reference point”.\n[29]\t3GPP TS 26.114: “IP Multimedia Subsystem (IMS); Multimedia Telephony; Media handling and interaction”\n[30]\t3GPP TS 26.247: “Transparent end-to-end Packet-switched Streaming Service (PSS) Progressive Download and Dynamic Adaptive Streaming over HTTP (3GP-DASH) “.\n[31]\tVoid.\n[32]\tBroadband Forum WT-134: “Policy Control Framework” (work in progress).\n[33]\tIETF RFC 7683: \"Diameter Overload Indication Conveyance\".\n[34]\t3GPP TS 23.468: \"Group Services and System Aspects; Group Communication System Enablers for LTE (GCSE LTE).\n[35]\t3GPP TS 23.380: \"IMS Restoration Procedures\".\n[36]\t3GPP TS 29.217: “Policy and Charging Control: Congestion Reporting over Np reference point”.\n[37]\t3GPP TS 23.003: \"Numbering, addressing and identification\".\n[38]\t3GPP TS 23.682: \"Architecture enhancements to facilitate communications with packet data networks and applications\".\n[39]\tIETF RFC 5761: \"Multiplexing RTP Data and Control Packets on a Single Port\".\n[40]\tIETF RFC 7944: \"Diameter Routing Message Priority\".\n[51]\t3GPP TS 23.335: \"User Data Convergence (UDC); Technical realization and information flows; Stage 2\".\n[52]\t3GPP TS 29.335: \"User Data Convergence (UDC); User Data Repository Access Protocol over the Ud interface; Stage 3\".\n[53]\t3GPP TS 29.201: \"Representational State Transfer (REST) reference point between Application Function (AF) and Protocol Converter (PC)\".\n[54]\t3GPP TS 29.155: \"Traffic Steering Control; Representational State Transfer (REST) over St reference point\".\n[55]\t3GPP TS 32.240: \"Telecommunication management; Charging management; Charging architecture and principles\".\n[56]\t3GPP TS 29.154: \"Service Capability Exposure Function over Nt reference point\".\n[57]\tVoid.\n[58]\t3GPP TS 22.153: \"Multimedia Priority Service\".\n[59]\t3GPP TS 23.228: \"IP Multimedia Subsystem (IMS); Stage 2\".\n[60]\tIETF RFC 8583: \"Diameter Load Information Conveyance\".\n[61]\tIETF RFC 6733: \"Diameter Base Protocol\".\n[62]\t3GPP TS 29.250: \"Nu reference point between SCEF and PFDF for sponsored data connectivity\".\n[63]\t3GPP TS 29.251: \"Gw and Gwn reference points for sponsored data connectivity\".\n[64]\t3GPP TS 23.280: \"Common functional architecture to support mission critical services; Stage 2\".\n[65]\t3GPP TS 29.244: \"Interface between the Control Plane and the User Plane of EPC Nodes; Stage 3\".\n[66]\t3GPP TS 23.221: \"Architectural requirements\".\n[67]\tIETF RFC 8445: \"Interactive Connectivity Establishment (ICE): A Protocol for Network Address Translator (NAT) Traversal\".\n[68]\tIETF RFC 8839: \"Session Description Protocol (SDP) Offer/Answer Procedures for Interactive Connectivity Establishment (ICE)\".\n[69]\tIETF RFC 8864: \"Negotiation Data Channels Using the Session Description Protocol (SDP)\".",
      "chunk_type": "general",
      "cross_references": [
        "ts_21.905",
        "ts_23.203",
        "ts_23.060",
        "ts_23.107",
        "ts_24.229",
        "ts_26.234",
        "ts_29.212",
        "ts_29.214",
        "ts_23.402",
        "ts_29.215",
        "ts_24.292",
        "ts_23.216",
        "ts_29.219",
        "ts_26.114",
        "ts_26.247",
        "ts_23.468",
        "ts_23.380",
        "ts_29.217",
        "ts_23.003",
        "ts_23.682",
        "ts_23.335",
        "ts_29.335",
        "ts_29.201",
        "ts_29.155",
        "ts_32.240",
        "ts_29.154",
        "ts_22.153",
        "ts_23.228",
        "ts_29.250",
        "ts_29.251",
        "ts_23.280",
        "ts_29.244",
        "ts_23.221"
      ]
    },
    {
      "chunk_id": "ts_29.213_3.1",
      "section_id": "3.1",
      "section_title": "Definitions",
      "content": "For the purposes of the present document, the terms and definitions given in 3GPP TR 21.905 [1] and the following apply:\nDRA binding: The PCRF routing information stored per UE or per PDN in the DRA, which include the user identity (UE NAI), the UE Ipv4 address and/or Ipv6 prefix, the APN (if available) and the selected PCRF identity for a certain IP-CAN Session.\nGateway Control Session: An association between a BBERF and a PCRF (when GTP is not used in the EPC), used for transferring access specific parameters, BBERF events and QoS rules between the PCRF and BBERF. In the context of this specification this is implemented by use of the Gxx procedures.\nIP-CAN session: association between a UE and an IP network.The association is identified by one or more UE Ipv4 addresses/ and/or Ipv6 prefix together with a UE identity information, if available, and a PDN represented by a PDN ID (e.g. an APN). An IP-CAN session incorporates one or more IP-CAN bearers. Support for multiple IP-CAN bearers per IP-CAN session is IP-CAN specific. An IP-CAN session exists as long as the related UE Ipv4 address and/or Ipv6 prefix are assigned and announced to the IP network.\nPolicy counter: A mechanism within the OCS to track spending applicable for a subscriber.\nPolicy counter status: A label whose values are not standardized and that is associated with a policy counter’s value relative to the spending limit(s) (the number of possible policy counter status values for a policy counter is one greater than the number of thresholds associated with that policy counter, i.e policy counter status values describe the status around the thresholds). This is used to convey information relating to subscriber spending from OCS to PCRF. Specific labels are configured jointly in OCS and PCRF.\nRAN user plane congestion: RAN user plane congestion occurs when the demand for RAN resources exceeds the available RAN capacity to deliver the user data for a prolonged period of time.\nNOTE:\tShort-duration traffic bursts is a normal condition at any traffic load level, and is not considered to be RAN user plane congestion. Likewise, a high-level of utilization of RAN resources (based on operator configuration) is considered a normal mode of operation and might not be RAN user plane congestion.\nRestricted local operator services: communication services provided by an operator that involve either automated or human assistance (e.g. credit card billing, directory assistance, customer care) for which successful authentication is not necessary.\nSpending limit: A spending limit is the usage limit of a policy counter (e.g. monetary, volume, duration) that a subscriber is allowed to consume.\nSpending limit report: a notification, containing the current policy counter status generated from the OCS to the PCRF via the Sy reference point.\nTDF session: An association between an IP-CAN session and the assigned TDF for the purpose of application detection and control by the PCRF . The association is identified by one UE Ipv4 address and/or Ipv6 prefix together with optionally a PDN represented by a PDN ID and a set of ADC rules to be applied by the TDF.",
      "chunk_type": "definition",
      "cross_references": [
        "ts_21.905"
      ]
    },
    {
      "chunk_id": "ts_29.213_3.2",
      "section_id": "3.2",
      "section_title": "Abbreviations",
      "content": "For the purpose of the present document, the abbreviations given in 3GPP TR 21.905 [1] and the following apply:\nADC\tApplication Detection and Control\nAF\tApplication Function\nARA\tAggregated RUCI Report Answer\nARP\tAllocation and Retention Priority\nARR\tAggregated RUCI Report Request\nAVP\tAttribute-Value Pair\nBBERF\tBearer Binding and Event Reporting Function\nCHEM\tCoverage and Handoff Enhancements using Multimedia error robustness feature\nCSG\tClosed Subscriber Group\nCSG ID\tClosed Subscriber Group Identity\nCoA\tCare of Address\nDRA\tDiameter Routing Agent\nDRMP\tDiameter Routing Message Priority\nDSCP\tDifferentiated Services Code Point\nDTS\tData Transport Service\nGBR\tGuaranteed Bitrate\nGCS\tGroup Communication Service\nGCS AS\tGroup Communication Service Application Server\nH-AF\tHome AF\nH-DRA\tHome DRA\nH-PCRF\tHome PCRF\nHPLMN\tHome PLMN\nMBR\tMaximum Bitrate\nMUA\tModify UE context Answer\nMUR\tModify UE context Request\nMPS\tMultimedia Priority Service\nNBIFOM\tNetwork-based IP flow mobility\nNRA\tNon-Aggregated RUCI Report Answer\nNRR\tNon-Aggregated RUCI Report Request\nPA\tProxy Agent\nPCC\tPolicy and Charging Control\nPCEF\tPolicy and Charging Enforcement Function\nPCRF\tPolicy and Charging Rule Function\nPGW\tPDN-Gateway\nPFDF\tPacket Flow Description Function\nRLOS\tRestricted Local Operator Services\nQCI\tQoS Class Identifier\nRCAF\tRAN Congestion Awareness Function\nRUCI\tRAN User Plane Congestion Information\nSCEF\tService Capability Exposure Function\nSDF\tService Data Flow\nSLA\tSpending Limit Answer\nSLR\tSpending Limit Request\nSNA\tSpending-Status Notification Answer\nSSD\tSource Statistics Descriptor\nSNR\tSpending-Status Notification Request\nSTA\tSession Termination Answer\nTSSF\tTraffic Steering Support Function\nSTR\tSession Termination Request\nTDF\tTraffic Detection Function\nUDC\tUser Data Convergence\nUDR\tUser Data Repository\nV-AF\tVisited AF\nV-DRA\tVisited DRA\nV-PCRF\tVisited PCRF\nVPLMN\tVisited PLMN\n3a\tReference architecture\nThe PCC functionality is provided by the functions of the Policy and Charging Rules Function (PCRF), the Policy and Charging Enforcement Function (PCEF), the Bearer Binding and Event Reporting Function (BBERF), the Application Function (AF), the Traffic Detection Function (TDF), the Traffic Steering Support Function (TSSF), the RAN Congestion Awareness Function (RCAF), the Service Capability Exposure Function (SCEF), the Packet Flow Description Function (PFDF), the Online Charging System (OCS), the Offline Charging System (OFCS) and the Subscription Profile Repository (SPR) or the User Data Repository (UDR). UDR replaces SPR when the UDC architecture as defined in 3GPP TS 23.335 [51] is applied to store PCC related subscription data. In this deployment scenario Ud interface as defined in 3GPP TS 29.335 [52] between PCRF and UDR is used to access subscription data in the UDR. 3GPP TS 23.203 [2] specifies the PCC stage 2 functionality.\nFigure 3a.1: Overall PCC architecture for non-roaming scenario\nFigure 3a.2: Overall PCC architecture for roaming with home routed access scenario\nFigure 3a.3: Overall PCC architecture for roaming with visited access scenario\nNOTE 1:\tThe Sp reference point is located between PCRF and SPR, The Ud interface is located between PCRF and UDR.\nNOTE 2:\tThe UDC Application Informational Model related to the PCRF is not specified in this Release.\nNOTE 3:\tAF can be located in both VPLMN and HPLMN for the visited access.\nNOTE 4:  The H-PCRF can optionally send the addresses of the OCS to the V-PCRF in the visited access.\nNOTE 5: \tUse of TSSF in roaming scenarios is in this release only specified for the home routed access.\nNOTE 6: \tThe SCEF acts as an AF (using Rx) in some service capability exposure use cases as described in 3GPP TS 23.682 [38].\nNOTE 7:\tGw and Gwn reference points are not supported in the visited access.\nNOTE 8:\tThe PCEF and TDF can each be decomposed into a User Plane Function and a Control Plane Function connected via the Sx reference point specified in 3GPP TS 29.244 [65].\nThe protocols for the Gx reference point, the Gxx reference point and the Sd reference point are specified in 3GPP TS 29.212 [9].\nThe protocols for the St reference point are specified in 3GPP TS 29.212 [9] and 3GPP TS 29.155 [54].\nThe protocols for the Rx reference point are specified in 3GPP TS 29.214 [10] and 3GPP TS 29.201 [53].\nThe protocol for the S9 reference point is specified in 3GPP TS 29.215 [22].\nThe protocol for the Sy reference point is specified in 3GPP TS 29.219 [28].\nThe protocol for the Np reference point is specified in 3GPP TS 29.217 [36].\nThe protocol for the Nt reference point is specified in 3GPP TS 29.154 [56].\nThe protocol for the Nu reference point is specified in 3GPP TS 29.250 [62].\nThe protocols for the Gw and Gwn reference points are specified in 3GPP TS 29.251 [63].\nMore information about the protocols on the Gy reference point, the Gyn refrence point, the Gz refrence point and the Gzn refrence point are provided in 3GPP TS 32.240 [55].\nThe details associated with the Sp reference point are not specified in this Release. The SPR's relation to existing subscriber databases is not specified in this Release.\nThe UDR replaces the SPR when the UDC architecture as defined in 3GPP TS 23.335 [51] is applied to store PCC related subscription data. In this deployment scenario Ud interface as defined in 3GPP TS 29.335 [52] between PCRF and UDR is used to access subscription data in the UDR.",
      "chunk_type": "general",
      "cross_references": [
        "figure_3",
        "ts_21.905",
        "ts_23.335",
        "ts_29.335",
        "ts_23.203",
        "ts_23.682",
        "ts_29.244",
        "ts_29.212",
        "ts_29.155",
        "ts_29.214",
        "ts_29.201",
        "ts_29.215",
        "ts_29.219",
        "ts_29.217",
        "ts_29.154",
        "ts_29.250",
        "ts_29.251",
        "ts_32.240"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.0",
      "section_id": "4.0",
      "section_title": "General",
      "content": "There are three distinct network scenarios for an IP-CAN Session:\nCase 1. No Gateway Control Session is required, no Gateway Control Establishment occurs at all (e.g. 3GPP Access where GTP-based S5/S8 are employed, and Non-3GPP access where GTP-based S2a or GTP-based S2b is employed).\nCase 2. A Gateway Control Session is required. There are two subcases:\n2a)\tThe BBERF assigns a Care of Address (CoA) to the UE and establishes a Gateway Control Session prior to any IP-CAN session establishment that will apply for all IP-CAN sessions using that CoA.\n2b) At IP-CAN session establishment a Gateway Control Session is required before the PCEF announces the IP-CAN Session to the PCRF. At BBERF change and pre-registration the Gateway Control Session shall match an IP-CAN session that the PCEF has already announced. Each IP-CAN session is handled in a separate Gateway Control Session.\nThe PCRF shall select whether case 2a or case 2b applies based on the information received in the Gateway Control Session Establishment. For a user identified with a Subscription-Id AVP, when the PDN identifier included as part of the Called-Station-Id AVP is received, case 2b applies. If not received, case 2a applies.\nThe following considerations shall be taken into account when interpreting the signalling flows:\n-\tV-PCRF is included to also cover the roaming scenarios.\n-\tH-PCRF will act as a PCRF for non-roaming Ues.\n-\tThe steps numbered as “number+letter” (e.g. “3a”) will be executed, for the roaming case, instead of steps numbered as “number” (e.g. “3”), as indicated in the explanatory text below the signalling flows.\n-\tEmergency services and RLOS are handled locally in the serving network, therefore the S9 reference point does not apply.\nNOTE: For the Visited Access case, the operator can by roaming agreement decide not to use S9 reference point.\nThe procedure to detect that the Gx session or a Gateway Control Session is restricted to Emergency Services is described in 3GPP TS 29.212 [9].\n-\tThe procedure to detect that the Gx session is restricted to RLOS is described in 3GPP TS 29.212 [9].\n-\tSubscription-related information is not relevant for the policy control of Emergency Sessions and RLOS; therefore Sp reference point does not apply in that case.\n-\tWith the UDC-based architecture as defined in 3GPP TS 23.203 [2] and 3GPP TS 23.335 [51], SPR, whenever mentioned in the present specification, refers to UDR. The Ud interface as defined in 3GPP TS 29.335 [52] is the interface between the PCRF and the UDR.\n-\tWhen monitoring event reporting via PCRF applies as defined in 3GPP TS 23.682 [38], the SCEF is acting as an AF. In this case, only the flows where the AF is located in the home network apply. Support of this functionality is detailed in 3GPP TS 29.214 [10], Annex D.\n-\tIf the PCEF/BBERF/TDF needs to send an IP-CAN session/ Gateway Control Session/ TDF session modification request towards a PCRF which is known to have restarted since the IP-CAN session/ Gateway Control Session/ TDF session establishment, the PCEF/BBERF/TDF shall follow the PCRF Failure and Restoration procedure as defined in 3GPP TS 29.212 [9].\nNOTE:\tOnly the interaction with OCS for spending limits reporting over Sy interface is introduced in this document.\n-\tThe PCEF and TDF are depicted as monolithic entities in the signalling flows, but each of those can be decomposed into a User Plane Function and a Control Plane Function connected via the Sx reference point. Signalling on the Sx reference point is not shown.",
      "chunk_type": "definition",
      "cross_references": [
        "ts_29.212",
        "ts_23.203",
        "ts_23.335",
        "ts_29.335",
        "ts_23.682",
        "ts_29.214"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.1",
      "section_id": "4.1",
      "section_title": "IP-CAN Session Establishment",
      "content": "This subclause is applicable if a new IP-CAN Session is being established.\nFigure 4.1.1: IP-CAN Session Establishment\n1.\tThe BBERF may initiate a Gateway Control Session Establishment procedure as defined in subclause 4.4.1 (applicable for cases 2a during initial attach and 2b, as defined in subclause 4.0), if appropriate. In this step, the PCRF determines whether the cases 2a or 2b applies, as defined in subclause 4.0.\n2.\tThe PCEF receives an Establish IP-CAN Session Request. The form of the Establish IP-CAN Session Request depends upon the type of the IP-CAN.\n3.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the PCEF informs the H-PCRF of the IP-CAN Session establishment. The PCEF starts a new Gx session by sending a CCR to the H-PCRF using the CC-Request-Type AVP set to the value INITIAL_REQUEST. The PCEF provides UE identity information, PDN identifier, the UE Ipv4 address and/or UE Ipv6 prefix and, if available, the PDN connection identifier, IP-CAN type, RAT type and/or the default charging method and additional charging parameters as defined in subclause 4.5.1 of 3GPP TS 29.212 [9] and may send charging characteristics if available. The PCEF provides, when available, the Default-EPS-Bearer-QoS and the APN-AMBR to the PCRF. The PCEF may provide the applicable TDF routing information in TDF-Information AVP. If the UE has declared support for the extended TFT filter format and the PCEF does not prevent the use thereof, the PCE F shall indicate that the support for extended TFT filters is available in the IP-CAN session. For types of IP-CAN, where the H-PCRF can be in control of IP-CAN Bearers, e.g. GPRS, the PCEF also provides a new bearer identifier and information about the requested bearer, such as QoS. If applicable for the IP-CAN type, it will also provide information to indicate whether NW-initiated bearer control procedures are supported, if available. The PCRF links the Gx session for the new IP-CAN session with the corresponding Gateway Control Session as defined in subclause 4.0. The PCRF maintains aligned set of PCC and QoS rules in the PCEF and BBERF(s) as applicable for the case. For case 2a and if IP flow mobility is supported, the PCEF provides, when available, the IP flow mobility routing rules. For case 1 and if NBIFOM is supported, the PCEF provides, when available, the NBIFOM support and NBIFOM mode information. If available, the PCEF provides a timestamp corresponding to the time at which the request was initiated by the originating node, and additionally the PCEF can include the maximum wait time as defined in subclause 4.5.1 of 3GPP TS 29.212 [9].\nFor the case when the UE is roaming in a Visited Access scenario, steps 3a~3c are executed instead of step 3.\n3a.\tThe PCEF informs the V-PCRF of the establishment of the IP-CAN session. The PCEF starts a new Gx session by sending a CCR to the V-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The parameters for CCR as listed in step 3 are applicable here.\n3b.\tThe V-PCRF determines that the request is for a roaming user and concludes the IP-CAN session uses visited access. V-PCRF stores the received information.\n3c.\tIf there is not an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\nIf there is an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\n4.\tThe H-PCRF stores the information received in the CCR. For cases 2a and 2b, the H-PCRF links the Gx session with the Gateway Control Session(s).\nNOTE 1:\tIn the case 2a, when an additional PDN connection is established, the Gx session is linked with the already established Gateway Control Session.\n5.\tIf the H-PCRF requires subscription-related information and does not have it, the H-PCRF sends a request to the SPR in order to receive the information.\n6.\tThe SPR replies with the subscription related information containing the information about the allowed service(s), QoS information, PCC Rules information and may include MPS EPS Priority, MPS Priority Level and IMS Signalling Priority for establishing a PS session with priority.\nNOTE 2:\tFor steps 5 and 6: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n7.\tIf the PCRF determines that the policy decision depends on the status of the policy counters available at the OCS and no Sy session yet has been established for this subscriber, the PCRF sends an Initial Spending Limit Report Request as defined in subclause 4.7.1. If the Sy sesson is already established for this subscriber, the PCRF may send, if required, an Intermediate Spending Limit Report Request as defined in subclause 4.7.2.\n8.\tThe H-PCRF selects or generates PCC Rule(s) to be installed. The H- PCRF may also make a policy decision by deriving an authorized QoS and by deciding whether service flows described in the PCC Rules are to be enabled or disabled. If MPS EPS Priority, MPS Priority Level, and IMS Signalling Priority are present for the user, the PCRF takes the information into account. If NBIFOM is supported, the PCRF determines whether the NBIFOM applies to the IP-CAN session and selects the NBIFOM mode.\n9.\tThe H-PCRF stores the selected PCC Rules. The H-PCRF selects the Bearer Control Mode that will apply during the IP-CAN session if applicable for the particular IP-CAN. If the H-PCRF controls the binding of IP-CAN Bearers, the H-PCRF stores information about the IP-CAN Bearer to which the PCC Rules have been assigned. If the BBERF/PCEF controls the binding of IP-CAN bearers, the H-PCRF may derive the QoS information per QCI applicable to that IP-CAN session for non-GBR bearers.\n10.\tWhen user profile configuration indicates that Application Detection and Control function is enabled, the H-PCRF makes the policy decision for the application detection and control. For the non-roaming case, or for the case when the UE is roaming in a Home Routed scenario, the H-PCRF selects the applicable PCC Rules to be provided for application detection and control for the PCEF supporting ADC feature, or the applicable ADC rules for the solicited application reporting with a TDF. For the case when the UE is roaming in a Visited Access scenario, the H-PCRF selects the applicable PCC Rules to be provided for application detection and control. For solicited application reporting with a TDF, the H-PCRF finds the TDF by using the TDF-Information AVP received from the PCEF in step 3, or, if not received, using a pre-configured TDF address.\n11.\tOnly applicable for non-roaming case, and for the case when the UE is roaming in a home routed case, In case of solicited application reporting with a TDF, the PCRF initiates a TDF Session Establishment procedure, according to subclause 4.6.1, with the selected TDF.\n12.\tIf traffic steering control over St applies andthe H-PCRF determines that traffic steering control information is needed for the IP-CAN session, the PCRF initiates an St session establishment procedure according to subclause 4.9.1 with the TSSF. The TSSF identifier is pre-configured on the PCRF per e.g. PCEF.\n13.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the H-PCRF provisions the PCC Rules to the PCEF using CCA. The H-PCRF also provides the selected Bearer Control Mode if applicable for the particular IP-CAN and if available, the QoS information per QCI. If the PCEF has indicated that the support for extended TFT filters is available in the IP-CAN session, then the PCRF may, by indicating the PCRF support for extended TFT filters, enable the use of the extended TFT filter format in the IP-CAN session. The PCRF may also provide event triggers listing events for which the PCRF desires PCC Rule Requests. Furthermore, the PCRF may provide authorized QoS including the APN-AMBR and the Default-EPS-Bearer-QoS, User Location Information, user CSG information (if received from the BBERF) and Presence Reporting Area Information. If usage monitoring is enabled, the H-PCRF may provide the applicable thresholds for usage monitoring control at PCEF within the Usage-Monitoring-Information AVP. If NBIFOM is supported, the H-PCRF provides the decision on whether the NBIFOM is supported and the selected NBIFOM mode if applicable.\nFor types of IP-CAN, where the PCRF controls IP-CAN Bearers, e.g. GPRS, the PCRF indicates the IP-CAN Bearer where the PCC Rules are to be installed and that the authorized QoS refers to. Otherwise, the PCRF operates without any further reference to any specific bearer.\nIf the PCEF supports Application Detection and Control feature, the PCRF provisions the applicable PCC Rules to the PCEF for the corresponding IP-CAN session.\nIf online charging is applicable then the PCEF requests credit information from the OCS over the Gy interface. If the PCEF receives credit re-authorisation triggers from the OCS then, for case 2b, it requests the PCRF via a CCR message to provision the triggers at the BBERF. The triggers to be provisioned are specified in the Event-Report-Indication AVP in the CCR message.\nFor the case when the UE is roaming in a Visited Access scenario, steps 13a -13g are executed.\n13a.\tThe PCC Rules, if they were selected in step 9, are provisioned by the H-PCRF to the V-PCRF by using a CCA. The H-PCRF includes PCC Rules in the Subsession-Decision-Info AVP of the CCA, along with the S9 subsession identifier as received in step 3c within the Subsession-Id AVP. Other parameters listed in step 9 are also applicable here.\n13b.\tThe V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n13c. In case of TDF, if Application Detection and Control function is enabled for the IP-CAN session, the V-PCRF extracts ADC rules from the received PCC rules from the H-PCRF and stores the ADC rules.\n13d.\tThe V-PCRF informs the H-PCRF when a request has been denied and may provide the acceptable QoS Information for the service.\n13e.\tThe H-PCRF acknowledges the CCR and may additionally include new or modified PCC rules to the V-PCRF. When user profile configuration indicates that Application Detection and Control function is enabled, some of those PCC Rules may be dedicated for application detection and control.\n13f.\tIn case of solicited application reporting with a TDF, the V-PCRF initiates a TDF Session Establishment procedure, according to subclause 4.6.1, with the selected TDF and provides ADC Rules extracted from the corresponding PCC Rules.\n13g.\tThe V-PCRF provisions PCC rules received from the H-PCRF to the PCEF by using CCA. The parameters listed in step 11a are applicable here, User Location Information and user CSG information (if received from the BBERF).\nNOTE 3:\tFrom this point and onward, the PCRF is responsible for keeping the active PCC, ADC and QoS rules aligned.\n14.\tIf case 2a or 2b applies, the PCRF aligns the set of QoS rules at the BBERF with the set of active rules at the PCEF.\n15.\tThe PCEF installs the received PCC Rules. The PCEF also enforces the authorized QoS and enables or disables service flows according to the flow status of the corresponding PCC Rules. If QoS information is received per QCI, PCEF sets the upper limit accordingly for the MBR that the PCEF assigns to the non-GBR bearer(s) for that QCI. In case of PCEF supporting Application Detection and Control feature, the PCEF enforces the application detection and control.\n16. The PCEF sends a response to the Establish IP-CAN Session Request.For GPRS, the GGSN accepts the PDP Context Request based on the results of the authorisation policy decision enforcement. If the requested QoS parameters do not correspond to the authorized QoS, the GGSN adjusts (downgrades /upgrades) the requested UMTS QoS parameters to the authorized values.\nNOTE 4:\tThe PCRF can reject the IP-CAN session establishment, e.g. the PCRF cannot obtain the subscription-related information from the SPR and the PCRF cannot make the PCC rule decisions, as described in 3GPP TS 29.212 [9].\nPCEF can also enforce active preconfigured PCC rules which are not know to the PCRF.\nThe PCEF can also reject the IP-CAN session establishment, e.g. there is no active PCC rule for the IP-CAN session as specified in 3GPP TS 23.203 [2].",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.4.1",
        "clause_4.0",
        "ts_29.212_clause_4.5.1",
        "clause_4.7.1",
        "clause_4.7.2",
        "clause_4.6.1",
        "clause_4.9.1",
        "figure_4.1.1",
        "ts_29.212",
        "ts_23.203"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.1.1",
      "section_id": "4.2.1.1",
      "section_title": "AF located in the HPLMN",
      "content": "This clause is applicable if an IP-CAN Session is being released by the UE and the AF is located in the HPLMN.\nFigure 4.2.1.1.1: UE-Initiated IP-CAN Session Termination – AF located in the HPLMN\nIn the following procedures, the V-PCRF is included to depict the roaming scenarios. H-PCRF acts as the PCRF for non-roaming UEs.\n1.\tIf case 2b applies (as defined in clause 4.0), the BBERF receives a request to remove the IP-CAN session. In case 2a, the request goes transparently through the BBERF. In all cases, the PCEF receives a request to remove the IP-CAN Session. The form of the Remove IP-CAN Session Request depends upon the type of the IP-CAN.\n2.\tIf case 2b applies (as defined in clause 4.0), the BBERF-initiated Gateway Control Session Termination procedure as defined in clause 4.4.4 (BBERF-Initiated Gateway Control Session Termination) is initiated.\n3.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the PCEF sends a CCR to the H-PCRF, indicating the IP-CAN Session termination. The PCEF requests the termination of the Gx session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST. If the usage monitoring is enabled, the PCEF informs the H-PCRF about the resources that have been consumed by the user since the last report. If the Required-Access-Info AVP is included in any PCC Rule, the PCEF informs the H-PCRF about the access network information. If NAS-RAN-Cause feature is supported the PCEF informs the H-PCRF about the access network information and the failure cause(s), if available.\nFor the case when the UE is roaming in a Visited Access scenario, steps 3a~3b are executed instead of step 3:\n3a.\tThe PCEF sends a CCR to the V-PCRF, indicating the IP-CAN Session termination. The PCEF requests the termination of the Gx session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST. If the usage monitoring is enabled, the PCEF informs the V-PCRF about the resources that have been consumed by the user since the last report. If the Required-Access-Info AVP is included in any PCC Rule, the PCEF informs the V-PCRF about access network information.\n3b\tIf there is an active TDF session between the TDF and the V-PCRF, for roaming UE with visited access, the TDF Session termination is initiated as defined in Section 4.6.2. For this case, the PCRF described in Section 4.6.2 acts as a V-PCRF.\n3c.\tIf congestion reporting is active for the user id and PDN id, for roaming UE with visited access, the V-PCRF initiates a UE context removal as defined in clause 4.8.5.\n3d.\tThe V-PCRF sends the CCR to the H-PCRF. If case 2b or case 1 applies and this is the last subsession associated with the S9 session, the V-PCRF sends a CCR to the H-PCRF to request the termination of the S9 session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST. Otherwise, the V-PCRF sends a CCR to the H-PCRF with a CC-Request-Type AVP set to the value UPDATE_REQUEST and a Subsession-Enforcement-Info within which the Subsession-Operation AVP set to value TERMINATION to request the termination of the conresponding S9 subsession.\nNOTE 1:\tIf the usage monitoring is enabled on PCEF and/or TDF, the V-PCRF gathers the reports and provides them all to H-PCRF in the single CCR message.\n4.\tThe H-PCRF identifies the AF sessions that are bound to IP flows of the removed IP-CAN Session.\n5.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the H-PCRF acknowledges the Gx session termination by sending a CCA to the PCEF.\nFor the case when the UE is roaming in a Visited Access scenario, steps 5a~5c are executed instead of step 5:\n5a. The H-PCRF acknowledges the S9 session or subsession termination by sending a CCA to the V-PCRF.\n5b. The V-PCRF removes the information related to the terminated IP-CAN Session.\n5c. The V-PCRF acknowledges the Gx session termination by sending a CCA to the PCEF.\n6.\tThe PCEF sends a response to the Remove IP-CAN Session Request. The form of the Remove IP-CAN Session Response depends upon the type of the IP-CAN. Step 6 may be executed in parallel with step 3 or 3a (as applicable).\n7. If there is an activeTDF session between the TDF and the H-PCRF, for non-roaming UE/roaming UE with home routed access, the TDF Session termination is initiated as defined in Section 4.6.2.\nNOTE 2: Step 7 can occur anytime after step 3.\nFor each AF session identified in step 4 as bound to the IP-CAN Session being removed, steps 7-11 are executed:\n8.\tIf congestion reporting is active for the user id and PDN id, for non-roaming UE or UE is roaming in home routed case, the H-PCRF initiates a UE context removal as defined in clause 4.8.5.\nNOTE 3:\tStep 8 can occur anytime after step 3.\n9.\tThe H-PCRF indicates the session abort to the H-AF by sending an ASR to the H-AF.\n10.\tThe H-AF responds by sending an ASA to the H-PCRF.\n11.\tThe H-AF sends an STR to the H-PCRF to indicate that the session has been terminated.\n12.\tThe H-PCRF responds by sending an STA to the H-AF. If the provided PCC rules are related to an AF session associated with a sponsor, usage thresholds were provided by the H-AF earlier, and the H-PCRF has usage data that has not yet been reported to the H-AF, the H-PCRF informs the H-AF about the resources that have been consumed by the user since the last report. If the BBERF in step 2 or PCEF in step 3 reports the access network information and if the AF requested the H-PCRF to report access network information previously and/or the RAN-NAS-Cause feature is supported, the H-PCRF informs the H-AF about the access network information and/or RAN/NAS/TWAN/Untrusted WLAN failure cause(s) if available.\n13.\tIf this is the last IP-CAN session for this subscriber the Final Spending Limit Report Request as defined in clause 4.7.3 is sent. If any existing IP-CAN sessions for this subscriber require policy counter status reporting, the Intermediate Spending Limit Report Request as defined in clause 4.7.2 can be sent to alter the list of subscribed policy counters.\n14.\tIf case 2a applies (as defined in clause 4.0), the Gateway Control and QoS Rules Provision procedure as defined in clause 4.4.3 (Gateway Control and QoS Rules Provision) may be initiated to remove the QoS rules associated with the IP‑CAN session being terminated. This applies e.g. in case the Gateway Control Session remains to serve other IP‑CAN sessions.\nAlternatively, if UE acquires a care of address (CoA) that is used for the S2c reference point and the H-PCRF determines that all QoS rules are to be removed and the Gateway Control Session to be terminated, the PCRF-initiated Gateway Control Session Termination procedure as defined in clause 4.4.4 (PCRF-Initiated Gateway Control Session Termination) is initiated. This applies e.g. in case the UE is detached and the CoA acquired by the UE is not used for any other IP‑CAN session.\n15. The H-PCRF sends a cancellation notification request to the SPR if it has subscribed such notification. The H-PCRF stores the remaining usage allowance in the SPR if all IP-CAN sessions of the user to the same APN are terminated. Step 14 may be initiated any time after step 5 or 5a (as applicable).\n16.\tThe SPR sends a response to the H-PCRF.\nNOTE 4:\tFor steps 14 and 15: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n17.\tIf the H-PCRF has provided traffic steering control information to the TSSF for the IP-CAN session, the H-PCRF initiates the St session termination procedure to the TSSF to remove the traffic steering control information associated to the UE IPv4 address and/or to the UE IPv6 prefix for the terminated IP-CAN session according to the subclause 4.9.3.\nNOTE 5:\tStep 17 can be initiated any time after step 5.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.0",
        "clause_4.4.4",
        "clause_4.6.2",
        "clause_4.8.5",
        "clause_4.7.3",
        "clause_4.7.2",
        "clause_4.4.3",
        "clause_4.9.3",
        "figure_4.2.1.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.1.2",
      "section_id": "4.2.1.2",
      "section_title": "AF located in the VPLMN",
      "content": "This clause is applicable only for the Visited Access scenario for the case when an IP-CAN Session is being released by the UE and the AF is located in the VPLMN.\nFigure 4.2.1.2.1: UE-Initiated IP-CAN Session Termination – AF located in the VPLMN\nIf the AF resides in the VPLMN, the V‑PCRF proxies AF session signalling over S9 between the V-AF and the H‑PCRF.\n1\tIn order to perform UE initiated IP-CAN Session Termination Procedures, step 1 through step 8: as specified in Figure 4.2.1.1.1: UE Initiated IP-CAN Session Termination – AF Located in the HPLMN are executed.\nFor each AF session identified in step 4 (Figure 4.2.1.1.1) as bound to the IP-CAN Session being removed steps 2-10 are executed:\n2.\tThe H-PCRF indicates the session abort to the V-AF in VPLMN by sending an ASR to the V-PCRF.\n3.\tThe V-PCRF proxies the ASR to the V-AF.\n4.\tThe V-AF responds by sending an ASA to the V-PCRF.\n5.\tThe V-PCRF proxies the ASA to the H-PCRF.\n6.\tThe V-AF sends an STR to the V-PCRF to indicate that the session has been terminated.\n7.\tThe V-PCRF proxies the STR to the H-PCRF.\n8.\tThe H-PCRF responds by sending an STA to the V-PCRF.\n9.\tThe V-PCRF proxies the STA to the V-AF.\n10.\tStep 13 through step 16: as specified in Figure 4.2.1.1.1: UE Initiated IP-CAN Session Termination – AF Located in the HPLMN are executed, as needed.\nNOTE:\tFor steps 15 and 16: the details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.2.1.2.1",
        "figure_4.2.1.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.2.1",
      "section_id": "4.2.2.1",
      "section_title": "AF located in the HPLMN",
      "content": "This clause is applicable if an IP-CAN Session is being released by the PCEF and the AF is located in the HPLMN.\nFigure 4.2.2.1.1 : PCEF-initiated IP-CAN Session Termination – AF located in the HPLMN\nIn the following procedures, the V-PCRF is included to depict the roaming scenarios. H-PCRF acts as the PCRF for non-roaming Ues.\n1.\tThe PCEF detects that the terminat\tion of an IP-CAN Session or bearer is required.\n2.\tIf case 2b applies (as defined in clause 4.0), PCEF sends the Remove IP-CAN Session Request to the BBERF. If case 2a applies (as defined in clause 4.0), the request goes transparently through the BBERF. In all cases, the PCEF sends a Remove IP-CAN Session Request to remove the IP-CAN Session. The form of the Remove IP-CAN Session Request depends upon the type of the IP-CAN. It can consist of separate requests for each IP-CAN Bearer within an IP-CAN Session.\n3\tIf case 2b applies (as defined in clause 4.0), the BBERF-initiated Gateway Control Session Termination\tprocedure as defined in clause 4.4.4 (BBERF-Initiated Gateway Control Session Termination) is initiated.\n4.\tThe PCEF receives a response to the Remove IP-CAN Session Request.\n5 – 7.\tSame as Steps 3~5 in figure 4.2.1.1.1.\n8 – 18.Same as Steps 7~17 in figure 4.2.1.1.1.\nNOTE 1:\tSteps 2 and 5 may be executed in parallel.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.0",
        "clause_4.4.4",
        "figure_4.2.2.1.1",
        "figure_4.2.1.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.2.2",
      "section_id": "4.2.2.2",
      "section_title": "AF located in the VPLMN",
      "content": "This clause is applicable only for the Visited Access scenario for the case when an IP-CAN Session is being released by the PCEF and the AF is located in the VPLMN\nFigure 4.2.2.2.1: PCEF-Initiated IP-CAN Session Termination – AF located in the VPLMN\nIf the AF resides in the VPLMN, the V‑PCRF proxies AF session signalling over S9 between the V-AF and the H‑PCRF.\n1.\tIn order to perform PCEF initiated IP-CAN Session Termination Procedures, step 1 through step 9: as specified in Figure 4.2.2.1.1: PCEF Initiated IP-CAN Session Termination – AF Located in the HPLMN are executed.\nFor each AF session identified in step 6 (Figure 4.2.2.1.1) as bound to the IP-CAN Session being removed, steps 2-9 are executed:\n2.\tThe H-PCRF indicates the session abort to the V-AF in VPLMN by sending an ASR to the V-PCRF.\n3.\tThe V-PCRF proxies the ASR to the V-AF.\n4.\tThe V-AF responds by sending an ASA to the V-PCRF.\n5.\tThe V-PCRF proxies the ASA to the H-PCRF.\n6.\tThe V-AF sends an STR to the V-PCRF to indicate that the session has been terminated.\n7.\tThe V-PCRF proxies the STR to the H-PCRF.\n8.\tThe H-PCRF responds by sending an STA to the V-PCRF.\n9.\tThe V-PCRF proxies the STA to the V-AF.\n10.\tStep 14 through step 17: as specified in Figure 4.2.2.1.1: PCEF Initiated IP-CAN Session Termination – AF Located in the HPLMN are executed, as needed.\nNOTE:\tFor steps 16 and 17: the details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.2.2.2.1",
        "figure_4.2.2.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.3.1",
      "section_id": "4.2.3.1",
      "section_title": "AF located in the HPLMN",
      "content": "This clause is applicable if an IP-CAN Session is being released by the PCRF and the AF is located in the HPLMN.\nFigure 4.2.3.1.1: PCRF-initiated IP-CAN Session Termination – AF located in HPLMN\nIn the following procedures, the V-PCRF is included to depict the roaming scenarios. H-PCRF acts as the PCRF for non-roaming Ues.\n1.\tThe H-PCRF detects that the termination of an IP-CAN Session is required.\n2.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the H-PCRF sends a RAR including the Session-Release-Cause AVP to request that the PCEF terminates the IP CAN session.\nFor the case when the UE is roaming in a Visited Access scenario, steps 2a~2b are executed instead of step 2:\n2a.\tIf case 2b or case 1 applies and the subsession being terminated is the last subsession over S9, the H-PCRF sends a RAR including the Session-Release-Cause AVP to the V-PCRF to indicate the termination of the S9 session. Otherwise, the H-PCRF sends a RAR to the V-PCRF including the Subsession-Decision-Info AVP with the Session-Release-Cause AVP to indicate the request for terminating the S9 subsession corresponding to the IP-CAN session.\n2b. The V-PCRF sends a RAR including the Session-Release-Cause AVP to the PCEF.\n3.\tThe PCEF removes all the PCC Rules which are applied to the IP-CAN session.\n4.\tFor the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the PCEF sends a RAA to acknowledge the RAR.\nFor the case when the UE is roaming in a Visited Access scenario, steps 4a~4b are executed instead of step 4:\n4a.\tThe PCEF sends a RAA to the V-PCRF.\n4b. The V-PCRF sends a RAA to the H-PCRF and acknowledges the request for terminating the S9 session or the S9 subsession corresponding to the IP-CAN session.\n5.\tThe PCEF applies IP CAN specific procedures to terminate the IP CAN session.\n6. – 21.\tSame as Steps 3-18 in figure 4.2.2.1.1.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.2.3.1.1",
        "figure_4.2.2.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.2.3.2",
      "section_id": "4.2.3.2",
      "section_title": "AF located in the VPLMN",
      "content": "This clause is applicable only for the Visited Access scenario for the case when an IP-CAN Session is being released by the PCRF and the AF is located in the VPLMN\nFigure 4.2.3.2.1: PCRF-Initiated IP-CAN Session Termination  – AF located in the VPLMN\nIf the AF resides in the VPLMN, the V‑PCRF proxies AF session signalling over S9 between the V-AF and the H‑PCRF.\n1.\tIn order to perform PCRF initiated IP-CAN Session Termination Procedures, step 1 through step 12: asspecified in Figure 4.2.3.1.1: PCRF Initiated IP-CAN Session Termination – AF Located in the HPLMN areexecuted.\nFor each AF session identified in step 6 (Figure 4.2.3.1.1) as bound to the IP-CAN Session being removed, steps 2-9 are executed:\n2.\tThe H-PCRF indicates the session abort to the V-AF in VPLMN by sending an ASR to the V-PCRF.\n3.\tThe V-PCRF proxies the ASR to the V-AF.\n4.\tThe V-AF responds by sending an ASA to the V-PCRF.\n5.\tThe V-PCRF proxies the ASA to the H-PCRF.\n6.\tThe V-AF sends an STR to the V-PCRF to indicate that the session has been terminated.\n7.\tThe V-PCRF proxies the STR to the H-PCRF.\n8.\tThe H-PCRF responds by sending an STA to the V-PCRF.\n9.\tThe V-PCRF proxies the STA to the V-AF.\n10.\tStep 17 through step 20: as specified in Figure 4.2.3.1.1: PCRF Initiated IP-CAN Session Termination – AF Located in the HPLMN are executed, as needed.\nNOTE:\tFor steps 19 and 20: the details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.2.3.2.1",
        "figure_4.2.3.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.1",
      "section_id": "4.3.1.1",
      "section_title": "Interactions between BBERF, PCEF, TDF, OCS, TSSF and PCRF(PCC/QoS/ADC Rule Provisioning in PUSH mode)",
      "content": "This flow shows the provisioning of PCC/QoS/ADC Rules and/or authorized QoS triggered by an event in the PCRF.\nFigure 4.3.1.1.1: Interactions between BBERF, PCEF, TDF, OCS, TSSF and PCRF for PCRF-Initiated IP-CAN Session Modification\n1.\tThe H-PCRF receives an internal or external trigger to re-evaluate PCC Rules and policy decision for an IP-CAN Session. Possible external trigger events are described in clause 4.3.1.2. In addition, this procedure is triggered by\n-\tPCEF subscribed event\n-\tSPR subscription data modification (e.g. change in MPS EPS Priority, MPS Priority Level and/or IMS Signalling Priority, or change in user profile configuration indicating whether supporting application detection and control).\n-\tOCS status of a policy counter identifier(s) has changed and the PCRF requested notification for spending limits apply.\n-\tApplication detection information report from TDF.\n2.\tThe H-PCRF selects the PCC Rule(s) to be installed, modified or removed for the IP-CAN Session. In case of PCEF supporting Application Detection and Control feature, some of those PCC rules may be used for application detection and control. The H-PCRF may also update the policy decision by defining an authorized QoS and enable or disable the service flow(s) of PCC Rules. If the PCEF controls the binding of IP-CAN bearers, the H-PCRF may add or change QoS information per QCI applicable to that IP-CAN session. In case of TDF, the H-PCRF selects the applicable ADC rules for the solicited application reporting with a TDF. If NBIFOM applies to the IP-CAN session and Network-initiated mode is selected, the H-PCRF determines the access that is to be used for the transfer of traffic and include the allowed access type in the PCC rules. If NBIFOM applies to the IP-CAN session, the H-PCRF determines one access is to be removed from multi access IP-CAN session.\n3.\tThe H-PCRF stores the updated PCC Rules, and ADC rules if available.\n4.\tStep 4 is only applicable if the Bearer Control Mode (BCM) selected is UE-only or, for UE/NW the H-PCRF determines that UE mode applies for the affected PCC Rules, and the PCRF receives an external trigger from the AF.The PCRF may start a timer to wait for a UE requested bearer resource initiation, modification or removal procedure initiated by the UE, as depicted in figure 4.3.2.1.1.\nIf a UE requested bearer resource initiation, modification or termination procedure initiated by the terminal is received for the affected PCC rules while the timer is running, all subsequent steps in the present figure shall not be executed and, for case 1, the steps in figure 4.3.2.1.1 (on provisioning based on PULL procedure at PCEF –initiated IP-CAN session modification when the AF is located in the HPLMN), 4.3.2.2.1 (on provisioning based on PULL procedure at PCEF-initiated IP-CAN session modification when the AF is located in the VPLMN) and for cases 2a and 2b, the steps in figure 4.4.2.1.1 (Home Routed case) or 4.4.2.2.1 (Visited Access case) shall be executed instead.\nOtherwise, if the BCM selected is UE/NW, the PCRF shall proceed with the subsequent steps (provisioning based on PUSH procedure) in the present figure after timer expiry.\nNOTE 1:\tFor IMS Emergency session and RLOS session step 4 is not applicable.\n5.\tFor case 2a and 2b, if Gxx applies for the IP-CAN session and the user is not roaming, or the user is roaming in a Home Routed scenario or a Visited Access scenario for case 2a when the available QoS rule are not related to any IP-CAN session, the H-PCRF may initiate Gateway Control and QoS rules provisioning procedures described in clause 4.4.3.\nNOTE 2: This step is not executed if this procedure is triggered by PCEF subscribed events and/or credit re-authorisation triggers reported by the BBERF.\n6.\tThe H-PCRF sends a Diameter RAR to request that the PCEF installs, modifies or removes PCC Rules and updates the policy decision, or to report PCEF subscribed events reported by the BBERF. The report includes the User Location Information and the User CSG Information (If received from the BBERF). If the provided PCC rules are related to an AF session associated with a sponsor that has requested sponsoring the service, the H-PCRF includes, in the Charging-Rule-Definition AVP, the Sponsor-Identity AVP and the Application-Service-Provider-Identity AVP that it received from the AF if the Reporting-Level AVP is set to the value SPONSORED_CONNECTIVITY_LEVEL and, if AF provided the application usage thresholds, the Usage-Monitoring-Information AVP. If the AF requests the access network information, the H-PCRF includes Required-Access-Info AVP in the Charging-Rule-Definition AVP and/or Charging-Rule-Remove AVP. In addition, the H-PCRF includes the Event-Trigger set to the value \"ACCESS_NETWORK_INFO_REPORT\" if not provided yet. If the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP are provided within the Media-Component-Description AVP, the PCRF may apply the mechanisms for resource sharing as specified at 3GPP TS 29.212 [9]. The PCRF includes the Removal-Of-Access AVP set to the value REMOVAL_OF_ACCESS (0) and the IP-CAN-Type AVP set to the value of removed access to remove one access from the multi access IP-CAN session. If the H-PCRF subscribes the change of UE presence in Presence Reporting Area, the H-PCRF may provide the Presence Reporting Area Information to the PCEF. If the RAN-Support-Info feature is enabled and local policy allows, for PCC rules with QCI of 1, the PCRF can provide the Charging-Rule-Definition AVP including the maximum packet loss rate(s) for uplink and/or downlink direction(s) in the Max-PLR-UL/DL AVP(s) respectively.\nWhen the UE is roaming in a Visited Access scenario, steps 6a ~ 6e are executed instead of step 6:\n6a.\tThe H-PCRF sends a Diameter RAR to the V-PCRF to request that the PCEF installs, modifies or removes PCC Rules and updates the policy decision. In the case of VPLMN supporting Application Detection and Control feature for solicited application reporting, some of those PCC Rules may be used for application detection and control. If the provided PCC rules are related to an AF session associated with a sponsor that has requested sponsoring the service, the H-PCRF includes, in the Charging-Rule-Definition AVP, the Sponsor-Identity AVP and the Application-Service-Provider-Identity AVP that it received from the AF if the Reporting-Level AVP is set to the value SPONSORED_CONNECTIVITY_LEVEL and, if AF provided the application usage thresholds, the Usage-Monitoring-Information AVP. If the AF requests the access network information, the H-PCRF includes Required-Access-Info AVP in the Charging-Rule-Definition AVP and/or Charging-Rule-Remove AVP. In addition, the H-PCRF includes the Event-Trigger set to the value \"ACCESS_NETWORK_INFO_REPORT\" if not provided yet.\n6b. The V-PCRF enforces visited operator policies regarding PCC rules requested by the H-PCRF based on roaming agreements or locally configured policy. In case of TDF, V-PCRF extracts the ADC rules from the PCC Rules received from the H-PCRF and stores them.\nNOTE 3:\tIf the V-PCRF rejects provisioned PCC rules received from the H-PCRF, the remaining steps in this call flow are not followed. Instead, the V-PCRF shall notify the H-PCRF by sending a Diameter RAA, including the Experimental-Result-Code AVP set to the value PCC_RULE_EVENT, identify the failed PCC rules as specified in 3GPP TS 29.212 [9], and additionally may provide the acceptable QoS Information for the service.\n6c. In case of TDF, solicited application reporting, for roaming UE with visited access, the V-PCRF initiates the TDF session establishment, modification, or termination. If the provided ADC rules are related to an AF session associated with a sponsor that has requested sponsoring the service, the H-PCRF includes, in the ADC-Rule-Definition AVP, the Sponsor-Identity AVP and the Application-Service-Provider-Identity AVP that are received from the AF if the Reporting-Level AVP is set to the value SPONSORED_CONNECTIVITY_LEVEL. Additionally, if the AF provided the application usage thresholds, the H-PCRF includes the Usage-Monitoring-Information AVP. If the last ADC rule is deactivated, the V-PCRF requests the TDF to terminate the TDF session toward the V-PCRF as defined in clause 4.6.2. If there is no active TDF session between the TDF and the V-PCRF, the V-PCRF requests the TDF to establish the TDF session towards V-PCRF and provides ADC Rules to the TDF as defined in clause 4.6.1. If there is already an active TDF session between the TDF and the V-PCRF, the V-PCRF provides the ADC rules to the TDF as defined in clause 4.6.3.2.\n6d.\tFor case 2a and 2b, V-PCRF will derive the QoS rules from the PCC rules. The V-PCRF will initiate a Gateway Control and QoS Rule procedure as described in clause 4.4.3 to install, modify or remove QoS rules and optionally subscribe to new events in the BBERF.\n6e.\tThe BBERF installs, modifies or removes the identified QoS Rules. The BBERF also enforces the authorized QoS of the corresponding QoS Rules.\n6f. The V-PCRF sends a Diameter RAR to request that the PCEF installs, modifies or removes PCC Rules.\n7.\tThe PCEF installs, modifies or removes the identified PCC Rules. The PCEF also enforces the authorized QoS and enables or disables service flow according to the flow status of the corresponding PCC Rules. If QoS information is received per QCI, PCEF shall set/update the upper limit for the MBR that the PCEF assigns to the non-GBR bearer for that QCI. In the case of PCEF supporting Application Detection and Control feature, the PCEF may also enforce application detection and control. The PCEF may perform resource sharing among PCC rules if requested from the PCRF. If allowed access type information is included in the PCC rules, the PCEF generates the NBIFOM routing rules based on the PCC rules. If the RAN-Support-Info feature is supported, the PCEF sets the UL/DL maximum packet loss rate value(s) as described in subclause B.3.18 of 3GPP TS 29.212 [9].\nThe following applies for emergency sessions only:\nWhen the PCEF receives an IP-CAN Session Modification Request from the PCRF requesting the removal of the PCC rules of an emergency session, the PCEF starts an inactivity timer to enable the PSAP to request a callback session with the UE.\nWhen the timer expires, the PCEF initiates an IP-CAN Session Termination Request (per clause 4.2.2.1) to terminate the emergency session.\nIf, before the timer expires, the PCEF receives an IP-CAN Session Modification Request from the PCRF with PCC rules for an emergency session the PCEF cancels the timer.\n8.\tThe PCEF sends a Diameter RAA to acknowledge the RAR. The PCEF informs the H-PCRF about the outcome of the PCC rule operation\nWhen the UE is roaming in a Visited Access scenario, steps 8a ~ 8d are executed instead of step 8:\n8a.\tThe BBERF informs the V-PCRF about the outcome of the operation by sending a Diameter RAA command.\n8b.\tThe PCEF informs the V-PCRF about the outcome of the PCC rule operation by sending a Diameter RAA command.\n8c.\tThe V-PCRF stores the received information.\n8d.\tThe V-PCRF informs the H-PCRF about the outcome of the operation by sending a Diameter RAA command.\n9.\tIn case of TDF, solicited application reporting, for non-roaming UE/roaming UE with home routed access, H-PCRF initiates the TDF session establishment, modification, or termination. If the provided ADC rules are related to an AF session associated with a sponsor that has requested sponsoring the service, the H-PCRF includes, in the ADC-Rule-Definition AVP, the Sponsor-Identity AVP and the Application-Service-Provider-Identity AVP that are received from the AF if the Reporting-Level AVP is set to the value SPONSORED_CONNECTIVITY_LEVEL. Additionally, if the AF provided the application usage thresholds, the H-PCRF includes the Usage-Monitoring-Information AVP. If the last ADC rule is deactivated, the H-PCRF requests the TDF to terminate the TDF session toward the H-PCRF as defined in clause 4.6.2. If there is no active TDF session between the TDF and the H-PCRF, the H-PCRF requests the TDF to establish the TDF session towards H-PCRF and provides ADC Rules to the TDF as defined in clause 4.6.1. If there is already an active TDF session between the TDF and the H-PCRF, H-PCRF provides the ADC rules to the TDF as defined in clause 4.6.3.2.\nNOTE 4: Step 9 can occur anytime after step 6.\n10.\tIf traffic steering control over St applies, if the PCRF determines that the traffic steering control information needs to be provisioned for the IP-CAN session; the PCRF initiates the St session establishment procedure according to the subclause 4.9.1. If the PCRF determines that the traffic steering control information provisioned to the TSSF needs to be updated, the PCRF initiates the St session modification procedure according to the subclause 4.9.2. If the PCRF determines that the traffic steering control information is not needed for the IP-CAN session any more, the PCRF initiates the St session termination procedure according to the subclause 4.9.3.\n11.\tIn case of spending limits, for non-roaming/roaming UE with both home routed and visited access, H-PCRFinitiates Initial/ Intermediate/ Final Spending Limit Report Request. The H-PCRF sends an Initial Spending Limit Report Request if this is the first time a status notification of policy counter is requested for the user as defined in clause 4.7.1. If the H-PCRF decides to modify the list of subscribed policy counters the H-PCRF sends an Intermediate Spending Limit Report Request as defined in clause 4.7.2. If the H-PCRF decides to unsubscribe any future status notification of policy counters, it sends a Final Spending Limit Report Request to cancels the request for reporting the change of the status of the policy counters available at the OCS as defined in clause 4.7.3.\nNOTE 5: Step 11 can occur anytime after step 2.\n12.\tIf usage monitoring is enabled and the H-PCRF either removed the last PCC rule applicable for certain monitoring key, or disabled usage monitoring or requested usage report, the PCEF shall initiate an IP-CAN session modification procedure.\n13.\tWhen Gxx does not apply for the IP-CAN session, IP-CAN bearer signalling is executed separately for each IP-CAN bearer under the following conditions:\n-\tIf all PCC rules bound to a bearer have been removed or deactivated (bearer deactivation is applicable)\n-\tIf one or more bearers have to be modified\n-\tIf the PCEF needs to establish a new bearer (bearer establishment is applicable).\n-\tIf the PCEF needs to request access network information.\n-\tif the PCEF needs to send the NBIFOM routing rules to the UE in the corresponding access.\n14.\tIf the AF, in step 1, has requested notifications from the PCRF, e.g. in the case of access network information the PCEF initiates an IP-CAN session modification procedure to provide the requested information as described in clause 4.3.2.\nNOTE 6:\tIf the conditions of both step 14 and step 12 apply the PCEF can make use of only one IP-CAN session modification procedure in step 14.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.3.1.2",
        "clause_4.4.3",
        "clause_4.6.2",
        "clause_4.6.1",
        "clause_4.6.3.2",
        "clause_4.2.2.1",
        "clause_4.9.1",
        "clause_4.9.2",
        "clause_4.9.3",
        "clause_4.7.1",
        "clause_4.7.2",
        "clause_4.7.3",
        "clause_4.3.2",
        "figure_4.3.1.1.1",
        "figure_4.3.2.1.1",
        "figure_4.4.2.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.2.1",
      "section_id": "4.3.1.2.1",
      "section_title": "AF Session Establishment",
      "content": "4.3.1.2.1.1\tAF located in HPLMN\nFigure 4.3.1.2.1.1.1: AF session establishment triggers PCRF-Initiated IP-CAN Session Modification (AF in HPLMN)\n1.\tThe AF receives an internal or external trigger to set-up a new AF session and provides Service Information. The AF identifies the Service Information needed (e.g. IP address of the IP flow (s), port numbers to be used, information on media types, etc).\n2.\tThe AF provides the Service Information to the H-PCRF by sending a Diameter AAR for a new Rx Diameter session. If this AF session is associated with a sponsor, Sponsor-Identity AVP, optionally the Sponsoring-Action AVP set to applicable value and the Application-Service-Provider-Identity AVP are included in Sponsored-Connectivity-Data AVP. If usage thresholds are to be associated with this sponsored AF session, then Granted-Service-Unit AVP is included in Sponsored-Connectivity-Data AVP. The AF can request access network information within the AAR by adding Required-Access-Info AVP(s) and Specific-Action AVP set to the value \"ACCESS_NETWORK_INFO_REPORT\". If the Service can be subject to resource sharing, the AF includes the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP within the Media-Component-Description AVP. If PrioritySharing feature is supported and the service is allowed to use the same Allocation and Retention Priority (ARP) as media flows belonging to other AF sessions, the AF includes the Priority-Sharing-Indicator AVP set to PRIORITY_SHARING_ENABLED within the Media-Component-Description AVP. If the CHEM feature is supported, the AF may also include the maximum packet loss rate(s) for uplink and/or downlink direction(s) in the Max-PLR-UL/DL AVP(s) respectively within the Media-Component-Description AVP. If the service has negotiated the background data transfer policy, the AF includes the reference id of the transfer policy within the Reference-Id AVP. To invoke MPS for DTS, the AF includes the MPS-Action AVP within the AAR, as specified in clause 5.3.\n3.\tThe H-PCRF stores the received Service Information.\n4.\tIf the H-PCRF requires subscription related information and does not have it, the PCRF sends a request to the SPR in order to receive the information. If the Reference-Id AVP is received, the PCRF retrieves the corresponding transfer policy from the SPR and derives the PCC rules for the background data transfer according to the transfer policy.\nIf the AF session is for MPS for DTS invocation, the PCRF performs MPS subscription checks if and only if requested by the AF, as described in subclause 4.4.11 of 3GPP TS 29.214 [10].\n5.\tThe SPR replies with the subscription related information containing the information about the allowed service(s), QoS information and PCC Rules information.\nNOTE:\tFor steps 4 and 5: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n6.\tIf the AF session is associated with a sponsor and sponsored service is enabled,\n-\tif the UE is in the non-roaming case or UE is roaming with the home routed case and operator policies allow accessing the sponsored data connectivity with this roaming case, the H-PCRF authorizes the request based on sponsored data connectivity profile obtained from the SPR;\n-\tif the UE is roaming with the home routed case and operator policies do not allow accessing the sponsored data connectivity with this roaming case or the UE is roaming with the visited access case, the H-PCRF rejects the request.\nThe H-PCRF identifies the affected established IP-CAN Session(s) using the information previously received from the PCEF/V-PCRF and the Service Information received from the AF.\n7.\tThe H-PCRF sends a Diameter AAA to the AF. The PCRF indicates whether the support for UE IP address/mask in the TFT filter is available in the IP-CAN session.\n8.\tThe H-PCRF interacts with the PCEF/BBERF/V-PCRF according to figure 4.3.1.1.1 (Interactions between BBERF/PCEF and PCRF for PCRF-Initiated IP-CAN Session Modification).\n4.3.1.2.1.2\tAF located in VPLMN\nFigure 4.3.1.2.1.2.1: AF session establishment triggers PCRF-Initiated IP-CAN Session Modification (AF in VPLMN)\n1.\tThe AF receives an internal or external trigger to set-up a new AF session and provides Service Information. The AF identifies the Service Information needed (e.g. IP address of the IP flow (s), port numbers to be used, information on media types, etc).\n2.\tThe AF provides the Service Information to the V-PCRF by sending a Diameter AAR for a new Rx Diameter session. If the AF session is associated with a sponsor, Sponsor-Identity AVP and Application-Service-Provider-Identity are included in Sponsored-Connectivity-Data AVP. If usage thresholds are to be associated with this sponsored AF session, then Granted-Service-Unit AVP is included in Sponsored-Connectivity-Data AVP. The AF can request access network information within the AAR by adding Required-Access-Info AVP(s) and Specific-Action AVP set to the value \"ACCESS_NETWORK_INFO_REPORT\". If the Service can be subject to resource sharing, the AF includes the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP within the Media-Component-Description AVP. If PrioritySharing feature is supported and the service is allowed to use the same Allocation and Retention Priority (ARP) as media flows belonging to other AF sessions, the AF includes the Priority-Sharing-Indicator AVP set to PRIORITY_SHARING_ENABLED within the Media-Component-Description AVP. To invoke MPS for DTS, the AF includes the MPS-Action AVP within the AAR, as specified in clause 5.3.\n3.\tThe V-PCRF stores the Service Information.\nNOTE 1: \tThe V-PCRF may employ operator policies and reject the AAR from the AF if the provided Service Information is not acceptable. If this happens, the V-PCRF replies immediately to the AF, includes an unsuccessful Result-Code or Experimental-Result-Code in the AAA, and the remaining steps of this call flow are not carried out.\n4.\tThe V-PCRF forwards the Diameter AAR to the H-PCRF.\n5.\tThe H-PCRF stores the received Service Information.\n6. If the H-PCRF requires subscription-related information and does not have it, the H-PCRF sends a request to the SPR in order to receive the information.\nIf the AF session is for MPS for DTS invocation, the PCRF performs MPS subscription checks if and only if requested by the AF, as described in subclause 4.4.11 of 3GPP TS 29.214 [10].\n7.\tThe SPR replies with the subscription related information containing the information about the allowed service(s), QoS information and PCC Rules information.\nNOTE 2:\tFor steps 6 and 7: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n8.\tIf the AF session is associated with a sponsor, the H-PCRFrejects the request. Otherwise, the H-PCRF stores the Service Information and identifies the affected established IP-CAN Session (s) using the information previously received from the PCEF via the V-PCRF and the Service Information received from the AF.\n9.\tThe H-PCRF responds to the V-PCRF with a Diameter AAA. The H- PCRF indicates whether the support for UE IP address/mask in the TFT filter is available in the IP-CAN session.\n10. The V-PCRF forwards the Diameter AAA to the AF.\n11. The H-PCRF interacts with the PCEF/BBERF via the V-PCRF according to figure 4.3.1.1.1 (Interactions between BBERF/PCEF and PCRF for PCRF-Initiated IP-CAN Session Modification).",
      "chunk_type": "general",
      "cross_references": [
        "clause_5.3",
        "ts_29.214_clause_4.4.11",
        "figure_4.3.1.2.1.1.1",
        "figure_4.3.1.1.1",
        "figure_4.3.1.2.1.2.1",
        "ts_29.214"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.2.2.1",
      "section_id": "4.3.1.2.2.1",
      "section_title": "AF located in the HPLMN",
      "content": "Figure 4.3.1.2.2.1.1: AF session modification triggers PCRF-Initiated IP-CAN Session Modification (AF in HPLMN)\n1.\tThe AF receives an internal or external trigger to modify an existing AF session and provide related Service Information.\n2.\tThe AF identifies the Service Information needed (e.g. IP address of the IP flow(s), port numbers to be used, information on media types, etc.).\n3.\tThe AF provides the Service Information to the H-PCRF by sending a Diameter AAR for the existing Rx Diameter session corresponding to the modified AF session. If this AF session is associated with a sponsor, Sponsor-Identity AVP, optionally if the AF wants to enable sponsored dataconnectivity the Sponsoring-Action AVP set to the value \"ENABLE_SPONSORING\" and Application-Service-Provider-Identity are included in Sponsored-Connectivity-Data AVP. If application usage thresholds are to be associated with this sponsored AF session, then Granted-Service-Unit AVP is included in Sponsored-Connectivity-Data AVP. If this AF session is associated with a sponsor and the AF wants to disable sponsored data connectivity the AF includes the Sponsoring-Action AVP set to the value \"DISABLE_SPONSORING\" within the Sponsored-Connectivity-Data AVP. The AF can request access network information within the AAR by adding Required-Access-Info AVP(s) and Specific-Action AVP set to the value \"ACCESS_NETWORK_INFO_REPORT\". If resource sharing conditions have been changed, the AF includes the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP within the Media-Component-Description AVP. If the service has negotiated the background data transfer policy, the AF includes the reference id of the transfer policy within the Reference-Id AVP. If PrioritySharing feature is supported and the service is allowed to use the same Allocation and Retention Priority (ARP) as media flows belonging to other AF sessions, the AF includes the Priority-Sharing-Indicator AVP within the Media-Component-Description AVP to indicate if priority sharing is enabled or disabled. The AF may also include the Pre-emption-Capability AVP and the Pre-emption-Vulnerability AVP within the Media-Component-Description AVP for the PCRF to determine the ARP values and include the Pre-emption-Control-Info AVP at the command level for the PCRF to perform the pre-emption control. If the CHEM feature is supported, the AF may also include the maximum packet loss rate(s) for uplink and/or downlink direction(s) in the Max-PLR-UL/DL AVP(s) respectively within the Media-Component-Description AVP. To invoke/revoke MPS for DTS, the AF includes the MPS-Action AVP within the AAR as specified in clause 5.3.\n4.\tThe H-PCRF stores the received Service Information. If the Reference-Id AVP is received, the PCRF retrieves the corresponding transfer policy from the SPR and derives the PCC rules for the background data transfer according to the transfer policy.\nIf the AF session is for MPS for DTS invocation, the PCRF performs MPS subscription checks if and only if requested by the AF, as described in subclause 4.4.11 of 3GPP TS 29.214 [10].\n5.\tIf the AF session is associated with a sponsor and sponsored service is enabled,\n-\tif the UE is in the non-roaming case or UE is roaming with the home routed case and operator policies allow accessing the sponsored data connectivity with this roaming case, the H-PCRF authorizes the request based on sponsored data connectivity profile obtained from the SPR;\n-\tif the UE is roaming with the home routed case and operator policies do not allow accessing the sponsored data connectivity with this roaming case or the UE is roaming with the visited access case, the H-PCRF rejects the request.\nThe H-PCRF identifies the affected established IP-CAN Session(s) using the information previously received from the PCEF/V-PCRF and the Service Information received from the AF.\n6.\tThe H-PCRF sends a Diameter AAA to the AF.\n7.\tThe H-PCRF interacts with the BBERF/PCEF/V-PCRF according to figure 4.3.1.1.1.",
      "chunk_type": "general",
      "cross_references": [
        "clause_5.3",
        "ts_29.214_clause_4.4.11",
        "figure_4.3.1.2.2.1.1",
        "figure_4.3.1.1.1",
        "ts_29.214"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.2.2.2",
      "section_id": "4.3.1.2.2.2",
      "section_title": "AF located in the VPLMN",
      "content": "Figure 4.3.1.2.2.2.1 AF session modification triggers PCRF-Initiated IP-CAN Session Modification (AF in VPLMN)\n1.\tThe AF receives an internal or external trigger to modify an existing AF session and provide related Service Information.\n2.\tThe AF identifies the Service Information needed (e.g. IP address of the IP flow(s), port numbers to be used, information on media types, etc.). If resource sharing conditions have been changed, the AF includes the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP within the Media-Component-Description AVP. If PrioritySharing feature is supported and the service is allowed to use the same Allocation and Retention Priority (ARP) as media flows belonging to other AF sessions, the AF may include the Priority-Sharing-Indicator AVP within the Media-Component-Description AVP to indicate if priority sharing is enabled or disabled.\n3.\tThe AF provides the Service Information to the V-PCRF by sending a Diameter AAR for the existing Rx Diameter session corresponding to the modified AF session. If this AF session is associated with a sponsor, Sponsor-Identity AVP and Application-Service-Provider-Identity AVP are included in Sponsored-Connectivity-Data AVP. If usage thresholds are to be associated with this sponsored AF session, then Granted-Service-Unit AVP is included in Sponsored-Connectivity-Data AVP. The AF can request access network information within the AAR by adding Required-Access-Info AVP(s) and Specific-Action AVP set to the value \"ACCESS_NETWORK_INFO_REPORT\". To invoke/revoke MPS for DTS, the AF includes the MPS-Action AVP within the AAR, as specified in clause 5.3.\n4.\tThe V-PCRF stores the received Service Information.\nNOTE: \tThe V-PCRF may employ operator policies and reject the AAR from the AF if the provided Service Information is not acceptable. If this happens, the V-PCRF replies immediately to the AF, includes an unsuccessful Result-Code or Experimental-Result-Code in the AAA, and the remaining steps of this call flow are not carried out.\n5.\tThe V-PCRF forwards the Diameter AAR to the H-PCRF.\n6.\tThe H-PCRF stores the received Service Information.\nIf the AF session is for MPS for DTS invocation, the PCRF performs MPS subscription checks if and only if requested by the AF, as described in subclause 4.4.11 of 3GPP TS 29.214 [10].\n7.\tThe H-PCRF identifies the affected established IP-CAN Session(s) using the information previously received from the PCEF/V-PCRF and the Service Information received from the AF.\n8.\tThe H-PCRF responds with a Diameter AAA.\n9.\tThe V-PCRF forwards the Diameter AAA to the AF.\n10.\tThe H-PCRF interacts with the BBERF/PCEF via the V-PCRF according to figure 4.3.1.1.1.",
      "chunk_type": "general",
      "cross_references": [
        "clause_5.3",
        "ts_29.214_clause_4.4.11",
        "figure_4.3.1.2.2.2.1",
        "figure_4.3.1.1.1",
        "ts_29.214"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.2.3.1",
      "section_id": "4.3.1.2.3.1",
      "section_title": "AF located in the HPLMN",
      "content": "Figure 4.3.1.2.3.1.1: Removal of PCC/QoS Rules at AF session release (AF in HPLMN)\n1.\tThe AF receives an internal or external trigger for a session release.\n2.\tThe AF sends a session termination request, Diameter STR, to the H-PCRF to request the removal of the session. The AF can request access network information within the STR by adding a Required-Access-Info AVP.\n3.\tThe H-PCRF identifies the affected IP-CAN Session where PCC Rules and, if available, QoS Rules for the IP flow(s) of this AF session are installed. These PCC/QoS Rules need to be removed.\nIf the AF session being terminated corresponds to a session that included the Priority-Sharing-Indicator AVP set to PRIORITY_SHARING_ENABLED within the Media-Component-Description AVP, if the related media flow(s) was in priority sharing with other media flows, the PCRF should readjust the Allocation and Retention Priority for the remaining services sharing priority. These PCC/QoS Rules may need to be modified.\nIf the AF did not request access network information, and if no usage thresholds due to an AF session associated with a sponsor were provided that relate to the installed PCC rules and RAN-NAS-Cause feature is not supported, step 4a applies. If AF requested access network information, or usage thresholds due to an AF associated with a sponsor were provided that relate to the installed PCC rules,step 4b applies. If RAN-NAS-Cause is supported but Enh-RAN-NAS-Cause is not supported over Gx and the previous conditions do not apply , step 4a applies.. Otherwise step 4b applies.\n4a.\tThe H-PCRF sends Diameter STA, session termination answer, to the AF.\n4b.\tThe H-PCRF sends Diameter STA, session termination answer, to the AF and includes access network information and/or information about the resources that have been consumed by the user since the last report or RAN/NAS/TWAN/Untrusted WLAN release cause(s) if available obtained in step 5.\n5.\tThe H-PCRF interacts with the BBERF/PCEF/V-PCRF according to figure 4.3.1.1.1.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.3.1.2.3.1.1",
        "figure_4.3.1.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.1.2.3.2",
      "section_id": "4.3.1.2.3.2",
      "section_title": "AF located in the VPLMN",
      "content": "Figure 4.3.1.2.3.2.1: Removal of PCC/QoS Rules at AF session release (AF in VPLMN)\n1.\tThe AF receives an internal or external trigger for a session release.\n2.\tThe AF sends a session termination request, Diameter STR, to the V-PCRF to request the removal of the session. The AF can request access network information within the STR by adding a Required-Access-Info AVP.\n3.\tThe V-PCRF forwards the Diameter STR to the H-PCRF.\n4.\tThe H-PCRF identifies the affected IP-CAN Session where PCC Rules and, if available, QoS Rules for the IP flow(s) of this AF session are installed. These PCC/QoS Rules need to be removed.\nIf the AF session being terminated corresponds to a session that included the Priority-Sharing-Indicator AVP set to PRIORITY_SHARING_ENABLED within the Media-Component-Description AVP, if the related media flow(s) was in priority sharing with other media flows, the PCRF should readjust the Allocation and Retention Priority for the remaining services sharing priority. These PCC/QoS Rules may need to be modified.\nSteps 5a and 6a apply if the AF did not request access network information\n5a.\tThe H-PCRF sends Diameter STA, session termination answer, to the V-PCRF.\n6a.\tThe V-PCRF forwards the Diameter STA to the AF.\n7.\tThe H-PCRF interacts with the BBERF/PCEF via the V-PCRF according to figure 4.3.1.1.1.\nSteps 5b and 6b apply if the AF requested access network information\n5b.\tThe H-PCRF sends Diameter STA, session termination answer, to the V-PCRF and includes access network information obtained in step 7.\n6b.\tThe V-PCRF forwards the Diameter STA to the AF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.3.1.2.3.2.1",
        "figure_4.3.1.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.2.1",
      "section_id": "4.3.2.1",
      "section_title": "PCEF-initiated IP-CAN Session Modification. AF located in HPLMN.",
      "content": "This flow shows the provisioning of PCC Rules and/or authorized QoS triggered by the PCEF.\nFigure 4.3.2.1.1: PCEF-initiated IP-CAN Session Modification. AF in HPLMN.\n1.\tFor case 2a and 2b, the BBERF may initiate Gateway Control and QoS rules request procedure described in subclause 4.4.2.\n2.\tThe PCEF may receive a request for IP‑CAN Session modification. The IP-CAN session modification can be initiated upon receiving UE-initiated resource modification request (case 1), a new IP-CAN bearer establishment signalling (case 1), due to a specific event (e.g. UE requested PDN connectivity in all cases) or an internal trigger(e.g. if the PCEF supports Application Detection and Control feature, the start/stop of application traffic event that matches with one or more activated PCC rules for application detection and control that do not contain the Mute-Notification AVP has been detected by the PCEF).\n3.\tThe PCEF informs the H-PCRF about the IP-CAN session modification for non-roaming case and Home Routed roaming scenario. The PCEF sends a CCR command to the H-PCRF including the CC-Request-Type AVP set to the value “UPDATE_REQUEST”. For an IP-CAN Session modification where an existing IP-CAN bearer is modified, the PCEF supplies the specific event that caused the IP-CAN Session modification within the Event-Trigger AVP and the PCC rule name(s) and their status within the Charging-Rule-Report AVP. For an IP-CAN Session modification where an existing IP-CAN bearer is terminated, the PCEF supplies the affected PCC rule name(s), their status set to inactive, the rule failure code and, if available, the RAN/NAS/TWAN/Untrusted WLAN cause(s) within the Charging-Rule-Report AVP. In the case where the UE initiates a resource modification request procedure, the PCEF includes the Packet-Filter-Information AVP, Packet-Filter-Operation AVP and QoS-Information AVP, if applicable. In the case of PCEF supporting Application Detection and Control feature, when the start or stop of the application’s traffic, identified by TDF-Application-Identifier, is detected, if PCRF has previously subscribed to the APPLICATION_START/APPLICATION_STOP Event-Triggers, the PCEF shall report the information regarding the detected application’s traffic in the Application-Detection-Information AVP in the CCR command. If NBIFOM applies to the IP-CAN session, if one of the conditions specified in subclause 4.5.25.2 of 3GPP TS 29.212 [9] applies, the PCEF informs the PCRF accordingly making use of the applicable event trigger, i.e. \"ADDITION_OF_ACCESS\", \" REMOVAL_OF_ACCESS\", \"UNAVAILIBILITY_OF_ACCESS\", \"AVAILIBILITY_OF_ACCESS\" or \"ROUTING_RULE_CHANGE\".\nWhen the UE is roaming in a Visited Access case, steps 3a ~ 3c are executed instead of step 3:\n3a.\tThe PCEF sends a Diameter CCR to the V-PCRF to request PCC/ADD Rules for the roaming user. The parameters listed in step 3 are applicable here.\n3b. The V-PCRF stores the information received in the Diameter CCR from the PCEF.\n3c. The V-PCRF sends a CCR command with the CC-Request-Type AVP set to “UPDATE_REQUEST” to the H-PCRF. The V-PCRF includes the Subsession-Enforcement-Info AVP and the assigned S9 subsession identifier within Subsession-Id AVP. The Subsession-Operation AVP is set to the value “MODIFICATION”.\n4.\tIf the H-PCRF requires subscription-related information and does not have it, the PCRF sends a request to the SPR in order to receive the information.\n5.\tThe SPR replies with the subscription related information containing the information about the allowed service(s) and PCC Rules information.\nNOTE 1:\tFor steps 4 and 5: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n6.\tIf the AF requested a notification of the corresponding event, the H-PCRF sends a Diameter RAR with the Specific-Action AVP set to indicate the event that caused the request. If the session modification affected a sponsored data flow and the H-PCRF detects that the usage threshold provided by the AF has been reached, this message includes the accumulated usage in the Used-Service-Unit AVP within the Sponsored-Connectivity-Data AVP and the Specific-Action AVP set to the value USAGE_REPORT.\n7.\tIf step 6 takes place, the AF may take the application specific procedure (e.g. for IMS refer to 3GPP TS 23.228 [59], replies with a Diameter RAA and may provide updated service information within. Additionally, the AF may terminate the Rx session as per subclause 4.3.1.2.3.\n8-11.\tIf all service data flows for an AF session are deleted, the AF session is terminated. If the session modification affected a sponsored data flow and the H-PCRF detects the UE is roaming with home routed case, the H-PCRF initiates the AF session termination.\nIf the IP-CAN session is associated with a sponsor, usage thresholds were provided by the AF earlier, and the H-PCRF has usage data that has not yet been reported to the AF, the H-PCRF informs the AF, in step 11, about the resources that have been consumed by the user since the last report.\nIf RAN-NAS-Cause feature is supported and RAN/NAS/TWAN/Untrusted WLAN cause(s) and/or access network information were received in step 3, the H-PCRF sends this information to the AF in step 11.\nNOTE 2:\tInitial/intermediate/Final Spending Limit Report Request can be triggered at any time after this if PCRF, based on policy decisions, find the need to initialize, modify, or deactivate spending limit reporting for the subscriber according to subclause 4.7.1/2/3 respectively.\n12. \tThe H-PCRF selects or generates PCC Rule(s) to be installed. The H-PCRF may also identify existing PCC rules that need to be modified or removed. In the case of VPLMN supporting Application Detection and Control feature for solicited application reporting, some of those PCC Rules may be used for application detection and control. The PCC Rules may relate to any of the matching AF sessions or may exist in the PCRF without matching to any AF session. The H-PCRF may also make a policy decision by deriving an authorized QoS and by deciding whether service data flows described in the PCC Rules are to be enabled or disabled. The H-PCRF may also update the ADC decisions and select the ADC rules to be installed, modified or removed for the IP-CAN session in the non-roaming case. If the NBIFOM applies to the IP-CAN session, the PCRF can also make a decision of NBIFOM as defined in subclause 4.5.25.2 of 3GPP TS 29.212 [9].\n13. For the non-roaming case, and for the case when the UE is roaming in a Home Routed scenario, the H-PCRF provisions the PCC Rules to the PCEF using CCA command. The H-PCRF also provides the selected Bearer Control Mode, if changed and applicable for the IP-CAN type. The PCRF may also provide a new list of event triggers for which the PCRF requires to be notified. The PCRF may provide QoS information within the APN-AMBR AVP and the Default-EPS-Bearer-QoS AVP. In the case of PCEF supporting Application Detection and Control feature, the H-PCRF may provision the PCC rules for application detection and control to the PCEF.\nWhen the UE is roaming in a Visited Access, steps 13a ~13c are executed instead of step 13:\n13a. The H-PCRF sends a Diameter CCA to the V-PCRF including the PCC Rules to be provisioned within the Subsession-Decision AVP, along with the S9 subsession identifier as received in step 3b within the Subsession-Id AVP. Other parameters listed in step 9 are also applicable here.\n13b. The V-PCRF validates the QoS parameters requested within the PCC Rules and enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements. In case of TDF, the V-PCRF extracts and validates the ADC rules from the PCC rules received from the H-PCRF according to the local policy and roaming agreements if provided by the H-PCRF.\nNOTE:\tIf the V-PCRF rejects provisioned PCC rules received from the H-PCRF, the remaining steps in this call flow are not followed. Instead, the V-PCRF shall notify the H-PCRF by sending a Diameter CCR, including the Experimental-Result-Code AVP set to the value PCC_RULE_EVENT, identify the failed PCC rules as specified in 3GPP TS 29.215 [22], and additionally may provide the acceptable QoS Information for the service.\n13c. The V-PCRF provisions PCC rules to the PCEF by using CCA command. The parameters listed in step 13a are applicable here.\n13d. In case of TDF, solicited application reporting, the V-PCRF provisions the ADC rules to the TDF as defined in subclause 4.6.3.2. In case of TDF, unsolicited application reporting, the V-PCRF initiates the TDF session termination as defined in clause 4.6.2 if the PCEF reported the UE_IP_ADDRESS_RELEASE to the V-PCRF and there is an active Ipv4 address related TDF session for that IP-CAN session.\n14. In case of TDF, solicited application reporting, the H-PCRF provisions the ADC rules to the TDF as defined in subclause 4.6.3.2. In case of TDF, unsolicited application reporting, the H-PCRF initiates the TDF session termination as defined in subclause 4.6.2 if the PCEF reported the UE_IP_ADDRESS_RELEASE to the H-PCRF and there is an active Ipv4 address related TDF session for that IP-CAN session.\n15. The PCEF installs, modifies or removes the provided PCC Rules. The PCEF also enforces the authorized QoS and enables or disables service flows according to the flow status of the corresponding PCC Rules. In the case of PCEF supporting Application Detection and Control feature, the PCEF enforces application detection and control.\n16. If traffic steering control over St applies, if the PCRF determines that the traffic steering control information needs to be provisioned for the IP-CAN session; the PCRF initiates the St session establishment procedure according to the subclause 4.9.2. If the PCRF determines that the traffic steering control information provisioned to the TSSF needs to be updated, the PCRF initiates the St session modification procedure according to the subclause 4.9.3. If the PCRF determines that the traffic steering control information is not needed for the IP-CAN session any more, the PCRF initiates the St session termination procedure according to the subclause 4.9.2.\n17.\tThe PCEF may initiate IP-CAN session signalling or acknowledges any IP‑CAN Session signalling for IP-CAN Session modification received in step 2.\n18.\tIf the PCRF requested to confirm that the resources associated to a PCC Rule have been successfully allocated or the resource release procedure has concluded, the PCEF-initiated IP-CAN session modification procedure is performed again starting from step 3.\n19.\tFor case 2a and 2b, the PCRF may initiate Gateway Control and QoS rules Provision procedure described in subclause 4.4.3.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.4.2",
        "ts_29.212_clause_4.5.25.2",
        "clause_4.3.1.2.3",
        "clause_4.7.1",
        "clause_4.6.3.2",
        "clause_4.6.2",
        "clause_4.9.2",
        "clause_4.9.3",
        "clause_4.4.3",
        "figure_4.3.2.1.1",
        "ts_29.212",
        "ts_23.228",
        "ts_29.215"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.3.2.2",
      "section_id": "4.3.2.2",
      "section_title": "PCEF-initiated IP-CAN Session Modification, AF located in the VPLMN",
      "content": "Figure 4.3.2.2.1: PCEF-initiated IP-CAN Session Modification, AF in VPLMN. If the AF resides in the VPLMN, the V‑PCRF proxies the AF session signalling over S9 between the V-AF and the H‑PCRF.\n1.\tSteps 1 to 5 in figure 4.3.2.1.1 are executed.\nWhen all PCC Rules related to a particular AF session are removed, the H-PCRF initiates the AF session termination procedure. For each AF session bound to the modified IP-CAN session that is being removed, steps 2-9 are executed instead of steps 10-13:\n2.\tThe H-PCRF indicates the session abort to the V-PCRF by sending a Diameter ASR to the V-PCRF.\n3.\tThe V-PCRF proxies the Diameter ASR command to the V-AF.\n4.\tThe V-AF responds by sending a Diameter ASA command to the V-PCRF.\n5.\tThe V-PCRF proxies the ASA command to the H-PCRF.\n6.\tThe V-AF sends a Diameter STR command to the V-PCRF to indicate that the session has been terminated.\n7.\tThe V-PCRF proxies the Diameter STR command to the H-PCRF.\n8.\tThe V-PCRF proxies the Diameter STA command to the V-AF.\n9.\tThe H-PCRF responds by sending a Diameter STA command.\nWhen the H-PCRF receives event triggers related to specific actions that the AF has subscribed to, the H-PCRF initiates the AF session modification procedure to notify the AF of these specific actions. For each Afsession bound to the modified IP-CAN session that has subscribed to these specific actions, steps 10-13 are executed instead of steps 2-9:\n10. If the H-PCRF is notified of an event in the access network that has to be notified to the V-AF for an AF session, the H-PCRF informs of the event by sending a RAR command to the V-PCRF.\n11. The V-PCRF proxies the RAR command to the V-AF.\n12.\tThe V-AF responds by sending a RAA command to the V-PCRF.\n13. The V-PCRF proxies the RAA to the H-PCRF.\n14.\tSteps 12 to 18 in figure 4.3.2.1.1 are executed.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.3.2.2.1",
        "figure_4.3.2.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4",
      "section_id": "4.4",
      "section_title": "Gateway Control Session Procedures",
      "content": "There are two kinds of Gateway Control (GC) sessions:\n-\tA Gateway Control session that serves a single IP-CAN session (e.g. S-GW/BBERF connecting to PDN-GW using S5/S8 PMIP according to 3GPP TS 23.402 [21]).\n-\tA Gateway Control session that serves all the IP-CAN sessions from the same Care-of address of the UE (e.g. a UE connecting to PDN-GW using S2c according to 3GPP TS 23.402 [21]).\nThese Gateway Control sessions are initiated in connection with IP-CAN session establishment and Initial Attach respectively. For the first case, the PCRF will identify that the GC session serves a single IP-CAN session based on the PDN Identifier received in the request.\nAn access network may support mobility with BBERF change. The new BBERF shall establish new Gateway Control sessions according to the procedures defined for the new access type and the PCRF shall correlate those sessions with ongoing IP-CAN sessions as part of the handover procedure.\nThese scenarios are shown separately in different flows.\nIn the following procedures, the V-PCRF is included to depict the roaming scenarios. H-PCRF will act as a PCRF for non-roaming Ues. The procedure to detect that the IP-CAN Session is restricted to Emergency Services is described in 3GPP TS 29.212 [9].",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_23.402",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.1",
      "section_id": "4.4.1",
      "section_title": "Gateway Control Session Establishment",
      "content": "Figure 4.4.1.1 Gateway Control Session Establishment.\n1.\tThe BBERF receives a message or indication that it needs to establish a Gateway Control session.For case 2a, as defined in clause 4.0, the BBERF detects that a UE has been assigned a Local IP address that the UE may use as a Care-of Address in MIP registrations (see 3GPP TS 23.402 [21], clause 6.3).For case 2b, as defined in clause 4.0, the BBERF detects that the UE requests an IP-CAN session to be established (see 3GPP TS 23.402 [21], clauses 4.5.2 and 5.6.1) or, at BBERF relocation, to be resumed with a certain APN (see 3GPP TS 23.402 [21], clauses 5.7.1 and 5.7.2) or the UE requests a pre-registration with this BBERF (see 3GPP TS 23.402 [21], clause 9.3.1).\n2.\tFor the non-roaming case, the BBERF initiates a Gateway Control session with the H-PCRF by sending a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BBERF provides UE identity information and the IP-CAN type, User Location Information, User CSG Information (if received from the access network) and the indication of the BBERF support for the extended TFT filters.For case 2a, as defined in clause 4.0, the BBERF provides the CoA assigned to the UE.For case 2b, as defined in clause 4.0,the BBERF provides the PDN identifier and PDN connection identifier, if multiple PDN connections for the same APN are supported and, if applicable, a Session-Linking-Indicator to indicate if the session linking has to be deferred. The BBERF provides, when available, the APN-AMBR and Default-EPS-Bearer-QoS.\nNOTE:\tThe BBERF support is a prerequisite for the PCRF enabling the possibility for usage of the extended TFT filter in the IP-CAN session(s).\nIf applicable for the IP-CAN type, the BBERF additionally provides Network-Request-Support AVP to indicate whether NW-initiated procedures are supported.\nWhen the UE is roaming, the steps 2a-2c are executed instead of step 2:\n2a.\tThe BBERF initiates a Gateway Control session with the V-PCRF by sending a CCR to the V-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BBERF provides UE identity information and the IP-CAN type, User Location Information and User CSG Information (if received from the access network).For case 2a, as defined in clause 4.0, the BBERF provides the CoA assigned to the UE.For case 2b, as defined in clause 4.0, the BBERF provides the PDN identifier and, if applicable, a Session-Linking-Indicator AVP to indicate if the session linking has to be deferred. The BBERF provides, when available, the APN-AMBR and Default-EPS-Bearer-QoS.\nIf applicable for the IP-CAN type, the BBERF additionally provides Network-Request-Support AVP to indicate whether NW-initiated procedures are supported.\n2b.\tThe V-PCRF determines based on the UE identity information that the request is for a roaming user. The V-PCRF checks whether the V-PCRF needs to send the CCR to the H-PCRF based on the roaming agreements. For the Visited Access case, the V-PCRF does not send the CCR to the H-PCRF if the Session-Linking-Indicator AVP was received indicating that the session linking has to be deferred.\nNOTE:\tIf the V-PCRF does not send the CCR to the H-PCRF, the PCRF may generate QoS rules based on VPLMN roaming agreements.\n2c.\tFor case 2a:\n-\tIf there is not an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The V-PCRF includes in the CCR the information received in step 2a.\n-\tIf there is an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2a.\nFor case 2b and for the visited case or for the home routed case and if the Session-Linking-Indicator AVP is not received or it indicates SESSION_LINKING_IMMEDIATE, the following procedures apply:\n-\tIf there is not an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this Gateway Control Session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\n-\tIf there is an already established S9 session for this roaming user and not an already established S9 subsession for the PDN connection corresponding to the Gateway Control Session, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this Gateway Control Session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\n-\tIf there is an already established S9 session for this roaming user and an already established S9 subsession for the PDN connection corresponding to the Gateway Control Session, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR command with the S9 subsession identifier assigned by the V-PCRF for this Gateway Control Session within the Subsession-Id AVP, the Subsession-Operation AVP set to the value MODIFICATION, and the BBERF identity within AN-GW-Address AVP.\nFor case 2b and for the home routed case and if the Session-Linking-Indicator AVP was received indicating that the session linking has to be deferred, following procedure applies:\n-\tThe V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this Gateway Control Session within the Subsession-Id AVP, the Subsession-Operation AVP set to the value ESTABLISHMENT and the Session-Linking-Indicator AVP set to the value “SESSION_LINKING_DEFERRED”.\n3.\tThe H-PCRF stores the information received in the CCR. The H-PCRF determines the network scenario that applies (case 2a or 2b) as described in clause 4.0.\nFor case 2a, the H-PCRF may correlate the UE identity information with already established Gx sessions for the same UE.For case 2b, for non roaming case, the H-PCRF links the Gateway Control session with the already established Gx Session and acts as follows:\n-\tif the Session-Linking-Indicator was received indicating that the session linking has to be deferred, defers the session linking till the associated IP-CAN session establishment or modification is received.\n-\tif the Session-Linking-Indicator was not received or indicates that the session linking has to be performed immediately, links the Gateway Control session with the already established Gx Session.\n4.\tIf the H-PCRF requires subscription-related information and does not have it, the H-PCRF sends a request to the SPR in order to receive the information.\n5.\tThe SPR replies with the subscription related information containing the information about the allowed service(s), QoS information, PCC Rules information and may include MPS EPS Priority, MPS Priority Level and IMS Signalling Priority of establishment a PS session with priority.\nNOTE:\tFor steps 4 and 5: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n6.\tFor case 2a, the H-PCRF may prepare for the installation of QoS rules if available;\nFor case 2b, the H-PCRF may\n-\tAt IP-CAN session establishment, if the session linking was not deferred, select or generate and store PCC Rule(s) in preparation for the anticipated Gx session and derive the QoS rules from them. If MPS EPS Priority, MPS Priority Level, and IMS Signalling Priority are present for the user, the PCRF takes the information into account. If the session linking was deferred, the PCC rules are not generated;\n-\tAt BBERF relocation and at pre-registration, if the Session-Linking-Indicator was not received or indicates that the session linking has to be performed immediately, prepare for the installation of QoS rules, derived from the active PCC rules, at the target BBERF;\n7.\tThe H-PCRF stores the selected QoS Rules and PCC Rules. If applicable the H-PCRF selects the Bearer Control Mode that will apply during the Gateway Control session.\n8.\tFor the non-roaming case, the H-PCRF acknowledges the Gateway Control Session by sending a CCA to the BBERF. The H-PCRF includes:\n-\tThe selected BCM, if applicable for the IP-CAN type\n-\tIf NW-initiated procedures are available, the available QoS rules\n-\tIf BCM is UE-only, the QoS rules that correspond to the request from the BBERF\n-\tDefault-EPS-Bearer-QoS and APN-AMBR when applicable\n-\tThe event triggers\nWhen the UE is roaming, the steps 8a-8e are executed instead of step 8:\n8a. The H-PCRF acknowledges the Gateway Control Session by sending a CCA to the V-PCRF. The H-PCRF includes\n-\tThe selected BCM, if applicable for the IP-CAN type\n-\tIf NW-initiated procedures are available, the available QoS rules for the home routed case or the available PCC rules for the visited access case\n-\tIf BCM is UE-only, the QoS rules that correspond to the request from the V-PCRF for the home routed case or the PCC rules that correspond to the request from the V-PCRF for the visited access case\n-\tFor the case 2a, the QoS rules when the available QoS rules are not related to any IP-CAN session\n-\tDefault-EPS-Bearer-QoS and APN-AMBR when applicable\n-\tEvent triggers\n8b.\tThe V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n8c.\tIf the V-PCRF denies an authorization, it informs the H-PCRF and may provide the acceptable QoS Information for the service.\n8d.\tThe H-PCRF may provide new or modified QoS rules to the V-PCRF\n8e.\tIf V-PCRF receives the PCC rules from the H-PCRF, the V-PCRF extracts the QoS rules from the PCC rules. The V-PCRF acknowledges the Gateway Control Session establishment by sending a CCA to the BBERF. The V-PCRF includes the selected BCM if applicable for the IP-CAN type, any applicable QoS rules and event triggers.\n9.\tThe BBERF installs and enforces the received QoS Rules.\n10.\tThe BBERF sends an Establish Gateway Session Control Response to ack the Gateway Control Session Request.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.0",
        "ts_23.402_clause_6.3",
        "ts_23.402_clause_9.3.1",
        "figure_4.4.1.1",
        "ts_23.402"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.2.1",
      "section_id": "4.4.2.1",
      "section_title": "Non-Roaming and Home Routed cases",
      "content": "Figure 4.4.2.1.1: Gateway Control and QoS Rules Request for non-roaming and home routed\n1.\tThe BBERF is triggered to either report an event or obtain QoS rules or both for a gateway control session.\n2.\tThe BBERF sends a Diameter CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report event or request QoS rules.\nWhen the UE is roaming (home routed traffic), steps 2a ~ 2c are executed instead of step 2:\n2a. The BBERF sends a Diameter CCR to the V-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report event or request QoS rules.\n2b. The V-PCRF stores the information received.\n2c. For case 2a, The V-PCRF sends a Diameter CCR to the H-PCRF within the information received in step 2a at command level.\nFor case 2b, The V-PCRF sends a Diameter CCR to the H-PCRF within the information received in step 2a at Subsession-Enforcement-Info AVP.\n3.\tThe H-PCRF stores the received information in the Diameter CCR and derives updated QoS rules and event triggers.\n4.\tThe H-PCRF provisions the updated QoS rules and event triggers to the BBERF using Diameter CCA. The CCA may also only acknowledge that the event report has been received successfully.\nWhen the UE is roaming (home routed traffic), steps 4a ~ 4c are executed instead of step 4:\n4a.\tThe H-PCRF sends the updated QoS rules and event triggers to the V-PCRF using Diameter CCA. The CCA may also only acknowledge that the event report has been received successfully.\n4b. The V-PCRF may also perform further authorization of the rules based on local policies.\n4c. The V-PCRF sends the updated QoS rules and event triggers to the BBERF using Diameter CCA.\n5.\tThe BBERF installs the received QoS Rules and event triggers. This may result in bearer binding being performed according to the rules. The BBERF also enables or disables service flow according to the flow status of the corresponding QoS Rules. The result of the QoS rule activation may trigger the BBERF to send an additional Diameter CCR as described above to the PCRF, for example, to indicate that QoS rule activation has failed.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.4.2.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.2.2",
      "section_id": "4.4.2.2",
      "section_title": "Visited access cases",
      "content": "Figure 4.4.2.2.1: Gateway Control and QoS Rules Request for visited access\n1.\tThe BBERF is triggered to either report an event or obtain QoS rules or both for a gateway control session.\n2.\tThe BBERF sends a Diameter CCR to the V-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report event or request QoS rules.\n3.\tThe V-PCRF stores the information received in the Diameter CCR and derives updated QoS rules and event triggers according to local policies and roaming agreements.\nWhen the report event is subscribed by H-PCRF, the steps 3a~3d are executed instead of step3:\n3a. The V-PCRF sends a Diameter CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report event.\nFor case 2a, the information received in step 2 is send to H-PCRF at command level.\nFor case 2b, the CCR is send with the information provided at subsession level within the Subsession-Enforcement-Info AVP.\n3b. The H-PCRF stores the received information in the Diameter CCR and derives event triggers.\n3c.\tThe H-PCRF sends the event triggers to the V-PCRF using Diameter CCA. The CCA may also only acknowledge that the event report has been received successfully.\n3d. The V-PCRF may also perform further authorization of the rules based on local policies.\n4.\tThe V-PCRF provisions the updated QoS rules and event triggers to the BBERF using Diameter CCA.\n5.\tThe BBERF installs the received QoS Rules and event triggers. This may result in bearer binding being performed according to the rules. The BBERF also enables or disables service flow according to the flow status of the corresponding QoS Rules. The result of the QoS rule activation may trigger the BBERF to send an additional Diameter CCR as described above to the PCRF, for example, to indicate that QoS rule activation has failed.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.4.2.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.3",
      "section_id": "4.4.3",
      "section_title": "Gateway Control and QoS Rules Provision",
      "content": "Since the PCRF is required to keep QoS rules aligned with the active PCC rules for a certain IP-CAN session, it shall initiate the Gateway Control and QoS Rules Provision whenever there is a change to the corresponding PCC rules for a Gx session that is linked with the Gateway Control Session.\nFigure 4.4.3.1: Gateway Control and QoS Rules Provision\n1.\tThe H-PCRF receives an internal or external trigger to update QoS Rules and event triggers for a gateway control session. If the trigger is from the AF and the AF requests the access network information, the H-PCRF applies the procedure as defined in clause 4a.5.16 of 3GPP TS 29.212 [9] to request the access network information. If the trigger is from the AF and the AF provided the Sharing-Key-UL AVP and/or Sharing-Key-DL AVP within the Media-Component-Description AVP, the H-PCRF may apply the procedures as defined in clause 4a.5.10.6 of 3GPP TS 29.212 [9] to request the resource sharing.\n2.\tThe H-PCRF sends a Diameter RAR to request that the BBERF installs, modifies or removes QoS Rules and/or updates the event triggers.\nIf the UE is roaming, then steps 2a ~ 2c are executed instead of step 2:\n2a.\tThe H-PCRF sends a Diameter RAR to the V-PCRF to provision updated QoS Rules and updated event triggers.\nFor case 2a, the RAR provides the updated QoS Rules and updated event triggers with the information included at command level.\nFor case 2b, The H-PCRF sends a Diameter RAR to the V-PCRF within the information at Subsession-Decision-Info AVP.\n2b. The V-PCRF identifies the gateway control session if needed and performs local authorization of the updated QoS rules when necessary.\n2c. The V-PCRF sends a Diameter RAR to the BBERF to provision updated QoS rules and updated event triggers.\n3.\tThe BBERF installs, modifies or removes the identified QoS Rules. The BBERF also enforces the authorized QoS and enables or disables service flow according to the flow status of the corresponding QoS Rules.\n4.\tThe BBERF sends RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the QoS rule operation. If network initiated resource allocation procedures apply for the QoS rules and the corresponding IP-CAN bearer can not be established or modified to satisfy the bearer binding, then the BBERF rejects the activation of a PCC rule.\nIf the UE is roaming, then steps 4a ~ 4b are executed instead of step 4:\n4a.\tThe BBERF sends RAA to the V-PCRF to acknowledge the RAR and informs the V-PCRF about the outcome of the QoS rule operation. If network initiated resource allocation procedures apply for the QoS rules and the corresponding IP-CAN bearer can not be established or modified to satisfy the bearer binding, then the BBERF rejects the activation of a PCC rule.\n4b. The V-PCRF forwards the RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the QoS rule operation.\n5.\tIf needed, the BBERF initiates the access specific procedures to create or modify existing IP-CAN bearers. When the procedure in step 5 is completed and requires of notifications from the BBERF to the PCRF, e.g. in the case of access network information, the steps described as in clause 4.4.2 are additionally executed.",
      "chunk_type": "requirement",
      "cross_references": [
        "ts_29.212_clause_4",
        "clause_4.4.2",
        "figure_4.4.3.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.4.1",
      "section_id": "4.4.4.1",
      "section_title": "BBERF-Initiated Gateway Control Session Termination",
      "content": "This procedure applies for case 2b, as defined in clause 4.0, whenever the BBERF detects a request for a PDN disconnection, mobility to other access or the termination of a pre-registration at the BBERF.\nFigure 4.4.4.1.1: BBERF-Initiated Gateway Control Session Termination\n1.\tThe BBERF is requested to terminate its gateway control session. The form of the request to remove the gateway control session depends upon the type of the IP-CAN.\n2.\tThe BBERF sends a Diameter CCR message to the H-PCRF, indicating the gateway control session termination. The BBERF requests the termination of the DCC session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST.\nIf the UE is roaming, then steps in 2a ~ 2b are executed instead of step 2:\n2a.\tThe BBERF sends a Diameter CCR message to the V-PCRF, indicating the gateway control session termination. The BBERF requests the termination of the DCC session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST.\n2b. For the case 2a or if this is the last subsession associated with the S9 session for the case 2b, the V-PCRF sends a Diameter CCR message to the H-PCRF to request the termination of the S9 session. Otherwise, if the gateway control session is locally handled at the V-PCRF, the V-PCRF continues from step 4b; if the gateway control session has a corresponding S9 subsession, then the V-PCRF sends a Diameter CCR message to the H-PCRF to request the termination of the corresponding S9 subsession.\n3. The H-PCRF identifies the related IP-CAN session and performs update as necessary.\n4. The H-PCRF acknowledges the session termination by sending a Diameter CCA message.\nIf the UE is roaming, then steps 4a ~ 4c are executed instead of step 4:\n4a. If the H-PCRF receives the Diameter CCR message in step 2b, the H-PCRF acknowledges the session or subsession termination request by sending a Diameter CCA message to the V-PCRF.\n4b. The V-PCRF identifies the related IP-CAN session and performs update as necessary.\n4c. The V-PCRF acknowledges the session termination by sending a Diameter CCA message to the BBERF.\n5.\tThe BBERF sends a reply to the request to remove the gateway control session. The form of the reply depends upon the type of the IP-CAN.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.0",
        "figure_4.4.4.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.4.4.2",
      "section_id": "4.4.4.2",
      "section_title": "PCRF-Initiated Gateway Control Session Termination",
      "content": "This procedure applies for case 2a, as defined in clause 4.0, when the PCRF detects that there is no remaining IP-CAN session at the PCRF.\nFigure 4.4.4.2.1: PCRF-Initiated Gateway Control Session Termination\n1.\tThe H-PCRF is requested to terminate the gateway control session.\n2.\tThe H-PCRF sends a Diameter RAR message to the BBERF including a Session-Release-Cause AVP to indicate request for terminating the gateway control session.\nIf the UE is roaming, then steps in 2a ~ 2b are executed instead of Step 2:\n2a. The H-PCRF sends a Diameter RAR message to the V-PCRF to indicate the termination of the S9 session including the Session-Release-Cause AVP.\n2b. The V-PCRF sends a Diameter RAR message to the BBERF based on the termination request received from the H-PCRF to indicate the gateway control session termination.\n3.\tThe BBERF acknowledges the gateway control session termination request by sending a Diameter RAA message.\nIf the UE is roaming, then steps 3a ~ 3b are executed instead of Step 3:\n3a. The BBERF acknowledges the gateway control session termination request by sending a Diameter RAA message to the V-PCRF.\n3b. The V-PCRF sends a Diameter RAA message to the H-PCRF and acknowledges the request for terminating the S9 session corresponding to the gateway control session.\n4.\tThe BBERF follows the BBERF-initiated gateway control session termination procedures described in clause 4.4.4.1 to terminate the gateway control session.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4.0",
        "clause_4.4.4.1",
        "figure_4.4.4.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.1.1",
      "section_id": "4.5.1.1",
      "section_title": "New Gateway Control Session Establishment",
      "content": "The following signalling flow describes an example of a new BBERF initiating a GW control session establishment associated with an existing IP-CAN session.\nFigure 4.5.1.1.1: Gateway Control Session Establishment during BBERF relocation\n1.\tThe target BBERF receives a message or indication to establish a Gateway Control session\n2.\tThe target BBERF initiates a Gateway Control session with the H-PCRF by sending a CCR using the CC-Request-Type AVP set to the value INITIAL_REQUEST to the H-PCRF. The target BBERF provides information as detailed in clause 4a.5.1 of 3GPP TS 29.212 [9].\nWhen the UE is roaming, the following steps are executed instead of step 2:\n2a. The target BBERF initiates a Gateway Control session with the V-PCRF by sending a CCR using the CC-Request-Type AVP set to the value INITIAL_REQUEST to the V-PCRF. The target BBERF provides information as detailed in clause 4a.5.1 of 3GPP TS 29.212 [9].\n2b.\tThe V-PCRF determines based on the UE identity information that the request is for a roaming user. The V-PCRF checks whether the V-PCRF is required to send the request to the H-PCRF based on the roaming agreements.\n2c.\tFor case 2a:\n-\tThe V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2a. The V-PCRF includes the BBERF identity by including the AN-GW-Address AVP at command level.\nFor case 2b:\n- \tIf the Session-Linking-Indicator AVP is not received, or it indicates SESSION_LINKING_IMMEDIATE, the V-PCRF sends the CCR command to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR command with allocated S9 subsession identifier assigned by the V-PCRF for this PDN connection within the Subsession-Id AVP, the Subsession-Operation AVP set to the value MODIFICATION, the BBERF identity within AN-GW-Address AVP.\n- \tIf the Session-Linking-Indicator AVP is received indicating that the session linking has to be deferred, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this Gateway Control Session within the Subsession-Id AVP, the Subsession-Operation AVP set to the value ESTABLISHMENT and the Session-Linking-Indicator AVP set to the value “SESSION_LINKING_DEFERRED”.\n3.\tThe H-PCRF stores the information received in the Diameter CCR.\n4.\tIf the Session-Linking-Indicator AVP was received indicating that the session linking has to be deferred, the linking between the Gateway Control Session and the Gx session shall be deferred. Otherwise, based on the information received the H-PCRF identifies multiple BBERF sessions for a particular IP-CAN session.\n5.\tThe H-PCRF derives applicable PCC/QoS rules based on the BCM mode as defined in clause 4a.5.7 of 3GPP TS 29.212 [9].\n6.\tThe H-PCRF stores the selected QoS Rules and PCC Rules. For non-roaming users the H-PCRF selects the Bearer Control Mode that will apply during the Gateway Control session.\n7.\tThe H-PCRF acknowledges the Gateway Control Session by sending a Diameter CCA. The H-PCRF includes the selected BCM if applicable, the QoS rules and event triggers.\nWhen the UE is roaming, the following steps are executed instead of step 7:\n7a.\tThe H-PCRF acknowledges the Gateway Control Session by sending a Diameter CCA to the V-PCRF. The H-PCRF includes applicable QoS rules and also event triggers. The H-PCRF also includes the AN-GW-Address AVP if the QoS rules are applicable for a single BBERF.\n7b.\tThe V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n7c.\tIf the V-PCRF denies an authorization, it informs the H-PCRF and may provide the acceptable QoS Information for the service.\n7d.\tThe H-PCRF may provide new or modified QoS rules to the V-PCRF.\n7e.\tThe V-PCRF acknowledges the Gateway Control Session and provisions, when applicable, the selected BCM, policy decisions and event triggers to the target BBERF.\n8.\tThe BBERF installs the received QoS Rules.\n9.\tThe target BBERF establishes an indication for a Gateway control session response.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.1.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.1.2",
      "section_id": "4.5.1.2",
      "section_title": "PCEF IP-CAN session modification – Handover",
      "content": "The following signalling flow describe the case when an indication of handover is received by the PCEF and the H-PCRF derives QoS rules based on the type of BBERF (primary/non-primary).\nFigure 4.5.1.2.1: PCEF IP-CAN session modification – Handover\n1.\tThe PCEF receives a message or indication that a handover occurred\n2.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the H-PCRF. The PCEF includes the AN_GW_CHANGE event trigger, and if applicable the IP-CAN_CHANGE event trigger as well, to indicate that handover has occurred.\n3.\tThe H-PCRF stores the information received in the Diameter CCR.\n4.\tIf there is a pending gateway control session to be linked to a Gx session, the H-PCRF shall perform the session linking according to clause 4a.5.6 of 3GPP TS 29.212 [9] for the non-roaming case. Based on the information received the H-PCRF reclassifies primary/non-primary BBERFs according to the procedures defined in clause 4a.5.7 of 3GPP TS 29.212 [9].\n5.\tThe H-PCRF derives PCC rules for the PCEF, and QoS rules for the new reclassified primary BBERF, based on the BCM mode of the GW control session as defined in clause 4a.5.7 of 3GPP TS 29.212 [9].\n6.\tThe H-PCRF stores the selected QoS Rules and PCC Rules.\n7.\tThe H-PCRF acknowledges the IP-CAN session modification request by sending a Diameter CCA to the PCEF. The H-PCRF includes updated PCC rules and event triggers (if applicable).\n8.\tThe H-PCRF initiates a Gateway Control and QoS Rules Provision procedure by sending a Diameter RAR. The H-PCRF includes the selected BCM if applicable, the QoS rules and event triggers.\nWhen the UE is roaming, the following steps are executed instead of step 8:\n8a.\tThe H-PCRF initiates a Gateway Control and QoS Rules Provision procedure to the V-PCRF by sending a Diameter RAR to the V-PCRF. The H-PCRF sends applicable QoS rules based on the BBERF type (primary/non-primary) and BCM mode selected as defined in clause 4a.5.9 of 3GPP TS 29.212 [9]. The H-PCRF includes the AN-GW-Address AVP if the QoS rules are applicable only for a single BBERF. If the QoS rules are applicable for all BBERF sessions this AVP is omitted.\n8b.\tThe V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n8c.\tIf the V-PCRF denies an authorization, it informs the H-PCRF and may provide the acceptable QoS Information for the service by including in the RAA command the QoS-Rule-Report AVP to indicate the QoS Rules that were not accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL-QoS-VALIDATION, and the QoS-Information AVP.\n8d.\tThe H-PCRF may provide new or modified QoS rules to the V-PCRF.\n8e.\tThe V-PCRF initiates the Gateway Control Session and QoS rules provisions, when applicable, the selected BCM, policy decisions and event triggers to the target BBERF.\n9.\tThe BBERF installs the received QoS Rules.\n10. The target BBERF acknowledges the RAR command by sending a Diameter RAA command to the PCRF.\nWhen the UE is roaming, the following steps are executed instead of step 10:\n10a.The BBERF acknowledges the Gateway Control and QoS Rules Provision request by sending a Diameter RAA to the V-PCRF.\n10b. The V-PCRF acknowledges the Gateway Control and QoS Rules Provision request by sending a Diameter RAA to the H-PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.1.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.1.3",
      "section_id": "4.5.1.3",
      "section_title": "PCEF IP-CAN session modification – S2c-based IP flow mobility",
      "content": "The following signalling flow describes an example of S2c-based IP flow mobility. In this case, the H-PCRF receives an IP flow mobility event by the PCEF and derives QoS rules based on the IP flow mobility routing rules.\nFigure 4.5.1.3.1: PCEF IP-CAN session modification – S2c-based IP flow mobility\n1.\tThe PCEF receives a message or indication that an IP flow mobility event occurred\n2.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the H-PCRF. The PCEF includes the ROUTING_RULE_CHANGE event trigger to indicate that a change in the IP flow mobility routing rules has occurred. The PCEF includes in the CCR the Routing-Rule-Install and/or Routing-Rule-Removal AVPs.\n3.\tThe H-PCRF stores the information received in the Diameter CCR.\n4.\tThe H-PCRF derives PCC rules for the PCEF, and QoS rules for the BBERF(s), based on the BCM mode of the GW control session and the IP flow mobility routing rules as defined in clause 4a.5.7 of 3GPP TS 29.212 [9]\n5.\tThe H-PCRF stores the selected PCC/QoS Rules.\n6.\tThe H-PCRF acknowledges the IP-CAN session modification request by sending a Diameter CCA to the PCEF. The H-PCRF includes updated PCC rules and event triggers (if applicable).\n7.\tThe H-PCRF initiates a Gateway Control and QoS Rules Provision procedure by sending a Diameter RAR. The H-PCRF includes the QoS rules and event triggers.\nWhen the UE is roaming, the following steps are executed instead of step 7:\n7a.\tThe H-PCRF initiates a Gateway Control and QoS Rules Provision procedure to the V-PCRF by sending a Diameter RAR to the V-PCRF. The H-PCRF sends applicable QoS rules based on BCM mode selected as defined in clause 4a.5.9 of 3GPP TS 29.212 [9]. The H-PCRF includes the AN-GW-Address AVP identifying the BBERF involved in the exchange of the IP flows described by the received IP flow mobility routing rules\n7b.\tThe V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n7c.\tIf the V-PCRF denies an authorization, it informs the H-PCRF and may provide the acceptable QoS Information for the service by including in the RAA command the QoS-Rule-Report AVP to indicate the QoS Rules that were not accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL-QoS-VALIDATION, and the QoS-Information AVP.\n7d.\tThe H-PCRF may provide new or modified QoS rules to the V-PCRF.\n7e.\tThe V-PCRF initiates the Gateway Control Session and QoS rules provisions, when applicable, policy decisions and event triggers to BBERF.\n8\tStep 9 through step 10b: as specified in Figure 4.5.1.2.1: PCEF-initiated IP-CAN session modification‑ Handover are executed, as needed. If the IP flows were moved from one access to another (e.g. 3GPP to WLAN, or vice versa), the PCRF may also initiate a RAR command towards BBERF#1 to modify or release the related resources associated with the flows that were moved to BBERF#2.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.1.3.1",
        "figure_4.5.1.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.1.4",
      "section_id": "4.5.1.4",
      "section_title": "Gateway Control Session Establishment and PCEF IP-CAN session modification – S2c-based IP flow mobility",
      "content": "The following signalling flow describes an example of S2c-based IP flow mobility. In this case, the H-PCRF receives a Gateway Control session establishment by a BBERF and an IP flow mobility event by the PCEF. H-PCRF associates the IP‑CAN session to multiple Gateway Control Sessions and derives QoS rules based on the IP flow mobility routing rules.\nFigure 4.5.1.4.1: Gateway Control Session Establishment and PCEF IP-CAN session modification – S2c-based IP flow mobility\n1.\tStep 1 through step 10: as specified in Figure 4.4.1.1: Gateway Control Session Establishment are executed, as needed. The Gateway Control Session is established for BBERF #2. The Gateway Control Session for BBERF #1 was previously established.\nNOTE:\tIf the Gateway Control Session is established for WLAN access, only case 2a is possible.\n2.\tThe PCEF receives a message or indication that an IP flow mobility event occurred.\n3.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the H-PCRF. The PCEF includes the ROUTING_RULE_CHANGE event trigger to indicate that a change in the IP flow mobility routing rules has occurred. The PCEF includes in the CCR the Routing-Rule-Install and/or Routing-Rule-Removal AVPs.\n4.\tThe H-PCRF stores the information received in the Diameter CCR.\n5.\tThe H-PCRF does not differentiate between primary and non-primary BBFs. H-PCRF derives PCC rules for the PCEF, and QoS rules for the BBERF(s), based on the BCM mode of the GW control session and the IP flow mobility routing rules as defined in clause 4a.5.7 of 3GPP TS 29.212 [9]\n6.\tStep 5 through step 8: as specified in Figure 4.5.1.3.1: PCEF-initiated IP‑CAN session modification‑ IP Flow mobility are executed, as needed.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.1.4.1",
        "figure_4.4.1.1",
        "figure_4.5.1.3.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.2.1",
      "section_id": "4.5.2.1",
      "section_title": "New Gateway Control Session Establishment",
      "content": "The following signalling flow describes an example of a new BBERF initiating a GW control session establishment associated with an existing IP-CAN session.\nFigure 4.5.2.1.1: Gateway Control Session Establishment during BBERF relocation\n1.\tThe target BBERF receives a message or indication to establish a Gateway Control Session.\n2.\tThe target BBERF initiates a Gateway Control Session with the V-PCRF by sending a CCR using the CC-Request-Type AVP set to the value INITIAL_REQUEST to the V-PCRF. The target BBERF provides information as detailed in clause 4a.5.1 of 3GPP TS 29.212 [9].\n3.\tThe V-PCRF stores the information received in the Diameter CCR and determines based on the UE identity information that the request is for a roaming user. The V-PCRF checks whether the V-PCRF is required to send the request to the H-PCRF based on the roaming agreements. The V-PCRF does not send the CCR to the H-PCRF to update the S9 session immediately if the Session-Linking-Indicator AVP was received indicating that the session linking has to be deferred.\n4.\tIf the Session-Linking-Indicator AVP was received indicating that the session linking has to be deferred, the linking between the Gateway Control Session and the Gx session shall be deferred. Otherwise, based on the information received the V-PCRF identifies multiple BBERF sessions for a particular IP-CAN session. The V-PCRF derives applicable QoS rules according to local policies and stores them.\nFor case 2a or if either the AN_GW_CHANGE or the IP-CAN_CHANGE event is subscribed by H-PCRF and this event trigger is received steps 5~8 are executed. Otherwise steps 5~8 are skipped.\n5.\tThe V-PCRF initiates an IP-CAN Session Modification procedure by sending a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2.\n6.\tThe H-PCRF stores the information received in the Diameter CCR. And the H-PCRF decides PCC rules for the BBERF and stores PCC rules.\n7.\tThe H-PCRF sends a Diameter CCA to the V-PCRF to provide the PCC rules. The H-PCRF sends applicable PCC rules. The H-PCRF includes the AN-GW-Address AVP if the PCC rules are applicable only for a single BBERF. If the PCC rules are applicable for all BBERF sessions this AVP is omitted.\n8.\tIf the steps 5~7 are executed, the V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\nSteps 8a and 8b are executed if the V-PCRF denies authorisation for one or more PCC rules.\n8a.\tIf V-PCRF denies authorization, it informs the H-PCRF by sending a CCR command including the Charging-Rule-Report AVP to indicate the PCC Rules that were not accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL-QoS-VALIDATION, and the acceptable QoS Information for the service.\n8b.\tThe H-PCRF may provide new modified PCC rules to the V-PCRF.\n9.\tThe V-PCRF acknowledges the Gateway Control Session and provisions policy decisions and event triggers to the target BBERF.\n10. The BBERF installs the received QoS rules.\n11. The target BBERF responds to the Gateway control session establishment request in step 1.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.2.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.2.2",
      "section_id": "4.5.2.2",
      "section_title": "PCEF-Initiated IP-CAN session modification-Handover",
      "content": "The following signalling flow describe the case when an indication of handover is received by the PCEF and the H-PCRF derives QoS rules based on the type of BBERF (primary/non-primary)\nFigure 4.5.2.2.1: PCEF-initiated IP-CAN session modification – Handover\n1.\tThe PCEF receives a message or indication that a handover occurred.\n2.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the V-PCRF. The PCEF includes the AN_GW_CHANGE event trigger, and if applicable the IP-CAN_CHANGE event trigger as well, to indicate that handover has occurred.\n3.\tThe V-PCRF stores the information received in the Diameter CCR.\n4.\tIf there is a pending Gateway Control Session to be linked to a Gx session, the V-PCRF links Gateway Control Session with the Gx session according to clause 4a.5.6 of 3GPP TS 29.212 [9]. Otherwise based on the information received the V-PCRF identifies multiple BBERF sessions for a particular IP-CAN session.\n5.\tBased on the information received the V-PCRF reclassifies primary/non-primary BBERFs according to the procedures defined in clause 4a.5.7 of 3GPP TS 29.212 [9].\nIf either the AN_GW_CHANGE or the IP-CAN_CHANGE event is subscribed by H-PCRF and this event trigger is received steps 6~9 are executed. Otherwise steps 6~9 are skipped.\n6.\tThe V-PCRF initiates an IP-CAN Session Modification procedure by sending a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2.\n7.\tThe H-PCRF stores the information received in the Diameter CCR.\n8.\tThe H-PCRF decides PCC rules for the PCEF and stores PCC rules.\n9.\tThe H-PCRF sends a Diameter CCA to the V-PCRF to provide the PCC Rules. The H-PCRF sends applicable PCC rules. The H-PCRF includes the AN-GW-Address AVP if the PCC rules are applicable only for a single BBERF. If the PCC rules are applicable for all BBERF sessions this AVP is omitted.\n10.\tIf the steps 6~9 are executed, the V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\nSteps 10a and 10b are executed if the V-PCRF denies authorisation for one or more PCC rules.\n10a. If V-PCRF denies authorization, it informs the H-PCRF by sending a CCR command including the Charging-Rule-Report AVP to indicate the PCC Rules that were not accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL-QoS-VALIDATION, and the acceptable QoS Information for the service.\n10b. The H-PCRF may provide new modified PCC rules to the V-PCRF.\n11. The V-PCRF acknowledges the IP-CAN session modification request by sending a Diameter CCA to the PCEF. The V-PCRF includes updated PCC rules and event triggers (if applicable)\n12. The V-PCRF initiates the Gateway Control Session and QoS rules provisions by sending a Diameter RAR to the BBERF policy decisions and event triggers to the target BBERF.\n13. The BBERF installs the received QoS Rules.\n14. The BBERF acknowledges the Gateway Control and QoS Rules Provision request by sending a Diameter RAA to the V-PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.2.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.2.3",
      "section_id": "4.5.2.3",
      "section_title": "PCEF-Initiated IP-CAN session modification - S2c-based IP flow mobility",
      "content": "The following signalling flow describes an example of S2c-based IP flow mobility. In this case, the H-PCRF receives an IP flow mobility event by the PCEF and derives QoS rules based on the IP flow mobility routing rules.\nFigure 4.5.2.3.1: PCEF-initiated IP-CAN session modification – S2c-based IP flow mobility\n1.\tThe PCEF receives a message or indication that a handover occurred.\n2.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the V-PCRF. The PCEF includes the ROUTING_RULE_CHANGE event trigger to indicate that a change in the IP flow mobility routing rules has occurred. The PCEF includes in the CCR Routing-Rule-Install and/or Routing-Rule-Removal AVPs.\n3.\tThe V-PCRF stores the information received in the Diameter CCR.\n4.\tBased on the information received the V-PCRF determines that there is a change in the IP flow routing in the multiple BBERF(s) as described in clause 4a.5.7 of 3GPP TS 29.212 [9].\nIf either the AN_GW_CHANGE or the IP-CAN_CHANGE event is subscribed by H-PCRF and this event trigger is received steps 5~8 are executed. Otherwise steps 5~8 are skipped.\n5.\tThe V-PCRF initiates an IP-CAN Session Modification procedure by sending a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2.\n6.\tThe H-PCRF stores the information received in the Diameter CCR.\n7.\tThe H-PCRF decides PCC rules for the PCEF and stores PCC rules. Based on the IP flow mobility routing rule as defined in clause 4a.5.7 of 3GPP TS 29.212 [9]\n8.\tThe H-PCRF sends a Diameter CCA to the V-PCRF to provide the PCC Rules. The H-PCRF sends applicable PCC rules.\n9.\tIf the steps 5~8 are executed, the V-PCRF establishes QoS Rules based on received IP flow mobility routing rules and enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\nSteps 9a and 9b are executed if the V-PCRF denies authorisation for one or more PCC rules.\n9a.\tIf V-PCRF denies authorization, it informs the H-PCRF by sending a CCR command including the Charging-Rule-Report AVP to indicate the PCC Rules that were not accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL-QoS-VALIDATION, and the acceptable QoS Information for the service.\n9b.\tThe H-PCRF may provide new modified PCC rules to the V-PCRF.\n10.\tStep 11 through step 14: as specified in Figure 4.5.2.2.1: PCEF-initiated IP-CAN session modification‑ Handover are executed, as needed. If the IP flows were moved from one access to another (e.g. 3GPP to WLAN, or vice versa), the PCRF may also initiate a RAR command towards BBERF#1 to modify or release the related resources associated with the flows that were moved to BBERF#2.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.2.3.1",
        "figure_4.5.2.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.5.2.4",
      "section_id": "4.5.2.4",
      "section_title": "Gateway Control Session Establishment and PCEF IP-CAN session modification – S2c-based IP flow mobility",
      "content": "The following signalling flow describes an example of IP flow mobility. In this case, the V-PCRF receives a Gateway Control session establishment by a BBERF and an IP flow mobility event by the PCEF. V-PCRF associates the IP‑CAN session to multiple Gateway Control Sessions and derives QoS rules based on the IP flow mobility routing rules.\nFigure 4.5.2.4.1: Gateway Control Session Establishment and PCEF IP-CAN session modification – S2c-based IP flow mobility\n1.\tStep 1 through step 10: as specified in Figure 4.4.1.1: Gateway Control Session Establishment are executed, as needed. The Gateway Control Session is established for BBERF #2. The Gateway Control Session for BBERF #1 was previously established.\nNOTE:\tIf the Gateway Control Session is established for WLAN access, only case 2a is possible.\n2.\tThe PCEF receives a message or indication that an IP flow mobility event occurred.\n3.\tThe PCEF initiates an IP-CAN Session Modification procedure by sending a CCR using the CC-Request-Type AVP set to the value UPDATE_REQUEST to the V-PCRF. The PCEF includes the ROUTING_RULE_CHANGE event trigger to indicate that a change in the IP flow mobility routing rules has occurred. The PCEF includes in the CCR Routing-Rule-Install and/or Routing-Rule-Removal AVPs.\n4.\tThe V-PCRF stores the information received in the Diameter CCR.\n5.\tBased on the received information, the V-PCRF does not differentiate between primary and non-primary BBFs and determines that there are IP flows routed through multiple BBERF(s) as described in clause 4a.5.7 of 3GPP TS 29.212 [9].\nIf either the AN_GW_CHANGE or the IP-CAN_CHANGE event is subscribed by H-PCRF and this event trigger is received steps 6~9 are executed. Otherwise steps 6~9 are skipped.\n6.\tThe V-PCRF initiates an IP-CAN Session Modification procedure by sending a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes in the CCR the information received in step 2.\n7.\tThe H-PCRF stores the information received in the Diameter CCR.\n8.\tThe H-PCRF decides PCC rules for the PCEF and stores PCC rules. Based on the IP flow mobility routing rule as defined in clause 4a.5.7 of 3GPP TS 29.212 [9].\n9.\tThe H-PCRF sends a Diameter CCA to the V-PCRF to provide the PCC Rules. The H-PCRF sends applicable PCC rules.\n10. Step 9 through step 10: as specified in Figure 4.5.2.3.1: PCEF-initiated IP‑CAN session modification‑ IPFlow mobility are executed, as needed.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.5.2.4.1",
        "figure_4.4.1.1",
        "figure_4.5.2.3.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.6.1",
      "section_id": "4.6.1",
      "section_title": "TDF Session Establishment in case of solicited reporting",
      "content": "In the following procedure, the PCRF is the H-PCRF for the roaming UE with home routed access and the V-PCRF for the roaming UE with visited access.\nAs part of the IP-CAN Session Establishment or Modification procedure, in case of solicited application reporting with a TDF, the PCRF initiates a TDF Session Establishment with the selected TDF. The TDF is selected based on data received from the PCEF or a local configuration at the PCRF.\nFigure 4.6.1.1: TDF Session Establishment in case of solicited reporting\n1.\tPCRF initiates a session towards the TDF. The PCRF provisions the applicable ADC Rules for the corresponding TDF session by sending a Diameter TS-Request to the TDF, including user identity information, the UE Ipv4 address and/or UE Ipv6 prefix and, if available, PDN identifier, IP-CAN type, RAT type and additional parameters as defined in clause 4b.5.1.1 of 3GPP TS 29.212 [9]. PCRF may also subscribe to the Event Triggers (e.g. APPLICATION_START and APPLICATION_STOP).\nNOTE:\tFor PDN type Ipv4v6, in case the UE Ipv4 address is not available in the PCRF, the PCRF initiates the TDF session establishment providing the UE Ipv6 prefix, and will subsequently provide UE Ipv4 address to the TDF using Event-Report-Indication AVP to the TDF.\n1a.\tThis step applies to the IP-CAN Session Establishment procedure. If online charging is applicable for the TDF, and at least one ADC rule with charging parameters was activated, then the TDF requests credit information from the OCS over the Gyn interface. If the TDF receives credit re-authorisation triggers from the OCS then it requests the PCRF via a TSA message to provision the triggers at the PCEF and/or BBERF. The triggers to be provisioned are specified in the Event-Report-Indication AVP in the TSA message.\n2.\tThe TDF acknowledges the session establishment by sending a Diameter TS-Answer. The TDF may include Event-Report-Indication in the response.\n4.6.1A\tTDF Session Establishment in case of unsolicited reporting\nIn the following procedure, the PCRF is the H-PCRF for the roaming UE with home routed access and the V-PCRF for the roaming UE with visited access.\nWhen the TDF detects for an Ipv4 address or Ipv6 address the first application start, the TDF shall initiate the TDF Session Establishment procedure with the PCRF.\nFigure 4.6.1A.1: TDF Session Establishment in case of unsolicited reporting\n1.\tThe TDF initiates a session by sending a CCR to the PCRF using the CC-Request-Type AVP set to the value INITIAL_REQUEST. The TDF provides the full UE IP address using either Framed-IP-Address AVP or Framed-Ipv6-Prefix AVP and, if available, the PDN identifier. The TDF also includes the TDF-Application-Identifier AVP, the Flow-Information AVP of the detected application when service data flow descriptions are deducible, within the Application-Detection-Information AVP and sets the event trigger value with APPLICATION_START. If Flow-Information AVP is included, the TDF-Application-Instance-Identifier shall also be included within the Application-Detection-Information AVP in order to allow correlation of APPLICATION_START.\n2\tThe PCRF stores the information and acknowledges the session establishment by sending a CCA. The PCRF may include the Ipv6 prefix within the Framed-Ipv6-Prefix AVP if the established TDF session is Ipv6 address related.\nNOTE 1:\tThe TDF handles each Ipv4 address and Ipv6 prefix within a separate TDF session.\nNOTE 2:\tIn the scenario where the TDF performs initial Application Detection on vailabi simultaneous traffic flows for the same Ipv6 prefix (i.e. two or more from Ipv6 addresses of the same IP-CAN session) the TDF could not be aware that those flows belong to the same IP-CAN session until a response is received from the PCRF, containing the Ipv6 prefix. This leads to using separate TDF sessions for the Ipv6 addresses for the same IP-CAN session. The TDF reports new application detection information related to that Ipv6 prefix via any of the TDF sessions at a later stage.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.6.1.1",
        "figure_4.6.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.6.2",
      "section_id": "4.6.2",
      "section_title": "TDF Session termination",
      "content": "In the following procedures, the PCRF is the H-PCRF for the roaming UE with home routed access and the V-PCRF for the roaming UE with visited access.\nThis procedure applies in any of the following cases:\n-\tthe corresponding IP-CAN session is terminated;\n-\tthe Ipv4 address of a dual stack IP-CAN session is released and there is an active Ipv4 address related TDF session for the IP-CAN session (only for unsolicited application reporting);\n-\tat any point of time when the PCRF decides that the session with TDF is to be terminated (e.g. subscriber profile changes).\nFigure 4.6.2.1: TDF Session Termination\n1.\tThe PCRF sends a RAR including the Session-Release-Cause AVP to request that the TDF terminates the TDF session.\n2.\tFor the solicited application reporting, the TDF removes/deactivates all the ADC Rules which are applied to the TDF session.\n3.\tThe TDF sends a RAA to acknowledge the RAR.\n4.\tThe TDF sends a CCR to the PCRF, indicating the TDF Session termination. The TDF requests the termination of the Sd session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST. For solicited application reporting, if the usage monitoring is enabled, the TDF informs the PCRF about the resources that have been consumed by the user since the last report in the same request.\n5.\tThe PCRF acknowledges the TDF session termination by sending a CCA to the TDF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.6.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.6.3.1",
      "section_id": "4.6.3.1",
      "section_title": "Application Detection, Reporting and Control Rules Request",
      "content": "In the following procedure, the PCRF is the H-PCRF for the roaming UE with home routed access and the V-PCRF for the roaming UE with visited access.\nFigure 4.6.3.1.1 Application Detection, Reporting and Control Rules Request\n1.\tTDF is triggered to report an event(s) (e.g. The TDF detects the start/stop of an application traffic that matches with one or more activated ADC rules that do not contain the Mute-Notification AVP) for a TDF session. For the start of traffic detection, in case the enforcement actions were provided as a part of ADC rules, the TDF enforces corresponding actions for solicited application reporting.\n2.\tThe TDF sends a Diameter CCR to the PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report an event. For the start of traffic detection, if PCRF has previously subscribed to the APPLICATION_START/APPLICATION_STOP Event-Triggers, the TDF includes TDF-Application-Identifier AVP, the Flow-Information AVP of the detected application when service data flow descriptions are deducible, within the Application-Detection-Information AVP and sets the event trigger value with APPLICATION_START. If Flow-Information AVP is included, the TDF-Application-Instance-Identifier shall also be included within the Application-Detection-Information AVP in order to allow correlation of APPLICATION_START. For the stop of traffic detection, if PCRF has previously subscribed to the APPLICATION_START/APPLICATION_STOP Event-Triggers, the TDF includes TDF-Application-Identifier AVP, the TDF-Application-Instance-Identifier AVP, if provided in the report of the start of application traffic detection within the Application-Detection-Information AVP and sets the event trigger value with APPLICATION_STOP. For the solicited application reporting, if usage monitoring is enabled and the usage threshold is reached or the PCRF removes the last ADC rule applicable for certain monitoring key or disables usage monitoring or requests usage report, the TDF may inform the PCRF about the corresponding usage that have been consumed by the user since the last report.\n3.\tThe PCRF stores the information, received in the Diameter CCR and makes the PCC/QoS and – in the solicited reporting case – ADC decisions.\n4.\tThe PCRF acknowledges to the TDF by sending a Diameter CCA. For the solicited application reporting, the PCRF may provide a new ADC decisions by including the ADC-Rule-Install AVP and/or ADC-Rule-Remove AVP to the TDF within this acknowledge.\n5.\tFor the solicited application reporting, the TDF installs, modifies and removes the ADC rules according the new ADC decisions provided in step 4.\nNOTE:\tIf the installation or modification of one or more ADC rules fails, the TDF reports the failure to the PCRF as defined in clause 4b.5.5 of 3GPP TS 29.212 [9].",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.6.3.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.6.3.2",
      "section_id": "4.6.3.2",
      "section_title": "Application Detection and Control Rules Provision",
      "content": "In the following procedure, the PCRF is the H-PCRF for the roaming UE with home routed access and the V-PCRF for the roaming UE with visited access. This procedure is applicable only for the solicited application reporting.\nFigure 4.6.3.2.1 Application Detection and Control Rules Provision\n1.\tThe PCRF receives an internal or external trigger (e.g. the subscriber’s profile configuration is changed) to update the ADC rule or notify the event occurred at the PCEF/BBERF for a TDF session.\n2.\tThe PCRF sends a Diameter RAR to provide a new ADC decision by including the ADC-Rule-Install AVP and/or ADC-Rule-Remove AVP or notify the event occurred at the PCEF/BBERF by including the Event-Report-Indication AVP.\n3.\tThe TDF stores the information, received in the Diameter RAR. The TDF installs, modifies and removes the ADC rules according the new ADC decisions provided in step 2.\n4.\tThe TDF acknowledges to the PCRF by sending a Diameter RAA to inform the PCRF about the outcome of the actions related to the decision(s).",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.6.3.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.7.1",
      "section_id": "4.7.1",
      "section_title": "Initial Spending Limit Report Request",
      "content": "In the following procedure, the signalling flow for the H-PCRF to request the status of the policy counters available at the OCS, and to subscribe to updates of these policy counters by the OCS. If the H-PCRF provides the list of policy counter identifier(s), the OCS returns the policy counter status per policy counter identifier provided by the PCRF. If the H-PCRF does not provide the list of policy counter identifier(s), the OCS returns the policy counter status for all policy counter identifier(s), which are available for this subscriber.\nFigure 4.7.1: Initial Spending Limit Report Request\n1.\tThe H-PCRF retrieves subscription information that indicates that policy decisions depend on policy counter(s) held at the OCS and optionally the list of policy counter identifier(s).\n2.\tThe H-PCRF sends a Diameter SLR command if no Sy session yet has been established for this subscriber. The Diameter SLR command includes the Subscription-Id AVP (e.g. IMSI) and optionally the list of policy counter identifier(s) within Policy-Counter-Identifier AVPs. The request also includes the SL-Request-Type AVP which set to the value INITIAL_REQUEST (0).\n3.\tThe OCS sends a Diameter SLA command to the PCRF. The Diameter SLA includes a Policy-Counter-Status-Report AVP for each requested policy counter identifier containing the policy counter identifier and the current status value, optionally pending policy counter statuses with the activation times, and Result-Code AVP contains the result of the operation. When no policy counter identifier(s) was provided, the Diameter SLA includes a Policy-Counter-Status-Report AVP for all policy counter identifiers applicable to the subscriber. The OCS stores the H-PCRF’s subscription to changes in the status of all policy counter identifiers provided to the H-PCRF in the Diameter SLA.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.7.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.7.2",
      "section_id": "4.7.2",
      "section_title": "Intermediate Spending Limit Report Request",
      "content": "This clause describes the signalling flow for the H-PCRF to request the status of additional policy counters available at the OCS or to remove the request for the status of policy counters available at OCS. If the H-PCRF provides the list of policy counter identifier(s), the OCS returns the policy counter status per policy counter identifier provided by the PCRF.\nFigure 4.7.2: Intermediate Spending Limit Report Request\n1.\tThe H-PCRF decides to modify the list of subscribed policy counters, e.g. PCRF determines that policy decisions depend on additional policy counter identifier(s) held at the OCS or that notifications of policy counter status changes for some policy counters are no longer required.\n2.\tThe H-PCRF sends a Diameter SLR command, optionally including the list of policy counter identifier(s) within Policy-Counter-Identifier(s) AVPs. The request also includes the SL-Request-Type AVP which set to the value INTERMEDIATE_REQUEST (1).\n3.\tThe OCS sends the Diameter SLA command to the PCRF including Policy-Counter-Status-Report AVP(s) containing the policy counter identifier, the current status value and optionally pending policy counter statuses with the activation times. Result-Code contains the result of the operation is also included in the response.\n4.\tThe PCRF makes the policy decision based on the information provided by the OCS.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.7.2"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.7.3",
      "section_id": "4.7.3",
      "section_title": "Final Spending Limit Report Request",
      "content": "This clause describes the signalling flow for the H-PCRF to unsubscribe to any future updates of policy counters for a given subscriber by the OCS. It cancels the request for reporting the change of the status of the policy counters available at the OCS.\nFigure 4.7.3: Final Spending Limit Report Request\n1.\tThe PCRF decides that policy decisions for a given user no longer depend on policy counter(s) to which the PCRF has existing subscriptions for status change notification.\n2.\tThe H-PCRF sends the Diameter STR command to the OCS to cancel the notification request from the OCS on policy counter status. The request includes the Termination-Cause which contains the reason why the session was terminated set to “DIAMETER_LOGOUT”.\n3.\tThe OCS sends the Diameter STA command to the H-PCRF with Result-Code contains the result of the operation.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.7.3"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.7.4",
      "section_id": "4.7.4",
      "section_title": "Spending Limit Report",
      "content": "This clause describes the signalling flow for the OCS to notify the changes of the status of a subscribed policy counter(s) available at the OCS for that subscriber. Alternatively, the signalling flow can be re-used by the OCS to provide one or more pending statuses for a subscribed policy counter together with the time that have to be applied.\nFigure 4.7.4: Spending Limit Report\n1.\tThe OCS detects that status of a policy counter identifier(s) has changed and the PCRF requested notification of changes in the status of a policy counter(s). Alternatively, if the OCS detects a policy counter status will change at a future point in time, the OCS shall be able to instruct the PCRF to apply one or more pending statuses for a requested policy counter.\n2.\tWhen the status of a specific policy counter changes, or the OCS detects that a policy counter status will change at a future point in time and decides to instruct the PCRF to apply one or more pending statuses for a requested policy counter, the OCS shall determine the Sy sessions impacted by the change (i.e. those Sy sessions that have subscribed to status change notifications for the changed policy counter) and send the Diameter SNR command to the PCRF associated with each affected Sy session including one Policy-Counter-Status-Report AVP. If several counters change status at the same time, the OCS may group the status change notifications into a single Spending Limit Report request to the PCRF by sending multiple Policy-Counter-Status-Report AVPs in the request.\nNOTE:\tSy session is per UE. And more than one Sy session will exist when the UE has IP-CAN session connection with more than one PCRF.\n3.\tThe H-PCRF acknowledges the request by sending a Diameter SNA command with a Result-Code AVP set to DIAMETER_SUCCESS and use the status of the received policy counter(s) as input to its policy decision to apply operator defined actions, e.g. downgrade the QoS. The PCRF shall ignore an unknown policy counter status report for all unknown policy counter identifiers in the SNR from the OCS.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.7.4"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.8.1",
      "section_id": "4.8.1",
      "section_title": "General",
      "content": "The call flows for User Plane Congestion Management (UPCON) over Np reference point are specified as follows:\n-\tRAN User Plane Congestion Information (RUCI) reporting, in which non-aggregated RUCI reporting and aggregated RUCI reporting are included.\n-\tReporting restriction provisioning\n-\tUE mobility between RAN Congestion Awareness Functions (RCAFs)\n-\tRemoval of UE context",
      "chunk_type": "definition",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_4.8.2.1",
      "section_id": "4.8.2.1",
      "section_title": "Non-aggregated RUCI report procedure",
      "content": "Figure 4.8.2.1.1: Non-aggregated RUCI reporting\n1.\tThe RCAF sends a diameter NR-Request command to the PCRF, including the user id, PDN ID, the congestion level info and additional parameters as defined in clause 4.4.1.2 of 3GPP TS 29.217 [36].\n2.\tThe PCRF stores the related information and acknowledges the RUCI reporting by sending a Diameter NR-Answer including the PCRF id.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.217_clause_4.4.1.2",
        "figure_4.8.2.1.1",
        "ts_29.217"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.8.2.2",
      "section_id": "4.8.2.2",
      "section_title": "Aggregated RUCI report procedure",
      "content": "Figure 4.8.2.2.1: Aggregated RUCI reporting\n1.\tThe RCAF sends a Diameter AR-Request command to the PCRF, including one or more Aggregated-RUCI-Report AVP and additional parameters as defined in clause 4.4.1.3 of 3GPP TS 29.217 [36]. The PCRF is the common destination PCRF for a set of user id and PDN ID and identified by the PCRF id returned in the previous non-aggregating RUCI reporting.\n2.\tThe PCRF stores the related information and acknowledges the RUCI reporting by sending a Diameter AR-Answer back to the RCAF.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.217_clause_4.4.1.3",
        "figure_4.8.2.2.1",
        "ts_29.217"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.8.3",
      "section_id": "4.8.3",
      "section_title": "Np reporting restriction provisioning",
      "content": "The Np reporting restriction provisioning is used by the PCRF to stop RUCI reporting for a specific user id and PDN ID. It is also used by the PCRF to specify, modify or disable restrictions for RUCI reporting.\nFigure 4.8.3.1: Np reporting restriction provisioning\n1.\tThe PCRF sends a Diameter MUR command to the RCAF for the provisioning of RUCI reporting restriction including the parameters as defined in clause 4.4.2 of 3GPP TS 29.217 [36].\n2.\tThe RCAF responds a Diameter MUA command to the PCRF including the parameters as defined in clause 4.4.2 of 3GPP TS 29.217 [36].",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.217_clause_4.4.2",
        "figure_4.8.3.1",
        "ts_29.217"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.8.4",
      "section_id": "4.8.4",
      "section_title": "UE mobility between RCAFs",
      "content": "This signalling flow describes the mobility handling of a UE from one RCAF to another RCAF. The UE is affected by congestion for both RCAFs.\nFigure 4.8.4.1: UE mobility from RCAF1 to RCAF2 (the UE is affected by congestion at RCAF2 after the UE was earlier affected by congestion at RCAF1)\n1.\tThe UE is located in the RCAF1 which is affected by congestion. The RCAF1 sends a Diameter NRR command to the PCRF for reporting RUCI including the parameters as defined in clause 4.4.1.2 of 3GPP TS 29.217 [36].\n2.\tThe PCRF stores the identity of RCAF1 for the given UE and responds a Diameter NRA command to the RCAF1 including the parameters as defined in clause 4.4.1.2 of 3GPP TS 29.217 [36].\n3.\tThe UE moves to the RCAF2 which is also affected by congestion. The RCAF2 sends a Diameter NRR command to the PCRF for reporting RUCI of the same UE including the parameters as defined in clause 4.4.1.2 of 3GPP TS 29.217 [36].\n4.\tThe PCRF stores the identity of RCAF2 for the given UE and responds a Diameter NRA command to the RCAF2 including the parameters as defined in clause 4.4.1.2 of 3GPP TS 29.217 [36].\n5.\tThe PCRF initiates a removal of the UE context to RCAF1 to release the context of the given user id and PDN ID, including the parameters as defined in clause 4.4.4 of 3GPP TS 29.217 [36].",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.217_clause_4.4.1.2",
        "ts_29.217_clause_4.4.4",
        "figure_4.8.4.1",
        "ts_29.217"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.8.5",
      "section_id": "4.8.5",
      "section_title": "Removal of UE context",
      "content": "This signalling flow describes the removal of a UE context from the RCAF.\nFigure 4.8.5.1: UE context removal in RCAF\n1.\tThe PCRF sends a Diameter MUR command to the RCAF to release the context of the given user id and PDN ID, including the parameters as defined in clause 4.4.4 of 3GPP TS 29.217 [36].\n2.\tThe RCAF responds with a Diameter MUA command to the PCRF including the parameters as defined in clause 4.4.4 of 3GPP TS 29.217 [36]. The RCAF releases the context corresponding to the given user id and PDN ID, including any reporting restriction.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.217_clause_4.4.4",
        "figure_4.8.5.1",
        "ts_29.217"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.9.1",
      "section_id": "4.9.1",
      "section_title": "St Session Establishment",
      "content": "In the following procedure, the PCRF initiates the St session establishment procedure and provides the traffic steering control informaiton to the TSSF due to the PCRF determines that the traffic steering control is needed for the IP-CAN session.\nFigure 4.9.1.1: St Session Establishment\n1.\tThe PCRF initiates session between the PCRF and TSSF and provisions the applicable ADC Rules for the corresponding IP-CAN session by sending a Diameter TSR to the TSSF, including the Request-Type AVP set to the value \"0\" and other parameters as defined in subclause 4c.4.1 of 3GPP TS 29.212 [9].\n2.\tThe TSSF installs and/or activates the ADC rules and acknowledges to the PCRF by sending a Diameter TSA command.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.9.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.9.2",
      "section_id": "4.9.2",
      "section_title": "St Session Modification",
      "content": "In the following procedure, the PCRF updates the traffic steering control informaiton at the TSSF due to the PCRF determines that the traffic steering control information needs to be update for the IP-CAN session (e.g. Subscription is changed) or notifies the TSSF that the IPv4 address is allocated/released.\nFigure 4.9.2.1: St Session Modification\n1.\tThe PCRF provisions the new, updated and/or requests to remove ADC rules for the corresponding IP-CAN session or notifies the TSSF that the IPv4 address is allocated/released by sending a Diameter TSR command to the TSSF, including the Request-Type AVP set to the value \"1\" and other parameters as defined in subclause 4c.4.1 or 4c.4.4 of 3GPP TS 29.212 [9].\n2.\tThe TSSF installs, modifies and/or removes the ADC rules or activates and/or deactivates the ADC rules and acknowledges to the PCRF by sending a Diameter TSA commands.",
      "chunk_type": "general",
      "cross_references": [
        "clause_4",
        "figure_4.9.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.9.3",
      "section_id": "4.9.3",
      "section_title": "St Session Termination",
      "content": "In the following procedure, the the PCRF initiates the St session termination procedure and removes all the traffic steering control informaiton to the TSSF due to the corresponding IP-CAN session is terminated or the H-PCRF determines that the traffic steering control information is not needed for the IP-CAN session any longer (e.g. Subscription has changed).\nFigure 4.9.3.1: St Session Termination\n1.\tThe PCRF sends an STR to the TSSF to terminate the session between the PCRF and the TSSF.\n2.\tThe TSSF removes/deactivates all the ADC Rules which are applied to the session.\n3.\tThe TSSF sends an STA to acknowledge the STR.",
      "chunk_type": "general",
      "cross_references": [
        "figure_4.9.3.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.9.4",
      "section_id": "4.9.4",
      "section_title": "St notification initiated by the TSSF",
      "content": "In the following procedure, the TSSF reports the ADC rule error when the ADC rule can’t be enforced any longer.\nFigure 4.9.4.1: St notification initiated by the TSSF\n1.\tThe TSSF reports the ADC rules error by sending a Diameter TNR command to the PCRF as defined in subclause 4c.4.3 of 3GPP TS 29.212 [9].\n2.\tThe PCRF acknowledges to the TSSF by sending a Diameter TNA command.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4",
        "figure_4.9.4.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_4.10",
      "section_id": "4.10",
      "section_title": "Negotiation for future background data transfer procedure over Nt reference point",
      "content": "The following procedure shows the signaling flow for the SCEF to request the transfer policy for future background data transfer determined by the H-PCRF.\nFigure 4.10.1: Negotiation for future background data transfer\n1.\tBased on the SCS/AS request, the SCEF sends a Diameter BTR command to the H-PCRF for the request of  transfer policy including the parameters as defined in subclause 4.4.1 of 3GPP TS 29.154 [56].\n2.\tThe H-PCRF determines one or more transfer policies based on the information received from the SCEF and other available information (e.g. network policy, existing transfer policies).\n3.\tThe H-PCRF sents a Diameter BTA command to the SCEF including the parameters as defined in subclause 4.4.1 of 3GPP TS 29.154 [56].\n4.\tIf there is more than one transfer policy provided from the H-PCRF to the SCEF in the BTA command, when the SCEF receives the selected transfer policy from the SCS/AS, the SCEF sends a Diameter BTR command to the H-PCRF with the selected transfer policy.\n5.\tThe H-PCRF acknowledges the BTR command by sending BTA command.",
      "chunk_type": "procedure",
      "cross_references": [
        "ts_29.154_clause_4.4.1",
        "figure_4.10.1",
        "ts_29.154"
      ]
    },
    {
      "chunk_id": "ts_29.213_5.1",
      "section_id": "5.1",
      "section_title": "Overview",
      "content": "The binding mechanism associates the session information with the IP-CAN bearer that is intended to carry the service data flow.\nFor PCC rules with application identifier, and for certain IP-CAN types, up-link traffic can be received on other/additional IP-CAN bearers than the one determined by the binding mechanism (further details provided in clause 6.2.2.2 and the IP-CAN specific annexes of 3GPP TS 23.203 [2]).\nThe binding mechanism includes three steps as defined in 3GPP TS 23.203 [2]:\n1.\tSession binding.\n2.\tPCC Rule authorization and QoS Rule generation.\n3.\tBearer binding.\nThe Session Binding function receives the Session Information and determines the relevant IP-CAN session. With this information the PCC Rule Authorization and QoS Rule generation function runs the policy rules and constructs the PCC rule(s) and if applicable, the QoS rule(s) if the authorization is granted. Finally the Bearer Binding function selects the IP-CAN bearer where the PCC rule(s) or QoS rule(s) should be installed within the IP-CAN session already known.\nPCC Rule Authorization and QoS Rule generation function and Bearer Binding function can take place without Session Binding at certain IP-CAN Session events (e.g. IP-CAN Session Establishment).",
      "chunk_type": "definition",
      "cross_references": [
        "clause_6.2.2.2",
        "ts_23.203"
      ]
    },
    {
      "chunk_id": "ts_29.213_5.2",
      "section_id": "5.2",
      "section_title": "Session Binding",
      "content": "Session binding is the association of the AF session information to an IP-CAN session.\nWhen the PCRF accepts an AA-Request from the AF over the Rx interface with service information, the PCRF shall perform session binding and associate the described service IP flows within the AF session information (and therefore the applicable PCC rules) to one and only one existing IP-CAN session. When the PCRF receives an AA-Request from the P-CSCF acting as an AF over the Rx interface for P-CSCF Restoration, the PCRF shall perform session binding and associate the request to the existing IMS PDN connection and perform P-CSCF Restoration for that impacted IMS PDN connection. This association is done comparing the user IP address received via the Rx interface in either the Frame-IP-Address AVP or the Framed-Ipv6-Prefix AVP with the Ipv4 address or Ipv6 prefix received via the Gx interface. The UE Identity if present in the Subscription-Id AVP and the PDN information if available in the Called-Station-Id AVP may also assist on this association. The Domain identity if available in the IP-Domain-Id AVP may also assist on this association, e.g. if other user identity information than the UE IP address is unavailable and the UE IP addresses is not unique for a certain APN.\nNOTE 1:\tThe UE IP address is unique per Domain identity.\nNOTE 2:\tThe IP-Domain-Id AVP is helpful in the following scenario: Within a PLMN, there are several separate IP address domains, with PCEF(s) that allocate Ipv4 IP addresses out of the same private address range to Ues. The same IP address can thus be allocated to Ues served by PCEFs in different address domains. If one PCRF controls several PCEFs in different IP address domains, the UE IP address is thus not sufficient for the session binding. An AF can serve Ues in different IP address domains, either by having direct IP interfaces to those domains, or by having interconnections via NATs in the user plane between PCEFs and the AF. If a NAT is used, the AF obtains the IP address allocated to the UE via application level signalling and supplies it for the session binding as Framed-IP-Address to the PCRF. The AF supplies an IP-Domain-Id value denoting the IP address domain behind the NAT in addition. The AF can derive the appropriate value from the source address (allocated by the NAT) of incoming user plane packets.\nNOTE 3：When the scenario described in NOTE 2 applies and the AF is a P-CSCF it is assumed that the P-CSCF has direct IP interfaces to the different IP address domains and that no NAT is located between P-GW and P-CSCF. How a non-IMS AF obtains the UE private IP address to be provided to the PCRF is out of scope of the present release; it is unspecified how to support applications that use a protocol that does not retain the original UE’s private IP address.\nIf the Domain identity is not used to assist association, the PCRF will determine that the UE has an IP-CAN session if the IP address (Ipv4 or Ipv6) received over the Rx interface matches the Ipv4 address or Ipv6 prefix received via one or more of the following interfaces: Gx interface and S9 interface, and if the UE identity is used to assist the association, the UE identity received over the Rx interface matches the UE identity received via one or more of the following interfaces: Gx interface and S9 interface.\nIf the Domain identity is used to assist association, the PCRF will determine that the UE has an IP-CAN session if the Domain identity received over the Rx interface matches the PCEF Identity received via the Gx interface, and the IP address (Ipv4) received over the Rx interface matches the Ipv4 address received via the Gx interface.\nFor the roaming scenario, the Domain identity may be used for session binding when the AF and PCEF are located in same PLMN, i.e. for the home routed case, the Domain identity may be used by the (H-)PCRF for session binding, and for the visited case, Domain identity could be used by the V-PCRF for session binding.\nFor an IP-CAN session associated to a dedicated APN for the purpose of offering services to remote UEs via a ProSe UE-to-network relay UE, the PCRF shall use the UE IPv6 prefix alone in the session binding.\nNOTE 4:\tIn case the UE identity in the IP-CAN and the application level identity for the user are of different kinds, the PCRF needs to maintain, or have access to, the mapping between the identities. Such mapping is not subject to specification within this TS.\nNOTE 5:\tAn Ipv6 address provided over Rx matches an Ipv6 prefix provided over Gx or S9 if the Ipv6 address belongs to the Ipv6 (sub-)network prefix.\nNOTE 6:\tThe PCRF derives the PCEF identity from the Origin-Host AVP of the CCR command received from the PCEF. In order to correlate the PCEF Identity and the domain identity received over the Rx interface, the PCRF uses configured mapping between those identities. The Domain Identity is useful for assistance in session binding if the Origin-Host of the Gx CCR command is not modified by intermediate Diameter proxies deployed between the PCEF and the PCRF.\nNOTE 7:\tThe PCEF identity is not transported over S9 reference point in the present release. So for the visited access with AF located in HPLMN case, session binding assisted with Domain identity is not supported in the present release. Session binding is still possible based on other available information in addition to the IP address when provided by the AF, according to the current procedures.\nIf the PCRF uses the Called-Station-Id AVP to assist the association, the PCRF shall apply the procedures in Annex I to match APN information.\nAs a result from the session binding function, the PCRF identifies what IP-CAN session the current AF session is related with. If the PCRF is not capable of executing the Session Binding, the PCRF shall issue an AA-Answer command to the AF with a negative response.",
      "chunk_type": "requirement",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_5.3",
      "section_id": "5.3",
      "section_title": "PCC Rule Authorization and QoS Rule Generation",
      "content": "The PCRF shall perform the PCC rule authorization and QoS rule generation when the PCRF receives session information from an AF over Rx interface, when the PCRF receives notification of IP-CAN session events (e.g. establishment, modification) from the PCEF over Gx or S9 interface, when the PCRF receives IP-CAN events from the BBERF over Gxa/Gxc interface, or the PCRF receives a notification from the SPR that calls for a policy decision. The PCRF shall also perform PCC Rule Authorization and QoS Rule generation for dynamic PCC Rules already provisioned to the PCEF and dynamic QoS rules already provisioned to the BBERF due to internal PCRF triggers (e.g. policies are included or modified within PCRF).\nIf the PCRF receives any traffic mapping information from the BBF that does not match any service data flow filter, the PCRF shall also perform PCC and/or QoS rule authorization when the UE’s subscriber profile allows subscription based authorization. In this case, the PCRF shall treat the received traffic mapping information as if it is service data flow filter information.\nIf the PCRF receives from the AF a reference ID together with the AF session information, the PCRF may provide it to the SPR in order to retrieve the corresponding transfer policy. The PCRF shall derive the PCC rules for the background data transfer according to the retrieved transfer policy.\nNOTE 1:\tA transfer policy is only valid within its time window. The removal of outdated transfer policies from the SPR is up to implementation.\nIf the PCRF receives information from the SPR for the invocation/revocation of a Priority EPS Bearer service (i.e. the MPS EPS Priority is set/removed or the MPS Priority Level changes while the MPS EPS Priority is set) , then the PCRF should change the QCI/ARP of the dynamic PCC/QoS rules that have the same QCI/ARP as for the present default EPS bearer with the new QCI/ARP assigned to the default EPS bearer unless those PCC rules contain an indication that they have to be bound to the default EPS bearer. If there are active non-MPS services, the QCI/ARP of the PCC/QoS rules related to the non-MPS services shall also be changed.\nIf the PCRF receives a request from the AF for the invocation/revocation of MPS for DTS (i.e., the MPS-Action AVP is set to enabled or to disabled, see 3GPP TS 29.214 [10]), then the PCRF shall behave according to clause 4.5.19.1 of  3GPP TS 29.212 [9].\nIf the PCRF receives information from the SPR that invokes/revokes the IMS Signalling Priority or changes the MPS Priority Level while IMS Signaling Priority is enabled, then the PCRF should\n-\tchange the ARP of the dynamic PCC/QoS rules applicable to the IM CN signalling\n-\treplace the predefined PCC rules applicable to the IM CN signalling by predefined rules that apply when the IMS Signalling Priority is set according to operator policies\nWhen IMS Signalling Priority is set, the PCRF should keep the ARP assigned to the default EPS bearer higher than the ARP related to the IM CN signalling bearer.\nNOTE 2.\tIMS Signalling Priority only applies to an APN enabled for IMS.\nThe PCRF assigns appropriate QoS parameters (QCI, ARP, GBR, MBR, etc.) to each PCC or QoS rule. The PCRF takes the information received over Rx into account for determining the appropriate QCI/ARP. If the Rx authorization indicates IMS Multimedia Priority Service, then the PCRF shall allow the prioritization of the MPS session according to clauses 4.5.19.1.3 and 4a.5.14.1.3 in 3GPP TS 29.212 [9] for Gx/Gxx respectively. If the Rx authorization indicates Group Communication Service prioritization as described in 3GPP TS 23.468 [34], then the PCRF shall allow the prioritization of the Group Communication session according to clause 4.5.19 in 3GPP TS 29.212 [9].\nThe PCRF authorizes the affected PCC rules and /or QoS rules after successful Session Binding. By the authorization process the PCRF will determine whether the user can have access to the requested services and under what constraints. If so, the PCC rules and QoS rules are created or modified. If the Session Information is not authorized, a negative answer shall be issued to the AF by sending an AA-Answer command.\nThe PCRF assigns an appropriate QCI to each PCC or QoS rule. IP-CAN specific restrictions and other information available to the PCRF (e.g. users subscription information, operator policies) shall be taken into account. Each PCC or QoS rule shall receive a QCI that can be supported by the IP-CAN. The PCRF shall ensure consistency between the QoS rules and PCC rules authorized for the same service data flow when QoS rules are derived from corresponding PCC rules.\nIf PrioritySharing feature is supported over Rx reference point as described in 3GPP TS 29.214 [10], the PCRF shall apply the priority sharing procedures as described in 3GPP TS 29.212 [9], subclauses 4.5.27 and 4a.5.17, if applicable.\nIn roaming scenarios, the V-PCRF may further authorize the rules received from the H-PCRF based on local operator policy. Depending on the local policy, the V-PCRF may change the authorized QoS for the affected rules. If local authorization of the rules fails, the V-PCRF shall issue a negative answer to the H-PCRF.",
      "chunk_type": "requirement",
      "cross_references": [
        "ts_29.212_clause_4.5.19.1",
        "ts_29.212_clause_4.5.19",
        "ts_29.214",
        "ts_29.212",
        "ts_23.468"
      ]
    },
    {
      "chunk_id": "ts_29.213_5.4",
      "section_id": "5.4",
      "section_title": "Bearer Binding",
      "content": "The Bearer Binding function is responsible for associating a PCC rule and QoS rule (if applicable) to an IP-CAN bearer within the IP-CAN session. The QoS demand in the rule, as well as the service data flow template, is input to the bearer binding. The selected bearer shall have the same QCI and ARP as the one indicated by the PCC or QoS rule.\nWhen Rule-Bound-to-Default-Bearer feature is supported as described in 3GPP TS 29.212 [9], the value included within the Default-Bearer-Indication AVP shall be used as input for the bearer binding instead of the QoS demand in the rule.\nNOTE 1:\tThe PCRF provides the appropriate ARP/QCI for both PCC Rules and default bearer QoS so that the PCEF can perform a valid bearer binding. Alternatively, when Rule-Bound-to-Default-Bearer feature is supported, the PCRF can provide the Default-Bearer-Indication AVP within the PCC Rules to indicate that these PCC Rules have to be bound to the default bearer regardless of the provisioned ARP/QCI.\nThe Bearer Binding Function (BBF) is located either at the BBERF or at the PCEF.\nThe PCRF shall supply the PCC rules to be installed, modified or removed over Gx interface to PCEF. If there are gateway controls sessions associated with the Gx session, the PCRF shall also supply the QoS rules to be installed, modified, or removed over Gxa/Gxc interface to the BBERF.\nWhen Rule-Bound-to-Default-Bearer feature is supported, the BBF located at the PCEF shall bind to the default bearer the PCC rules that have indicated so.\nFor the rules that do not contain an indication that they have to be bound to the default bearer, the BBF shall then check the QoS class identifier and ARP indicated by the rule and bind the rule with an IP-CAN bearer that has the same QoS class identifier and ARP. The BBF shall evaluate whether it is possible to use one of the existing IP-CAN bearers or not and, if applicable, whether to initiate IP-CAN bearer modification or not. If none of the existing bearers are possible to use, the BBF should initiate the establishment of a suitable IP-CAN bearer. The BBF should not bind rules with the PS to CS session continuity indicator to the same bearer as the rules without the PS to CS session continuity indicator.\nNOTE 2:\tFor an IP-CAN, limited to a single IP-CAN bearer per IP-CAN session, the bearer is implicit, so finding the IP-CAN session is sufficient for successful bearer binding.\nNOTE 3:\tThe handling of a rule with MBR>GBR is up to operator policy (e.g. an independent IP-CAN bearer may be maintained for that SDF to prevent unfairness between competing SDFs).\nNOTE 4:\tThe QCI and ARP (including the Priority-Level, Pre-emption-Capability and Pre-emption-Vulnerability) are used for the bearer binding. Depending on operator policy, only the QCI and ARP Priority-Level can be used for bearer binding. In such a case, it is left to operator policy to determine whether different PCC rules with the same QCI and ARP Priority-Level but different Pre-emption-Capability and Pre-emption-Vulnerability can be bound to the same bearer.\nFor an IP-CAN, where the BBF gains no information on what IP-CAN bearer the UE selects to send an uplink IP flow on, the binding mechanism shall assume that, for bi-directional service data flows, both downlink and uplink packets travel on the same IP-CAN bearer.\nWhenever the service data flow template, the QoS authorization of a PCC/QoS rule or the negotiated traffic mapping information change, the existing bearer bindings shall be re-evaluated. The re-evaluation may, for a service data flow, require a new binding with another IP-CAN bearer. The BBF should, if the PCRF requests the same change to the ARP/QCI for all PCC/QoS Rules bound to the same bearer, modify the bearer ARP/QCI as requested.\nNOTE 5:\tA QoS change of the default EPS bearer causes the bearer binding for PCC/QoS rules previously bound to the default EPS bearer to be re-evaluated.\nDuring PCC/QoS rules enforcement, if packet filters are provided to the UE, the BBF shall provide packet filters with the same content as that in the SDF template filters received over the Gx/Gxx interface from the PCRF within the Flow-Description or the Flow-Information AVP. The representation/format of the packet filters provided by the network to the UE is access-system dependent and may vary between accesses and also may be different from that of the SDF template filter on the Gx/Gxx interface. The PCRF may control the provisioning of packet filters to the UE, i.e. which filters are required to be sent to the UE, as described in 3GPP TS 29.212 [9].\nIf PCC rule(s) with application identifier(s) are the only PCC rule(s) that are bound to a bearer which requires traffic mapping information, the PCEF shall derive traffic mapping information based on implementation specific logic (e.g. traffic mapping information that effectively disallows any useful packet flows in uplink direction as described in clause 15.3.3.4 of 3GPP TS 23.060 [3]) and provides it to the UE.\nNOTE 6:\tFor GPRS and EPS, the state of TFT packet filters, as defined in 3GPP TS 23.060 [3], for an IP-CAN session requires that there is at most one bearer with no TFT packet filter for the uplink direction.\nRequirements specific for each type of IP-CAN are defined in the IP-CAN specific Annex. The Bearer Binding Function may also be located in the PCRF (e.g. as specified in Annex D for GPRS running UE only IP-CAN bearer establishment mode). Selection of the Bearer Binding location shall be based on the Bearer Control Mode selected by the PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "ts_23.060_clause_15.3.3.4",
        "ts_29.212",
        "ts_23.060"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.1",
      "section_id": "6.1",
      "section_title": "Overview",
      "content": "Several QoS parameters mapping functions are needed during PCC interaction. These functions are located at the AF, PCRF, PCEF and UE. The main purpose of these mapping functions is the conversion of QoS parameters from one format to another. Examples of QoS information are:\n-\tParts of a session description language (SDI), e.g. SDP, MPD.\n-\tIP QoS parameters.\n-\tAccess specific QoS parameters.\nOne QoS mapping function is located at the AF, which maps the application specific information into the appropriate AVPs that are carried over the Rx interface. The AF derives information about the service from the SDI or from other sources. The mapping is application specific. If SDP (IETF RFC 2327 [11]) is used as SDI, the AF should apply the mapping described in clause 6.2. If MPD (3GPP TS 26.247 [30]) is used, the AF may apply the mapping described in Annex X in 3GPP TS 26.247 [30]. For IMS, the mapping rules in clause 6.2 shall be used at the P-CSCF. The AF passes service information to the PCRF over the Rx interface. Subclause 6.2 specifies the QoS parameter mapping functions at the AF applicable for all IMS P-CSCFs regardless of the access technology.\nOne QoS mapping function is located at the PCRF, which maps the service information received over the Rx interface into IP QoS parameters (e.g. QCI, GBR, MBR, ARP, …). This mapping is access independent. Subclause 6.3 specifies the QoS mapping functions at the PCRF applicable for all accesses.\nThe other mapping functions located at PCEF, BBERF, and UE are implementation dependent and are not specified within this specification except for GPRS case.\nThe PCRF notes and authorizes the IP flows described within this service information by mapping from service information to Authorized IP QoS parameters for transfer to the PCEF/BBERF via the Gx/Gxx interface. Both the PCEF and BBERF will map from the Authorized IP QoS parameters to the access specific QoS parameters. For GPRS, the GGSN acting as PCEF will map from the Authorized IP QoS parameters to the Authorized UMTS QoS parameters.\nThe general QoS mapping framework is shown in figure 6.1.1.\nFigure 6.1.1: Framework for QoS mapping\nNOTE 1:\tThe AF can derive the Service information from the AF session signalling.\nNOTE 2:\tService Information on Rx interface to Authorized IP QoS parameters mapping.\nNOTE 3:\tFor the UE initiated bearer setup, the UE may derive IP QoS parameters, requested Access-Specific QoS parameters mapping and Authorized Access-Specific QoS parameters from the AF session signalling.\nNOTE 4:\tAuthorized IP QoS parameters to Authorized Access-Specific QoS parameters mapping.\nNOTE 5:\tAccess Specific QoS parameters with Authorized Access-Specific QoS parameters comparison.",
      "chunk_type": "definition",
      "cross_references": [
        "ts_26.247_clause_6.2",
        "clause_6.2",
        "clause_6.3",
        "figure_6.1.1",
        "ts_26.247"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.1.1",
      "section_id": "6.1.1",
      "section_title": "UE-Initiated IP-CAN bearers",
      "content": "This clause covers the case where the UE is capable to initiate/modify the IP-CAN bearers sending requests to the PCEF/BBERF. When a UE desires to establish/modify an IP-CAN bearer the following steps are followed:\n1.\tThe AF can map from SDI within the AF session signalling to service information passed to the PCRF over the Rx interface. (see clause 6.2 if SDP is used as SDI).\n2.\tThe PCRF shall map from the service information received over the Rx interface to the Authorized IP QoS parameters that shall be passed to the PCEF/BBERF via the Gx/Gxx interface. The mapping is performed for each IP flow. Upon a request from the PCEF/BBERF, the PCRF combines per direction the individual Authorized IP QoS parameters per flow (see clause 6.3).\n3.\tThe UE derives access specific QoS parameters, e.g. UMTS QoS parameters, and, if an IP BS manager is present, IP QoS parameters from the AF session signalling in an application specific manner. The IP and access specific QoS parameters should be generated according to application demands.For GPRS, the recommendations for conversational (3GPP TS 26.114 [29]) or streaming applications (3GPP TS 26.234 [6]) should also be taken into account when the UE derives the IP and UMTS QoS parameters. If SDP is used as SDI, e.g. for IMS, the UE should apply clause 6.5.1.and should also apply mapping rules for the authorised QoS parameters in clause 6.5.2 to derive the maximum values for the different requested bit rates and traffic classes. In case the UE multiplexes several IP flows onto the same PDP Context, it has to combine their IP and UMTS QoS parameters. If an IP BS manager is present, the Translation/Mapping function maps the IP QoS parameters to the corresponding UMTS QoS parameters.\n4.\tThe PCEF/BBERF shall map from the Authorized IP QoS parameters received from PCRF to the Authorized access specific QoS parameters.\nFor GPRS. The GGSN shall map to the Authorized UMTS QoS parameters (see clause 6.4.1.1).\n5.\tThe PCEF/BBERF shall compare the requested access specific QoS parameters against the authorized access specific QoS parameters.\nFor GPRS, the GGSN shall compare the UMTS QoS parameters of the PDP context against the Authorized UMTS QoS parameters (see clause 6.4.1.2).\nThe mapping that takes place in the UE and the network should be compatible in order to ensure that the PCEF will be able to correctly authorize the session.\nFigure 6.1.1.1 shows the different kind of QoS parameters in the different points of QoS mapping figure. Due to the UE requests, there are bidirectional flows between the UE and the PCRF.\nFigure 6.1.1.1: QoS mapping for UE initiated IP CAN bearers",
      "chunk_type": "general",
      "cross_references": [
        "clause_6.2",
        "clause_6.3",
        "clause_6.5.1",
        "clause_6.5.2",
        "clause_6.4.1.1",
        "clause_6.4.1.2",
        "figure_6.1.1.1",
        "ts_26.114",
        "ts_26.234"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.1.2",
      "section_id": "6.1.2",
      "section_title": "Network-Initiated IP-CAN bearers",
      "content": "When the IP-CAN session supports Network-Initiated bearers, the network sets up IP CAN bearer(s) with a suitable QoS. If the type of IP CAN supports such an indication, the network indicates to the terminal the QoS characteristics of those IP-CAN bearer(s). Therefore the flow of QoS related information will be unidirectional as indicated in the figure 6.1.2.1.\nFigure 6.1.2.1: QoS mapping for network initiated IP CAN bearers\n1.\tThe AF can map from SDI within the AF session signalling to service information passed to the PCRF over the Rx interface (see subclause 6.2 if SDP is used as SDI).\n2.\tThe PCRF shall map from the service information received over the Rx interface to the Authorized IP QoS parameters that shall be passed to the PCEF/BBERF via the Gx/Gxx interface. The mapping is performed for each IP flow. Upon a request from the PCEF/BBERF, the PCRF combines per direction the individual Authorized IP QoS parameters per flow (see subclause 6.3).\n3.\tThe PCEF/BBERF shall map from the Authorized IP QoS parameters received from PCRF to the access specific QoS parameters. For GPRS, the GGSN shall map to the UMTS QoS parameters (see clause 6.4.1.1).",
      "chunk_type": "general",
      "cross_references": [
        "clause_6.2",
        "clause_6.3",
        "clause_6.4.1.1",
        "figure_6.1.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.2",
      "section_id": "6.2",
      "section_title": "QoS parameter mapping Functions at AF",
      "content": "The mapping described in this clause is mandatory for the P-CSCF and should also be applied by other AFs, if the SDI is SDP.\nWhen a session is initiated or modified the P-CSCF shall use the mapping rules in table 6.2.1 for each SDP media component to derive a Media-Component-Description AVP from the SDP Parameters. The mapping shall not apply to media components where the SDP payload is proposing to use a circuit-switched bearer (i.e. \"c=\" line set to \"PSTN\" and an \"m=\" line set to \"PSTN\", refer to 3GPP TS 24.292 [24]). Circuit-switched bearer related media shall not be included in the service information sent to the PCRF.\nTable 6.2.1: Rules for derivation of service information withinMedia-Component-Description AVP from SDP media component\nservice information per Media-Component-Description AVP\n(see notes 1 and 7)\nDerivation from SDP Parameters(see Note 2)\nMedia-Component-Number\nordinal number of the position of the \"m=\" line  in the SDP\nAF-Application-Identifier\nThe AF-Application-Identifier AVP may be supplied or omitted, depending on the application.\nFor IMS, if the AF-Application-Identifier AVP is supplied, its value should not demand application specific bandwidth or QoS class handling unless the IMS application is capable of handling a QoS downgrading.\nMedia-Type\nThe Media Type AVP shall be included with the same value as supplied for the media type in the \"m=\" line.\nFlow-Status\nIF port in m-line = 0 THEN\nFlow-Status:= REMOVED;\nELSE\nIF Transport in m-line is \"TCP\" or \"TCP/MSRP\" or \"UDP/DTLS/SCTP\" THEN (NOTE 9)\nFlow-Status := ENABLED;\nELSE /* UDP or RTP/AVP transport\nIF a=rtcp-mux is negotiated THEN\nFlow-Status :=ENABLED; (NOTE 12 and 13)\nELSE\nIF a=recvonly THEN\nIF <SDP direction> = UE originated (NOTE 8) THEN\nFlow-Status := ENABLED_DOWNLINK; (NOTE 4)\nELSE /* UE terminated (NOTE 8) */\nFlow-Status := ENABLED_UPLINK; (NOTE 4)\nENDIF;\nELSE\nIF a=sendonly THEN\nIF <SDP direction> = UE originated (NOTE 8) THEN\nFlow-Status := ENABLED_UPLINK; (NOTE 4)\nELSE /* UE terminated (NOTE 8) */\nFlow-Status := ENABLED_DOWNLINK; (NOTE 4)\nENDIF;\nELSE\nIF a=inactive THEN\nFlow-Status :=DISABLED;\nELSE /* a=sendrecv or no direction attribute */\nFlow-Status := ENABLED (NOTE 4)\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\n(NOTE 5)\nMax-Requested-Bandwidth-UL\nIF <SDP direction> = UE terminated (NOTE 8) THEN\nIF Transport in m-line is \"TCP\" or \"TCP/MSRP\" or \"UDP/DTLS/SCTP\" THEN (NOTE 9)\nIF a=recvonly or a=sendrecv or no direction attribute THEN\nIF b=AS:<bandwidth> is present and\n( b=TIAS:<Tibandwidth> is not\npresent or is present but not supported ) THEN\nMax-Requested-Bandwidth-UL:= <bandwidth> * 1000; /* Unit bit/s\nELSE\nIF b=TIAS:<Tibandwidth> is present and supported THEN\nMax-Requested-Bandwidth-UL:= <Transport-dependent bandwidth>\n(NOTE 11) /* Unit bit/s\nELSE\nMax-Requested-Bandwidth-UL:= <Operator specific setting>;\nENDIF;\nENDIF;\nELSE\nMax-Requested-Bandwidth-UL:= <Operator specific setting>,\n(NOTE 10)\nENDIF;\nELSE /* UDP or RTP/AVP transport\nIF b=AS:<bandwidth> is present and\n( b=TIAS:<Tibandwidth> is not\npresent or is present but not supported ) THEN\nIF a=rtcp-mux is negotiated(NOTE 13) THEN\nIF b=RR:<rrbandwidth> is present\nOR b=RS:<rsbandwidth> is present THEN\nMax-Requested-Bandwidth-UL:= <bandwidth> * 1000 +\n<rrbandwidth> + <rsbandwidth>; (NOTE 3; NOTE 6)\nELSE\nMax-Requested-Bandwidth-UL:= <bandwidth> * 1050;\n/* Unit is bit/s\nENDIF\nELSE\nMax-Requested-Bandwidth-UL:= <bandwidth> * 1000;\n/* Unit is bit/s\nENDIF;\nELSE\nIF b=TIAS:<Tibandwidth> is present and supported THEN\nIF a=rtcp-mux is negotiated (NOTE 13) THEN\nIF b=RR:<rrbandwidth> is present\nOR b=RS:<rsbandwidth> is present THEN\nMax-Requested-Bandwidth-UL:=               <Transport-dependent bandwidth> (NOTE 11) +\n<rrbandwidth> + <rsbandwidth>; (NOTE 3; NOTE 6)\nELSE\nMax-Requested-Bandwidth-UL:=               <Transport-dependent bandwidth>\n* 1.05 (NOTE 11) /* Unit bit/s\nENDIF\nELSE\nMax-Requested-Bandwidth-UL:= <Transport-dependent bandwidth>\n(NOTE 11) /* Unit bit/s\nENDIF;\nELSE\nMax-Requested-Bandwidth-UL:= <Operator specific setting>,\nor AVP not supplied;\nENDIF;\nENDIF;\nENDIF\nELSE\nConsider SDP in opposite direction\nENDIF\nMax-Requested-Bandwidth-DL\n(NOTE 17)\nIF <SDP direction> = UE originated (NOTE 8) THEN\nIF Transport in m-line is \"TCP\" or \"TCP/MSRP\" or \"UDP/DTLS/SCTP\" THEN (NOTE 9)\nIF a=recvonly or a=sendrecv or no direction attribute THEN\nIF b=AS:<bandwidth> is present and\n( b=TIAS:<Tibandwidth> is not present or\nis present but not supported ) THEN\nMax-Requested-Bandwidth-DL:= <bandwidth> * 1000; /* Unit bit/s\nELSE\nIF b=TIAS:<Tibandwidth> is present and supported THEN\nMax-Requested-Bandwidth-DL:= <Transport-dependant bandwidth>\n/* Unit bit/s (see NOTE 11)\nOR Operator specific setting\nELSE\nMax-Requested-Bandwidth-DL:= <Operator specific setting>;\nENDIF;\nELSE\nMax-Requested-Bandwidth-DL:= <Operator specific setting>,\n(NOTE 10)\nENDIF;\nELSE /* UDP or RTP/AVP transport\nIF b=AS:<bandwidth> is present and b=TIAS:<Tibandwidth> is not\npresent THEN\nIF a=rtcp-mux is negotiated(NOTE 13) THEN\nIF b=RR:<rrbandwidth> is present\nOR b=RS:<rsbandwidth> is present THEN\nMax-Requested-Bandwidth-DL:= <bandwidth> * 1000 +\n<rrbandwidth> + <rsbandwidth>; (NOTE 3; NOTE 6)\nELSE\nMax-Requested-Bandwidth-DL:= <bandwidth> * 1050;\n/* Unit is bit/s\nENDIF\nELSE\nMax-Requested-Bandwidth-DL:= <bandwidth> * 1000\n;/* Unit is bit/s\nENDIF;\nELSE\nIF b=TIAS:<Tibandwidth> is present THEN\nIF a=rtcp-mux is negotiated (NOTE 13) THEN\nIF b=RR:<rrbandwidth> is present\nOR b=RS:<rsbandwidth> is present THEN\nMax-Requested-Bandwidth-DL:=               <Transport-dependent bandwidth> (NOTE 11) +\n<rrbandwidth> + <rsbandwidth>; (NOTE 3; NOTE 6)\nELSE\nMax-Requested-Bandwidth-DL:=               <Transport-dependent bandwidth>\n* 1.05 (NOTE 11) /* Unit bit/s\nENDIF\nELSE\nMax-Requested-Bandwidth-DL:= <Transport-dependent bandwidth>            (NOTE 11) /* Unit bit/s\nENDIF;\nELSE\nMax-Requested-Bandwidth-DL:= <Operator specific setting>,\nor AVP not supplied;\nENDIF;\nENDIF;\nENDIF\nELSE\nConsider SDP in opposite direction\nENDIF\nMax-Supported-Bandwidth-UL\n(NOTE 18)\nIF a=bw-info is present and includes MaxSupBw: <bandwidth> and direction: recv (UE terminated) or send (UE originated) or sendrecv (NOTE 14) THEN\nMax-Supported-Bandwidth-UL:= [supplied <bandwidth>] * 1000 /Unit bit/s/\n(NOTE 16)\nELSE /* a=bw-info is not present or is present but MaxSupBw is not\nincluded or direction is the opposite\nAVP not supplied\nENDIF;\n(NOTE 15)\nMax-Supported-Bandwidth-DL\n(NOTE 18)\nIF a=bw-info is present and includes MaxSupBw : <bandwidth> and direction: send (UE terminated) or recv (UE originated) or sendrecv (NOTE 14)THEN\nMax-Supported-Bandwidth-DL:= [supplied <bandwidth>] * 1000 /Unit bit/s/\n(NOTE 16)\nELSE /* a=bw-info is not present or is present but MaxSupBw is not\nincluded or direction is the opposite\nAVP not supplied\nENDIF;\n(NOTE 15)\nMin-Desired-Bandwidth-UL\n(NOTE 19)\nIF a=bw-info is present and includes MinDesBw : <bandwidth> and direction: recv (UE terminated) or send (UE originated) or sendrecv (NOTE 14) THEN\nMin-Desired-Bandwidth-UL:= supplied <bandwidth> * 1000 /Unit bit/s/\n(NOTE 16)\nELSE /* a=bw-info is not present or is present but MinDesBw is not\nincluded or direction is the opposite\nAVP not supplied\nENDIF;\nMin-Desired-Bandwidth-DL\n(NOTE 19)\nIF a=bw-info is present and includes MinDesBw : <bandwidth> and direction: send (UE terminated) or recv (UE originated) or sendrecv (NOTE 14) THEN\nMin-Desired-Bandwidth-DL:= [supplied <bandwidth>] * 1000 /Unit bit/s/\n(NOTE 16)\nELSE /* a=bw-info is not present or is present but MinDesBw is not\nincluded or direction is the opposite\nAVP not supplied\nENDIF;\nRR-Bandwidth\nIF b=RR:<bandwidth> is present THEN\nRR-Bandwidth:= <bandwidth>;\nELSE\nAVP not supplied\nENDIF;\n(NOTE 3; NOTE 6)\nRS-Bandwidth\nIF b=RS:<bandwidth> is present THEN\nRS-Bandwidth:= <bandwidth>;\nELSE\nAVP not supplied\nENDIF;\n(NOTE 3, NOTE 6)\nMedia-Sub-Component\nSupply one AVP for bidirectional combination of two corresponding IP flows, if available, and for each single IP flow without a corresponding IP flow in opposite direction.\nIf a media component comprises separate IP flows for RTP and RTCP, they are described in two separate Media-Sub-Component AVPs. However, if a=rtcp-mux is negotiated, RTP and RTCP use the same IP flow and shall be described in a single Media-Sub-Component AVP.\nThe encoding of the AVP is described in Table 6.2.2\nReservation-Priority\nThe AF may supply or omit this AVP.\nCodec-Data\nCodec Data AVP(s) are provisioned as specified in clause 5.3.16 of 3GPP TS 29.214 [10], including the codec-related information detailed in clause 5.3.7 of 3GPP TS 29.214 [10].\nMax-PLR-DL\nIF a= PLR_adapt line is NOT present in both SDP OFFER and ANSWER THEN\n/* As UE don’t support CHEM feature, AF should not use packet loss rates\nin either the uplink or downlink direction */\nMax-PLR-DL AVP not supplied\nELSE\nIF P-CSCF serving the OFFERER THEN\nFOR each RTP payload type of the same media line\nIF MAXimum-e2e-PLR line is present in the SDP OFFER THEN\nIF maxUL-PLR is present in the SDP ANSWER\nMax-PLR-DL = value of maxe2e-PLR in the SDP OFFER - maxUL-PLR\nin the SDP ANSWER\nELSE /* maxUL-PLR is not present in the SDP ANSWER */\nMax-PLR-DL = the default value is ½ maxe2e-PLR value present\nin the SDP OFFER\nELSE /* MAXimum-e2e-PLR line is not present in the SDP OFFER */\nIF maxUL-PLR is present in the SDP ANSWER THEN\nMax-PLR-DL = (the default value is end-to-end Maximum\nEnd-to-End Packet Loss Rate for the decoder of\nthe RTP payload type as recommended in 3GPP\nTS 26.114 [29] clause X.1.2 for application\nlayer redundancy or X.1.1 for partial redundancy)\n- maxUL-PLR in the SDP ANSWER\nELSE /* maxUL-PLR is not present in the SDP ANSWER */\nMax-PLR-DL = the default value is ½ end-to-end Maximum End-to-End\nPacket Loss Rate for the decoder of the RTP payload\ntype as recommended in 3GPP TS 26.114 [29]\nclause X.1.2 for application layer redundancy\nor X.1.1 for partial redundancy\nENDIF;\nENDIF;\nEND FOR LOOP of each RTP payload type of the same media\nMax-PLR-DL = maximum value of Max-PLR-DL among all the RTP payload\ntypes\nELSE /* For P-CSCF serving the ANSWERER */\nFOR each RTP payload type of the same media line\nIF MAXimum-e2e-PLR line is present in the SDP ANSWER THEN\nIF maxDL-PLR is present in the SDP ANSWER\nMax-PLR-DL = value of maxDL-PLR in the SDP ANSWER\nELSE /* maxDL-PLR is not present in the SDP ANSWER */\nMax-PLR-DL = the default value is ½ maxe2e-PLR value present\nin the SDP ANSWER\nELSE /* MAXimum-e2e-PLR line is not present in the SDP ANSWER */\nMax-PLR-DL = the default value is ½ end-to-end Maximum End-to-End\nPacket Loss Rate for the decoder of the RTP payload\ntype as recommended in 3GPP TS 26.114 [29]\nclause X.1.2 for application layer redundancy\nor X.1.1 for partial redundancy\nENDIF;\nEND FOR LOOP of each RTP payload type of the same media\nMax-PLR-DL = maximum value of Max-PLR-DL among all the RTP payload\ntypes\nENDIF;\nENDIF;\nENDIF;\nMax-PLR-UL\nIF a= PLR_adapt line is NOT present in both SDP OFFER and ANSWER THEN\n/* As UE don’t support CHEM feature, AF should not use packet loss rates\nin either the uplink or downlink direction */\nMax-PLR-UL AVP not supplied\nELSE\nIF P-CSCF serving the OFFERER THEN\nFOR each RTP payload type of the same media line\nIF MAXimum-e2e-PLR line is present in the SDP ANSWER THEN\nIF maxDL-PLR is present in the SDP ANSWER\nMax-PLR-UL = value of maxe2e-PLR in the SDP ANSWER - maxDL-PLR\nin the SDP ANSWER\nELSE /* maxDL-PLR is not present in the SDP ANSWER */\nMax-PLR-UL = the default value is ½ maxe2e-PLR value present\nin the SDP ANSWER\nELSE /* MAXimum-e2e-PLR line is not present in the SDP ANSWER */\nMax-PLR-UL = the default value is ½ end-to-end Maximum End-to-End\nPacket Loss Rate for the decoder of the RTP payload\ntype as recommended in 3GPP TS 26.114 [29]\nclause X.1.2 for Application layer redundancy\nor X.1.1 for partial redundancy\nENDIF;\nEND FOR LOOP of each RTP payload type of the same media\nMax-PLR-UL = maximum value of Max-PLR-UL among all the RTP payload\ntypes\nELSE /* For P-CSCF serving the ANSWERER */\nFOR each RTP payload type of the same media line\nIF MAXimum-e2e-PLR line is present in the SDP OFFER THEN\nIF maxUL-PLR is present in the SDP ANSWER\nMax-PLR-UL = value of maxUL-PLR in the SDP ANSWER\nELSE /* maxUL-PLR is not present in the SDP ANSWER */\nMax-PLR-UL = the default value is ½ maxe2e-PLR value present\nin the SDP OFFER\nELSE /* MAXimum-e2e-PLR line is not present in the SDP OFFER */\nMax-PLR-UL = the default value is ½ end-to-end Maximum End-to-End\nPacket Loss Rate for the decoder of the RTP payload\ntype as recommended in 3GPP TS 26.114 [29]\nclause X.1.2 for Application layer redundancy\nor X.1.1 for partial redundancy\nENDIF;\nEND FOR LOOP of each RTP payload type of the same media\nMax-PLR-UL = maximum value of Max-PLR-UL among all the RTP payload\ntypes\nENDIF;\nENDIF;\nENDIF;\nDesired-Max-Latency\nIF <SDP direction> = UE originated (NOTE 8) THEN\nIF a=3gpp-qos-hint is present and includes a qos-hint-property that indicates \"latency\"\nIF qos-hint-split-value for \"local\" is not present\nDesired-Max-Latency = <qos-hint-end-to-end-value>*0.5\nELSE /* qos-hint-split-value for \"local\" is present\nDesired-Max-Latency = <qos-hint-split-value>\nENDIF\nELSE\nAVP not supplied\nENDIF\nELSE /* <SDP direction> = UE terminated (NOTE 8)/\nIF a=3gpp-qos-hint is present and includes a qos-hint-property that indicates \"latency\"\nIF qos-hint-split-value for \"local\" is not present\nDesired-Max-Latency = <qos-hint-end-to-end-value>*0.5\nELSE /* qos-hint-split-value for \"local\" is present/\nDesired-Max-Latency = <qos-hint-end-to-end-value> - <qos-hint-split-value>\nENDIF\nELSE\nAVP not supplied\nENDIF\nENDIF\nDesired-Max-Loss\nIF <SDP direction> = UE originated (NOTE 8) THEN\nIF a=3gpp-qos-hint is present and includes a qos-hint-property that indicates \"loss\"\nIF qos-hint-split-value for \"local\" is not present\nDesired-Max-Loss = <qos-hint-end-to-end-value>*0.5\nELSE /* qos-hint-split-value for \"local\" is present/\nDesired-Max-Loss = <qos-hint-split-value>\nENDIF\nELSE\nAVP not supplied\nENDIF\nELSE /* <SDP direction> = UE terminated (NOTE 8)/\nIF a=3gpp-qos-hint is present and includes a qos-hint-property that indicates \"loss\"\nIF qos-hint-split-value for \"local\" is not present\nDesired-Max-Loss = < qos-hint-end-to-end-value>*0.5\nELSE /* qos-hint-split-value for \"local\" is present/\nDesired-Max-Loss = <qos-hint-end-to-end-value> - <qos-hint-split-value>\nENDIF\nELSE\nAVP not supplied\nENDIF\nENDIF\nNOTE 1:\tThe encoding of the service information is defined in 3GPP TS 29.214 [10].\nNOTE 2:\tThe SDP parameters are described in IETF RFC 2327 [11].\nNOTE 3:\tThe \"b=RS:\" and \"b=RR:\" SDP bandwidth modifiers are defined in IETF RFC 3556 [13].\nNOTE 4:\tAs an operator policy to disable forward and/or backward early media, for media with UDP as transport protocol only the Flow-Status AVP may be downgraded by using the gate control procedures defined in the annex A of 3GPP TS 29.214 [10] before a SIP confirmed dialogue is established, i.e. until a 200 (OK) response to an INVITE request is received.\nNOTE 5:\tIf the SDP answer is available when the session information is derived, the direction attributes and port number from the SDP answer shall be used to derive the flow status. However, to enable interoperability with SIP clients that do not understand the inactive SDP attribute, if \"a=inactive\" was supplied in the SDP offer, this shall be used to derive the flow status. If the SDP answer is not available when the session information is derived, the direction attributes from the SDP offer shall be used.\nNOTE 6:\tInformation from the SDP answer is applicable, if available.\nNOTE 7:\tThe AVPs may be omitted if they have been supplied in previous service information and have not changed, as detailed in 3GPP TS 29.214 [10].\nNOTE 8:\t\"Uplink SDP\" indicates that the SDP was received from the UE and sent to the network. This is equivalent to <SDP direction> = UE originated.\n\"Downlink SDP\" indicates that the SDP was received from the network and sent to the UE. This is equivalent to <SDP direction> = UE terminated.\nNOTE 9:\tSupport for TCP at a P-CSCF acting as AF is only required if services with TCP transport are used in the corresponding IMS system.\nAs an operator policy to disable forward and/or backward early media, for media with TCP as transport protocol, the Max-Requested-Bandwidth-UL/DL values may be downgraded before a SIP confirmed dialogue is established, i.e. until a 200 (OK) response to an INVITE request is received. Only a small bandwidth in both directions is required in this case in order for TCP control packets to flow.\nNOTE 10:\tTCP uses IP flows in the directionality opposite to the transferred media for feedback. To enable these flows, a small bandwidth in this direction is required.\nNOTE 11:\tTIAS is defined in IETF RFC 3890 [23]. IETF RFC 3890 clause 6.4 provides procedures for converting TIAS to transport-dependant values. This procedure relies on the presence of maxprate (also defined in IETF RFC 3890).\nNOTE 12:\tMultiplexed RTP/RTCP flows need to have Flow-Status set to \"ENABLED\" in order to always permit the RTCP traffic.\nNOTE 13:\tRTP/RTCP multiplexing is defined in IETF RFC 5761 [39].\nNOTE 14:\tThis AVP is derived from the SDP answer information and is omitted if E2EQOSMTSI feature is not supported.\nNOTE 15:\tWhen both \"b =\" line and \"a=bw-info\" including MaxSupBw are present when sending the SDP, it is expected that the values are aligned.\nNOTE 16:\tWhen the supplied bandwidth does not correspond to the bandwidth applicable to the IP version used by the UE, the AF shall re-compute it considering the IP version used by the UE as defined in 3GPP TS 26.114 [29].\nNOTE 17:\tWhen the Extended-Max-Requested-BW-NR feature is supported and if the bandwidth values are higher than 2^32-1 bps, Extended-Max-Requested-BW-UL/DL shall be derived instead of Max-Requested-Bandwidth-UL/DL. The same derivation procedure shall apply, with the exception that the units for the derived bandwidth shall be kbit per second instead of bit per second.\nNOTE 18:\tWhen the Extended-BW-E2EQOSMTSI-NR feature is supported and if the bandwidth values are higher than 2^32-1 bps, Extended-Max-Supported-BW-UL/DL shall be derived instead of Max-Supported-Bandwidth-UL/DL. The same derivation procedure shall apply, with the exception that the units for the derived bandwidth shall be kbit per second instead of bit per second.\nNOTE 19:\tWhen the Extended-BW-E2EQOSMTSI-NR feature is supported and if the bandwidth values are higher than 2^32-1 bps, Extended-Min-Desired-BW-UL/DL shall be derived instead of Min-Desired-Bandwidth-UL/DL. The same derivation procedure shall apply, with the exception that the units for the derived bandwidth shall be kbit per second instead of bit per second.\nTable 6.2.2: Rules for derivation of Media-Sub-Component AVP from SDP media component\nservice information per Media-Sub-Component AVP\n(see notes 1 and 5)\nDerivation from SDP Parameters(see Note 2)\nFlow-Number\nThe AF shall assign a number to the media-subcomponent AVP that is unique within the surrounding media component AVP and for the entire lifetime of the AF session. The AF shall select the ordinal number of the IP flow(s) within the \"m=\" line assigned in the order of increasing downlink destination port numbers, if downlink destination port numbers are available. For uplink or inactive unicast media IP flows, a downlink destination port number is nevertheless available, if SDP offer-answer according to IETF RFC 3264 is used.\nThe AF shall select the ordinal number of the IP flow(s) within the \"m=\" line assigned in the order of increasing uplink destination port numbers, if no downlink destination port numbers are available.\nFlow-Status\nAVP not supplied\nMax-Requested-Bandwidth-UL\nAVP not supplied\nMax-Requested-Bandwidth-DL\nAVP not supplied\nFlow-Description\nFor uplink and downlink direction, a Flow-Description AVP shall be provided unless no IP Flows in this direction are described within the media component.\nIf UDP is used as transport protocol, the SDP direction attribute (NOTE 4) indicates the direction of the media IP flows within the media component as follows:\nIF a=recvonly THEN (NOTE 3)\nIF <SDP direction> = UE originated (NOTE 7) THEN\nProvide only downlink Flow-Description AVP\nELSE /* UE terminated (NOTE 7) */\nProvide only uplink Flow-Description AVP\nENDIF;\nELSE\nIF a=sendonly THEN (NOTE 3)\nIF <SDP direction> = UE originated (NOTE 7) THEN\nProvide only uplink Flow-Description AVP\nELSE /* UE terminated (NOTE 7) */\nProvide only downlink Flow-Description AVP\nENDIF;\nELSE /* a=sendrecv or a=inactive or no direction attribute */\nProvide uplink and downlink Flow-Description AVPs\nENDIF;\nENDIF;\nHowever, for RTCP and RTP/RTCP multiplexed IP flows uplink and downlink Flow-Description AVPs shall be provided irrespective of the SDP direction attribute.\nIf TCP is used as transport protocol (NOTE 8), IP flows in uplink and downlink direction are described in SDP irrespective of the SDP direction attribute, as TCP uses an IP flow for feedback even if contents are transferred only in the opposite direction. Thus, both uplink and downlink Flow-Description AVPs shall be provided.\nThe uplink destination address shall be copied from the \"c=\" line of downlink SDP. (NOTE 6) (NOTE 7)\nThe uplink destination port shall be derived from the \"m=\" line of downlink SDP. (NOTE 6) (NOTE 7) However, for TCP transport the uplink destination port shall be wildcarded, if the local UE is the passive endpoint (NOTE 9)\nThe downlink destination address shall be copied from the \"c=\" line of uplink SDP. (NOTE 6) However, a P-CSCF acting as AF and applying NAT traversal procedures in Annex C shall derive the downlink destination address using those procedures.\nThe downlink destination port shall be derived from the \"m=\" line of uplink SDP. (NOTE 6) (NOTE 7) However, for TCP transport the downlink destination port shall be wildcarded, if the local UE is the active endpoint (NOTE 9). A P-CSCF acting as AF and applying NAT traversal procedures in Annex C shall derive the downlink destination port using those procedures.\nFor IPv6, uplink and downlink source addresses shall either be derived from the prefix of the destination address or be wildcarded by setting to \"any\", as specified in 3GPP TS 29.214 [10]. However, a P-CSCF acting as AF and applying NAT traversal procedures in Annex C shall derive the uplink source address using those procedures.\nIf IPv4 is being utilized, the uplink source address shall either be set to the address contained in the \"c=\" line of the uplink SDP or be wildcarded, and the downlink source address shall either be set to the address contained in the \"c=\" line of the downlink SDP or be wildcarded. However, for TCP transport, if the local UE is the passive endpoint (NOTE 9), the uplink source address shall not be wildcarded. If the local UE is the active endpoint (NOTE 9), the downlink source address shall not be wildcarded. A P-CSCF acting as AF and applying NAT traversal procedures in Annex C shall derive the uplink source address using those procedures.\nSource ports shall not be supplied. However, for TCP transport, if the local UE is the passive end point (NOTE 9), the uplink source port shall be derived from the \"m=\" line of the uplink SDP. If the local UE is the active end point (NOTE 9), the downlink source port shall be derived from the \"m=\" line of the downlink SDP. A P-CSCF acting as AF and applying NAT traversal procedures in Annex C shall derive the downlink source ports using those procedures.\nProto shall be derived from the transport of the \"m=\" line. For \"UDP/DTLS/SCTP\" as defined in IETF RFC 8864 [69] or \"RTP/AVP\", proto is 17(UDP). For \"TCP\", as defined in IETF RFC 4145 [16], or \"TCP/MSRP\", as defined in IETF RFC 4975 [17], proto is 6(TCP).\nFlow-Usage\nThe Flow-Usage AVP shall be supplied with value \"RTCP\" if the IP flow(s) described in the Media-Sub-Component AVP are used to transport RTCP only. Otherwise the Flow-Usage AVP shall not be supplied. IETF RFC 2327 [11] specifies how RTCP flows are described within SDP.\nIf the IP flows(s) are used to transport signalling the value should be \"AF-SIGNALLING\".\nNOTE 1:\tThe encoding of the service information is defined in 3GPP TS 29.214 [10].\nNOTE 2:\tThe SDP parameters are described in IETF RFC 2327 [11].\nNOTE 3:\tIf the SDP direction attribute for the media component negotiated in a previous offer-answer exchange was sendrecv, or if no direction attribute was provided, and the new SDP direction attribute sendonly or recvonly is negotiated in a subsequent SDP offer-answer exchange, uplink and downlink Flow-Description AVPs shall be supplied.\nNOTE 4:\tIf the SDP answer is available when the session information is derived, the direction attributes from the SDP answer shall be used to derive the flow description. However, to enable interoperability with SIP clients that do not understand the inactive SDP attribute, if \"a=inactive\" was supplied in the SDP offer, this shall be used. If the SDP answer is not available when the session information is derived, the direction attributes from the SDP offer shall be used.\nNOTE 5:\tThe AVPs may be omitted if they have been supplied in previous service information and have not changed, as detailed in 3GPP TS 29.214 [10].\nNOTE 6:\tIf the session information is derived from an SDP offer, the required SDP may not yet be available. The corresponding Flow Description AVP shall nevertheless be included and the unavailable fields (possibly all) shall be wildcarded.\nNOTE 7:\t\"Uplink SDP\" indicates that the SDP was received from the UE and sent to the network. This is equivalent to <SDP direction> = UE originated.\n\"Downlink SDP\" indicates that the SDP was received from the network and sent to the UE. This is equivalent to <SDP direction> = UE terminated.\nNOTE 8:\tSupport for TCP at a P-CSCF acting as AF is only required if services with TCP transport are used in the corresponding IMS system.\nNOTE 9:\tFor TCP transport, the passive endpoints is derived from the SDP \"a=setup\" attribute according to the rules in IETF RFC 4145 [16], or, if that attribute is not present, from the rules in IETF RFC 4975 [17].",
      "chunk_type": "parameter",
      "cross_references": [
        "ts_29.214_clause_5.3.16",
        "ts_29.214_clause_5.3.7",
        "clause_6.4",
        "table_6.2.1",
        "table_6.2.2",
        "ts_24.292",
        "ts_29.214",
        "ts_26.114"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.3",
      "section_id": "6.3",
      "section_title": "QoS parameter mapping Functions at PCRF",
      "content": "The QoS authorization process consists of the derivation of the parameters Authorized QoS Class Identifier (QCI), Allocation and Retention Priority (ARP), and Authorized Maximum/Guaranteed Data Rate UL/DL.\nWhen a session is initiated or modified the PCRF shall derive Authorized IP QoS parameters (i.e. QCI, Authorized Maximum/Guaranteed Data Rate DL/UL (if bandwidth values are lower or equal to 2^32-1 bps), Extended Authorized Maximum/Guaranteed Data Rate DL/UL (if bandwidth values are higher than 2^32-1 bps and if the Extended-BW-NR feature is supported), ARP) from the service information. If the selected Bearer Control Mode (BCM) is UE-only this process shall be performed according to the mapping rules in table 6.3.1 to avoid undesired misalignments with the UE QoS parameters mapping.\nIn the case of forking, the various forked responses may have different QoS requirements for the IP flows of the same media component. Each Authorized IP QoS Parameter should be set to the highest value requested for the IP flow(s) of that media component by any of the active forked responses.\nTable 6.3.1: Rules for derivation of the Maximum Authorized Data Rates, Authorized Guaranteed Data Ratesand Maximum Authorized QoS Class per IP flow or bidirectional combination of IP flows in the PCRF\nAuthorized IP QoS Parameter\nDerivation from service information(see Note 4)\nMaximum Authorized Data Rate DL (Max_DR_DL) and UL (Max_DR_UL)\n(NOTE 21)\nIF operator special policy exists THEN\nMax_DR_UL:= as defined by operator specific algorithm;\nMax_DR_DL:= as defined by operator specific algorithm;\nELSE\nIF AF-Application-Identifier AVP demands application specific data rate\nhandling THEN\nMax_DR_UL:= as defined by application specific algorithm;\nMax_DR_DL:= as defined by application specific algorithm;\nELSE IF Codec-Data AVP provides Codec information for a codec that is\nsupported by a specific algorithm (NOTE 19,20) THEN\nMax_DR_UL:= as defined by specific algorithm;\nMax_DR_DL:= as defined by specific algorithm;\nELSE\nIF not RTCP flow(s) according to Flow-Usage AVP THEN\nIF Flow-Status = REMOVED THEN\nMax_DR_UL:= 0;\nMax_DR_DL:= 0;\nELSE\nIF uplink Flow Description AVP is supplied THEN\nIF Max-Supported-Bandwidth-UL is present and supported THEN\nMax_DR_UL:= Max-Supported-Bandwidth-UL;\nELSE IF Max-Requested-Bandwidth-UL is present THEN\nMax_DR_UL:= Max-Requested-Bandwidth-UL ;\nELSE\nMax_DR_UL:= as set by the operator;\nENDIF;\nELSE\nMax_DR_UL:= 0;\nENDIF;\nIF downlink Flow Description AVPs is supplied THEN\nIF Max-Supported-Bandwidth-DL is present and supported THEN\nMax_DR_DL:= Max-Supported-Bandwidth-DL;\nELSE IF Max-Requested-Bandwidth-DL is present THEN\nMax_DR_DL:= Max-Requested-Bandwidth-DL;\nELSE\nMax_DR_DL:= as set by the operator;\nENDIF;\nELSE\nMax_DR_DL:= 0;\nENDIF;\nENDIF;\nELSE /* RTCP IP flow(s) */\nIF RS-Bandwidth is present and RR-Bandwidth is present THEN         Max_DR_UL:= (RS-Bandwidth + RR-Bandwidth);        Max_DR_DL:= (RS-Bandwidth + RR-Bandwidth);      ELSE        IF Max-Requested-Bandwidth-UL is present THEN\nIF RS-Bandwidth is present and RR-Bandwidth is not present THEN\nMax_DR_UL:= MAX[0.05 * Max-Requested-Bandwidth-UL,RS-Bandwidth];\nENDIF;\nIF RS-Bandwidth is not present and RR-Bandwidth is present THEN\nMax_DR_UL:= MAX[0.05 * Max-Requested-Bandwidth-UL,RR-Bandwidth];\nENDIF;\nIF RS-Bandwidth and RR-Bandwidth are not present THEN\nMax_DR_UL:= 0.05 * Max-Requested-Bandwidth_UL ;\nENDIF;\nELSE\nMax_DR_UL:= as set by the operator;\nENDIF;\nIF Max-Requested-Bandwidth-DL is present THEN\nIF RS-Bandwidth is present and RR-Bandwidth is not present THEN\nMax_DR_DL:= MAX[0.05 * Max-Requested-Bandwidth-DL,RS-Bandwidth];\nENDIF;\nIF RS-Bandwidth is not present and RR-Bandwidth is present THEN\nMax_DR_DL:= MAX[0.05 * Max-Requested-Bandwidth-DL,RR-Bandwidth];\nENDIF;\nIF RS-Bandwidth and RR-Bandwidth are not present THEN\nMax_DR_DL:= 0.05 * Max-Requested-Bandwidth-DL;          ENDIF;\nELSE\nMax_DR_DL:= as set by the operator;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nIF SIP-Forking-Indication AVP indicates SEVERAL_DIALOGUES THEN\nMax_DR_UL = MAX[Max_DR_UL, previous Max_DR_UL]\nMax_DR_DL = MAX[Max_DR_DL, previous Max_DR_DL]\nENDIF;\nAuthorized Guaranteed Data Rate DL (Gua_DR_DL) and UL (Gua_DR_UL)\n(see NOTE 11, 13, 15, 16. 21)\nIF operator special policy exists THEN\nGua_DR_UL:= as defined by operator specific algorithm;\nGua_DR_DL:= as defined by operator specific algorithm;\nELSE\nIF AF-Application-Identifier AVP demands application specific data rate\nhandling THEN\nGua_DR_UL:= as defined by application specific algorithm;\nGua_DR_DL:= as defined by application specific algorithm;\nELSE IF Codec-Data AVP provides Codec information for a codec that is\nsupported by a specific algorithm (NOTE 5,19,20)THEN\nGua_DR_UL:= as defined by specific algorithm;\nGua_DR_DL:= as defined by specific algorithm;\nELSE\nIF uplink Flow-Description AVP is supplied THEN\nIF Min-Desired-Bandwidth-UL is present and supported THEN\nGua_DR_UL:= Min-Desired-Bandwidth-UL ;\nELSE IF Min-Requested-Bandwidth-UL is present THEN\nGua_DR_UL:= Min-Requested-Bandwidth-UL ;\nELSE\nGua_DR_UL:= as set by the operator;\nENDIF;\nELSE\nGua_DR_UL:= Max DR UL;\nENDIF;\nIF downlink Flow-Description AVP is supplied THEN\nIF Min-Desired-Bandwidth-DL is present and supported THEN\nGua_DR_DL:= Min-Desired-Bandwidth-DL\nELSE IF Min-Requested-Bandwidth-DL is present THEN\nGua_DR_DL:= Min-Requested-Bandwidth-DL ;\nELSE\nGua_DR_DL:= as set by the operator;\nENDIF;\nELSE\nGua_DR_DL:= Max DR DL;\nENDIF;\nENDIF;\nENDIF;\nIF SIP-Forking-Indication AVP indicates SEVERAL_DIALOGUES THEN\nGua_DR_UL = MAX[Gua_DR_UL, previous Gua_DR_UL]\nGua_DR_DL = MAX[Gua_DR_DL, previous Gua_DR_DL]\nENDIF;\nAuthorized QoS Class Identifier [QCI]\n(see NOTE 1, 2, 7, 12, 14 and 23)\nIF an operator special policy exists THEN\nQCI:= as defined by operator specific algorithm;\nELSE IF MPS-Identifier AVP demands MPS specific QoS Class handling THEN\nQCI:= as defined by MPS specific algorithm (NOTE 18);\nELSE IF GCS-Identifier AVP demands Group Communication specific handling THEN\nQCI:= as defined by GCS specific algorithm (NOTE 17);\nELSE IF AF-Application-Identifier AVP demands application specific QoS Class handling THEN\nQCI:= as defined by application specific algorithm;\nELSE IF Codec-Data AVP provides Codec information for a codec that is supported by a specific algorithm THEN\nQCI:= as defined by specific algorithm; (NOTE 5)\nELSE IF FLUS-Identifier AVP demands specific QoS Class handling THEN\nQCI:= as defined by specific algorithm; (NOTE 22)\nELSE\n/* The following QCI derivation is an example of how to obtain the QCI\nvalues in a GPRS network */\nIF Media-Type is present THEN\n/* for GPRS: streaming */\nIF (only uplink Flow Description AVPs are supplied for all IP\nflows of the AF session, which have media type “audio” or “video”\nand no flow usage “RTCP”, or\nonly downlink Flow Description AVPs are supplied for all IP\nflows of the AF session, which have media type “audio” or “video”\nand no flow usage “RTCP”) THEN\nCASE Media-Type OF\n“audio”:        MaxClassDerivation := 3 OR 4; (NOTE 9)\n“video”:        MaxClassDerivation := 4\nEND;\n/* for GPRS: conversational */\nELSE\nCASE Media-Type OF\n“audio”:        MaxClassDerivation:= 1 OR 2; (NOTE 6)\n“video”:        MaxClassDerivation:= 2\nEND;\nENDIF;\nCASE Media-Type OF\n“audio”:        QCI := MaxClassDerivation\n“video”:        QCI := MaxClassDerivation\n“application”:  QCI := 1 OR 2; (NOTE 6)\n/*e.g. for GPRS: conversational*/\n“data”:         QCI := 6 OR 7 OR 8; (NOTE 8)\n/*e.g. for GPRS: interactive with prio 1, 2 AND 3\nrespectively*/\n“control”:      QCI := 6;\n/*e.g. for GPRS: interactive with priority 1*/\n/* NOTE: include new media types here */\nOTHERWISE:      QCI := 9;\n/*e.g. for GPRS: background*/\nEND;\nENDIF;\nENDIF;\nIF SIP-Forking-Indication AVP indicates SEVERAL_DIALOGUES THEN\nQCI = MAX[QCI, previous QCI](NOTE 10)\nENDIF ;\nNOTE 1:\tThe QCI assigned to a RTCP IP flow is the same as for the corresponding RTP media IP flow.\nNOTE 2:\tWhen audio or video IP flow(s) are removed from a session, the parameter MaxClassDerivation shall keep the originally assigned value.\nNOTE 3:\tWhen audio or video IP flow(s) are added to a session, the PCRF shall derive the parameter MaxClassDerivation taking into account the already existing media IP flow(s) within the session.\nNOTE 4:\tThe encoding of the service information is defined in 3GPP TS 29.214 [10]. Possible Bandwidth information and Flow-Status information provided within the Media-Sub-Component AVP takes precedence over information within the encapsulating Media-Component-Description AVP as specified in 3GPP TS 29.214 [10]. If AVPs are omitted within a Media-Component-Description AVP or Media-Sub-Component AVP of the service information, the corresponding information from previous service information shall be used, as specified in 3GPP TS 29.214 [10].\nNOTE 5:\t3GPP TS 26.234 [6], 3GPP TS 26.114 [29], 3GPP2 C.S0046 [18], and 3GPP2 C.S0055 [19] contain examples of QoS parameters for codecs of interest. The support of any codec specific algorithm in the PCRF is optional.\nNOTE 6:\tFor GPRS, the final QCI value will depend on the value of SSD (speech/unknown) according to 3GPP TS 23.107 [4] and table A.3 of 3GPP TS 23.203 [2]. If the PCRF is not able to determine the SSD, it should use the QCI value 2 that corresponds to SSD unknown. For UE-init and mixed mode, the PCRF may derive from the requested QoS of an IP CAN bearer which SSD is applicable.\nNOTE 7:\tThe numeric value of the QCI are based on 3GPP TS 29.212 [9].\nNOTE 8:\tThe QCI value also encodes the traffic handling priority for GPRS. If the PCRF is not able to determine a traffic handling priority, it should choose QCI 8 that corresponds to priority 3. Also, for UE-initiated bearers the PCRF should only use QCI 8 in order to have the same mapping rules in both UE and PCRF.\nNOTE 9:\tFor GPRS, the final QCI value will depend on the value of SSD (speech/unknown) according to 3GPP TS 23.107 [4] and table A.3 of 3GPP TS 23.203 [2]. If the PCRF is not able to determine the SSD, it should use the QCI value 4 that corresponds to SSD unknown. For UE-init and mixed mode, the PCRF may derive from the requested QoS of an IP CAN bearer which SSD is applicable.\nNOTE 10:\tThe Max function shall use the following precedence order for the QCI values:  2 > 1 > 4 > 3 > 5 > 6 > 7 > 8 > 9\nNOTE 11:\tAuthorized Guaranteed Data Rate DL and UL shall not be derived for QCI values 5, 6, 7, 8 and 9.\nNOTE 12:\tRecommended QCI values for standardised QCI characteristics are shown in table 6.1.7 in 3GPP TS 23.203 [2].\nNOTE 13:\tThe PCRF may be configured with operator specific preconditions for setting the Authorized Guaranteed Data Rate lower than the corresponding Maximum Authorized Data Rate.\nNOTE 14:\tIn a network where SRVCC is enabled, the QCI=1 shall be used for IMS services in accordance to 3GPP TS 23.216 [27]. Non-IMS services using QCI=1 may suffer service interruption and/or inconsistent service experience if SRVCC is triggered. Triggering SRVCC for WebRTC IMS session will cause service interruption and/or inconsistent service experience when using QCI=1. Operator policy (e.g. use of specific AF application identifier) may be used to avoid using QCI 1 for a voice service, e.g. WebRTC IMS session.\nNOTE 15:\tFor certain services (e.g. DASH services according to 3GPP TS 26.247 [30]), the AF may also provide a minimum required bandwidth so that the PCRF can derive an Authorized Guaranteed Data Rate lower than the Maximum Authorized Data Rate.\nNOTE 16:\tFor GPRS and EPS, the PCRF shall assign an Authorized Guaranteed Data Rate UL/DL value within the limit supported by the serving network.\nNOTE 17:\tThe GCS specific algorithm shall consider various inputs, including the received Reservation-Priority AVP, for deriving the QCI.\nNOTE 18:\tThe MPS specific algorithm shall consider various inputs, including the received MPS-Identifier AVP and Reservation-Priority AVP, for deriving the QCI.\nNOTE 19:\tWhen multiple codecs are supported per media stream (e.g. as part of multi-stream multiparty conferencing media handling are negotiated as described in 3GPP TS 26.114 [29]) the codec specific algorithm shall consider the bandwidth related to each codec when calculating the total bandwidth.\nNOTE 20:\t3GPP TS 26.114 [29] contains examples of how the Authorized Guaranteed Data Rate and Maximum Authorized Data Rate are assumed to be derived for multi-party multimedia conference media handling support. The support of this behaviour is optional.\nNOTE 21:\tFor bandwidth values higher than 2^32-1 bps and if the Extended-BW-NR feature is supported over Gx/Gxx interface, Extended-Max_DR_DL/UL and Extended-Gua_DR_DL/UL shall be derived instead of Max_DR_DL/UL and Gua_DR_DL/UL.\nNOTE 22:\tThe \"live\" uplink streaming algorithm may consider various inputs, including the received FLUS-Identifier AVP, Desired-Max-Latency AVP, Desired-Max-Loss AVP, AF-Application-Identifier AVP and Media-Type AVP for deriving the QCI. When Desired-Max-Latency AVP and/or Desired-Max-Loss AVP are present, non-authority QCI mapping may be done according to table 6.1.7-A in 3GPP TS 23.203 [2].\nNOTE 23:\tThe algorithm to support applications with specific QoS hints (e.g. loss and/or latency demands) may consider various inputs, including the received Desired-Max-Latency AVP, Desired-Max-Loss AVP and AF-Application-Identifier AVP for deriving the QCI, as shown in table E.0 in 3GPP TS 26.114 [29]. Non-authority QCI mapping may be done according to table 6.1.7-A in 3GPP TS 23.203 [2].\nThe PCRF should per ongoing session store the Authorized IP QoS parameters per for each IP flow or bidirectional combination of IP flows (as described within a Media Subcomponent AVP).\nIf the PCRF provides a QoS-Information AVP within a Charging-Rule-Definition AVP it may apply the rules in table 6.3.2 to combine the Authorized QoS per IP flow or bidirectional combination of IP flows (as derived according to table 6.3.1) for all IP flows described by the corresponding PCC rule.\nIf the PCRF provides a QoS-Information AVP for an entire IP CAN bearer (for a UE-initiated IP-CAN bearer in the GPRS case) or IP CAN session, it may apply the rules in table 6.3.2 to combine the Authorized QoS per IP flow or bidirectional combination of IP flows (as derived according to table 6.3.1) for all IP flows allowed to be transported within the IP CAN bearer or session. It is recommended that the rules in table 6.3.2 are applied for all IP flows with corresponding AF session. The PCRF may increase the authorized QoS further to take into account the requirements of predefined PCC rules without ongoing AF sessions.\nNOTE 1:\tQoS-Information AVP provided at IP-CAN session level is not derived based on mapping tables, but based on subscription and operator specific policies.\nNOTE 2:\tAllocation-Retention-Priority AVP is always calculated at PCC rule level according to table 6.3.2.\nFor a UE initiated PDP context within GPRS, the PCRF applies the binding mechanism described in clause 5 to decide which flows are allowed to be transported within the IP CAN bearer.\nTable 6.3.2: Rules for calculating the Maximum Authorized/Guaranteed Data Rates,QCI and ARP in the PCRF\nAuthorized IP QoS Parameter\nCalculation Rule\nMaximum Authorized Data Rate DL and UL\n(see NOTE 6)\nMaximum Authorized Data Rate DL/UL is the sum of all Maximum Authorized Data Rate DL/UL for all the IP flows or bidirectional combinations of IP flows (as according to table 6.3.1).IF Network = GPRS AND Maximum Authorized Data Rate DL/UL > 256 Mbps THEN   Maximum Authorized Data Rate DL/UL = 256 Mbps  /* See 3GPP TS 23.107 [4] */ENDIF;\nGuaranteed Authorized Data Rate DL and UL\n(see NOTE 3,6)\nGuaranteed Authorized Data Rate DL/UL is the sum of all Guaranteed Authorized Data Rate DL/UL for all the IP flows or bidirectional combinations of IP flows (as according to table 6.3.1).\nQCI\nQCI = MAX [needed QoS parameters per IP flow or bidirectional combination of IP flows (as operator’s defined criteria) among all the IP flows or bidirectional combinations of IP flows.]\nARP\n(see NOTE 1)\nIF an operator special policy exists THEN\nARP:= as defined by operator specific algorithm;\nELSE IF MPS-Identifier AVP demands MPS specific ARP handling THEN\nARP:= as defined by MPS specific algorithm (NOTE 2);\nELSE IF GCS-Identifier AVP demands Group Communication Service specific ARP handling THEN\nARP:= as defined by GCS specific algorithm (NOTE 4);\nELSE IF MCPTT-Identifier AVP demands MCPTT specific ARP handling THEN\nARP:= as defined by MCPTT specific algorithm (NOTE 5);\nELSE IF MCVideo-Identifier AVP demands MCVideo specific ARP handling THEN\nARP:= as defined by MCVideo specific algorithm (NOTE 7);\nELSE  IF AF-Application-Identifier AVP demands application specific ARP\nhandling THEN\nARP:= as defined by application specific algorithm;\nELSE IF Reservation-Priority AVP demands application specific ARP handling THEN\nARP:= as defined by application specific algorithm;\nENDIF;\nNOTE 1:\tThe ARP priority levels 1-8 should only be assigned to resources for services that are authorized to receive prioritized treatment within an operator domain.\nNOTE 2:\tThe MPS specific algorithm shall consider various inputs, including the received MPS-Identifier AVP and Reservation-Priority AVP, for deriving the ARP.\nNOTE 3:\tFor GPRS and EPS, the PCRF may check that the Guaranteed Authorized Data Rate DL/UL does not exceed the limit supported by the serving network to minimize the risk of rejection of the bearer by the serving network.\nNOTE 4:\tThe GCS specific algorithm shall consider various inputs, including the received Reservation-Priority AVP, for deriving the ARP.\nNOTE 5:\tThe MCPTT specific algorithm shall consider the value of the MCPTT-Identifier AVP and the value of the Reservation-Priority AVP.\nNOTE 6:\tFor bandwidth values higher than 2^32-1 bps and if the Extended-BW-NR feature is supported, Extended Guaranteed Authorized Data Rate DL/UL and Extended Maximum Data Rated DL/UL shall be used instead of Maximum Authorized Data Rate DL/UL and Guaranteed Authorized Data Rate DL/UL.\nNOTE 7:\tThe MCVideo specific algorithm shall consider the value of the MCVideo-Identifier AVP and the value of the Reservation-Priority AVP.",
      "chunk_type": "parameter",
      "cross_references": [
        "clause_5",
        "table_6.3.1",
        "ts_23.203_table_6.1.7",
        "table_6.3.2",
        "ts_29.214",
        "ts_26.234",
        "ts_26.114",
        "ts_23.107",
        "ts_23.203",
        "ts_29.212",
        "ts_23.216",
        "ts_26.247"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.4.1.1",
      "section_id": "6.4.1.1",
      "section_title": "Authorized IP QoS parameters per PDP Context to Authorized UMTS QoS parameters mapping in GGSN",
      "content": "The Translation/Mapping function in the GGSN shall derive the Authorized UMTS QoS parameters from the Authorized IP QoS parameters received from the PCRF according to the rules in table 6.4.1.\nTable 6.4.1: Rules for derivation of the Authorized UMTS QoS Parameters per PDP contextfrom the Authorized IP QoS Parameters in GGSN\nAuthorized UMTS QoS Parameter per PDP context\nDerivation from Authorized IP QoS Parameters\nMaximum Authorized Bandwidth DL and UL per PDP context\n(see NOTE 2)\nMaximum Authorized Bandwidth DL/UL per PDP context = Maximum Authorized Data Rate DL/UL\nGuaranteed Authorized Data Rate DL and UL per PDP context\nGuaranteed Authorized Data Rate DL/UL per PDP context = Guaranteed Authorized Data Rate DL/UL\nMaximum Authorized Traffic Class per PDP context\nIF QCI = 1 OR 2 THEN     Maximum Authorized Traffic Class = “Conversational”ELSEIF QCI = 3 OR 4 THEN     Maximum Authorized Traffic Class = “Streaming”ELSEIF QCI = 5 OR 6 OR 7 OR 8 THEN     Maximum Authorized Traffic Class = “Interactive”;ELSE Maximum Authorized Traffic Class = “Background”ENDIF ;\nTraffic Handling Priority\nIF QCI = 5 OR 6 THEN\nMaximum Authorized Traffic Handling Priority = “1”;\nELSE IF QCI = 7 THEN\nMaximum Authorized Traffic Handling Priority = “2”;\nELSE IF QCI = 8 THEN\nMaximum Authorized Traffic Handling Priority = “3”;\nELSE the GGSN shall not derive Traffic Handling Priority\nENDIF ;\nSignalling Indication\nIF QCI = 5 THEN\nSignalling Indication = “Yes”;\nELSE IF QCI = 6 OR 7 OR 8 THEN\nSignalling Indication = “No”;\nELSE the GGSN shall not derive Signalling Indication\nENDIF ;\nSource Statistics Descriptor\nIF QCI = (1 OR 3) THEN\nSource Statistics Descriptor = “speech”;\nELSE IF QCI = 2 OR 4 THEN\nSource Statistics Descriptor = “unknown”;\nELSE the GGSN shall not derive Source Statistics Descriptor\nENDIF ;\nEvolved Allocation/Retention Priority\n(see NOTE 1)\nEvolved Allocation/Retention Priority  = Allocation-Retention-Priority as follows :\nPL := Priority-Level ;\nPVI := Pre-emption-Vulnerability ;\nPCI := Pre-emption-Capability ;\nAPN-AMBR UL and DL\nFor non-GBR PDP Contexts, APN-AMBR DL/UL = APN-Aggregate-Max-Bitrate DL/UL\nNOTE 1:   Evolved Allocation/Retention Priority is derived only if supported by the SGSN.\nNOTE 2:   When APN-AMBR is supported in GPRS and the PCEF performs the bearer binding, the MBR for non-GBR\nPDP-Contexts is not derived",
      "chunk_type": "parameter",
      "cross_references": [
        "table_6.4.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.4.1.2",
      "section_id": "6.4.1.2",
      "section_title": "Comparing UMTS QoS Parameters against the Authorized UMTS QoS parameters in GGSN for UE initiated PDP context",
      "content": "Upon receiving a PDP context activation, the GGSN requests PCC rules from the PCRF (see 3GPP TS 29.212 [9] for details). The PCRF may supply Authorized IP QoS Parameters per PDP context together with the PCC rules. The GGSN maps the Authorized IP QoS parameters per PDP Context to Authorized UMTS QoS parameters according to subclause 6.4.1.1 and then compares the requested UMTS QoS parameters against the corresponding Authorized UMTS QoS parameters. The following criteria shall be fulfilled:\n-\tIf the requested Guaranteed Bitrate DL/UL (if the requested Traffic Class is Conversational or Streaming) is equal to the Authorized Guaranteed data rate DL/UL; and\n-\tif received, the requested Maximum Bitrate DL/UL (if the requested Traffic Class is Interactive or Background) is equal to Maximum Authorized data rate DL/UL; and\n-\tthe requested Traffic Class is equal to Maximum Authorized Traffic Class; and.\n-\tif received, the requested Evolved Allocation/Retention Priority is equal to Allocation-Retention-Priority.\n-\tif received, the requested APN-AMBR DL/UL is equal to the APN-Aggregate-Max-Bitrate DL/UL.\nThen, the GGSN shall accept the PDP context activation or modification with the UE requested parameters.Otherwise, the GGSN is adjusted (downgrade or upgrade) the requested UMTS QoS parameters to the values that were authorized.",
      "chunk_type": "parameter",
      "cross_references": [
        "clause_6.4.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.4.2.1",
      "section_id": "6.4.2.1",
      "section_title": "Authorized IP QoS parameters per PDP Context to Authorized UMTS QoS parameters mapping in P-GW.",
      "content": "This Translation/Mapping function in the P-GW applies when the P-GW interacts with a Gn/Gp SGSN.\nThe Translation/Mapping function in the P-GW shall derive the Authorized UMTS QoS parameters from the Authorized IP QoS parameters derived for the bearer applying the rules in table 6.4.2.\nTable 6.4.2: Rules for derivation of the Authorized UMTS QoS Parameters per PDP contextfrom the Authorized IP QoS Parameters in P-GW.\nAuthorized UMTS QoS Parameter per PDP context\nDerivation from Authorized IP QoS Parameters\nMaximum Authorized Bandwidth DL and UL per PDP context\n(see NOTE 2)\nFor non-GBR bearers, Maximum Authorized Bandwidth DL/UL per PDP context = APN-Aggregate-Max-Bitrate DL/UL\nFor GBR bearers, Maximum Authorized Bandwidth DL/UL per PDP context = Sum of Maximum Authorized Data Rate DL/UL for all PCC Rules bound to that bearer\nGuaranteed Authorized Data Rate DL and UL per PDP context\nGuaranteed Authorized Data Rate DL/UL per PDP context = Sum of Guaranteed Authorized Data Rate DL/UL for all PCC Rules bound to that bearer\nMaximum Authorized Traffic Class per PDP context\nIF QCI = 1 OR 2 OR 3 THEN     Maximum Authorized Traffic Class = “Conversational”ELSEIF QCI = 4 THEN     Maximum Authorized Traffic Class = “Streaming”ELSEIF QCI = 5 OR 6 OR 7 OR 8 THEN     Maximum Authorized Traffic Class = “Interactive”;ELSE Maximum Authorized Traffic Class = “Background”ENDIF ;\nTraffic Handling Priority\nIF QCI = 5 OR 6 THEN\nMaximum Authorized Traffic Handling Priority = “1”;\nELSE IF QCI = 7 THEN\nMaximum Authorized Traffic Handling Priority = “2”;\nELSE IF QCI = 8 THEN\nMaximum Authorized Traffic Handling Priority = “3”;\nELSE the P-GW shall not derive Traffic Handling Priority\nENDIF ;\nSignalling Indication\nIF QCI = 5 THEN\nSignalling Indication = “Yes”;\nELSE IF QCI = 6 OR 7 OR 8 THEN\nSignalling Indication = “No”;\nELSE the P-GW shall not derive Signalling Indication\nENDIF ;\nSource Statistics Descriptor\nIF QCI = 1 THEN\nSource Statistics Descriptor = “speech”;\nELSE IF QCI = 2 OR 3 OR 4 THEN\nSource Statistics Descriptor = “unknown”;\nELSE the P-GW shall not derive Source Statistics Descriptor\nENDIF ;\nAPN-AMBR DL and UL\n(see NOTE 3)\nFor non-GBR bearers, APN-AMBR = APN-Aggregate-Max-Bitrate DL/UL\nTransfer Delay\n(see NOTE 1)\nIF QCI = 2 THEN\nTransfer Delay = 150 ms\nELSE IF QCI = 3 THEN\nTransfer Delay >= 80 ms\nELSE IF QCI = 1 OR 4 the P-GW shall set the Transfer Delay as the Packet Delay Budget for that QCI\nELSE the P-GW shall not derive Transfer Delay.\nENDIF ;\nEvolved Allocation/Retention Priority\n(see NOTE 4)\nEvolved Allocation/Retention Priority  = Allocation-Retention-Priority as follows :\nPL := Priority-Level ;\nPVI := Pre-emption-Vulnerability ;\nPCI := Pre-emption-Capability ;\nNOTE 1:   Recommended Packet Delay Budget values for the different QCI values are defined in subclause 6.1.7,3GPP TS 23.203 [2].\nNOTE 2:   For non-GBR bearers, applicable only if APN-AMBR is not supported by the SGSN.\nNOTE 3:   Applicable to all non-GBR PDP-Contexts when supported by the SGSN.\nNOTE 4:   Evolved Allocation/Retention Priority is derived only if supported by the SGSN.",
      "chunk_type": "parameter",
      "cross_references": [
        "ts_23.203_clause_6.1.7",
        "table_6.4.2",
        "ts_23.203"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.4.2.2",
      "section_id": "6.4.2.2",
      "section_title": "Comparing UMTS QoS Parameters against the Authorized UMTS QoS parameters in P-GW for UE initiated PDP context",
      "content": "Upon receiving a PDP context activation, the P-GW requests PCC rules from the PCRF (see 3GPP TS 29.212 [9] for details). The PCRF may supply Authorized IP QoS Parameters applicable for the provided PCC rules. The P-GW calculates the Authorized IP QoS parameters per bearer and maps the Authorized IP QoS parameters per bearer to Authorized UMTS QoS parameters according to subclause 6.4.2.1 and then compares the requested UMTS QoS parameters against the corresponding Authorized UMTS QoS parameters. The following criteria shall be fulfilled:\n-\tIf the requested Guaranteed Bitrate DL/UL (if the requested Traffic Class is Conversational or Streaming) is equal to the Authorized Guaranteed data rate DL/UL; and\n-\tthe requested Maximum Bitrate DL/UL (if the requested Traffic Class is Interactive or Background) is equal to Maximum Authorized data rate DL/UL; and\n-\tthe requested Traffic Class is equal to Maximum Authorized Traffic Class; and\n-\tif received, the requested Evolved Allocation/Retention Priority is equal to Allocation-Retention-Priority.\nThen, the P-GW shall accept the PDP context activation with the UE requested parameters. Otherwise, the P-GW shall accept the request and adjust (downgrade or upgrade) the requested UMTS QoS parameters to the values that were authorized.",
      "chunk_type": "parameter",
      "cross_references": [
        "clause_6.4.2.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.5",
      "section_id": "6.5",
      "section_title": "QoS parameter mapping Functions at UE for a UE-initiated GPRS PDP Context",
      "content": "Figure 6.5.1 indicates the entities participating in the generation of the requested QoS parameters when the UE activates or modifies a PDP Context. The steps are:\n1.\tThe Application provides the UMTS BS Manager, possibly via the IP BS Manager and the Translation/Mapping function, with relevant information to perform step 2 or step 4. (Not subject to standardization within 3GPP).\n2.\tIf needed, information from step 1 is used to access a proper set of UMTS QoS Parameters. See 3GPP TS 26.114 [29] for Conversational Codec Applications and 3GPP TS 26.234 [6] for Streaming Codec Applications.\n3.\tIf SDP is available then the SDP Parameters should give guidance for the UMTS BS Manager (possibly via the IP Manager and the Translation/Mapping function) ,according to the rules in clause 6.5.1, to set the Maximum Bitrate UL/DL and the Guaranteed Bitrate UL/DL. Furthermore the Maximum Authorized Bandwidth UL/DL and Maximum Authorised Traffic Class should be derived according to the rules in clause 6.5.2.\n4.\tA set of UMTS QoS Parameters values from step 2 (or directly from step 1) is possibly merged together with the Maximum Bitrate UL/DL and the Guaranteed Bitrate UL/DL from step 3. The result should constitute the requested UMTS QoS Parameters. The UE should check that the requested Guaranteed Bitrate UL/DL or requested Maximum Bitrate UL/DL (depending on the requested Traffic Class) does not exceed the Maximum Authorized Bandwidth UL/DL derived in step 3. Furthermore, if the UE has implemented the mapping rule for Maximum Authorized Traffic Class, as defined in clause 6.5.2, the UE should check that the requested Traffic Class does not exceed the Maximum Authorised Traffic Class derived in step 3.\nFigure 6.5.1: Framework for generating requested QoS parameters in the UE",
      "chunk_type": "parameter",
      "cross_references": [
        "clause_6.5.1",
        "clause_6.5.2",
        "figure_6.5.1",
        "ts_26.114",
        "ts_26.234"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.5.1",
      "section_id": "6.5.1",
      "section_title": "SDP to UMTS QoS parameter mapping in UE",
      "content": "If SDP Parameters are available, then before activating or modifying a PDP Context the UE should check if the SDP Parameters give guidance for setting the requested UMTS QoS Parameters. The UE should use the mapping rule in table 6.5.1.1 to derive the Maximum and Guaranteed Bitrate DL/UL from the SDP Parameters.\nTable 6.5.1.1: Recommended rules for derivation of the requested Maximumand Guaranteed Bitrate DL/UL per media component in the UE\nUMTS QoS Parameter per media component\nDerivation from SDP Parameters\nMaximum Bitrate DL/UL andGuaranteed Bitrate DL/UL per media component\n/* Check if the media use codec(s) */IF [(<media> = (“audio” or “video”)) and (<transport> = “RTP/AVP”)] THEN    /* Check if Streaming */     IF a= (“sendonly” or “recvonly”) THEN        Maximum Bitrate DL/UL and Guaranteed Bitrate DL/UL per media component as specified in 3GPP TS 26.234 [6] ;    /* Conversational as default !*/     ELSE        Maximum Bitrate DL/UL and Guaranteed Bitrate DL/UL per media component as specified in reference 3GPP TS 26.114 [29] ;    ENDIF ; /* Check for presence of bandwidth attribute for each media component */ELSEIF b=AS:<bandwidth-value> is present THEN    IF media stream only downlink THEN\nMaximum Bitrate DL = Guaranteed Bitrate DL =<bandwidth-value >;\nELSEIF mediastream only uplink THEN\nMaximum Bitrate UL = Guaranteed Bitrate UL =<bandwidth-value >;\nELSEIF mediastreams both downlink and uplink THEN\nMaximum Bitrate DL = Guaranteed Bitrate DL =<bandwidth-value >;\nMaximum Bitrate UL = Guaranteed Bitrate UL =<bandwidth-value >;\nENDIF;\nELSE/* SDP does not give any guidance ! */Maximum Bitrate DL/UL and Guaranteed Bitrate DL/UL per media component as specified by the UE manufacturer; ENDIF ;",
      "chunk_type": "parameter",
      "cross_references": [
        "table_6.5.1.1",
        "ts_26.234",
        "ts_26.114"
      ]
    },
    {
      "chunk_id": "ts_29.213_6.5.2",
      "section_id": "6.5.2",
      "section_title": "SDP parameters to Authorized UMTS QoS parameters mapping in UE",
      "content": "If the PDP Context is activated or modified the UE should use the mapping rules in table 6.5.2.1 for all applications using SDP to derive the Maximum Authorized Bandwidth UL/DL per IP flow or bidirectional combinations of IP flows.\nTable 6.5.2.1 also has a mapping rule for derivation of Maximum Authorized Traffic Class per IP flow or bidirectional combinations of IP flows which applies for session initiation and modification.\nIn future releases this mapping rule may change.\nIn the case of forking, the various forked responses may have different QoS requirements for the same IP flows of a media component. When the Authorized UMTS QoS Parameters are used by the UE, they shall be set equal to the highest values requested for the IP flows of that media component by any of the active forked responses. The UE should use the mapping rule in table 6.5.2.1 for each forked response.\nTable 6.5.2.1: Rules for derivation of the Maximum Authorized Bandwidth DL/UL andthe Maximum Authorized Traffic Class per IP flow or bidirectional combination of IP flows in the UE\nAuthorized UMTS QoS Parameter\nDerivation from SDP Parameters(see Note 4)\nMaximum Authorized Bandwidth DL (Max_BW_DL) and UL (Max_BW_UL)(see NOTE 5)\nIF a=recvonly THEN\nIF <SDP direction> = mobile originated THEN\nDirection:= downlink;\nELSE /* mobile terminated */\nDirection:= uplink;\nENDIF;\nELSE /* a!= recvonly */\nIF a=sendonly THEN\nIF <SDP direction> = mobile originated THEN\nDirection: = uplink;\nELSE /* mobile terminated */\nDirection:= downlink;\nENDIF;\nELSE /*sendrecv, inactive or no direction attribute*/\nDirection:=both;\nENDIF;\nENDIF;\n/* Max_BW_UL and Max_BW_DL */\nIF media IP flow(s) THEN\nIF bAS=AS:<bandwidth> is present and\n( bTIAS=TIAS:<Tibandwidth> is not present or\nis present but not supported ) THEN\nIF Direction=downlink THEN\nMax_BW_UL:= 0;\nMax_BW_DL:= bAS;\nELSE\nIF Direction=uplink THEN\nMax_BW_UL := bAS ;\nMax_BW_DL := 0 ;\nELSE /*Direction=both*/\nMax_BW_UL:= bAS;\nMax_BW_DL := bAS ;\nENDIF ;\nENDIF;\nELSE\nIF bTIAS=TIAS:<Tibandwidth> is present and supported THEN\nbTDBW= bTIAS + transport-overhead; (NOTE 6)\nIF Direction=downlink THEN\nMax_BW_UL:= 0;\nMax_BW_DL:= bTDBW; (NOTE 6)\nELSE\nIF Direction=uplink THEN\nMax_BW_UL:= bTDBW; (NOTE 6)\nMax_BW_DL:= 0;\nELSE /*Direction=both*/\nMax_BW_UL:= bTDBW; (NOTE 6)\nMax_BW_DL:= bTDBW; (NOTE 6)\nENDIF;\nENDIF;\nELSE /* bTIAS=TIAS:<Tibandwidth> is NOT present or is present but not           supported*/\nbw:= as set by the UE manufacturer;\nIF Direction=downlink THEN\nMax_BW_UL:= 0;\nMax_BW_DL:= bw;\nELSE\nIF Direction=uplink THEN\nMax_BW_UL:= bw;\nMax_BW_DL:= 0;\nELSE /*Direction=both*/\nMax_BW_UL:= bw;\nMax_BW_DL:= bw;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nELSE /* RTCP IP flow(s) */\nIF bRS=RS:<bandwidth> and bRR=RR:<bandwidth> is present THEN     Max_BW_UL:= (bRS + bRR) / 1000;    Max_BW_DL:= (bRS + bRR) / 1000;  ELSE    IF bAS=AS:<bandwidth> is present and\n( bTIAS=TIAS:<Tibandwidth> is not present or         is present but not supported ) THEN\nIF bRS=RS:<bandwidth> is present and bRR=RR:<bandwidth> is not present\nTHEN\nMax_BW_UL := MAX[0.05 * bAS, bRS / 1000] ;        Max_BW_DL := MAX[0.05 * bAS, bRS / 1000] ;\nENDIF;\nIF bRS=RS:<bandwidth> is not present and bRR=RR:<bandwidth> is present\nTHEN\nMax_BW_UL:= MAX[0.05 * bAS, bRR / 1000];        Max_BW_DL:= MAX[0.05 * bAS, bRR / 1000];\nENDIF;\nIF bRS=RS:<bandwidth> and bRR=RR:<bandwidth> is not present THEN\nMax_BW_UL := 0.05 * bAS ;          Max_BW_DL := 0.05 * bAS ;\nENDIF;\nELSE\nIF bTIAS=TIAS:<Tibandwidth> is present and supported THEN\nbTDBW= bTIAS + transport-overhead; (NOTE 6)\nIF bRS=RS:<bandwidth> is present and\nbRR=RR:<bandwidth> is not present THEN          Max_BW_UL:= MAX[0.05 * bTDBW, bRS]/1000;          Max_BW_DL:= MAX[0.05 * bTDBW, bRS]/1000;\nENDIF;\nIF bRS=RS:<bandwidth> is not present and\nbRR=RR:<bandwidth> is present THEN\nMax_BW_UL:= MAX[0.05 * bTDBW, bRR]/1000;          Max_BW_DL:= MAX[0.05 * bTDBW, bRR]/1000;\nENDIF;\nIF bRS=RS:<bandwidth> and\nbRR=RR:<bandwidth> is not present THEN\nMax_BW_UL:= 0.05 * bTDBW /1000;          Max_BW_DL:= 0.05 * bTDBW /1000;\nENDIF;\nELSE\nMax_BW_UL:= as set by the UE manufacture;\nMax_BW_DL:= as set by the UE manufacture;\nENDIF;\nENDIF;\nENDIF;\nENDIF;\nMaximum Authorized Traffic Class [MaxTrafficClass] (see NOTE 1, 2 and3)\nIF (all media IP flows of media type “audio”  or  “video” for the session are\nunidirectional and have the same direction) THEN\nMaxService:= streaming;\nELSE\nMaxService:= conversational;\nENDIF;\nCASE <media> OF\n“audio”:         MaxTrafficClass:= MaxService;\n“video”:         MaxTrafficClass:= MaxService;\n“application”:   MaxTrafficClass:=conversational;\n“data”:          MaxTrafficClass:=interactive with priority 3;\n“control”:       MaxTrafficClass:=interactive with priority 1;\n/*new media type*/\nOTHERWISE:       MaxTrafficClass:=background;\nEND;\nNOTE 1:\tThe Maximum Authorized Traffic Class for a RTCP IP flow is the same as for the corresponding RTP media IP flow.\nNOTE 2:\tWhen audio or video IP flow(s) are removed from a session, the parameter MaxService shall keep the originally assigned value.\nNOTE 3:\tWhen audio or video IP flow(s) are added to a session, the UE shall derive the parameter MaxService  taking into account the already existing media IP flows within the session.\nNOTE 4:\tThe SDP parameters are described in RFC 2327 [11].\nNOTE 5:\tThe ‘b=RS:’ and ‘b=RR:’ SDP bandwidth modifiers are defined in RFC 3556 [13].\nNOTE 6:\tTIAS is defined in IETF RFC 3890 [23]. RFC 3890 clause 6.4 provides procedures for converting TIAS to transport-dependant values. This procedure relies on the presence of maxprate (also defined in RFC 3890).\nThe UE should per ongoing session store the Authorized UMTS QoS parameters per IP flow or bidirectional combination of IP flows.\nBefore activating or modifying a PDP context the UE should check that the requested Guaranteed Bitrate UL/DL (if the Traffic Class is Conversational or Streaming) or the requested Maximum Bitrate UL/DL (if the Traffic Class is Interactive or Background) does not exceed the Maximum Authorized Bandwidth UL/DL per PDP context (calculated according to the rule in table 6.5.2.2). If the requested Guaranteed Bitrate UL/DL or the requested Maximum Bitrate UL/DL exceeds the Maximum Authorized Bandwidth UL/DL per PDP context, the UE should reduce the requested Guaranteed Bitrate UL/DL or the requested Maximum Bitrate UL/DL to the Maximum Authorized Bandwidth UL/DL per PDP context. Furthermore, if the rule in table 6.5.2.1 for calculating Traffic Class per IP flow or bdirectional combination of IP flows is implemented, the UE should check that the requested UMTS QoS parameter Traffic Class does not exceed the Maximum Authorized Traffic Class per PDP context (calculated according to the rule in table 6.5.2.2). If the requested UMTS QoS parameter Traffic Class exceeds the Maximum Authorized Traffic Class per PDP context, the UE should reduce the requested UMTS QoS parameter Traffic Class to the Maximum Authorized Traffic Class per PDP context.\nTable 6.5.2.2: Rules for calculating the Maximum Authorized Bandwidthsand Maximum Authorized Traffic Class per PDP Context in the UE\nAuthorized UMTS QoS Parameter per PDP Context\nCalculation Rule\nMaximum Authorized Bandwidth DL and UL per PDP Context\nMaximum Authorized Bandwidth DL/UL per PDP Context is the sum of all Maximum Authorized Bandwidth DL/UL for all the IP flows or bidirectional combinations\nof IP flows (as derived according to table 6.5.2.1) associated with that PDP\nContext ;IF Maximum Authorized Bandwidth DL/UL per PDP Context > 256 Mbps THEN   Maximum Authorized Bandwidth DL/UL per PDP Context = 256 Mbps\n/* See 3GPP TS 23.107 [4] */END;\nMaximum Authorized Traffic Class per PDP Context\nMaximum Authorised Traffic Class per PDP Context = MAX [Maximum Authorized QoS Class per IP flow or bidirectional combination of IP flows (as derived according to table 6.5.2.1) among all the IP flows or bidirectional combinations of IP flows associated with that PDP Context] ;(The MAX function ranks the possible Maximum Authorised Traffic Class values as follows: Conversational > Streaming > Interactive with priority 1 > Interactive with priority 2 > Interactive with priority 3 > Background)",
      "chunk_type": "parameter",
      "cross_references": [
        "clause_6.4",
        "table_6.5.2.1",
        "table_6.5.2.2",
        "ts_23.107"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.1",
      "section_id": "7.1",
      "section_title": "General",
      "content": "The PCRF discovery procedures are needed where more than one PCRF is present in an operator’s network realm. Within such a deployment, an additional functional element, called DRA, is needed. PCRF discovery procedures include all the procedures that involve a DRA functional element.\nRouting of Diameter messages from a network element towards the right Diameter realm in a PLMN is based on standard Diameter realm-based routing, as specified in IETF RFC 6733 [61] using the UE-NAI domain part. If PLMN is separated into multiple realms based on PDN information or IP address range (if applicable); the PDN information available in the Called-Station-Id AVP, or the UE’s Ipv4 address available in the Framed-IP-Address AVP or the UE’s Ipv6 address or prefix provided within the Framed-Ipv6-Prefix AVP may be used to assist routing PCC message to the appropriate Diameter realm.\nThe DRA keeps status of the assigned PCRF for a certain UE and IP-CAN session across all reference points, e.g. Gx, Gxx, S9, Rx and for unsolicited application reporting, the Sd interfaces.\nThe DRA shall support the functionality of a proxy agent and a redirect agent as defined in IETF RFC 6733 [61]. The mode in which it operates (i.e. proxy or redirect) shall be based on operator’s requirements.\nDiameter clients of the DRA, i.e. AF, PCEF, BBERF, RCAF and PCRF in roaming scenarios shall support all procedures required to properly interoperate with the DRA in both the proxy and redirect modes.\nNOTE: The proxy mode includes two variants:\nPA1:\tProxy agent based on the standard Diameter proxy agent functionality. All the messages need to go through the DRA.\nPA2:\tProxy agent based on the standard Diameter proxy agent functionality. Session establishment messages always go through the DRA. Gx, Gxx and S9 session termination messages always go through the DRA. All other messages bypass the DRA.",
      "chunk_type": "definition",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.2",
      "section_id": "7.2",
      "section_title": "DRA Definition",
      "content": "The DRA (Diameter Routing Agent) is a functional element that ensures that all Diameter sessions established over the Gx, S9, Gxx, Rx interfaces and for unsolicited application reporting, the Sd interface for a certain IP-CAN session reach the same PCRF when multiple and separately addressable PCRFs have been deployed in a Diameter realm. The DRA also ensures that the NRR commands over Np interface reach the same PCRF for a certain IP-CAN session. The DRA is not required in a network that deploys a single PCRF per Diameter realm.",
      "chunk_type": "definition",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.3.1",
      "section_id": "7.3.1",
      "section_title": "General",
      "content": "A DRA implemented as a Diameter Redirect Agent or a Diameter Proxy Agent shall be compliant to IETF RFC 6733 [61], except when noted otherwise in this document.",
      "chunk_type": "definition",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.3.2",
      "section_id": "7.3.2",
      "section_title": "DRA Information Storage",
      "content": "The DRA shall maintain PCRF routing information per IP-CAN session or per UE-NAI, depending on the operator’s configuration.\nThe DRA shall select the same PCRF for all the Diameter sessions established for the same UE in case 2a.\nAs there’s only one S9 session per UE, the V-DRA/H-DRA shall select the same V-PCRF/H-PCRF respectively for the same UE in the roaming case.\nThe DRA has information about the user identity (UE NAI), the UE Ipv4 address and/or Ipv6 prefix, the APN (if available), the PCEF identity (if available) and the selected PCRF identity for a certain IP-CAN Session.\nNOTE 1:\tThe DRA derives the PCEF identity from the Origin-Host AVP of the CCR command received from the PCEF.\nThe DRA finds the correct PCRF by matching the user identity (if available), IPv4 address or IPv6 address/prefix (if available) and APN (if available) received in the message from the BBERF/PCEF/AF/TDF/ RCAF/V-PCRF with the corresponding information stored the DRA.\nNOTE 2:\tIf the DRA does not use the IP address to find the PCRF and the user identity in the IP‑CAN and the application level identity for the user are of different kinds (e.g. user identity is the IP-CAN is IMSI and application level identity for the user is SIPURI), the DRA needs to maintain, or have access to, the mapping between the identities. Such mapping is not subject to specification within this TS.\nNOTE 3:\tAn IPv6 address provided over Rx matches an IPv6 prefix stored in the DRA binding if the IPv6 address belongs to the IPv6 (sub-)network prefix.\nWhen matching the APNs to each other, the DRA shall apply the procedures in Annex I.\nFor the PCRF selection over the Rx reference point, the DRA may additionally match the IP domain Id received in the message from the AF with the PCEF identity stored in the DRA to find the correct PCRF.\nNOTE 4:\tIn order to correlate the PCEF Identity and the domain identity, the DRA uses configured mapping between those identities.\nFor the PCRF selection over the Rx reference point, when the APN related to the IP-CAN session is dedicated for the purpose of offering services to remote UEs via a ProSe UE-to-network relay UE, the DRA shall use the UE IPv6 prefix alone to find the correct PCRF.\nThe PCRF routing information stored for an IP-CAN session in the DRA shall be removed after the IP-CAN session is terminated. In case of DRA change (e.g. inter-operator handover), the information about the IP-CAN session stored in the old DRA shall be removed.\nThe PCRF routing information stored per UE in the DRA may be removed when no more IP-CAN and gateway control sessions are active for the UE.",
      "chunk_type": "requirement",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.3.3",
      "section_id": "7.3.3",
      "section_title": "Capabilities Exchange",
      "content": "In addition to the capabilities exchange procedures defined in IETF RFC 6733 [61], the Redirect DRA and Proxy DRA shall advertise the specific applications it supports (e.g., Gx, Gxx, Rx, Np,S9 and for unsolicited application reporting, Sd) by including the value of the application identifier in the Auth-Application-Id AVP and the value of the 3GPP (10415) in the Vendor-Id AVP of the Vendor-Specific-Application-Id AVP contained in the Capabilities‑Exchange-Request and Capabilities-Exchange-Answer commands.",
      "chunk_type": "requirement",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.3.4.1",
      "section_id": "7.3.4.1",
      "section_title": "Redirecting Diameter Requests",
      "content": "A DRA implemented as a Diameter redirect agent shall redirect the received Diameter request message by carrying out the procedures defined in clause 6.1.7 of IETF RFC 6733 [61]. The Client shall use the value within the Redirect-Host AVP of the redirect response in order to obtain the PCRF identity. The DRA may provide the Redirect-Host-Usage AVP in the redirect response to provide a hint to the Client about how the cached route table entry created from the Redirect-Host AVP is to be used as described in clause 6.13 of IETF RFC 6733 [61].\nThe two most revelant redirect host usage scenarios for PCC from IETF RFC 6733 [61]are:\n-\tIf the PCRF routing information is per UE-NAI, the DRA shall set the Redirect-Host-Usage AVP to ALL_USER. The DRA client may contact the DRA on IP-CAN session termination.\n-\tIf the PCRF routing information is per IP-CAN session, the DRA shall set the Redirect-Host-Usage AVP to ALL_SESSION. The DRA client shall contact the DRA on IP-CAN session termination.\nThe DRA may also provide the Redirect-Max-Cache-Time AVP in the redirect response to indicate to the Client the lifetime of the cached route table entry created from the Redirect-Host and Redirect-Host-Usage AVP values as described in clause 6.14 of IETF RFC 6733 [61].\nIf the DRA is maintaining PCRF routing information per IP-CAN session, the DRA shall be aware of Gx and Gxx Diameter termination requests as defined in 3GPP TS 29.212 [9] in order to detect whether release of DRA bindings is required. Otherwise the DRA clients shall use cached route table entry created from the Redirect-Host, Redirect-Host-Usage and Redirect-Max-Cache-Time AVPs to determine whether DRA interaction is required.\nThe DRA shall be aware of IP-CAN Session modification requests over Gx which is to update the Ipv4 address of the UE by the PCEF.\nIf the client is the AF, the DRA (redirect) does not need to maintain Diameter sessions and Diameter Base redirect procedures are applicable. Therefore, an AF should not send an AF session termination request to the DRA.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_6.1.7",
        "clause_6.13",
        "clause_6.14",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.4.2",
      "section_id": "7.3.4.2",
      "section_title": "DRA binding removal",
      "content": "If the DRA binding is per IP-CAN session and the IP-CAN session is terminated or if the DRA binding is per UE and the last IP-CAN session is terminated (eg. From an indication by the BBERF/PCEF) the Redirect DRA shall remove the associated DRA binding information and responds with a Diameter redirect answer message.",
      "chunk_type": "general",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.3.5",
      "section_id": "7.3.5",
      "section_title": "Proxy DRA",
      "content": "The DRA shall support the functionality of a Diameter proxy agent as defined in IETF RFC 6733 [61].\nWhen the DRA receives a request from a client, it shall check whether it already has selected a PCRF for the UE or the UE’s IP-CAN session; if it does have a PCRF already selected for that UE or UE’s IP-CAN session, it shall proxy the request to the corresponding PCRF. If the request is an IP-CAN session termination or gateway control session termination, the DRA shall check whether PCRF routing information shall be removed as specified in clause 7.3.3. If the DRA does not have a PCRF already selected, it shall follow one of the procedures below:\n-\tIf the request is an IP-CAN session establishment or gateway control session establishment, it shall select a PCRF to handle all sessions for that UE or UE’s IP-CAN session. It shall then proxy the request to the selected PCRF.\n-\tOtherwise, if the request is not an IP-CAN session establishment or gateway control session establishment, it shall reject the request by returning a DIAMETER_UNABLE_TO_COMPLY error code.\nIf a DRA is deployed in a PCRF’s realm, clients of the DRA shall send the first request of a session to the DRA handling the PCRF’s realm. Clients of the DRA shall as well send IP-CAN session termination and gateway control termination requests to the DRA. A client of the DRA shall be capable of sending every message of a session to the DRA. A client of the DRA may be configured to bypass the DRA on session modification messages and AF session termination messages by sending these types of messages directly to the PCRF.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_7.3.3"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.6",
      "section_id": "7.3.6",
      "section_title": "PCRF selection by BBERF/PCEF (non-roaming case)",
      "content": "The PCEF (e.g. P-GW) or BBERF (e.g. Non-3GPP Access, S-GW) shall provide the DRA of the PCRF realm with identity parameters upon the first interaction between the access entity and the PCRF realm.\nIf the redirect agent is used for DRA, the DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the PCEF or the BBERF.\nIf proxy agent is used for DRA, the DRA should use the proxy procedure as specified in IETF RFC 6733 [61]. For PA2 solution (described in clause 7.1), only session establishment, session modification with the UE’s Ipv4 address updated and session termination messages shall be sent through the DRA.\nThe identity parameters from the PCEF or BBERF may comprise the UE’s Ipv4 address in the Framed-IP-Address AVP and/or the UE’s Ipv6 prefix in the Framed-Ipv6-Prefix AVP, PDN information in the Called-Station-Id AVP and user identity in the Subscription-Id AVP.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_7.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.7",
      "section_id": "7.3.7",
      "section_title": "PCRF selection by AF",
      "content": "If the AF has the realm identification (i.e. FQDN from a UE NAI) and is located in the HPLMN, the AF sends the user identity in the Subscription-Id AVP and PDN information (i.e. APN) if available in the Called-Station-Id AVP in a Diameter request to the DRA which acts as a Diameter agent.\nFor an AF serving mission critical communication services (e.g. MCPTT), the AF shall derive the realm of the PCRF based on the IP address and, based on the PLMN ID, construct the Diameter destination realm and use that destination realm in the initial request to address the DRA.\nNOTE 1:\tAn AF serving mission critical communication services as defined in 3GPP TS 23.280 [64] can be independent from a PLMN and is not guaranteed to have any realm identification.\nIf the AF does not have proper knowledge about the user identity and the AF is located in the HPLMN, the AF may use pre-configured information to find the DRA.\nNOTE 1A:\tHow the AF which is a third party or non-IMS application server finds the DRA if it does not have the proper knowledge about the user identity is out of scope of this specification.\nThe AF shall provide the DRA of the PCRF realm with identity parameters upon the first interaction between the AF and the PCRF realm.\nIf redirect agent is used for DRA, the DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the AF.\nIf proxy agent is used for DRA, the DRA should use the proxy procedure as specified in IETF RFC 6733 [61]. For PA2 solution (described in clause 7.1), only AF session establishment messages shall be sent through the DRA.\nThe parameters from the AF may comprise the UE IP address in either the Framed-IP-Address AVP or the Framed-Ipv6-Prefix AVP, PDN information in the Called-Station-Id AVP, user identity in the Subscription-Id AVP and domain Identity in the IP-Domain-Id AVP (3GPP TS 23.203 [2]).\nNOTE 2:\tIn case the user identity in the IP‑CAN and the application level identity for the user are of different kinds (e.g. user identity is the IP-CAN is IMSI and application level identity for the user is SIPURI), the DRA needs to maintain, or have access to, the mapping between the identities. Such mapping is not subject to specification within this TS.",
      "chunk_type": "general",
      "cross_references": [
        "clause_7.1",
        "ts_23.280",
        "ts_23.203"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.8",
      "section_id": "7.3.8",
      "section_title": "PCRF selection in a roaming scenario",
      "content": "In the roaming case, a V-DRA is needed in the visited PLMN when there are more than one PCRFs per realm. The V-DRA will ensure that all the related Diameter sessions for a UE are handled by the same V-PCRF.\nThe BBERF in the visited access and home routed cases, the PCEF in the case of visited access and the AF when located in the visited PLMN may use pre-configured information (e.g. based on PDN) to find the V-DRA, and then find theV-PCRF. Other possible options are Dynamic peer discovery, or DNS-based.\nThe V-PCRF can find the H-DRA based on the UE NAI, and then find the H-PCRF by the H-DRA.\nThe V-PCRF shall provide the H-DRA of the H-PCRF realm with identity parameters upon the first interaction between the V-PCRF and the H-PCRF realm.\nIf redirect agent is used for H-DRA, the H-DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the H-PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the V-PCRF.\nIf proxy agent is used for H-DRA, the H-DRA should use the proxy procedure as specified in IETF RFC 6733 [61]. For PA2 solution (described in clause 7.1), only session establishment, session modification with the UE’s Ipv4 address updated and, only for the Gx, Gxx and S9 interfaces, termination messages shall be sent through the H-DRA.\nThe identity parameters from the V-PCRF may comprise the same parameters sent by the PCEF or the BBERF to the V-PCRF, i.e. the user identity (UE NAI), APN, the UE’s Ipv4 address and/or Ipv6 prefix (3GPP TS 23.203 [2]).\nIf redirect agent or PA2 is used for H-DRA, and the V-PCRF receives establishment message from the AF in the VPLMN, the V-PCRF may send the message to the H-PCRF directly (e.g. based on the stored information provided by H-DRA during the IP-CAN session establishment).",
      "chunk_type": "general",
      "cross_references": [
        "clause_7.1",
        "ts_23.203"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.9",
      "section_id": "7.3.9",
      "section_title": "PCRF selection by TDF for unsolicited application reporting",
      "content": "The TDF uses pre-configured information to find the DRA.\nThe TDF shall provide the DRA of the PCRF realm with identity parameters upon the first interaction between the TDF and the PCRF realm.\nIf redirect agent is used for DRA, the DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the TDF.\nIf proxy agent is used for DRA, the DRA should use the proxy procedure as specified in IETF RFC 6733 [61]. For PA2 solution (described in subclause 7.1), only TDF session establishment messages shall be sent through the DRA.\nThe parameters from the TDF may comprise the UE IP address in either the Framed-IP-Address AVP or the Framed-Ipv6-Prefix AVP and PDN information in the Called-Station-ID AVP.\nNOTE:\tThe TDF located in the HPLMN finds the H-PCRF for the roaming UE with home routed access case. The TDF located in the VPLMN finds the V-PCRF for the roaming UE with visited access case.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_7.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.3.10",
      "section_id": "7.3.10",
      "section_title": "PCRF selection by RCAF",
      "content": "For initial Non-Aggregated RUCI reporting, the RCAF shall provide the identity parameters to the DRA of the PCRF realm.\nThe identity parameters from the RCAF may comprise PDN information in the Called-Station-Id AVP and user identity in the Subscription-Id AVP.\nIn the roaming with home-routed access case, the RCAF can find the H-DRA based on the IMSI, and then find the H-PCRF by the H-DRA.The RCAF shall provide the H-DRA of the H-PCRF realm with identity parameters upon the first interaction between the RCAF and the H-PCRF realm.\nIn the roaming with visited case, the RCAF shall provide the V-DRA of the V-PCRF realm with identity parameters upon the first interaction between the RCAF and the V-PCRF realm.\nIf the redirect agent is used for DRA, the DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the RCAF.\nIf proxy agent is used for DRA, the DRA should use the proxy procedure as specified in IETF RFC 6733 [61].\nFor subsequent non-aggregated or aggregated RUCI reporting, the RCAF shall include the PCRF identity within the Destination-Host AVP for direct PCRF selection. The PCRF identity shall be responded by the PCRF within the PCRF-Address AVP in the initial non-aggregated RUCI reporting, for identifying the same destination PCRF in the subsequent non-aggregated or aggregated RUCI reporting.",
      "chunk_type": "requirement",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_7.4.1.1.1",
      "section_id": "7.4.1.1.1",
      "section_title": "Non-roaming cases",
      "content": "Establishment of Diameter sessions may occur at any of the following cases:\n-\tGateway control establishment\n-\tIP-CAN session establishment\n-\tAF session establishment\n-\tFor unsolicited application reporting, TDF session establishment\nFigure 7.4.1.1.1.1: Establishment of Diameter sessions using DRA (proxy)\n1.\tA Client receives an external trigger (e.g. IP-CAN session establishment request) that requires the establishment of a Diameter session with a PCRF.\n2.\tA Diameter Request (e.g. a Diameter CCR sent by PGW to indicate establishment of an IP-CAN session as defined in clauses 4.5.1, 4a.5.1 of 3GPP TS 29.212 [9]) is sent by the Client and received by a DRA (proxy).\n3.\tThe DRA (proxy) stores the user information (e.g. UE-NAI) and checks whether an active DRA binding exists. If not, the DRA creates a dynamic DRA binding (assignment of a PCRF node per UE or per IP-CAN session).\nNOTE 1:\tWhen the AF establishes an Rx session or TDF establishes a TDF session with the DRA, there is already a DRA binding active.\n4.\tThe DRA (proxy) proxies the Diameter Request to the target PCRF. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tPCRF-1 returns a Diameter Answer as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9] to the DRA (proxy).\n6.\tDRA (proxy) proxies the Diameter Answer to the Client. The proxied Diameter Answer maintains the same Session-Id AVP value.\n7.\tIf PA2 option is implemented, the Client uses the Origin-Host AVP value providedin the Diameter Answer of step 6. This value is the identity of the target PCRF. The client populates the Destination-Host AVP with this address and sends any subsequent Diameter messages directly to this PCRF bypassing the DRA (proxy).\nNOTE 2:\tFigure 7.4.1.1.1.1 is also applicable when the AF/BBERF/PCEF/TDF in the VPLMN contacts the V-DRA to locate the V-PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.1.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.1.2",
      "section_id": "7.4.1.1.2",
      "section_title": "Roaming cases",
      "content": "Establishment of Diameter sessions may occur at any of the following cases:\n-\tV-PCRF initiates S9 Diameter session to H-PCRF\n-\tV-PCRF proxies Rx Diameter session to H-PCRF\nFigure 7.4.1.1.2.1: Establishment of Diameter sessions using DRA (proxy) – Roaming case\n1.\tV-PCRF receives a trigger to establish a Diameter session to H-PCRF (e.g. S9 session establishment request).\n2.\tA Diameter Request involving either the Rx or S9 protocol is sent by the V-PCRF and received by a H-DRA (proxy) in the home PLMN.\n3.\tThe H-DRA (proxy) stores the user information (e.g. UE-NAI) and checks whether an active DRA binding exists. If not, the H-DRA creates a dynamic DRA binding (assignment of a PCRF node per UE or per IP-CAN session).\n4.\tThe H-DRA (proxy) proxies the Diameter Request to the target PCRF in the home PLMN. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tH-PCRF-1 returns a Diameter Answer to the H-DRA (proxy).\n6.\tH-DRA (proxy) proxies the Diameter Answer to the V-PCRF. The proxied Diameter Answer maintains the same Session-Id AVP value.\n7.\tIf PA2 option is implemented, the V-PCRF uses the Origin-Host AVP value provided in the Diameter Answer of step 6. This value is the identity of the target H-PCRF. The V-PCRF populates the Destination-Host AVP with this address and sends any subsequent Diameter messages directly to this H-PCRF bypassing the H-DRA.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.1.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.2.1",
      "section_id": "7.4.1.2.1",
      "section_title": "Non-roaming cases",
      "content": "7.4.1.2.1.1\tClient-initiated\nModification of Diameter sessions may occur in any of the following cases:\n-\tGateway control session modification\n-\tIP-CAN session modification\n-\tAF session modification\n-\tFor unsolicited application reporting, TDF session modification\nIf PA1 option is implemented, only steps 2, 3, 4, 5, 6 are carried out. If PA2 option is implemented, only steps 2a, 5a are carried out.\nFigure 7.4.1.2.1.1.1: Modification of Diameter sessions through DRA (proxy)- AF/BBERF/PCEF/TDF interaction\n1.\tA Client receives an external trigger (e.g. IP-CAN session modification) that requires a subsequent Diameter message to be sent to the PCRF.\n2.\tA subsequent Diameter Request (e.g. a Diameter CCR sent by PGW to indicate modification of an IP-CAN session) as defined in clauses 4.5.1, 4a.5.1 of 3GPP TS 29.212 [9] or clause 4.4 of 3GPP TS 29.214 [10]) is sent by the Client and received by the DRA (proxy).\n2a\tIf PA2 option is implemented, based on Client configuration and operator policy, the Client communicates directly to the PCRF, bypassing the DRA (proxy), by using the PCRF identity obtained through the Origin-Host AVP (see step 7 in clause 5.2.5.7.1.1). The Client uses the same active Session-Id AVP value on the Diameter Request sent to the PCRF. In such a case steps 2, 3, 4, 5, 6 are not carried out.\n3.\tAfter receiving a Diameter Request (Step 2), the DRA (proxy) verifies that there is an active DRA binding for the session identified in the request.\n4.\tThe DRA (proxy) proxies the Diameter Request to the target PCRF.\n5.\tPCRF-1 returns a Diameter Answer as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9] or clause 4.4 of 3GPP TS 29.214 [10]) to the DRA (proxy).\n5a\tUpon receiving a Diameter Request (Step 2a), PCRF-1 returns a Diameter Answer directly to the Client, bypassing the DRA (proxy).\n6.\tDRA (proxy) proxies the Diameter Answer to the Client.\nNOTE:\tFigure 7.4.1.2.1.1.1 is also applicable when the AF/BBERF/PCEF/TDF in the VPLMN modifies the Diameter session through the V-DRA.\n7.4.1.2.1.2\tPCRF-initiated\nModification of Diameter sessions occur on PCRF initiated session modifications towards the clients (AF/BBERF/PCEF).\nIf PA1 option is implemented, only steps 2, 3, 4, 5, 6 are carried out. If PA2 option is implemented, only steps 2a, 5a are carried out.\nFigure 7.4.1.2.1.2.1: Modification of Diameter sessions through DRA (proxy)- PCRF interaction\n1.\tPCRF receives an internal or external trigger that requires a Diameter message to be sent to the clients (either AF, BBERF, PCEF)\n2.\tA PCRF-initiated Diameter Request (e.g. a Diameter RAR request sent to the PGW) is sent to the Clients and received by the DRA (proxy).\n2a\tIf PA2 option is implemented, the PCRF communicates directly to the client, bypassing the DRA (proxy). In such a case steps 2, 3, 4, 5, 6 are not carried out.\n3.\tAfter receiving a Diameter Request (Step 2), the DRA (proxy) verifies that there is an active DRA binding for the session identified in the request.\n4.\tThe DRA (proxy) proxies the Diameter Request to the Client. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tClients returns a Diameter Answer as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9] or clause 4.4 of 3GPP TS 29.214 [10]) to the DRA (proxy).\n5a\tUpon receiving a Diameter Request (Step 2a), Client returns a Diameter Answer directly to the PCRF, bypassing the DRA (proxy).\n6.\tDRA (proxy) proxies the Diameter Answer to the PCRF.\nNOTE:\tFigure 7.4.1.2.1.2.1 is also applicable when the V-PCRF modifies the Diameter session through the V-DRA.",
      "chunk_type": "general",
      "cross_references": [
        "ts_29.212_clause_4.4",
        "clause_5.2.5.7.1.1",
        "figure_7.4.1.2.1.1.1",
        "figure_7.4.1.2.1.2.1",
        "ts_29.214_clause_4.4",
        "ts_29.212",
        "ts_29.214"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.2.2",
      "section_id": "7.4.1.2.2",
      "section_title": "Roaming cases",
      "content": "7.4.1.2.2.1\tV-PCRF initiated\nIn roaming scenarios modification of Diameter sessions may occur at any of the following cases:\n-\tV-PCRF S9 Diameter session modification to H-PCRF\n-\tV-PCRF proxies Rx Diameter session modification to H-PCRF\nIf PA1 option is implemented, only steps 2, 3, 4, 5, 6 are carried out. If PA2 option is implemented, only steps 2a, 5a are carried out.\nFigure 7.4.1.2.2.1.1: Modification of Diameter sessions through DRA (proxy) on roaming scenarios – V-PCRF initiated\n1.\tV-PCRF receives an internal or external trigger that requires a Diameter message to be sent to H-PCRF over the S9 reference point\n2.\tV-PCRF sends a Diameter session update (e.g. an S9 session modification request) over the S9 reference point that is received by the DRA (proxy) in the home PLMN.\n2a\tIf PA2 option is implemented, the V-PCRF communicates directly to the H-PCRF, bypassing the H-DRA (proxy). In such a case steps 2, 3, 4, 5, 6 are not carried out.\n3.\tAfter receiving a Diameter Request (Step 2), the H-DRA (proxy) verifies that there is an active DRA binding for the session identified in the request.\n4.\tThe H-DRA (proxy) proxies the Diameter Request to the H-PCRF. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tH-PCRF returns a Diameter Answer to the H-DRA (proxy) in the home PLMN.\n5a\tUpon receiving a Diameter Request (Step 2a), Client returns a Diameter Answer directly to the PCRF, bypassing the H-DRA (proxy).\n6.\tH-DRA (proxy) proxies the Diameter Answer to the PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.2.2.1.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.2.2.2",
      "section_id": "7.4.1.2.2.2",
      "section_title": "H-PCRF initiated",
      "content": "In roaming scenarios modification of Diameter sessions may occur at any of the following cases:\n-\tH-PCRF S9 Diameter session modification to V-PCRF\nIf PA1 option is implemented, only steps 2, 3, 4, 5, 6 are carried out. If PA2 option is implemented, only steps 2a, 5a are carried out.\nFigure 7.4.1.2.2.2.1: Modification of Diameter sessions through DRA (proxy) on roaming scenarios – H-PCRF initiated\n1.\tH-PCRF receives an internal or external trigger that requires a Diameter message to be sent to V-PCRF over the S9 reference point.\n2.\tH-PCRF sends a Diameter session update (e.g. an S9 session modification request) over the S9 reference point that is received by the H-DRA (proxy) in the home PLMN.\n2a\tIf PA2 option is implemented, the H-PCRF communicates directly to the V-PCRF, bypassing the H-DRA (proxy). In such a case steps 2, 3, 4, 5, 6 are not carried out.\n3.\tAfter receiving a Diameter Request (Step 2), the H-DRA (proxy) verifies that there is an active DRA binding for the session identified in the request.\n4.\tThe H-DRA (proxy) proxies the Diameter Request to the V-PCRF. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tV-PCRF returns a Diameter Answer to the H-DRA (proxy) in the home PLMN.\n5a\tUpon receiving a Diameter Request (Step 2a), V-PCRF returns a Diameter Answer directly to the H-PCRF, bypassing the H-DRA (proxy).\n6.\tH-DRA (proxy) proxies the Diameter Answer to the H-PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.2.2.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.3.1",
      "section_id": "7.4.1.3.1",
      "section_title": "Non-roaming cases",
      "content": "The procedures required are identical for both PA1 and PA2 options\nTermination of Diameter sessions occur at the following cases:\n-\tGateway control session termination\n-\tIP-CAN session termination\n-\tAF session termination\n-\tFor unsolicited application reporting, TDF session termination\nFigure 7.4.1.3.1.1: Termination of Diameter sessions through DRA (proxy)\n1.\tA Client receives an external trigger (e.g. an IP-CAN session termination is initiated by the UE or PCRF) that requires the sending of a Diameter Termination Request.\n2.\tA Diameter Termination Request (e.g., a Diameter CCR sent by PGW to indicate termination of an IP-CAN session) as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9]) is sent by the Client to the DRA (proxy). The message uses the same Session-Id AVP value of the active Diameter session established between the Client and PCRF-1.\n3.\tThe DRA (proxy) verifies that there is an active DRA binding for the IP-CAN session based on the Session-Id AVP in the request.\n4.\tThe DRA (proxy) proxies the Diameter Termination Request to the target PCRF. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tPCRF-1 acknowledges termination of the session. PCRF-1 sends a Diameter Answer, (e.g., as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9]) to DRA (proxy).\n6.\tThe DRA marks the Diameter session terminated. If the DRA binding is per IP-CAN session and all the Diameter sessions (i.e. the Gx session or the Gxx session) of the IP-CAN session are terminated or if the DRA binding is per UE and all the Diameter sessions (i.e. the Gx session or the Gxx session) of that UE are terminated the DRA (proxy) removes the DRA binding.\n7.\tDRA (proxy) proxies the Diameter Answer to the Client. The proxied Diameter Answer maintains the same Session-Id AVP value.\nNOTE 1:\tFigure 7.4.1.3.1.1 is also applicable when the AF/BBERF/PCEF/TDF in the VPLMN terminates the Diameter sessions through the V-DRA.\nNOTE 2:\tAF/TDF is not required to send Diameter session termination request to DRA (PA2).",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.3.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.1.3.2",
      "section_id": "7.4.1.3.2",
      "section_title": "Roaming cases",
      "content": "In roaming cases (over S9 reference point) termination of Diameter sessions occur at the following cases:\n-\tS9 session termination\n-\tAF session termination\nFigure 7.4.1.3.2.1: Termination of Diameter sessions through H-DRA (proxy) – Roaming cases\n1.\tThe V-PCRF receives an external trigger (e.g., session termination request from the BBERF or the PCEF) that requires the sending of a Diameter Termination Request.\n2.\tA Diameter Termination Request (e.g., an S9 termination request) is sent by the V-PCRF and received by the H-DRA (proxy) in the home PLMN. The message uses the same Session-Id AVP value of the active Diameter session established between V-PCRF and H-PCRF-1.\n3.\tThe H-DRA (proxy) verifies that there is an active DRA binding for the IP-CAN session based on the Session-Id AVP in the request.\n4.\tThe H-DRA (proxy) proxies the Diameter Termination Request to the target H-PCRF-1. The proxied Diameter Request maintains the same Session-Id AVP value.\n5.\tH-PCRF-1 acknowledges termination of the session. H-PCRF-1 sends a Diameter Answer to H-DRA (proxy) in the home PLMN.\n6.\tThe H-DRA marks the Diameter session terminated. If all the Diameter sessions (i.e. the S9 session, the Gxx session, and the Gx session) of that UE are terminated the H-DRA (proxy) removes the DRA binding.\n7.\tH-DRA (proxy) proxies the Diameter Answer to the V-PCRF. The proxied Diameter Answer maintains the same Session-Id AVP value.\nNOTE:\tV-PCRF does not need to send Rx Diameter termination messages to proxy H-DRA (PA2 option) since Rx Diameter termination messages do not affect the DRA binding.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.1.3.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.2.1.1",
      "section_id": "7.4.2.1.1",
      "section_title": "Non-roaming cases",
      "content": "Establishment of Diameter sessions may occur at the following cases:\n-\tGateway control session establishment\n-\tIP-CAN session establishment\n-\tAF session establishment\n-\tFor unsolicited application reporting, TDF session establishment\nThe DRA client (AF/BBERF/PCEF/TDF) shall follow the procedure below if an appropriate cached route table entry created from previous DRA (redirect) interactions does not exist. Cached route table entries are created from the Redirect-Host, Redirect-Host-Usage and Redirect-Max-Cache-Time AVPs as described in sections 6.12, 6.13 and 6.14 of IETF RFC 6733 [61].\nFigure 7.4.2.1.1.1: Establishment of Diameter session through DRA (redirect)\n1.\tA Client receives an external trigger (e.g., IP-CAN session establishment request) that requires the establishment of a Diameter session with a PCRF.\n2.\tA Diameter Establishment request (e.g., a Diameter CCR sent by PGW to indicate establishment of an IP-CAN session as defined in clauses 4.5.1, 4a.5.1 of 3GPP TS 29.212 [9]) with user information (e.g., UE-NAI) is sent by the Client and received by the DRA (redirect).\n3.\tThe DRA (redirect) stores the user information (e.g., UE-NAI) and checks whether an active DRA binding exists. If not the DRA creates a dynamic DRA binding (assignment of a PCRF node per UE or per IP-CAN session); if the DRA (redirect) find there has been a DRA binding for the user, the DRA shall select the PCRF from the binding for the client.\n4.\tThe DRA (redirect) sends a Diameter Answer indicating redirection as defined in IETF RFC 6733 [61]. The target PCRF identity is included in the Redirect-Host AVP.\n5.\tThe Client re-sends the Diameter Establishment Request of step 2 to the target PCRF.\n6.\tPCRF-1 returns a Diameter Answer, as defined in clauses 4.5, 4a.5 of 3GPP TS 29.212 [9], to the Client.\nNOTE:\tFigure 7.4.2.1.1.1 is also applicable when the AF/BBERF/PCEF/TDF in the VPLMN contacts the V-DRA to locate the V-PCRF.",
      "chunk_type": "general",
      "cross_references": [
        "figure_7.4.2.1.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.2.1.2",
      "section_id": "7.4.2.1.2",
      "section_title": "Roaming cases",
      "content": "Establishment of Diameter sessions may occur at the following cases:\n-\tS9 session vailability\n-\tAF session establishment\nThe DRA client (AF/BBERF/PCEF) shall follow the procedure below if an appropriate cached route table entry created from previous DRA (redirect) interactions does not exist. Cached route table entries are created from the Redirect-Host, Redirect-Host-Usage and Redirect-Max-Cache-Time AVPs as described in clause 6.12, 6.13 and 6.14 of IETF RFC 6733 [61].\nFigure 7.4.2.1.2.1: Establishment of Diameter session through DRA (redirect) – Roaming scenario\n1.\tThe V-PCRF receives an external trigger (e.g., IP-CAN session establishment request) that requires the establishment of a Diameter session with an H-PCRF over the S9 reference point.\n2.\tA Rx/S9 Diameter Establishment Request with user information (e.g., UE-NAI) is sent by the V-PCRF and received by the H-DRA (redirect) in the home PLMN.\n3.\tThe H-DRA (redirect) stores the user information (e.g., UE-NAI) and checks whether an active DRA binding exists. If not the H-DRA creates a dynamic DRA binding (assignment of a PCRF node per UE); if the DRA (redirect) find there has been a DRA binding for the user, the DRA shall select the PCRF from the binding for the client.\n4.\tThe H-DRA (redirect) sends a Diameter Answer indicating redirection as defined in IETF RFC 6733 [61]. The target PCRF identity is included in the Redirect-Host AVP.\n5.\tThe V-PCRF re-sends the Rx/S9 Diameter Establishment Request of step 2 to the target H-PCRF.\n6.\tH-PCRF-1 returns a corresponding Diameter Answer to the V-PCRF.\nNOTE:\tThe V-PCRF may proxy the Rx Diameter Establishment Request to the H-PCRF directly (e.g. based on the stored information provided by H-DRA during the S9 Diameter session establishment).",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_6.12",
        "figure_7.4.2.1.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.2.2",
      "section_id": "7.4.2.2",
      "section_title": "Modification of Diameter sessions",
      "content": "The PCEF shall send the Diameter session modification message to the DRA to update the DRA binding information only if the UE’s address(es) is updated and the DRA (redirect) is maintaining PCRF routing information per IP-CAN session. For visited access case, the V-PCRF shall send the Diameter session modification message to the H-DRA to update the DRA binding information only if the UE’s address(es) is updated. The detailed procedure is similar to the Establishment of Diameter sessions, which is described in the clause 7.4.2.1.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_7.4.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.2.3.1",
      "section_id": "7.4.2.3.1",
      "section_title": "Non-roaming cases",
      "content": "Termination of Diameter sessions that impact the DRA binding occur at the following cases:\n-\tGateway control session termination\n-\tIP-CAN session termination\nThe DRA client (BBERF/PCEF) shall follow the procedure below if the DRA (redirect) is maintaining PCRF routing information per IP-CAN session or an appropriate cached route table entry created from previous DRA (redirect) interactions does not exist. Cached route table entries are created from the Redirect-Host, Redirect-Host-Usage and Redirect-Max-Cache-Time AVPs as described in clause 6.12, 6.13 and 6.14 of IETF RFC 6733 [61].\nFigure 7.4.2.3.1.1: Termination of Diameter sessions through DRA (redirect)\n1.\tClient receives an external trigger (e.g. an IP-CAN session termination is initiated by the UE or PCRF) that triggers the client to terminate Diameter session with server (i.e. PCRF)\n2\tA Diameter Termination Request (e.g., as defined in clauses 4.5.7 (Gx) and 4a.5.3 (Gxx) of 3GPP TS 29.212 [9]) is sent by the Client to the DRA (redirect).\n3.\tA Diameter Termination Request (e.g., as defined in clauses 4.5.7 (Gx) and 4a.5.3 (Gxx) of 3GPP TS 29.212 [9]) is sent by the Client to PRCF-1. The message uses the same Session-Id AVP value of the active Diameter session established between the Client and PCRF-1.\nNOTE:\tSteps 2, 3 may be carried out in parallel. Otherwise, the client after step2 may need to wait for the redirect answer before sending the Diameter termination request to the PCRF.\n4.\tDRA (redirect) verifies that there is an active DRA binding for the IP-CAN session based on the Session-Id AVP and marks the Diameter session terminated. If the DRA binding is per IP-CAN session and all the Diameter sessions (i.e. Gx session or Gxx session) of that IP-CAN session are terminated or if the DRA binding is per UE and all the Diameter sessions (i.e. Gx session or Gxx session) of that UE are terminated the DRA removes the DRA binding.\n5\tDRA (redirect) acknowledges termination of the session by sending a Diameter redirect answer to the client.\n6\tPCRF-1 acknowledges termination of session. PCRF-1 sends a Diameter Answer (e.g., as defined in clauses 4.5.7 (Gx) and 4a.5.3 (Gxx) of 3GPP TS 29.212 [9]) to the Client.\nNOTE:\tFigure 7.4.2.3.1.1 is also applicable when the BBERF/PCEF in the VPLMN terminates the Diameter sessions through the V-DRA.",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_6.12",
        "figure_7.4.2.3.1.1",
        "ts_29.212"
      ]
    },
    {
      "chunk_id": "ts_29.213_7.4.2.3.2",
      "section_id": "7.4.2.3.2",
      "section_title": "Roaming cases",
      "content": "Termination of Diameter sessions occur at the following cases:\n-\tS9 session termination\nThe DRA client (AF/BBERF/PCEF) shall follow the procedure below) if the DRA (redirect) is maintaining PCRF routing information per IP-CAN session or an appropriate cached route table entry created from previous DRA (redirect) interactions does not exist. Cached route table entries are created from the Redirect-Host, Redirect-Host-Usage and Redirect-Max-Cache-Time AVPs as described in clause 6.12, 6.13 and 6.14 of IETF RFC 6733 [61].\nFigure 7.4.2.3.2.1: Termination of Diameter sessions through DRA (redirect) – Roaming case\n1.\tV-PCRF receives an external trigger (e.g. session termination request from the BBERF, PCEF) that requires the sending of a Diameter Termination Reqeust.\n2\tA Diameter Termination Request is sent by the V-PCRF and received by the H-DRA (redirect) in the home PLMN.\n3.\tA Diameter Termination Request is sent by the V-PCRF to H-PRCF-1. The message uses the same Session-Id AVP value of the active Diameter session established between theV-PCRF and H-PCRF-1.\nNOTE:\tSteps 2, 3 may be carried out in parallel. Otherwise, the V-PCRF after step2 may need to wait for the redirect answer before sending the Diameter termination request to the H-PCRF\n4.\tH-DRA (redirect) verifies that there is an active DRA binding for the IP-CAN session based on the Session-Id AVP and marks the Diameter session terminated. If all the Diameter sessions (i.e. S9 session, Gxx session, Gx session) of that UE are terminated the H-DRA removes the DRA binding.\n5\tH-DRA (redirect) acknowledges termination of the session by sending a Diameter redirect answer to the V-PCRF.\n6\tH-PCRF-1 acknowledges termination of the session by sending a Diameter answer to the V-PCRF.\nNOTE:\tRx Diameter termination messages are not required to be sent to H-DRA (redirect) since such messages do not affect the DRA binding",
      "chunk_type": "requirement",
      "cross_references": [
        "clause_6.12",
        "figure_7.4.2.3.2.1"
      ]
    },
    {
      "chunk_id": "ts_29.213_8.1",
      "section_id": "8.1",
      "section_title": "Overview",
      "content": "Certain Diameter PCC applications (Gx, Gxx, Sd, S9) allow the server (PCRF for Gx, Gxx, Sd, H-PCRF for S9) to update a session in two ways: unsolicited and solicited. The PCRF can push policy decisions and provision event triggers in an unsolicited fashion using an RAR. It can also install policy decisions in a solicited manner by responding to a CCR sent by the client (BBERF for Gxx, PCEF for Gx, TDF for Sd, V-PCRF for S9).\nThe client and the server can initiate transactions that modify the state of the session independently (e.g. CCR from the client and RAR from the server) and potentially concurrently. Additionally, there may be Diameter agents in between the client and server (e.g. DRA or in general Diameter relays/proxies) that could cause messages to be delivered out of order. This can lead to race conditions that may result in the wrong information maintained by the client and/or server for a session.\nNote that race conditions occur in different ways based on the application. Also, their impact is specific to the application. For example, even though Gx is based on DCCA (RFC 4006), Gx is much more vulnerable to race conditions as Gx allows sessions to be updated based on RARs and CCAs whereas DCCA only allows the server to update the session based on a CCA. The RAR is merely used to solicit the client to send a CCR.",
      "chunk_type": "definition",
      "cross_references": []
    },
    {
      "chunk_id": "ts_29.213_8.2",
      "section_id": "8.2",
      "section_title": "Procedures for Gx, Gxx, Sd and S9",
      "content": "This clause describes the optional procedures for handling Diameter race conditions in a deterministic manner for the following interfaces: Gx, Gxx, Sd and S9. These procedures apply to the PCEF (Gx), BBERF (Gxx), TDF (Sd) and PCRF (Gx, Gxx, Sd and S9).\nIn this clause, the terms “client” and “server” are relative to the session context. As an example, for the Gx interface, the client is the PCEF and the server is the PCRF. The term “node” can refer to either a client or a server. The term “transaction” refers to a Diameter request and its associated answer. The term “ongoing transaction” refers to a transaction that has an outstanding answer.\nA node that supports the procedures defined in this clause and is configured to comply with them, shall advertise such support by setting the corresponding PendingTransaction feature bit in the Supported-Features AVP during session establishment as defined in 3GPP TS 29.212 [9] for Gx, Gxx and Sd and 3GPP TS 29.215 [22] for S9.\nOn receipt of a Diameter request for an existing Diameter session, the recipient Diameter node shall check if it has an ongoing transaction on that session:\n1.\tIf there are no ongoing transactions on the session, the node shall process the incoming request normally.\n2.\tIf there is an ongoing transaction on the session and optionally, if the recipient node cannot determine that the incoming request can be safely handled without creating a state mismatch:\na.\tThe client shall reject the incoming request with a Diameter experimental result code of DIAMETER_PENDING_TRANSACTION as defined in 3GPP TS 29.212 [9].\nb.\tThe server shall either reject the incoming request with a Diameter experimental result code of DIAMETER_PENDING_TRANSACTION or shall wait for one of the following conditions to occur:\ni.\tThe ongoing transaction completes. In this case, the session is updated at the server based on the completion of the ongoing transaction and afterwards, the incoming request (e.g. CCR) is processed normally based on the updated session state.\nii.\tThe waiting period has exceeded its allotted time. In this case, the server shall reject the incoming request with a Diameter experimental result code of DIAMETER_PENDING_TRANSACTION.\nNOTE 1:\tIf there is an ongoing transaction on the session and optionally, if the recipient node can determine that the incoming request can be safely handled without creating a state mismatch, the client and the server could handle the incoming request normally.\n3.\tOn receipt of a DIAMETER_PENDING_TRANSACTION result code, a client shall retry the request. On the other hand, if a server had rejected a request from the client with a DIAMETER_PENDING_TRANSACTION, the server should not retry the failed request until it responds to  the re-attempted request from the client. This is to avoid having both the client and server concurrently retry their requests. In all other cases, if the session on the client still needs to be updated, the server shall retry the request.\nNOTE 2:\tThe server retries the request either by resending the command (e.g. RAR) or by including the initial requested information in the command (e.g. CCA) answering the re-attempted request from the client. However, including the initial requested information in the command (e.g. CCA) answering the re-attempted request is only possible if the server does not require a response to the command.\n4.\tNodes should limit the number of times they re-attempt the same request due to receipt of a DIAMETER_PENDING_TRANSACTION.\n5.\tThe only exception to the rules above is a session termination request (e.g. CCR with a CC-Request-Type AVP set to TERMINATION_REQUEST) or a request for session release (e.g. RAR with Session-Release-Cause AVP). In both cases, the request should be handled as follows:\na.\tWhen receiving a request for a session release that requires new transactions to be initiated, a client shall acknowledge the request immediately (e.g. a RAR command with Session-Release-Cause AVP shall be acknowledged with a RAA command). The client shall wait for the current transaction to complete (either by the server acknowledging the request or rejecting it with DIAMETER_PENDING_TRANSACTION) before completing the session termination procedure (e.g. before sending the CCR command with the CC-Request-Type set to TERMINATION_REQUEST).\nNOTE 3:\tThe client needs to wait for the outcome of the session modification to determine if the session termination procedure will be used to report information that could not be reported as part of the session modification procedure.\nNOTE 4: \tAfter having sent a request for session termination, the server acknowledges any unrelated incoming request immediately (either by the server acknowledging the request or rejecting it with DIAMETER_PENDING_TRANSACTION) without a waiting period.\nb.\tWhen receiving a session termination request the server shall handle it immediately.\nAnnex A (informative):Examples of deriving the Maximum Authorized parameters from the SDP parameters\nAnnex B (normative):Signalling Flows for IMS\nThe signalling flows in clause 4 are also applicable for IMS. This Annex adds flows that show interactions with SIP/SDP signalling of the IMS.\nB.0\tGeneral\nThe following is applicable for Emergency Services and PSAP call back request:\n-\tThe P-CSCF includes an Emergency indication when service information is sent over Rx and when required by the IMS deployment, the P-CSCF may also indicate that it requires EPC-level user information as defined in 3GPP TS 29.214 [10].\n-\tThe PCRF only allows Emergency Sessions that are bound to an IP-CAN session established to an Emergency APN.\n-\tUpon request from the P-CSCF, the PCRF provides the P-CSCF with EPC-level user information corresponding to the established IP-CAN session.\nThe following is not applicable for Emergency Services and PSAP call back request:\n-\tPre-authorization for a UE terminated IMS session establishment with UE initiated resource reservation.\n-\tSubscription to notification of Signalling Path Status at IMS Registration, subscription to notification of changes of IP-CAN type at IMS Registration and Provisioning of SIP Signalling flow information at IMS Registration procedures.\nB.1\tSubscription to Notification of Signalling Path Status at IMS Registration\nThis clause covers the optional Subscription to Notifications of IMS Signalling Path Status upon an initial successful IMS Registration procedure.\nFigure B.1.1: Subscription to Notification of IMS Signaling Path Status at initial IMS Registration\n1-4.\tThe user initiates an initial SIP Registration procedure. The SIP Registration procedure is completed successfully (user has been authenticated and registered within the IMS Core NW).\n5.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention to subscribe to the status of the IMS Signaling path. The P-CSCF sends a Diameter AAR command to the PCRF.\n6.\tThe PCRF performs session binding and identifies corresponding PCC Rules related to IMS Signalling.\n7.\tThe PCRF confirms the subscription to IMS Signaling path status and replies with a Diameter AAR command back to the P-CSCF.\n8.\tIf the PCRF had not previously subscribed to the required bearer level events from the IP-CAN for the affected PCC/QoS Rules, then the PCRF shall do so now. The PCRF initiates procedures according to figure 4.3.1.1.1.\nB.1a\tSubscription to Notification of Change of IP-CAN Type at IMS Registration\nThis clause covers the optional Subscription to Notifications of change in the type of IP-CAN upon an initial IMS Registration procedure.\nFigure B.1.2: Subscription to Notification of change of IP-CAN Type at initial IMS Registration\n1.-\tThe user initiates an initial SIP Registration procedure.\n2.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention to subscribe to the notification of IP-CAN Type Change. The P-CSCF sends a Diameter AAR command to the PCRF.\nNOTE:\tIt should be possible for the P-CSCF to request the subscription to notification of IMS Signalling path status and PLMN changes also in this step.\n3.\tThe PCRF performs session binding and identifies corresponding PCC Rules related to IMS Signalling.\n4.\tThe PCRF confirms the subscription to notification of change of IP-CAN type and replies with a Diameter AAA command back to the P-CSCF. The PCRF includes in the response the type of IP-CAN currently in use.\n5-7.\tThe SIP Registration procedure is completed successfully (user has been authenticated and registered within the IMS Core NW).\n8.\tIf the PCRF had not previously subscribed to the required bearer level event from the IP-CAN (i.e. IP-CAN type change and RAT type change, if applicable), then the PCRF shall do so now. The PCRF initiates procedures according to figure 4.3.1.1.1.\nB.1b\tProvisioning of SIP signalling flow information at IMS Registration\nThis clause covers the optional Provisioning of SIP signalling flow information upon an initial successful IMS Registration procedure.\nFigure B.1.3: Provisioning of SIP Signalling Flow Information at initial IMS Registration\n1-4.\tThe user initiates an initial SIP Registration procedure. The SIP Registration procedure is completed successfully (user has been authenticated and registered within the IMS Core NW).\n5.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention to provision the information about the SIP signalling flows established between the UE and the P-CSCF. The P-CSCF sends a Diameter AAR command to the PCRF.\n6.\tThe PCRF performs session binding and identifies corresponding PCC Rules related to IMS Signalling.\n7.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n8.\tIf the PCRF had not previously provisioned PCC/QoS rules corresponding to the received SIP signalling flows, then the PCRF executes interactions according to figure 4.3.1.1.1. This step implies provisioning of PCC/QoS rules.\nB.1c\tSubscription to Notification of Change of PLMN Identifier at IMS Registration\nThis clause covers the optional Subscription to Notifications of change in the PLMN identifier upon an initial IMS Registration procedure.\nFigure B.1.4: Subscription to Notification of change of PLMN Identifier at initial IMS Registration\n1.\tThe user initiates an initial SIP Registration procedure.\n2.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention to subscribe to the notification of PLMN Identifier Change. The P-CSCF sends a Diameter AAR command to the PCRF.\nNOTE 1:\tIt should be possible for the P-CSCF to request the subscription to notification of IMS Signalling path status and IP-CAN Type changes also in this step.\n3.\tThe PCRF performs session binding and identifies corresponding PCC Rules related to IMS Signalling.\n4.\tThe PCRF confirms the subscription to notification of change of PLMN identifier and replies with a Diameter AAA command back to the P-CSCF. The PCRF includes in the response the PLMN Identifier currently in use, if available.\n5-7.\tThe SIP Registration procedure is completed successfully (user has been authenticated and registered within the IMS Core NW).\n8.\tIf the PCRF had not previously subscribed to the required bearer level event from the PLMN where the UE is located (i.e. PLMN change event), then the PCRF shall do so now. The PCRF initiates procedures according to figure 4.3.1.1.1.\nNOTE 2:\tIf the PLMN identifier is not available in step 4, the P-CSCF will wait to get it in step 8 before progressing the SIP Register, i.e. steps 5, 6 and 7 will occur after step 8.\nB.2\tIMS Session Establishment\nB.2.1\tProvisioning of service information at Originating P-CSCF and PCRF\nThis clause covers the PCC procedures at the originating P-CSCF and PCRF at IMS session establishment.\nIn figure B.2.1.1 the P-CSCF derives the provisioning of service information to the PCRF from the SDP offer/answer exchange.\nFigure B.2.1.1: PCC Procedures for IMS Session Establishment at originating P-CSCF and PCRF\n1.\tThe P-CSCF receives the SDP parameters defined by the originator within an SDP offer in SIP signalling.\n2.\tThe P-CSCF identifies the connection information needed (IP address of the down link IP flow(s), port numbers to be used etc…).\n3.\tThe P-CSCF forwards the SDP offer in SIP signalling.\n4.\tThe P-CSCF gets the negotiated SDP parameters from the terminating side through SIP signalling interaction.\n5.\tThe P-CSCF identifies the connection information needed (IP address of the up-link media IP flow(s), port numbers to be used etc…).\n6.\tThe P-CSCF forwards the derived session information to the PCRF by sending a Diameter AAR over a new Rx Diameter session.\n7.\tThe PCRF stores the received session information, and performs session binding.\n8.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n9.\tUpon reception of the acknowledgement from the PCRF, the SDP parameters are passed to the UE in SIP signalling.\n10.\tThe PCRF executes interactions according to figure 4.3.1.1.1 . This step implies provisioning of PCC/QoS rules and is executed in parallel with steps 8 and 9.\n11.\tIf the P-CSCF requested access network information in step 6, the PCRF forwards the access network information received in step 10 in a Diameter RAR.\n12.\tIf step 11 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n13.\tIf step 11 occurs, the P-CSCF forwards the access network information as the network provided location information when a suitable SIP message is received.\nOptionally, the provisioning of service information may be derived already from the SDP offer to enable that a possible rejection of the service information by the PCRF is obtained by the P-CSCF in time to reject the service with appropriate SIP signalling, to allow the P-CSCF to request network provided location information for inclusion in the SDP offer, to support authentication of roaming users in deployments with no IMS-level roaming interfaces or to support PSAP callback functionality for anonymous IMS emergency sessions. This is described in figure B.2.1.2.\nFigure B.2.1.2: PCC Procedures for IMS Session Establishment at originating P-CSCF and PCRF, provisioning of service information derived from SDP offer and answer\n1.\tThe P-CSCF receives the first SDP offer for a new SIP dialogue within a SIP INVITE request.\n2.\tThe P-CSCF extracts service information from the SDP offer (IP address of the down link IP flow(s), port numbers to be used etc…).\n3.\tThe P-CSCF forwards the derived service information to the PCRF by sending a Diameter AAR over a new Rx Diameter session. It indicates that only an authorization check of the service information is requested.\n4.\tThe PCRF checks and authorizes the service information, performs session binding, but does not provision PCC/QoS rules at this stage.\n5.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n6.\tIf the P-CSCF did not request access network information in step 3, or if the P-CSCF requested access network information but does not require the access network information for inclusion in the SDP offer, or the P-CSCF requested EPC-level user information in step 3 the P-CSCF forwards the SDP offer in SIP signalling.\n7.\tIf the P-CSCF requested access network information in step 3, the PCRF executes interactions according to Figure 4.3.1.1.1. This step implies provisioning of PCC/QoS rules.\n8.\tIf the P-CSCF requested access network information in step 3, the PCRF forwards the access network information received in step 7 in a Diameter RAR.\n9.\tIf step 8 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n10a.\tIf step 8 occurs, and if the P-CSCF requires the access network information for inclusion in the SDP offer, the P-CSCF forwards the SDP offer and adds the access network information as the network provided location information to the corresponding SIP message.\n10b.\tIf step 8 occurs, and if the P-CSCF does not require the access network information for inclusion in the SDP offer, the P-CSCF forwards the access network information as the network provided location information in a suitable SIP message. This step normally occurs only after step 17.\n11.\tThe P-CSCF receives the negotiated SDP parameters from the terminating side within a SDP answer in SIP signalling.\n12.\tThe P-CSCF extracts service information from the SDP answer (IP address of the up-link media IP flow(s), port numbers to be used etc…).\n13.\tThe P-CSCF forwards the derived service information to the PCRF by sending a Diameter AAR over the existing Rx Diameter session. Access network information is not requested if done in step 7.\n14.\tThe PCRF stores the received session information.\n15.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n16.\tThe PCRF authorizes the session information. The PCRF executes interactions according to Figure 4.3.1.1.1. This step implies provisioning of PCC/QoS rules and authorized QoS.\n17.\tUpon successful authorization of the session, the SDP parameters are passed to the UE in SIP signalling. This step is executed in parallel with step 16.\nB.2.2\tProvisioning of service information at terminating P-CSCF and PCRF\nThis clause covers the PCC procedures at the terminating P-CSCF and PCRF at IMS session establishment.\nIn figure B.2.2.1 the P-CSCF derives the provisioning of service information to the PCRF from the SDP offer/answer exchange.\nFigure B.2.2.1: PCC Procedures for IMS Session Establishment at terminating P-CSCF and PCRF\n1.\tThe P-CSCF receives the SDP parameters defined by the originator.\n2.\tThe P-CSCF identifies the connection information needed (IP address of the up-link IP flow(s), port numbers to be used etc…).\n3.\tThe P-CSCF sends the SDP offer to the UE.\n4.\tThe P-CSCF receives the negotiated SDP parameters from the UE.\n5.\tThe P-CSCF identifies the connection information needed (IP address of the down-link IP flow(s), port numbers to be used etc…).\n6.\tThe P-CSCF forwards the derived service information to the PCRF by sending a Diameter AAR over a new Rx Diameter session.\n7.\tThe PCRF stores the received session information, and performs session binding.\n8.\tThe PCRF sends a Diameter AAA to the P-CSCF.\n9.\tIf the P-CSCF did not request access network information in step 6, upon reception of the acknowledgement from the PCRF, the SDP parameters in the SDP answer are passed to the originator.\n10.\tThe PCRF executes interactions according to clause 4.3.1.1.1. This step implies provisioning of PCC/QoS rules and is executed in parallel with steps 8 and 9.\n11.\tIf the P-CSCF requested access network information in step 6, the PCRF forwards the access network information received in step 10 in a Diameter RAR.\n12.\tIf step 11 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n13.\tIf step 11 occurs, the P-CSCF forwards the SDP answer and adds the access network information as the network provided location information to the corresponding SIP message.\nOptionally, the provisioning of service information may be derived already from the SDP offer to enable that a possible rejection of the service information by the PCRF is obtained by the P-CSCF in time to reject the service with appropriate SIP signalling or to enable pre-authorization for a UE terminated IMS session establishment with UE initiated resource reservation. This is described in figure B.2.2.2.\nFigure B.2.2.2: PCC Procedures for IMS Session Establishment at terminating P-CSCF and PCRF, provisioning of service information derived from SDP offer and answer\n1.\tThe P-CSCF receives the first SDP offer for a new SIP dialogue within SIP signalling, e.g. within a SIP INVITE request.\n2.\tThe P-CSCF extracts the service information from the SDP offer (IP address of the up-link IP flow(s), port numbers to be used etc…).\n3.\tThe P-CSCF forwards the derived session information to the PCRF by sending a Diameter AAR over a new Rx Diameter session. It indicates that the service information that the AF has provided to the PCRF is preliminary and needs to be further negotiated between the two ends.\n4.\tThe PCRF checks and authorizes the session information, performs session binding, but does not provision PCC/QoS Rules at this stage.\n5.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n6.\tThe P-CSCF sends the SDP offer to the UE.\n7.\tIf the UE initiates a bearer resource modification request, the PCRF provides the PCEF/BBERF with PCC/QoS rules according to figure 4.3.1.1.1 based on the SDP offer.\nNOTE:\tStep 7 is not applicable for IMS Emergency Sessions.\n8.\tThe P-CSCF receives the negotiated SDP parameters from the UE within an SDP answer in SIP signalling.\n9.\tThe P-CSCF extracts service information from the SDP answer (IP address of the down-link IP flow(s), port numbers to be used etc…).\n10.\tThe P-CSCF forwards the derived service information to the PCRF by sending a Diameter AAR over the existing Rx Diameter session.\n10a.\tThe PCRF stores the received session information.\n11.\tThe PCRF sends a Diameter AAA to the P-CSCF.\n12.\tThe PCRF authorizes the session information. The PCRF executes interactions according to Figure 4.3.1.1.1. This step implies provisioning of PCC/QoS rules and authorized QoS.\n13.\tIf the P-CSCF did not request access network information in step 3 or 10, upon successful authorization of the session the SDP parameters in the SDP answer are passed to the originator. This step is executed in parallel with step 12.\n14.\tIf the P-CSCF requested access network information in step 3 or 10, the PCRF forwards the access network information received in step 12 in a Diameter RAR.\n15.\tIf step 14 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n16.\tIf step 14 occurs, the P-CSCF forwards the SDP answer and adds the access network information as the network provided location information to the corresponding SIP message.\nB.3\tIMS Session Modification\nB.3.1\tProvisioning of service information\nThis clause covers the provisioning of service information at IMS session modification both at the originating and terminating side.\nIn figure B.3.1.1 the P-CSCF derives the provisioning of service information to the PCRF from the SDP offer/answer exchange.\nFigure B.3.1.1: Provisioning of service information at IMS session modification\n1.\tThe P-CSCF receives the SDP parameters defined by the originator within an SDP offer in SIP signalling.\n2.\tThe P-CSCF identifies the relevant changes in the SDP.\n3.\tThe P-CSCF forwards the SDP offer in SIP signalling.\n4.\tThe P-CSCF gets the negotiated SDP parameters from the terminating side through SIP signalling interaction.\n5.\tThe P-CSCF identifies the relevant changes in the SDP.\n6.\tThe P-CSCF sends a Diameter AAR for an existing Diameter session and includes the derived updated service information.\n7.\tThe PCRF stores the received updated session information and identifies the affected established IP-CAN Session(s).\n8.\tThe PCRF answers with a Diameter AAA.\n9.\tIf the P-CSCF did not request access network information in step 6, the P-CSCF forwards the SDP answer in SIP signalling.\n10.\tThe PCRF executes interactions according to figure 4.3.1.1.1. Due to the updated service information, this step may imply provisioning of PCC/QoS rules or the need to enable or disable IP Flows (see clauses B.3.2 and B.3.3, respectively).\n11.\tIf the P-CSCF requested access network information in step 6, the PCRF forwards the access network information received in step 10 in a Diameter RAR.\n12.\tIf step 11 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n13.\tIf step 11 occurs, the P-CSCF forwards the SDP answer and adds the access network information as the network provided location information to the corresponding SIP message.\nOptionally, the provisioning of service information may be derived already from the SDP offer to enable that a possible rejection of the service information by the PCRF is obtained by the P-CSCF in time to reject the service with appropriate SIP signalling or to enable pre-authorization for a UE terminated IMS session establishment with UE initiated resource reservation. This is described in figure B.3.1.2.\nFigure B.3.1.2: Provisioning of service information derived from SDP offer and answer at IMS session modification\n1.\tThe P-CSCF receives an SDP offer in SIP signalling for an exiting SIP dialogue.\n2.\tThe P-CSCF identifies the relevant changes in the SDP and extracts the corresponding service information.\n3.\tThe P-CSCF forwards the derived service information to the PCRF by sending a Diameter AAR over the existing Rx Diameter session for the corresponding SIP session. It indicates that the service information that the AF has provided to the PCRF is preliminary and needs to be further negotiated between the two ends.\n4.\tThe PCRF checks and authorizes the session information, but does not provision PCC/QoS rules at this stage.\n5.\tThe PCRF replies to the P-CSCF with a Diameter AAA.\n6.\tIf the UE initiates a bearer resource modification request, the PCRF provides the PCEF/BBERF with PCC/QoS rules according to figure 4.3.1.1.1 based on the SDP offer.\nNOTE:\tStep 6 is not applicable for IMS Emergency Sessions.\n7.\tThe P-CSCF forwards the SDP offer in SIP signalling.\n8.\tThe P-CSCF receives the negotiated SDP parameters within an SDP answer in SIP signalling from the terminating side.\n9.\tThe P-CSCF identifies the relevant changes in the SDP and extracts the corresponding service information.\n10.\tThe P-CSCF sends a Diameter AAR for an existing Diameter session and includes the derived updated service information.\n11.\tThe PCRF answers with a Diameter AAA.\n12.\tThe PCRF interacts with the GW according to figure 4.3.1.1.1. This step may imply provisioning of PCC/QoS rules and authorized QoS. The PCRF may need to enable or disable IP Flows (see clauses B.3.2 and B.3.3, respectively) due to the updated service information.\n13.\tIf the P-CSCF did not request access network information in step 3 or 10, the P-CSCF forwards the SDP answer in SIP signalling. This step is executed in parallel with step 12.\n14.\tIf the P-CSCF requested access network information in step 3 or 10, the PCRF forwards the access network information received in step 12 in a Diameter RAR.\n15.\tIf step 14 occurs, the P-CSCF acknowledges the receipt of Diameter RAR.\n16.\tIf step 14 occurs, the P-CSCF forwards the SDP answer and adds the access network information as the network provided location information to the corresponding SIP message.\nB.3.2\tEnabling of IP Flows\nThe PCRF makes a final decision to enable the allocated QoS resource for the authorized IP flows of the media component (s) if the QoS resources are not enabled at the time they are authorized by the PCRF or if the media IP flow(s) previously placed on hold are resumed, i.e. the media IP flow(s) of the media component that was placed on hold at the time of the resource authorization or at a later stage is reactivated (with SDP direction sendrecv, sendonly, recvonly or none direction).\nThe Enabling of IP Flows procedure is triggered by the P-CSCF receiving any 2xx success response to an INVITE request or a 2xx success response to an UPDATE request within a confirmed dialogue that is not embedded as part of another INVITE Transaction (in both cases a 200 OK response is usually received). When receiving such responses, the PCRF shall take the SDP direction attribute in the latest received SDP (either within the 2xx success or a previous SIP message) into account when deciding, which gates shall be opened:\n-\tFor a unidirectional SDP media component, IP flows in the opposite direction shall not be enabled.\n-\tFor an inactive SDP media component, no IP flows shall be enabled.\nFigure B.3.2.1 is applicable to the Mobile Originating (MO) side and the Mobile Terminating (MT) side.\nFigure B.3.2.1: Enabling of IP Flows\n1.\tThe P-CSCF receives the 2xx Success message complying with the conditions specified in the paragraphs above.\n2.\tThe P-CSCF sends a Diameter AAR message to the PCRF, requesting that gates shall be opened.\n3.\tThe PCRF approves the enabling of IP flows and PCRF updates flow status of affected PCC rules.\n4\tThe PCRF sends a Diameter AAA to the P-CSCF.\n5\tThe P-CSCF forwards the 2xx Success message.\n6.\tThe PCRF executes interactions according to figure 4.3.1.1.1. This step implies opening the ‘gates’ by updating the flow status of PCC rules.\nB.3.3\tDisabling of IP Flows\nThe “Disabling of IP Flows” procedure is used when media IP flow(s) of a session are put on hold (e.g. in case of a media re-negotiation or call hold).\nMedia is placed on hold as specified in RFC 3264 [12]. Media modified to become inactive (SDP direction attribute) shall also be considered to be put on hold.\nIf a bidirectional media component is placed on hold by making it unidirectional, the IP flows shall only be disabled in the deactivated direction. If a media component is placed on hold by making it inactive, the IP flows shall be disabled in both directions.\nFigure B.3.3.1 presents the “Disabling of IP Flows” procedure at media on hold for both the Mobile Originating (MO) side and the Mobile Terminating (MT) side.\nFigure B.3.3.1: Disabling of IP Flows at Media on Hold\n1.\tThe P-CSCF receives an SDP answer putting media on hold within a SIP message. (NOTE)\n2.\tThe P-CSCF sends a Diameter AAR request to the PCRF, requesting that gates shall be closed.\n3.\tThe PCRF updates flow status of affected PCC rules for the media on hold.\n4.\tThe PCRF sends a Diameter AAA message back to the P-CSCF.\n5.\tThe P-CSCF forwards the SDP answer putting media on hold within a SIP message.\n6.\tThe PCRF executes interactions according to figure 4.3.1.1.1. This step implies closing the relevant media IP flow gate(s), leaving the possible related RTCP gate(s) open to keep the connection alive.\nNOTE:\tThis procedure occurs whenever a bidirectional media is made unidirectional or when a media is changed to inactive.\nB.3.4\tMedia Component Removal\nFigure B.3.4.1 presents the flows of PCC procedures at the removal of media component(s) from an IMS session which is not being released for both the Mobile Originating (MO) side and the Mobile Terminating (MT) side.\nFigure B.3.4.1: Revoke authorization for IP resources at media component removalfor both Mobile Originating (MO) and Mobile Terminating (MT) side\n1.\tA SIP message containing SDP indicating the removal of media component(s) is received by the P-CSCF.\n2.\tThe P-CSCF sends Diameter AAR to the PCRF with modified service information.\n3.\tThe PCRF stores the Session information and identifies the affected IP-CAN Session(s).\n4.\tThe PCRF sends a Diameter AAA message back to the P-CSCF.\n5.\tThe P-CSCF forwards the SDP answer removing a media component.\n6.\tThe PCRF makes a decision on what PCC/QoS rules need to be modified or removed and executes interactions according to figure 4.3.1.1.1.\nB.4\tIMS Session Termination\nB.4.1\tMobile initiated session release / Network initiated session release\nFigure B.4.1.1 presents the mobile or network initiated IMS session release without access network information retrieval. The session release may be signalled by a SIP BYE message, or any SIP 3xx redirect response, or any 4xx, 5xx, or 6xx SIP final error response to an initial INVITE request. If any 4xx, 5xx, or 6xx SIP final error response to Re-INVITE or UPDATE request just terminates the transaction, then the session is not released, otherwise if the error response terminates the dialog then the session is released.\nFigures B.4.1.2 and B.4.1.3 presents the network initiated and the mobile initiated IMS session release with access network information retrieval, respectively.\nFigure B.4.1.1: IMS session termination without access network information retrieval\n1.\tSIP BYE message, a SIP 3xx redirect response, or any 4xx, 5xx, or 6xx SIP final error response to an initial INVITE or any 4xx, 5xx, or 6xx SIP final error response to Re-INVITE or UPDATE which terminates the dialog is received by the P-CSCF.\n2.\tP-CSCF forwards the BYE message, or the SIP 3xx redirect response, or any 4xx, 5xx, or 6xx SIP final error response.\n3.\tThe Interactions in in Figure 4.3.1.2.3.1.1 or Figure 4.3.1.2.3.2.1are applicable.\nFigure B.4.1.2: network initiated IMS session termination with access network information retrieval\n1.\tSIP BYE message is received by the P-CSCF.\n2.\tThe P-CSCF forwards the BYE message.\n3.\tIn parallel to step 2, the Interactions in Figure 4.3.1.2.3.1.1 or Figure 4.3.1.2.3.2.1 take place. Within those interactions, the P-CSCF requests and receives the access network information.\n4.\tThe P-CSCF receives the SIP 200 OK (BYE) SIP message.\n5.\tThe P-CSCF forwards the SIP 200 OK (BYE) SIP message. It includes the access networking information obtained in step 3 as the network provided location information.\nFigure B.4.1.3: mobile initiated IMS session termination with access network information retrieval\n1.\tSIP BYE message is received by the P-CSCF.\n2.\tThe Interactions in Figure 4.3.1.2.3.1.1 or Figure 4.3.1.2.3.2.1 are applicable. Within those interactions, the P-CSCF requests and receives the access network information.\n3.\tThe P-CSCF forwards the BYE message. It includes the access network information obtained in step 2 as the network provided location information.\nB.4.2\tIP-CAN Bearer Release/Loss\nAn IP-CAN Bearer Release or Loss event may affect all IP-Flows within an IMS Session. Flows in clause 4.3.2.2.1 (AF located in the HPLMN) or 4.3.2.2.2 (AF located in the VPLMN) apply for case 1. Flows in clause 4.4.2.1.1 (Home Routed case) or 4.4.2.2.1 (Visited Access case) apply for case 2a and case 2b.\nB.5\tP-CSCF Restoration\nThis clause is applicable if P-CSCF Restoration is to be performed.\nFigure B.5.1: P-CSCF Restoration\n1.\tThe P-CSCF sends an AAR command to PCRF to initiate a P-CSCF Restoration procedure, as defined in the 3GPP TS 23.380 [35]. The AAR command contains a Rx-Request-Type AVP with value set to PCSCF_RESTORATION and can contain the IP address of the UE within Framed-IP-Address AVP (if available) or the Framed-Ipv6-Prefix AVP (if available), IMSI (if available) within the Subscription-Id AVP, the IMS APN (if available) within the Called-Station-Id AVP and/or the IP address domain (if available) within the IP-Domain-Id AVP.\nFor the non-roaming case and the home routed case, the H-PCRF receives the AAR command, i.e. step 1 is executed.\n1a.\tFor the roaming case with visited access, when the P-CSCF is located in the VPLMN, step 1 is executed with the exception that the V-PCRF receives the AAR command and responds with the AAA command\n2.\tWhen receiving the AAR command for P-CSCF Restoration from the P-CSCF, the PCRF acknowledges the AAR by sending an AAA command to the P-CSCF.\nFor the non-roaming case and the home routed case, the H-PCRF sends an AAA command to the P-CSCF, i.e. step 2 is executed.\n2a.\tFor the roaming case with visited access, when the P-CSCF is located in the VPLMN, step 2 is executed with the exception that the V-PCRF sends an AAA command to the P-CSCF.\nFor the roaming case with local breakout when the P-CSCF is located in the HPLMN, when the H-PCRF receives the AAR command from the P-CSCF, the H-PCRF sends an RAR command to the V-PCRF, i.e. step 1b is executed.\n3.\tWhen receiving the AAR command for P-CSCF Restoration, the PCRF finds the corresponding IP-CAN session according to the received information within the AAR command, and sends an RAR command for the corresponding IP-CAN session (IMS PDN connection) to the PCEF for P-CSCF Restoration. The RAR contains a PCSCF-Restoration-Indication AVP with value set to PCSCF_RESTORATION.\nFor the non-roaming case and the home routed case, when receiving the AAR command from the P-CSCF, the H-PCRF sends the RAR command to the PCEF, i.e. step 3 is executed.\n3a,\tFor the roaming case with visited access, when the P-CSCF is located in the VPLMN, step 3 is executed with the exception that when receiving the AAR command from the P-CSCF, the V-PCRF sends the RAR command to the PCEF.\nFor the roaming case with local breakout when the P-CSCF is located in the HPLMN, when receiving the RAR command from the H-PCRF, the V-PCRF sends an RAR command to the PCEF, i.e. step 2a is executed.\n4.\tWhen receiving the RAR command for P-CSCF Restoration, the PCEF acknowledges the RAR by sending an RAA command to the PCRF and performs the subsequent P-CSCF Restoration procedure as specified in 3GPP TS 23.380 [35].\nNOTE 1:\tIf the IMS PDN disconnection is performed for P-CSCF Restoration, the PCEF sends a CCR command to the PCRF to terminate the corresponding Gx session.\nFor the non-roaming case and the home routed case, when receiving the RAR command from the H-PCRF, the PCEF acknowledges this message by sending an RAA command to the H-PCRF, i.e. step 4 is executed.\n4a.\tFor the roaming case with visited access, when the P-CSCF is located in the VPLMN, step 4 is executed with the exception that when receiving the RAR command from the V-PCRF, the PCEF acknowledges this message by sending an RAA command to the V-PCRF.\nNOTE 2:\tThis P-CSCF Restoration procedure is applicable to the cases that both the P-CSCF and the PCEF are located in the same PLMN.\nB.6\tIMS Restricted Local Operator Services\nRLOS may be supported as described in subclause B.0 with the following differences:\n-\temergency service is replaced by RLOS;\n-\temergency indication is replaced by RLOS indication;\n-\temergency session is replaced by RLOS session;\n-\temergency APN is replaced by RLOS APN; and\n-\tthe call back functionality is not applicable to RLOS.\nSubclause B.2.2 is not supported for RLOS, because only UE originated RLOS requests are supported and there is no support for mobile terminated services as specified in 3GPP TS 23.221 [66].\nB.7\tRetrieval of Network Provided Location Information for SMS over IP at Originating side\nThis clause covers the optional request of access network information for SMS over IP.\nFigure B.7.1: Retrieval of Access Network Information for SMS over IP at originating side\n1.-\tThe UE sends a SIP MESSAGE request to IMS.\n2.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention of retrieval the access network information. The P-CSCF sends a Diameter AAR command to the PCRF.\n3.\tThe PCRF performs session binding.\n4.\tThe PCRF replies with a Diameter AAA command back to the P-CSCF.\n5.\tThe PCRF requires access network information according to figure 5.2.2.2.1-1.\n6.\tThe PCRF forwards the access network information received in step 5 in a Diameter RAR.\n7.\tThe P-CSCF acknowledges the receipt of Diameter RAR.\n8.\tIMS sends a SIP MESSAGE to the terminating side including the network provided location information.\nAfter, the P-CSCF terminates the AF session as described in subclause 4.3.1.2.3.\nB.8\tRetrieval of Network Provided Location Information for SMS over IP at Terminating side\nThis clause covers the optional request of access network information for SMS over IP.\nFigure B.8.1: Retrieval of Access Network Information for SMS over IP at terminating side\n1.-\tThe P-CSCF receives the 200 OK message on SIP MESSAGE request.\n2.\tThe P-CSCF requests the establishment of a new Diameter Rx session with the intention of retrieval the access network information. The P-CSCF sends a Diameter AAR command to the PCRF.\n3.\tThe PCRF performs session binding.\n4.\tThe PCRF replies with a Diameter AAA command back to the P-CSCF.\n5.\tThe PCRF requires access network information according to figure 5.2.2.2.1-1.\n6.\tPCRF forwards the access network information received in step 5 in a Diameter RAR.\n7.\tThe P-CSCF acknowledges the receipt of Diameter RAR.\n8.\tThe P-CSCF forwards the 200 OK including the network provided location information.\nAfter, the P-CSCF terminates the AF session as described in subclause 4.3.1.2.3.\nAnnex C (normative):NAT Related Procedures\nC.1\tSupport for media traversal of NATs using ICE\nThe IMS calls out procedures for NAT traversal for media and signalling within IMS. One of the methods supported by IMS for media traversal of NATs is a UE controlled NAT traversal solution based on the IETF Interactive Connectivity Establishment (ICE) protocol, IETF RFC 8445 [67]. When a UE uses the ICE protocol for media traversal of NATs, additional enhancements to the existing PCC procedures are necessary to allow for proper ICE operation.\nThis annex presents a set of rules that PCC network elements use to build flow descriptors, identify the proper UE IP addresses used by the PCRF for session and bearer binding, and gating control when the ICE procedures are invoked by the UE.\nIn order for the ICE procedures to work a static, preconfigured PCC rule needs to be in place at the PCEF which allows the UE to perform STUN binding requests prior to offering or answering an SDP.\nNOTE 1:\tPredefined PCC rules can be created to allow the UE to communicate with the STUN relay much in the same way the UE is allowed to communicate with the IMS network for session management.\nNOTE 2:\tGiven that a STUN relay is a forwarding server under the direction of the UE, necessary precaution needs to be taken by the operator in how it chooses to craft these rules. It is recommended that such predefined rules only guarantee the minimal amount of bandwidth necessary to accomplish the necessary UE to STUN relay communication. Such an approach helps reduce the resources required to support NAT traversal mechanisms. Finally, such an approach allows the preconfigured rule to be over-ridden by dynamic rules which allow for the necessary bandwidth needed by the session.\nNOTE 3:\tThe dynamic PCC rule will need to differentiate between different media traffic between UE and STUN relay (e.g. voice vs. video), which can be identified by the different ports assigned by the residential NAT. Session bindings need to take into account that the relevant terminal IP address may be contained within the ICE candidates contained in the session description, rather than in the normal media description.\nNOTE 4:\tIt is assumed that the NAT device is located between the UE and the PCEF. NAT traversal outside of IMS in FBI services is considered FFS in the current 3GPP stage 2 specifications.\nNOTE 5:\tWhen a NAT device is located between the UE and the PCEF, it is assumed that the IP CAN session signalling will contain the IP address assigned by the residential NAT, rather than the UE IP address.\nNOTE 6:\tIt is assumed that NAT devices that assign multiple IP addresses for the UE are outside the scope of release 7.\nNOTE 7:\tIn this release, only one IP address per subscription is supported by session binding at the PCRF. Multiple Ues behind a NAT will use the same IP CAN session and IP address.\nC.2\tP-CSCF procedures\nC.2.1\tGeneral\nThe procedures in clause C.2 are only invoked in the case where the local UE (uplink SDP) has utilized the ICE protocol for media traversal of NATs. The P-CSCF can determine this by inspecting the UE provided SDP (uplink) for the \"a=candidate\" attribute(s). If such attributes are present this is an indication that the UE has invoked the ICE procedures as defined in IETF RFC 8445 [67] and IETF RFC 8839 [68] for media traversal of NATs and the P-CSCF shall follow the requirements in clause C.2.\nC.2.2\tDeriving the Ues IP address\nThe P-CSCF shall set the Framed-IP-Address AVP or Framed-Ipv6-Prefix AVP to the source IP address of SIP messages received from the UE.\nC.2.3\tDeriving flow descriptions\nIn the case where STUN Relay and ICE are used for NAT traversal, the UE is required to place the STUN Relay provided address in the “m=” and “c=” lines of its SDP. Given that these addresses cannot be used by the P-CSCF for building a valid flow description, the P-CSCF will need to determine if a STUN Relay address has been provided in the “m=” and “c=” lines of the UE provided SDP (uplink only). The P-CSCF shall make this determination by inspecting the uplink SDP for “a=candidate” attributes and compare the candidate address with that contained in the “c=” line. If a match is found, the P-CSCF shall then look at the candidate type. If the candidate type is “relay” then the address in the “c=” line is that of a STUN Relay server. In this case, the P-CSCF shall derive the Flow-Description AVP within the service information from the SDP candidate type of “relay” as follows:\nUplink Flow-Description\n-\tDestination Address and Port: If the P-CSCF knows the destination address and port of the STUN Relay allocation that the UE is sending media to, it should use that information. If the P-CSCF does not know this address and port, it shall wildcard the uplink destination address and port.\n-\tSource Address and Port: The P-CSCF shall populate the uplink source address with the “rel-addr” address and the uplink source port with the “rel-port” port contained within the “a=candidate” attribute.\nDownlink Flow-Description\n-\tDestination Address and Port: The P-CSCF shall populate the downlink destination address with the “rel-addr” address and the downlink destination port with the “rel-port” port contained within the “a=candidate” attribute.\n-\tSource Address and Port: If the P-CSCF knows the source address and port of the STUN Relay allocation that the UE is receiving media from, it should use that information. If the P-CSCF does not know this address and port, it shall wildcard the downlink source address and port.\nFor the other candidate types, the address in the “c=” and “m=” SDP attributes can be used for building the flow descriptor and the P-CSCF shall follow the rules to derive the Flow-Description AVP as described in table 6.2.2 of clause 6.2 of this TS.\nC.2.4\tGating control\nIf both endpoints have indicated support for ICE (both the SDP offer and answer contain SDP attributes of type “a=candidate”) ICE connectivity checks will take place between the two Ues. In order to allow these checks to pass through the PCEF, the P-CSCF shall enable each flow description for each media component upon receipt of the SDP answer.\nC.2.5\tBandwidth impacts\nICE has been designed such that connectivity checks are paced inline with RTP data (sent no faster than 20ms) and thus consumes a lesser or equal amount of bandwidth compared to the media itself (given the small packet size of a STUN connectivity check it is expected that the STUN connectivity checks will always have a smaller payload than the media stream itself). Thus, there are no additional requirements on the P-CSCF for bandwidth calculations for a given media flow.\nC.3\tPCRF procedures\nC.3.1\tGeneral\nThe procedures in clause C.3 are only invoked when the following two conditions are met:\n1.\tBoth the local and remote UE have utilized the ICE protocol for media traversal of NATs (see clause C.2.1 for details on how this is determined); and\n2.\tThe IP-CAN which is servicing the IMS session does not support the concept of a default bearer.\nC.3.2\tDeriving additional flow descriptions\nThe PCRF may need to develop additional flow descriptions (beyond those provided by the P-CSCF) for a media component based on additional candidate addresses present in the SDP offer/answer exchange. The PCRF shall follow the procedures defined in IETF RFC 8445 [67] and IETF RFC 8839 [68] for forming candidate pairs based on the data contained within the received Codec-Data AVP. For each candidate pair created based on the ICE procedures and not already present in the received flow descriptions, the PCRF shall add an uplink and downlink flow description for each media component.\nNOTE 1:\tThe uplink SDP represents the local candidates while the downlink SDP represents the remote candidates.\nFollowing the ICE procedures for forming candidate pairs will result in some flow descriptions which would never be exercised. In particular, while the UE will send connectivity checks (and ultimately its media stream) from its host candidate, from the PCEF perspective, this will appear as being from the server reflexive address. Given this, the PCRF should not form flow descrptions using host candidate addresses and should only form additional flows based on server reflexive addresses and relay addresses.\nAs candidates are removed from the SDP via subsequent offer/answer exchanges, the PCRF shall update its candidate pair list and shall remove any flow descriptors no longer being used.\nNOTE 2:\tIf the default candidate (the candidate used to populate the \"c=\" and \"m=\" lines of both the uplink and downlink SDP) is chosen, then an updated SDP offer/answer will not be done, and any extra flow descriptions not being used by the session will not be removed.\nC.3.3\tGating control\nFor each additional flow description the PCRF adds to a media component (per clause C.3.2), the PCRF shall enable the flow in order to allow connectivity checks to pass.\nC.3.4\tBandwidth impacts\nPer clause C.2.5 ICE is designed to have minimal impact on bandwidth policy control. However, it is possible that media will begin flowing while the ICE connectivity checks are still in progress. Given the possibility that no session update will be made (the default candidates will be chosen by the ICE protocol), it is not recommended that the PCRF adjust the bandwidth parameters provided by the P-CSCF.\nC.4\tP_CSCF procedures to support media traversal through hosted NAT without ICE\nBoth the media flows and the SIP signalling can traverse a NA(P)T device located in the customer premises domain, or “hosted NAT”, as described in Annex F of 3GPP TS 24.229 [5]. The hosted NAT will modify the source IP address and source port of uplink IP packets, and the destination IP address and port of downlink IP packets. The IP addess and port information provided by the UE are thus not appropriate to configure PCC rules.\nThe UE may use ICE procedures for hosted NAT traversal, and related PCC procedures are described in clauses C.1 to C.3. The present clause provides procedures to cover the case where ICE is not used.\nIf the P-CSCF determines that the UE is located behind a hosted NAT (using procedures in Annex F of 3GPP TS 24.229 [5]) and that ICE is not used (using procedures in clause C.2.1), the P-CSCF shall, within the service information sent to the PCRF:\n-\tprovide the source IP address of IP packets transporting incoming SIP messages from the UE as destination IP address of downlink media streams;\n-\tfor Ipv4, provide the source IP address of IP packets transporting incoming SIP messages from the UE as source address of uplink media streams;\n-\tfor Ipv6, derive the source address of uplink media streams from the prefix of the source IP address of IP packets transporting incoming SIP messages from the UE;\n-\twildcard source ports of uplink media streams; and\n-\twildcard destination ports of downlink media streams.\n-\tprovide the port information within SDP sent towards the served UE as source ports of corresponding downlink media streams.\n-\tprovide the port information within SDP sent towards the served UE as destination ports of corresponding uplink media streams.\nAnnex D (normative):Access specific procedures for GPRS\nD.1\tGeneral\nThe present annex defines IP-CAN specific requirements for General Packet Radio Service (GPRS).\nD.2\tBinding Mechanisms\nDepending on the bearer control mode, bearer binding can be executed either by PCRF, PCEF or both PCRF and PCEF.\n-\tFor “UE-only” IP-CAN bearer establishment mode, the PCRF performs bearer binding.\n-\tFor “UE/NW” IP-CAN bearer establishment mode, the PCRF performs the binding of the PCC rules for user controlled services while the PCEF performs the binding of the PCC rules for the network controlled services.\nIf the PCEF performs the bearer binding, the PCRF shall follow the procedures as described in clause 5.4 with the exceptions described in this subclause.\nIf the Bearer Binding function is located at the PCEF, the PCEF shall check the QCI and ARP indicated by the PCC Rule(s) and bind the PCC rule with an IP-CAN bearer that has the same QCI and Evolved ARP (if this is supported by the SGSN).\nIf there is no suitable PDP-Context to accommodate a PCC rule when PCEF performs the bearer binding, the PCEF shall initiate the establishment of PDP-Contexts as specified in 3GPP TS 23.060 [3].\nThe PCEF shall not combine PCC rules with different ARP to the same bearer. If the Evolved ARP parameter is not supported by the SGSN, the PCEF shall map the Evolved ARP to Rel-99 ARP as specified in clause B.3.3.3 of 3GPP TS 29.212 [9].\nNOTE:\tIf Evolved ARP is not supported by the SGSN then this enables a modification of the PDP context ARP without impacting the bearer binding after relocation to a SGSN that supports Evolved ARP.\nIf the Bearer Binding function is located at the PCRF, the PCRF shall compare the TFT(s) of all IP-CAN bearer(s) within the IP-CAN session received via PCEF from the UE with the existing service data flow filter information. The PCRF shall indicate to the PCEF the IP-CAN bearer within the IP-CAN session where the PCC Rules shall be installed, modified or removed. This is done including the Bearer-Identifier AVP together with the associated PCC Rules within the corresponding RAR and/or CCA commands.\n-\tWhen the PCRF does not require additional filter information coming from the UE in order to decide on bearer binding, the PCRF shall supply the PCC rules to be installed over the Gx interface to the PCEF within a RAR command.\n-\tOtherwise, the PCRF shall wait for the PCEF requesting a policy decision for the establishment of a new IP-CAN bearer or the modification of an existing one within a CCR command over the Gx interface.\n-\tWhen the PCEF reports the bearer event, it shall include within the CCR command a bearer reference together with the new or modified TFT information, the QCI and associated bitrates for new or modified PDP-Contexts.\nD.3\tPCC Procedures\nD.3.1\tIP-CAN Session Modification\nD.3.1.1\tNetwork-initiated IP-CAN Session Modification\nNetwork-initiated IP-CAN session modification is executed according to clause 4.3.1.1 with the following differences:\n-\tThe timer in step 4 will also be activated waiting for one of the following cases:\n-\tIf the authorized QoS for an IP-CAN bearer is changed or\n-\tIf one or more Flow Descriptions need to be added, deactivated or removed in any of the PCC rules bound to an IP-CAN bearer\n-\tIf the timer in step 4 expires and the PCRF still requires additional filter information coming from the UE in order to decide on bearer binding for new PCC rules to be installed, all subsequent steps in figure 4.3.1.1.1 shall not be executed, and further reactions of the PCRF are left unspecified. As a possible option, the PCRF could abort the AF session.\n-\tWhen the PCRF performs the bearer binding, once the PCC rules are selected, the PCRF identifies the IP-CAN bearer for each of the PCC rules and the authorized QoS. The PCRF may provision PCC Rules and authorized QoS for several IP-CAN Bearers within the same RAR command.\n-\tFor step 9, IP-CAN session signalling, the subsequent steps are executed separately for each IP-CAN bearer under the following conditions:\n-\tif all PCC rules bound to a PDP context have been removed or deactivated (PDP Context deactivation is applicable)\n-\tif one or more PDP contexts have to be modified\n-\tif in UE/NW Bearer Control Mode, the GGSN needs to establish a new PDP context(PDP Context establishment is applicable) if the bearer binding is located at the PCEF.\nThe GGSN initiates the procedure to Create/Update or Terminate PDP Context Request message to the SGSN. If in the case of updating the PDP Context the authorized QoS for the bearer has changed, the GGSN will modify the UMTS QoS parameters accordingly.\nWhen the procedure in step 9 is completed and requires notifications from the GW, for an IP-CAN Bearer termination in UE-Only Bearer Control Mode, the GGSN sends a Diameter CCR with the Bearer-Identifier and Bearer-Operation AVPs to indicate “Termination”.\nD.3.1.2\tPCEF-initiated IP-CAN Session Modification\nPCEF-initiated IP-CAN Session Modification procedure shall take place according to clauses 4.3.2.1 and 4.3.2.2 except for those procedures initiated by the UE, as described in the clauses below.\nD.3.1.2.1\tUE-initiated IP-CAN Bearer Establishment or IP-CAN Bearer Modification\nThis clause is applicable for the establishment of a new IP-CAN Bearer (other than the one which created the IP-CAN session) and for the modification of an already established IP-CAN Bearer. The signalling flows for these cases are as per Figure 4.3.1.2.1.\nA bearer-event-initiated Request of PCC Rules occurs when a new bearer is established or when an existing bearer is modified. For GPRS, these are PDP Context Modification(s) or secondary PDP context Activation(s). An IP-CAN Session modification triggers a PCC Rule request only if the PCRF has previously requested a PCC Rule request for the given modification event.\nFigure D.3.1.2.1: UE-initiated IP-CAN Bearer Establishment and Modification.\n1.\tThe GW receives IP-CAN Bearer signalling that is a trigger for a PCC Rule request. For GPRS, the GGSN receives a secondary Establish PDP Context Request or an Update PDP Context Request.\n2.\tThe GW informs the PCRF of the modification of the IP-CAN Session due to the IP-CAN Bearer signalling in step 1, using a Diameter CCR with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The GW reuses the existing Gx DCC session corresponding to the IP-CAN Session.\nIf the IP-CAN Bearer signalling in step 1 established a new IP-CAN Bearer, the GW assigns a new bearer identifier to this IP-CAN Bearer. The GW provides information about the new or modified bearer, e.g. requested QoS and TFT filters. If the event that caused the bearer modification applies uniquely to that bearer and PCRF performs the bearer binding, then, the bearer identifier should be provided within the CCR. If no bearer identifier is provided, the event trigger will apply to the IP-CAN session.\n3.\tThe PCRF stores the received information in the Diameter CCR.\n4.\tThe PCRF binds the IP-CAN Session to existing of AF session(s) using the information received from the GW and the Service Information included in the stored PCC rules, which was previously received from the AF(s) , as depicted in figure 4.3.1.1.1.The PCRF also binds the IP-CAN Bearers within the IP-CAN Session to all matching IP flow(s) of existing AF session(s) using the bearer information received from the GW and the Service Information received from the AF(s). If IP flow(s), which have previously been bound to other bearers, have been bound to the modified bearer, PCC Rules in other bearer(s) may need to be removed. For GPRS, an IP flow may need to be removed if a matching higher priority TFT filter in the newly established PDP context takes precedence over a matching lower priority TFT filter in another PDP context. Furthermore, if IP Flow(s), which have previously been bound to the modified bearer are be bound to other bearer(s), PCC Rules may need to be installed in other bearers. For GPRS, an IP flow may be bound to another PDP context if it was previously bound to the modified PDP context due to a removed higher priority TFT filter, and a lower priority TFT filter in the other PDP context matches the IP flow.\n5.\tIf the PCRF requires subscription-related information and does not have it, the PCRF sends a request to the SPR in order to receive the information.\n6.\tThe SPR replies with the subscription related information containing the information about the allowed service(s) and PCC Rules information.\nNOTE:\tFor steps 5 and 6: The details associated with the Sp reference point are not specified in this Release. The SPR’s relation to existing subscriber databases is not specified in this Release.\n7.\tFor IP CAN session modification, if the AF requested a notification of the corresponding event at the initial authorisation of the AF session, the PCRF shall sent a Diameter RAR with the Specific-Action AVP set to indicate the trigger event that caused the request.\n8.\tIf step 7 happens, the AF replies with a Diameter RAA and may provide updated service information within.\n9.\tThe PCRF selects the new PCC Rule(s) to be installed. The PCRF can also identify existing PCC Rules that need to be modified or removed. The PCC Rules may relate to any of the matching AF sessions identified in step 4 or may exist in the PCRF without matching to any AF session. The PCRF may also make a policy decision by defining an authorized QoS and by deciding whether service flows described in the PCC Rules are to be enabled or disabled. For types of IP-CAN, where the PCRF controls IP-CAN Bearers, e.g. GPRS, the PCC Rules may affect the IP-CAN Bearer identified in the CCR of step 2 or any other IP-CAN Bearer identified in step 4.\n10.\tThe PCRF stores the modified PCC Rules.\n11.\tThe PCC Rules are provisioned by the PCRF to the GW using Diameter CCA. The PCRF may also provide authorized QoS. The PCRF identifies the affected IP-CAN Bearer for each of the PCC Rules and the authorized QoS. The PCRF may provision PCC Rules and authorized QoS for several IP-CAN Bearers within the same CCA.\n12.\tThe GW installs the received PCC Rules. The GW also enforces the authorized QoS and enables or disables service flow according to the flow status of the corresponding PCC Rules.\n13.\tThe GW sends a response to the IP-CAN Bearer signalling in step 1.For GPRS, the GGSN accepts the secondary Establish PDP Context Request or the Update PDP Context Request based on the results of the authorisation policy decision enforcement and sends an Establish PDP Context Response or Update PDP Context Response. If the requested QoS parameters do not correspond to the authorized QoS, the GGSN adjusts (downgrades/upgrades) the requested UMTS QoS parameters to the authorized values.\nThe PCRF may have decided in step 4 to modify PCC Rules and/or authorized QoS of other IP CAN bearers than the IP-CAN Bearer identified in the CCR of step 2. For each such other IP-CAN Bearer identified in step 4, the GGSN executes the following steps.\n14.\tThe PCRF may start a timer to wait for PDP context modification requests from the UE.\n15.\tThe PCRF interacts with the GW according to figure 4.3.1.1.1.\nD.3.1.2.2\tUE-initiated IP-CAN Bearer Termination\nThis clause is applicable if an IP-CAN Bearer is being released while other IP-CAN Bearers and thus the IP-CAN Session are not released.\nFor the termination of IP-CAN Bearers, three cases are covered:\n-\tBearer release that does not cause service data flow(s) within an AF session to be disabled;\n-\tBearer release that causes at least one but not all the service data flow(s) within an AF session to be disabled; and\n-\tBearer release that causes all the service data flows within an AF session to be disabled.\nA Bearer release may not cause a service data flow within this bearer to be disabled if the IP flow can be bound to another bearer. For GPRS, an IP flow can be bound to another PDP context if a lower precedence TFT filter matching the IP flow is installed at the other PDP context.\nFigure D.3.1.2.2: UE-Initiated IP-CAN Bearer Termination\n1.\tThe GW receives a Remove IP-CAN Bearer Request that request the deactivation of an IP-CAN Bearer while other IP-CAN Bearers and thus the IP-CAN Session are not released. The form of the Remove IP-CAN Bearer Request depends upon the type of the IP-CAN. For GPRS, the GGSN receives a Delete PDP Context Request.\n2.\tThe GW sends a Diameter CCR message with the CC-Request-Type AVP set to the value UPDATE_REQUEST to the PCRF, indicating the IP-CAN Bearer termination.\n3.\tThe PCRF identifies the IP flows bound to the removed bearer and updates the stored bearer information. The PCRF re-evaluates the binding of IP flows, as IP flows may now be bound to other bearers. For GPRS, an IP flow may be bound to another PDP Context if it was previously bound to the removed PDP context due to a higher priority TFT filter, and a lower priority TFT filter in another PDP context matches the IP flow.\nThe following steps 4 and 5 are performed for each of the other bearers identified in step 3:\n4.\tThe PCRF selects the PCC Rule(s) to be installed or modified for the affected bearer. The PCRF may also update the policy decision for this bearer.\n5.\tThe PCRF stores the updated PCC Rules for the affected bearer.\n6.\tThe PCRF acknowledges the bearer termination by sending a Diameter CCA message. The PCRF provides PCC Rules and possibly updated authorized QoS for each of the other bearers identified in step 3. The PCRF identifies the affected IP-CAN Bearer for each of the PCC Rules and the authorized QoS.\n7.\tThe GW removes those PCC Rules, which have not been moved to other IP CAN bearers by the CCA message and are installed in the IP-CAN bearer, for which a termination has been requested in step 1.\n8.\tThe GW sends a Remove IP-CAN Bearer Response. For GPRS, the GGSN sends the Delete PDP Context Response message.\n9.\tIt the PCRF has provided PCC Rules and possibly updated authorized QoS for other bearers in step 6, the GW installs or modifies the identified PCC Rules. The GW also enforces the authorized QoS and enables or disables service flow according to the flow status of the corresponding PCC Rules.\nThe following steps 10 to 13 or 10a to 13a apply for the case where at least one IP Flow within an AF session is being disabled, i.e. if the IP Flow is not bound to any other bearer that is still established. The steps shall be performed separately for each ongoing AF session that is affected by the bearer release as explained below.\nIf all IP flow(s) within the AF session are disabled by the bearer release:\n10.\tThe PCRF indicates the session abort to the AF by sending a Diameter ASR message to the AF.\n11.\tThe AF responds by sending a Diameter ASA message to the PCRF.\n12.\tThe AF sends a Diameter STR message to the PCRF to indicate that the session has been terminated.\n13.\tThe PCRF responds by sending a Diameter STA message to the AF.\nIf at least one but not all of the IP flow(s) within the AF session are disabled by the bearer release, and the AF has requested notification of bearer removal:\n10a.\tThe PCRF indicates the release of the bearer by sending a Diameter RAR to the AF.\n11a.\tThe AF responds by sending a Diameter RAA to the PCRF.\n12a.\tThe AF may send an AAR to the PCRF to update the session information.\n13a.\tIf step 12a occurs, the PCRF responds by sending a AAA to the AF.\nAnnex E (normative):Fixed Broadband Access Interworking with EPC\nE.1\tGeneral\nThe present annex defines specific requirements for Fixed Broadband Access Interworking with EPC.\nE.2\tDefinitions and abbreviations\nE.2.1\tDefinitions\nUE local IP address is defined as: either the public Ipv4 address and/or Ipv6 address/Ipv6 network prefix assigned to the UE by the BBF domain in the no-NAT case, or the public Ipv4 address assigned by the BBF domain to the NATed RG that is used for this UE.\nH(e)NB local IP address is defined as: either the public Ipv4 address and/or Ipv6 address/Ipv6 network prefix assigned to the H(e)NB by the BBF domain in the no-NAT case, or the public Ipv4 address assigned by the BBF domain to the NATed RG that is used for this H(e)NB.\nNon-seamless WLAN offload (NSWO) is defined as: a capability of routing specific IP flows over the WLAN access without traversing the EPC as defined in clause 4.1.5 of 3GPP TS 23.402 [21].\nNon-seamless WLAN offload APN (NSWO-APN) is defined as: an APN allowing the BPCF to indicate to PCRF that for subscribers of a certain HPLMN the IP-CAN session is related to NSWO traffic.\nEPC-routed traffic is defined as: User plane traffic that is routed via a PDN GW in EPC as part of a PDN Connection. EPC-routed traffic applies to non-roaming, roaming with home routed and roaming with visited access cases.\nE.2.2\tAbbreviations\nThe following abbreviations are relevant for this annex only:\nBBF\tBroadband Forum\nBPCF\tBroadband Policy Control Function\nNA(P)T\tNetwork Address (Port) Translation\nNSWO\tNon-Seamless WLAN offload\nNSWO-APN\tNon-Seamless WLAN offload APN\nRG\tResidential Gateway\nE.3\tBinding Mechanisms\nE.3.1\tEPC-routed traffic\nFor EPC- routed traffic, binding mechanisms apply as defined insub clause 5.1 by PCRF, PCEF and BBERF. In addition, if both a Gx and associated S9a session exist for the same IP-CAN session, the PCRF shall generate QoS Rules for all the authorized PCC rules.\nE.3.2\tNSWO traffic\nThe binding mechanism includes two steps for the NSWO traffic:\n1.\tSession binding.\n2.\tPCC rule authorization.\nFor NSWO traffic, session binding of AF session to an IP-CAN session is performed by the PCRF for the purpose of policy control in the Fixed Broadband access network.\nWhen the PCRF accepts an AA-Request from the AF over the Rx interface with service information, the PCRF shall perform session binding and associate the described service IP flows within the AF session information (and therefore the applicable PCC rules) to one and only one existing IP-CAN session. This association is done comparing the user IP address received via the Rx interface in either the Framed-IP-Address AVP or the Framed-Ipv6-Prefix AVP with the Ipv4 address or Ipv6 address/Ipv6 prefix received via the S9a or S9 interface. The user identity if present in the Subscription-Id AVP and the PDN information if available in the Called-Station-Id AVP may also assist on this association.\nThe PCRF determines that the UE has an IP-CAN session if the IP address (Ipv4 or Ipv6) received over the Rx interface matches the Ipv4 address or Ipv6 address/Ipv6 prefix received via one or more of the following interfaces: S9a interface and S9 interface, and if the user identity is used to assist the association, the user identity received over the Rx interface matches the user identity received via one or more of the following interfaces: S9a interface and S9 interface.\nNOTE 1:\tIn case the user identity in the IP-CAN and the application level identity for the user are of different kinds, the PCRF needs to obtain the mapping between the identities. Such mapping is not subject to specification within this TS.\nNOTE 2: An Ipv6 address provided over Rx matches an Ipv6 prefix provided over S9a or S9 if the Ipv6 address belongs to the Ipv6 (sub-)network prefix.\nAs a result from the session binding function, the PCRF identifies what IP-CAN session the current AF session is related with. If the PCRF is not capable of executing the Session Binding, the PCRF shall issue an AA-Answer command to the AF with a negative response.\nNOTE:\tFor roaming cases, the H-PCRF performs session binding of the AF session to an IP-CAN session.\nThe PCRF derives and authorises PCC rules as described in clause 5.\nE.4\tPCC Procedures\nE.4.1\tIntroduction\nFrom the network scenarios listed in clause 4.0, in order to support interworking with Fixed Broadband access network, three distinct network scenarios are defined as follows:\n-\tthe Case 1 (no Gateway Control Session over Gxx reference point) applies to GTP-based S2a or GTP-based S2b, trusted S2c and GTP-based S5/S8 H(e)NB scenarios.\n-\tthe Case 2a (the same Gateway Control Session over Gxx reference point) applies to untrusted S2c.\n-\tthe Case 2b (a Gateway Control Session over Gxx reference point per IP-CAN Session) applies to PMIP-based S2b and PMIP-based S5/S8 H(e)NB scenarios.\nNOTE:\tNo policy interworking solution based on S9a is defined for Fixed Broadband access interworking via S2a in this Release.\nAdditionally, for case 1, the PCRF checks whether the CoA information is included in the CC-Request command to differentiate the GTP-based S2b case and trusted S2c case. If it is included, the trusted S2c case applies; otherwise, the GTP-based S2b case applies.\nE.4.2\tIP-CAN Session Establishment\nE.4.2.1\tIP-CAN Session Establishment for EPC- routed traffic\nThis procedure is applicable for WLAN and H(e)NB scenarios for EPC-routed traffic. This procedure is same as described in clause 4.1 with the exceptions described in this clause.\nFigure E.4.2.1.1 IP-CAN Session Establishment for EPC-routed traffic\n1.\tStep 1 through step 6: as specified in Figure 4.1.1: IP-CAN session establishment are executed towards the H-PCRF (non-roaming case or home routed case) or towards the V-PCRF (roaming case).\nFor case 2a and case 2b of the WLAN scenario and for case 2b of the H(e)NB scenario, the BBERF provides the data as described in 3GPP TS 29.212 [9], clause E.5.2.\nFor case 1, the PCEF provides the data as described in 3GPP TS 29.212 [9], clause E.5.1.\nFor case 1 (visited access), case 2a and case 2b (home routed and visited access) the V-PCRF forwards the data towards the H-PCRF.\nNOTE: For the roaming case, the V-PCRF omits the UE Local IP address (WLAN scenario), the H(e)NB Local IP address and the UDP port in the S9 reference point.\n2.\tFor GTP/PMIP-based S2b of the WLAN scenario (non-roaming case) the PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure triggered by the Gateway Control session establishment or Indication of IP-CAN session establishment in step 1.\nFor trusted and untrusted S2c of the WLAN scenario (non roaming case), when there is not an already established S9a session for the user, the PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure triggered by the Gateway Control session establishment in step 1; otherwise, the PCRF may send a RAR command to BPCF to provide the QoS rules to the BPCF.\nFor H(e)NB scenarion (non roaming case), when there is not an already established S9a session for the H(e)NB Local IP address, the PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure triggered by the Gateway Control session establishment or Indication of IP-CAN session establishment in step 1; otherwise, the PCRF may send a RAR command to BPCF to provide the QoS rules to the BPCF.\nThe PCRF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.1\nFor case 1 (roaming with home routed case), the steps 2a and step 2b are executed instead of step 2.\n2a. If there is not an already established S9 session for the user, the H-PCRF sends a TER command to V-PCRF to trigger an S9 session establishment procedure triggered by the Indication of IP-CAN session establishment in step 1; otherwise, the H-PCRF sends a RAR command to V-PCRF to trigger an S9 subsession establishment procedure.\nThe H-PCRF trigger an S9 session/subsession establishment procedure as described in 3GPP TS 29.215 [22], clause A.6.1.1.1 or A.6.3.1.0.\n2b. For GTP-based S2b of the WLAN scenario, the V-PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure.\nFor trusted S2c of the WLAN scenario, if there is not an already established S9a session for the user, the V-PCRF sends a TER command to BPCF; otherwise, the PCRF may send a RAR command to BPCF to provide the QoS rules to the BPCF.\nFor the H(e)NB scenario and if there is not an already established S9a session for the H(e)NB local IP address, the V-PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure; otherwise the V-PCRF may send a RAR command to BPCF to provide the QoS rules to the BPCF.\nThe V-PCRF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.1.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 2c is executed instead of step 2.\n2c. For trusted and untrusted S2c of the WLAN scenario when there is not an already established S9a session for the user, the V-PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure; otherwise, the PCRF may send a RAR command to BPCF to provide the QoS rules to the BPCF.\nFor GTP/PMIP-based S2b of the WLAN scenario the V-PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure.\nFor case 1 and case 2b of the H(e)NB scenario when there is not an already established S9a session for the H(e)NB local IP address, the V-PCRF sends a TER command to BPCF to trigger an S9a session establishment procedure; otherwise, the V-PCRF may send a RAR command to provide the QoS rules to the BPCF.\nThe V-PCRF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.1.\n3.\tThe BPCF acknowledges to the PCRF by sending the TEA /RAAcommand.\nFor case 1(roaming with home routed case), steps 3a and step 3b are executed instead of step 3.\n3a. The BPCF acknowledges to the V-PCRF by sending the TEA /RAAcommand.\n3b. The V-PCRF acknowledges to the H-PCRF by sending the TEA/RAA command.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 3c is executed instead of step 3.\n3c. The BPCF acknowledges to the V-PCRF by sending the TEA/RAA command.\n4.\tFor the non-roaming case, triggered by step 2, the BPCF initiates an S9a session establishment with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.2.\nFor case 1 (roaming with home routed case), the steps 4a~4c are executed instead of step 4.\n4a. Triggered by step 2b, the BPCF initiates an S9a session establishment with the V-PCRF by sending a CCR to the V-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.2.\n4b. The V-PCRF determines that the request is for a roaming user and stores the received information.\n4c. If there is not an already established S9 session for the user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT. If there is an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), the steps 4d~step 4e are executed instead of step 4.\n4d. Triggered by step 2c, the BPCF initiates an S9a session establishment with the V-PCRF by sending a CCR to the V-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF provides the data as described in 3GPP TS 29.215 [22], clause A.5.1.2.\n4e. The V-PCRF determines that the request is for a roaming user and stores the received information.\n5.\tThe H-PCRF stores the information received in the CCR.\n6.\tFor the non-roaming case, the H-PCRF acknowledges the S9a session establishment by sending a CCA to the BPCF.\nFor case 1 (roaming with home routed case), steps 6a~6b are executed instead of step 6.\n6a. The H-PCRF acknowledges the S9 session establishment/modification by sending a CCA to the V-PCRF.\n6b. The V-PCRF acknowledges the S9a session establishment by sending a CCA to the BPCF.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), the step 6c is executed instead of step 6.\n6c. The V-PCRF acknowledges the S9a session establishment by sending a CCA to the BPCF.\n7.\tStep 7 through step 15: as specified in Figure 4.1.1: IP-CAN session establishment are executed. Step 13 is only applicable to case 2b of H(e)NB scenario.\nE.4.2.2\tIP-CAN Session Establishment for NSWO traffic\nFigure E.4.2.2.1: IP-CAN Session Establishment for NSWO traffic\n1.\tThe broadband access network becomes aware of the IMSI of the 3GPP UE if 3GPP-based access authentication (EAP-AKA/AKA’) is performed. The BPCF also becomes aware of the UE local IP address.\n2.\tFor the non-roaming case, the BPCF initiates an S9a* session establishment procedure with the H-PCRF by sending a CCR using the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF shall provide the data as described in 3GPP TS 29.215 [22], clause A.5.1.2.1.\nFor the roaming case, steps 2a~2c are executed instead of step 2.\n2a.The BPCF initiates an S9a* session establishment procedure with the V-PCRF by sending a CCR to the V-PCRF using the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF shall provide the data as described in 3GPP TS 29.215 [22], clause A.5.1.2.1.\n2b. The V-PCRF determines that the request is for a roaming user and stores the received information.\n2c. If there is not an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\nIf there is an already established S9 session for this roaming user, the V-PCRF sends a CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The V-PCRF includes the Subsession-Enforcement-Info AVP within the CCR with a new S9 subsession identifier assigned by the V-PCRF to this IP-CAN session within the Subsession-Id AVP, and the Subsession-Operation AVP set to the value ESTABLISHMENT.\n3.\tThe H-PCRF stores the information received in the CCR.\n4.\tPerform step 5 through 11: as specified in Figure 4.1.1: IP-CAN session establishment. Additionally, an indication on whether policy control for NSWO traffic should be performed for the UE may be retrieved from the SPR. The H-PCRF enables policy control for NSWO traffic for that UE based on operator policies and user profile information that may depend on e.g. NSWO-APN being used by the UE.\n5.\tFor the non-roaming case, the H-PCRF provisions the PCC Rules to the BPCF using CCA if policy control is enabled.\nFor the roaming case, steps 5a~5f are executed instead of step 5.\n5a. The H-PCRF provisions the PCC Rules if available to the V-PCRF using CCA if policy control is enabled. The H-PCRF includes PCC Rules and ADC Rules if available in the Subsession-Decision AVP of the CCA, along with the S9 subsession identifier as received in step 2c within the Subsession-Id AVP.\n5b.\tIf policy control is enabled in step 5a, the V-PCRF stores the received PCC rules if available. The V-PCRF enforces visited operator policies regarding QoS authorization requested by the H-PCRF as indicated by the roaming agreements.\n5c.\tThe V-PCRF informs the H-PCRF when a request has been denied and may provide the acceptable QoS information for the service.\n5d.\tThe H-PCRF acknowledges the CCR and may additionally include new or modified PCC rules to the V-PCRF. When user profile configuration indicates that Application Detection and Control function is enabled, the H-PCRF may additionally include new or modified PCC rules for application detection and control.\n5e. In case of solicited application reporting with a TDF, the V-PCRF initiates a TDF Session Establishment procedure, according to clause 4.6.1, with the selected TDF.\n5f.\tThe V-PCRF provisions PCC rules received from the H-PCRF to the BPCF by using CCA.\nE.4.3\tIP-CAN Session Termination\nE.4.3.1\tIP-CAN Session Termination for EPC- routed traffic\nFigure E.4.3.1.1: IP-CAN Session Termination for EPC-routed traffic\n1.\tPerform the step 1 through step 3: as defined in Figure 4.2.1.1: UE-initiated IP-CAN session termination-AF located in HPLMN, step 1 through step 5: as defined in Figure 4.2.2.1: PCEF-initiated IP-CAN session termination-AF located in HPLMN or step 1 through step 8: as defined in Figure 4.2.3.1: PCRF-initiated IP-CAN session termination-AF located in HPLMN.\n2.\tFor GTP/PMIP-based S2b of the WLAN scenario (non-roaming case), triggered by a Gateway control session termination from BBERF(ePDG) or by an Indication of IP-CAN session termination from PCEF, the H-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session.\nFor trusted and untrusted S2c of the WLAN scenario (non-roaming case), triggered by the Indication of IP-CAN session termination, the H-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session when the last PDN connection is released for this user; otherwise, the H-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection.\nFor H(e)NB scenario (non-roaming case), triggered by a Gateway control session termination from BBERF(S-GW) or by an indication of IP-CAN session termination, the H-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session when last PDN connection is released for this H(e)NB Local IP address; otherwise, the H-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection.\nFor case 1 (roaming with home routed case), the steps 2a and step 2b are executed instead of step 2.\n2a. If the subsession being terminated is the last subsession over S9, the H-PCRF sends a RAR including the Session-Release-Cause AVP to the V-PCRF to indicate the termination of the S9 session. Otherwise, the H-PCRF sends a RAR to the V-PCRF including the Subsession-Decision-Info AVP with the Session-Release-Cause AVP to indicate the request for terminating the S9 subsession corresponding to the IP-CAN session.\n2b. For GTP-based S2b of the WLAN scenario, the V-PCRF sends a RAR including the Session-Release-Cause AVP to the BPCF to indicate the request for terminating the S9a session.\nFor trusted S2c of the WLAN scenario, the V-PCRF sends a RAR including the Session-Release-Cause AVP to the BPCF to indicate the request for terminating the S9a session when the last PDN connection is released for this user; otherwise, the V-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection.\nFor the H(e)NB scenario, the V-PCRF sends a RAR including the Session-Release-Cause AVP to the BPCF to indicate the request for terminating the S9a session when the last PDN connection is released for this H(e)NB Local IP address; otherwise, the V-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 2c is executed instead of step 2.\n2c. For GTP/PMIP-based S2b of the WLAN scenario, triggered by a Gateway control session termination from BBERF(ePDG) or by an Indication of IP-CAN session termination, the V-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session.\nFor trusted and untrusted S2c of the WLAN scenario, triggered by the Indication of IP-CAN session termination or S9 session/subsession termination request from the H-PCRF , the V-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session when the last PDN connection is released for this user; otherwise, the V-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection\nFor case 1 and case 2b of H(e)NB scenario, triggered by a Gateway control session termination from the BBERF(S-GW) or by an Indication of IP-CAN session termination, the V-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a session when the last PDN connection is released for this H(e)NB Local IP address; otherwise, the H-PCRF sends a RAR to BPCF to remove all the QoS rules related to the released PDN connection.\n3.\tFor the non-roaming case, the BPCF sends a RAA to acknowledge the RAR.\nFor case 1 (roaming with home routed case), the steps 3a and 3b are executed instead of step 3.\n3a.\tThe BPCF sends a RAA to the V-PCRF.\n3b.\tThe V-PCRF sends a RAA to the H-PCRF.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 2c is executed instead of step 2.\n3c. The BPCF sends a RAA to the V-PCRF.\n4.\tFor the non-roaming case, the BPCF sends a CCR to the H-PCRF to indicate the S9a session termination if the H-PCRF requests that the BPCF terminates the S9a session in step 2. The BPCF requests the termination of the S9a session using the CC-Request-Type set to the value TERMINATION_REQUEST.\nFor case 1(roaming with home routed case), the steps 4a and 4b are executed instead of step 4\n4a.\tThe BPCF sends a CCR to the V-PCRF to indicate the S9a session termination if the V-PCRF requests that the BPCF terminates the S9a session in step 2b. The BPCF requests the termination of the S9a session using the CC-Request-Type set to the value TERMINATION_REQUEST.\n4b.\tThe V-PCRF sends a CCR to the H-PCRF to indicate the S9 session termination if the H-PCRF requests that the V-PCRF terminates the S9 session in step 2a. The V-PCRF requests the termination of the S9 session using the CC-Request-Type set to the value TERMINATION_REQUEST.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 4c is executed instead of step 4.\n4c.\tThe BPCF sends a CCR to the V-PCRF to indicate the S9a session termination if the V-PCRF request that the BPCF terminates the S9a session in step 2c. The BPCF requests the termination of the S9a session using the CC-Request-Type set to the value TERMINATION_REQUEST.\n5.\tFor the non-roaming case, the H-PCRF sends a CCA to acknowledge the CCR.\nFor case 1 (roaming with home routed case), the steps 5a and 5b are executed instead of step 5\n5a. The H-PCRF sends a CCA to acknowledge the CCR.\n5b. The V-PCRF sends a CCA to acknowledge the CCR.\nFor case 1 (visited access) and for case 2a and case 2b (visited access or home routed case), step 5c is executed instead of step 5.\n5c. The V-PCRF sends a CCA to acknowledge the CCR.\n6.\tPerform the step 3 through step 7: as defined in Figure 4.2.1.1: UE-initiated IP-CAN session termination-AF located in HPLMN,\n7.\tPerform the step 8 through step 11 :As Specified in Figure 4.2.1.1 for AF located in HPLMN or step 2 through step 9 :as specified in Figure 4.2.1.2 for AF located in VPLMN\n8.\tPerform the step 12 through step 15: as defined in Figure 4.2.1.1: UE-initiated IP-CAN session termination-AF located in HPLMN.\nE.4.3.2\tIP-CAN Session Termination for NSWO traffic\nE.4.3.2.1\tBPCF-initiated IP-CAN Session Termination for NSWO traffic\nFigure E.4.3.2.1.1: BPCF-initiated IP-CAN Session Termination for NSWO Traffic\n1.\tThe Fixed Broadband Access network is aware of the UE is detached from the broadband access network\n2.\tFor the non-roaming case, the BPCF sends a CCR to the H-PCRF to indicate the S9a* session termination. The BPCF requests the termination of the S9a* session using the CC-Request-Type set to the value TERMINATION_REQUEST.\nFor the roaming case, the steps 2a and 2c are executed instead of step 2.\n2a.\tThe BPCF sends a CCR to the V-PCRF to indicate the S9a* session termination. The BPCF requests the termination of the S9a* session using the CC-Request-Type set to the value TERMINATION_REQUEST.\n2b.\tIf there is an active TDF session between TDF and V-PCRF, the TDF session termination is initiated as defined in clause 4.6.2. For this case, the PCRF described in clause 4.6.2 acts as a V-PCRF.\n2c.\tThe V-PCRF sends the CCR to the H-PCRF. If this is the last subsession associated with the S9 session, the V-PCRF sends a CCR to the H-PCRF to request the termination of the S9 session using the CC-Request-Type AVP set to the value TERMINATION_REQUEST. Otherwise, the V-PCRF sends a CCR to the H-PCRF with a CC-Request-Type AVP set to the value UPDATE_REQUEST and a Subsession-Enforcement-Info within which the Subsession-Operation AVP set to value TERMINATION to request the termination of the conresponding S9 subsession.\n3.\tThe H-PCRF identifies the AF sessions that are bound to IP flows of the removed IP-CAN Session.\n4.\tFor the non-roaming case, the H-PCRF acknowledges the S9a* session termination by sending a CCA to the BPCF.\nFor the roaming case, steps 4a~4c are executed instead of step 4:\n4a.\tThe H-PCRF acknowledges the S9 session or subsession termination by sending a CCA to the V-PCRF.\n4b.\tThe V-PCRF removes the information related to the terminated IP-CAN Session.\n4c.\tThe V-PCRF acknowledges the S9a* session termination by sending a CCA to theBPCF.\n5.\tIf there is an active TDF session between TDF and H-PCRF, the TDF session termination is initiated as defined in clause 4.6.2.\n6.\tPerform step 8 through step 12: as specified in Figure 4.2.1.1: UE-Initiated IP-CAN Session Termination – AF located in the HPLMN\nE.4.3.2.2\tPCRF-initiated IP-CAN Session Termination for NSWO traffic\nFigure E.4.3.2.2.1: PCRF-initiated IP-CAN Session Termination for NSWO Traffic\n1.\tThe H-PCRF detects that the termination of an IP-CAN Session is required.\n2.\tFor the non-roaming case, the H-PCRF sends a RAR including the Session-Release-Cause AVP to request that the BPCF terminates the S9a* session.\nFor the roaming case, steps 2a~2b are executed instead of step 2:\n2a.\tIf the subsession being terminated is the last subsession over S9, the H-PCRF sends a RAR including the Session-Release-Cause AVP to the V-PCRF to indicate the termination of the S9 session. Otherwise, the H-PCRF sends a RAR to the V-PCRF including the Subsession-Decision-Info AVP with the Session-Release-Cause AVP to indicate the request for terminating the S9 subsession corresponding to the IP-CAN session.\n2b.\tThe V-PCRF sends a RAR including the Session-Release-Cause AVP to the BPCF.\n3.\tThe Fixed Broadband access network removes all the PCC rules which are applied to the IP-CAN session.\n4.\tFor the non-roaming case, the BPCF sends a RAA to acknowledge the RAR.\nFor the roaming case, steps 4a~4b are executed instead of step 4:\n4a.\tThe BPCF sends a RAA to the V-PCRF.\n4b.\tThe V-PCRF sends a RAA to the H-PCRF and acknowledges the request for terminating the S9 session or the S9 subsession corresponding to the IP-CAN session.\n5.\tStep 2 through 6: as specified in Figure E.4.3.2.1.1:BPCF-initiated IP-CAN session termination for NSWO traffic.\nE.4.4\tIP-CAN Session Modification\nE.4.4.1\tIP-CAN Session Modification for EPC-routed traffic\nE.4.4.1.1\tPCRF-initiated IP-CAN Session Modification\nThis procedure is applicable both for WLAN and H(e)NB scenario.\nFigure E.4.4.1.1.1: PCRF-Initiated IP-CAN Session Modification for EPC routed traffic\n1\tStep 1 to 3 as specified in figure 4.3.1.1.1 are executed. The H-PCRF receives an internal or external trigger to update PCC/QoS Rules. External trigger in Step 1 in figure 4.3.1.1.1 only applies to AF session interactions (as described in clause 4.3.1.2) and TDF session interactions (as described in clause 4.3.1.2). For V-PCRF initiated IP-CAN session modification, the V-PCRF always asks the H-PCRF for policy decision.\nNOTE:\tIf the AF/TDF is located in the V-PLMN, upon a request from the AF/TDF, the V-PCRF will proxy the request to the H-PCRF, this may also trigger the PCRF-Initiated IP-CAN Session Modification for EPC routed traffic.\n2\tThe H-PCRF sends a Diameter RAR to update the QoS information to the BPCF.\nIf the UE is roaming, then steps 2a ~ 2c are executed instead of step 2:\n2a.\tThe H-PCRF sends a Diameter RAR to the V-PCRF to install, modify or remove PCC rules for Visited Access scenario, or QoS Rules for Home Routed scenario.\n2b.\tThe V-PCRF performs local authorization of the received PCC rules or QoS rules when necessary.\n2c.\tThe V-PCRF sends a Diameter RAR to the BPCF to update the QoS information.\n3.\tThe BPCF shall perform QoS validation and translates the QoS rule as received (i.e. SDF template, QCI, MBR, GBR and ARP) into access specific QoS parameters applicable in the BBF domain (the details of the mapping from 3GPP QoS parameters on S9a to QoS parameters applicable in the BBF domain is out of 3GPP scope).\n4.\tThe BPCF sends RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the QoS rule operation. If the BPCF cannot provide the requested QoS by the H-PCRF, the BPCF may respond with the acceptable QoS.\nIf the UE is roaming, then steps 4a ~ 4b are executed instead of step 4:\n4a.\tThe BPCF sends RAA to the V-PCRF to acknowledge the RAR and informs the V-PCRF about the outcome of the QoS rule operation. If the BPCF cannot provide the QoS requested by the V-PCRF, the BPCF may respond with the acceptable QoS.\n4b. The V-PCRF forwards the RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the QoS rule operation.\nNOTE:\tIf the H-PCRF is informed that the BPCF cannot provide the requested QoS, the H-PCRF can decide to install, modify or remove QoS rules. In that case, the same flow as described in this clause will be executed.\n5.\tStep 5 to 12 as specified in figure 4.3.1.1.1 are executed.\nE.4.4.1.2\tBPCF-initiated IP-CAN Session Modification\nThis procedure is applicable both for WLAN and H(e)NB scenario.\nFigure E.4.4.1.2.1: BPCF-Initiated IP-CAN Session Modification\n1.\tThe trigger for this procedure is that the Fixed Broadband Access has pre-empted some resources and wants to report a QoS rule failure to the PCRF, or when the Fixed Broadband Access network cannot sustain the bandwidth allocated to a particular traffic class/DSCP aggregate.\n2.\tThe BPCF sends a Diameter CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report QoS Rule failure.\nWhen the UE is in roaming case, steps 2a ~ 2c are executed instead of step 2:\n2a.\tThe BPCF sends a Diameter CCR to the V-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report QoS Rule failure.\n2b.\tThe V-PCRF stores the information received.\n2c.\tFor Visited Access scenario, the V-PCRF sends a Diameter CCR to the H-PCRF to report PCC Rule failure. For Home Routed scenario, the V-PCRF sends a Diameter CCR to the H-PCRF to report QoS Rule failure.\n3\tThe H-PCRF sends a Diameter CCA to the BPCF to acknowledge the CCR command.\nWhen the UE is in roaming case, steps 3a ~ 3b are executed instead of step 3:\n3a.\tThe H-PCRF sends a Diameter CCA to the V-PCRF to acknowledge the CCR command.\n3b.\tThe V-PCRF forwards the Diameter CCA to the BPCF to acknowledge the CCR.\n4.\tThe PCRF-initiated IP-CAN Session Modification as described in E.4.4.1.1 may take place.\nE.4.4.1.3\tPCEF-initiated IP-CAN Session Modification\nThis procedure is applicable both for WLAN and H(e)NB scenario.\nFigure E.4.4.1.3.1: PCEF-Initiated IP-CAN Session Modification\n1.\tStep 1 to 3 (3a-3c for the Visited Access case) is the same as specified in figure 4.3.2.1.1. In step 3 (3c for the Visited Access case), when the UE Local IP address, H(e)NB Local IP address or the UDP port number is changed, the PCEF may provide the updated UE local IP address, the updated H(e)NB IP address, and/or UDP port number if available, to the PCRF; or the PCEF cannot enforce the PCC rule(s) and need report the PCC rule failure to the PCRF.\n2.\tThe H-PCRF sends a Diameter RAR to request that the BPCF installs, modifies or removes QoS Rules (i.e. SDF template, QCI, ARP, MBR and GBR).\nWhen the UE is in roaming case, steps 2a ~ 2c are executed instead of step 2:\n2a.\tFor Visited Access scenario, the H-PCRF may provision the PCC rule(s) to the V-PCRF. For Home Routed scenario the H-PCRF may provision the QoS rule(s) to the V-PCRF. The H-PCRF may provision for WLAN case the UE local IP address, and UDP port number (if available) and for H(e)NB case the H(e)NB local IP address, and UDP port number (if available) to the V-PCRF.\n2b.\tThe V-PCRF performs local authorization of the QoS Rules or PCC rules when necessary.\n2c.\tThe V-PCRF may provision QoS rules to the BPCF by using RAR command. The V-PCRF may provision for WLAN case the UE local IP address, and UDP port number (if available) and for H(e)NB case the H(e)NB local IP address, and UDP port number (if available) to the BPCF.\n3\tThe BPCF shall perform QoS validation and translates the QoS information as received (i.e. QCI, MBR, GBR and ARP) into access specific QoS parameters applicable in the Fixed Broadband Access.\nNOTE\tThe detail of the mapping from 3GPP QoS parameters on S9a to QoS parameters applicable in the Fixed Broadband Access is out of 3GPP scope.\n4.\tThe BPCF sends RAA to the H-PCRF to acknowledge the RAR command. If the QoS validation for admission control fails, the BPCF may include the acceptable QoS in the Fixed Broadband Access using 3GPP QoS parameters on S9a interface.\nWhen the UE is in roaming case, steps 4a ~ 4b are executed instead of step 2:\n4a.\tThe BPCF sends RAA to the V-PCRF to acknowledge the RAR command.\n4b.\tThe V-PCRF forwards the RAA to the H-PCRF to acknowledge the RAR command.\n5.\tStep 4 to 18 is the same as specified in figure 4.3.2.1.1.\nE.4.4.1.4\tBBERF-initiated IP-CAN Session Modification\nThis procedure is applicable for both WLAN and H(e)NB scenario.\nFigure E.4.4.1.4.1: BBERF-Initiated IP-CAN Session Modification\n1\tStep 1 to 3(3a-3c for the Visited Access case) is the same as specified in figure 4.3.2.1.1.\nIn step 1, in case 2b and case 2a for WLAN scenario, when the UE Local IP address, and/or the UDP port number is changed, the BBERF (ePDG) may provide these information to the PCRF. For H(e)NB scenario, when the H(e)NB local IP address and the UDP port number is changed, the BBERF (S-GW) may provide these information to the PCRF.\n2\tThe H-PCRF sends a Diameter RAR to request that the BPCF installs, modifies or removes QoS Rules (e.g. SDF template, QCI, ARP, MBR and GBR).\nWhen the UE is in roaming case, steps 2a ~ 2c are executed instead of step 2:\n2a.\tFor Visited Access scenario, the H-PCRF may provision the PCC rule(s) to the V-PCRF. For Home Routed scenario the H-PCRF may provision the QoS rule(s) to the V-PCRF. The H-PCRF provisions for WLAN case the UE local IP address and/or UDP port number, and for H(e)NB case the H(e)NB local IP address and UDP port number to the V-PCRF.\n2b.\tThe V-PCRF performs local authorization of the QoS Rules or PCC rules when necessary.\n2c.\tThe V-PCRF may provision QoS rules to the BPCF by using RAR command. The V-PCRF provisions for WLAN case the UE local IP address and/or UDP port number, and for H(e)NB case the H(e)NB local IP address and/or UDP port number to the BPCF.\n3\tThe BPCF shall perform QoS validation and translates the QoS information as received (i.e. QCI, MBR, GBR and ARP) into access specific QoS parameters applicable in the Fixed Broadband Access.\nNOTE:\tThe detail of the mapping from 3GPP QoS parameters on S9a to QoS parameters applicable in the Fixed Broadband Access is out of 3GPP scope.\n4.\tThe BPCF sends RAA to the H-PCRF to acknowledge the RAR command. If the QoS validation for admission control fails, the BPCF may include the acceptable QoS in the Fixed Broadband Access using 3GPP QoS parameters on S9a interface.\nWhen the UE is in roaming case, steps 4a ~ 4b are executed instead of step 4:\n4a.\tThe BPCF sends RAA to the V-PCRF to acknowledge the RAR.\n4b.\tThe V-PCRF forwards the RAA to the H-PCRF to acknowledge the RAR.\n5.\tStep 4 to 18 is the same as specified in figure 4.3.2.1.1.\nE.4.4.2\tIP-CAN Session Modification for NSWO traffic\nE.4.4.2.1\tPCRF-initiated IP-CAN Session Modification\nThis procedure is applicable for WLAN scenario.\nFigure E.4.4.2.1.1.1: PCRF-Initiated IP-CAN Session Modification for NSWO traffic\n1\tStep 1 to 3 as specified in figure 4.3.1.1.1 are executed. The H-PCRF receives an internal or external trigger to update PCC Rules for NSWO traffic (e.g. upon a request from the AF, a request from the TDF in the non roaming case or due to operator policies). External trigger in Step 1 in figure 4.3.1.1.1 only applies to AF session interactions (as described in clause 4.3.1.2), TDF session interactions (as described in clause 4.3.1.1) and SPR subscription data modification (as described in clause 4.3.1.1).\nNOTE:\tIn the roaming case, the TDF is located in the V-PLMN, upon a request from the TDF, the V-PCRF will proxy the request to the H-PCRF, this may also trigger the PCRF-Initiated IP-CAN Session Modification for NSWO traffic.\n2\tThe H-PCRF sends a Diameter RAR to update the QoS information to the BPCF.\nIf the UE is roaming, then steps 2a ~ 2c are executed instead of step 2:\n2a.\tThe H-PCRF sends a Diameter RAR to the V-PCRF to install, modify or remove PCC Rules.\n2b.\tThe V-PCRF performs local authorization of the received PCC rules when necessary.\n2c.\tThe V-PCRF sends a Diameter RAR to the BPCF to update the QoS information.\n3\tThe BPCF shall perform QoS validation and translates the PCC rule as received (i.e. SDF template, QCI, MBR, GBR and ARP) into access specific QoS parameters applicable in the Fixed Broadband Access.\nNOTE:\tThe detail of the mapping from 3GPP QoS parameters on S9a to QoS parameters applicable in the Fixed Broadband Access is out of 3GPP scope.\n4.\tThe BPCF sends RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the PCC rule operation. If the BPCF cannot provide the requested QoS from the PCRF, the BPCF may respond with the acceptable QoS.\nIf the UE is roaming, then steps 4a ~ 4b are executed instead of step 4:\n4a.\tThe BPCF sends RAA to the V-PCRF to acknowledge the RAR and informs the V-PCRF about the outcome of the PCC rule operation. If the BPCF cannot provide the QoS requested by the H-PCRF, the BPCF may respond with the acceptable QoS.\n4b.\tThe V-PCRF forwards the RAA to the H-PCRF to acknowledge the RAR and informs the H-PCRF about the outcome of the PCC rule operation.\nNOTE:\tIf the H-PCRF is informed that the BPCF cannot provide the requested QoS, the H-PCRF may decide to install, modify or remove PCC rules. In that case, the same flow as described in this clause will be executed.\n5.\tIf the AF requested it, the PCRF notifies the AF as described in steps 6-11 in clause 4.3.2.1.1.\nE.4.4.2.2\tBPCF-initiated IP-CAN Session Modification\nThis procedure is applicable for WLAN scenario.\nFigure E.4.4.2.2.1: BPCF-Initiated IP-CAN Session Modification for NSWO traffic\n1.\tThe trigger for this procedure is that the Fixed Broadband Access network has pre-empted some resources and wants to report a PCC rule failure to the PCRF, or when the Fixed Broadband Access network cannot sustain the bandwidth allocated to a particular traffic class/DSCP aggregate.\n2.\tThe BPCF sends a Diameter CCR to the H-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report PCC Rule failure.\nWhen the UE is roaming, steps 2a ~ 2c are executed instead of step 2:\n2a.\tThe BPCF sends a Diameter CCR to the V-PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST to report PCC Rule failure.\n2b.\tThe V-PCRF stores the information received.\n2c.\tThe V-PCRF sends a Diameter CCR to the H-PCRF within the information received in step 2a to report PCC Rule failure. The V-PCRF shall link the S9a* session to S9 session.\n3\tThe H-PCRF sends a Diameter CCA to the BPCF to acknowledge the CCR command.\nWhen the UE is roaming, steps 3a ~ 3b are executed instead of step 3:\n3a.\tThe H-PCRF sends a Diameter CCA to the BPCF to acknowledge the CCR command..\n3b.\tThe V-PCRF sends a Diameter CCA to the BPCF to acknowledge the CCR command.\n4.\tThe PCRF-initiated IP-CAN Session Modification as described in E.4.4.2.1 may take place.\nE.5\t3GPP HNB Procedures – CS Support\nE.5.1\tS9a CS Session Establishment\nIn the following procedure, the PCRF is the V-PCRF for the roaming UE.\nFigure E.5.1.1: S9a CS session Establishment\n1.\tThe HNB GW receives a trigger to establish an S15 session with the PCRF when the HNB performs the registration to the HNB GW.\n2.\tThe HNB GW initiates an S15 session with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The HNB GW provides the HNB Local IP address and the UDP source port number of IPSec tunnel if NA(P)T is detected.\n3.\tThe PCRF stores the information received in the CCR.\n4.\tThe PCRF acknowledges the session establishment by sending a CCA message.\n5.\tThe PCRF shall send a TER command to BPCF to trigger an S9a session establishment procedure. The PCRF provides HNB Local IP address and UDP source port number if available. The PCRF shall include the Auth-Session-State AVP set to NO_STATE_MAINTAINED.\nNOTE:\tWhen the HNB performs the registration to the HNB GW, there is no PS service handled by the HNB. So there is no already established S9a session for the HNB.\n6. The BPCF acknowledges the TER command by sending a TEA command.\n7. The BPCF initiates an S9a session establishment with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value INITIAL_REQUEST. The BPCF provides HNB local IP address and UDP source port number if available.\n8.\tThe PCRF acknowledges the S9a Session establishment by sending a CCA to the BPCF.\nE.5.2\tPCRF initiated S9a CS Session Modification\nIn the following procedure, the PCRF is the V-PCRF for the roaming UE.\nFigure E.5.2.1: S9a CS session Modification\nThis procedure is performed when the first UE or a subsequent UE connected to a HNB requesting a CS service.\n1.\tThe HNB GW receives RAB assignment message to request the resource for the CS service.\n2.\tThe HNB GW initiates an S15 session modification with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The HNB GW provides QoS information derived from the RAB assignment message by the HNB GW.\n3.\tThe PCRF initiates an S9a session modification procedure to the BPCF by sending a RAR to the BPCF. The PCRF provides QoS rule generated by the PCRF based on the QoS information received in step 2.\n4.\tFixed Broadband access network performs the admission control based on the QoS rule received in step3 and responds with the outcome of the admission control by sending a RAA to the PCRF.\n5.\tThe PCRF responds with outcome of the admission control to the HNB GW by sending a CCA.\n6. The HNB GW complete the procedure for the CS service.\nE.5.2a\tBPCF initiated S9a CS Session Modification\nIn the following procedure, the PCRF is the V-PCRF for the roaming UE.\nFigure E.5.2a.1: S9a CS session Modification\nThis procedure is performed when the first UE or a subsequent UE is connected to a HNB requesting a CS service.\n1.\tThe BPCF receives the report of the QoS rule failure\n2.\tThe BPCF initiates an S9a session modification with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value UPDATE_REQUEST. The BPCF includes QoS-Rule-Report AVP to identify the QoS rules that failed and PCC-Rule-Status AVP set to the value “INACTIVE”.\n3.\tThe PCRF acknowledges to the BPCF by sending a CCA.\n4.\tThe PCRF initiates the S15 session modification procedure by sending a RAR command to the HNB GW and includes the information as defined in clause E.5.3.2.2 of 3GPP TS 29.212 [9].\n5.\tThe HNB GW acknowledges to the PCRF by sending a RAA.\n6.\tThe HNB GW completes the procedure for the CS service.\nE.5.3\tS9a CS Session Termination\nIn the following procedure, the PCRF is the V-PCRF for the roaming UE.\nFigure E.5.3.1:  S9a CS Session Termination\n1.\tThe HNB GW initiates deregistration for the HNB or receives a deregistration request from the HNB.\n2.\tThe HNB GW initiates an S15 session termination with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value TERMINATION _REQUEST.\n3.\tThe PCRF acknowledges the session termination by sending a Diameter CCA message to HNB GW.\n4.\tThe PCRF sends a Diameter RAR message to the BPCF including a Session-Release-Cause AVP to indicate request for terminating the S9a session.\nNOTE:\tWhen the HNB is deregistered, there is no PS service which can be handled by the HNB any more. So S9a session for the HNB can be terminated.\n5.\tThe BPCF acknowledges the S9a session termination request by sending a Diameter RAA message.\n6.\tThe BPCF initiates the S9a session termination with the PCRF by sending a CCR to the PCRF with the CC-Request-Type AVP set to the value TERMINATION _REQUEST.\n7.\tThe PCRF acknowledges the session termination by sending a Diameter CCA message to BPCF.\nE.6\tPCRF Addressing\nE.6.1\tGeneral\nPCRF discovery at the DRA shall be done according to clause 7.1 with the additions described in this clause.\nFor EPC-routed scenario, the DRA keeps status of the assigned PCRF for a certain UE for the applicable reference points, i.e. Gx, Gxx, Rx, Sd (Unsolicited application reporting), S9a and S9 (for roaming cases).\nFor NSWO scenario, the DRA keeps status of the assigned PCRF for a certain UE for the applicable references points, i.e. Rx, Sd (Unsolicited application reporting) and S9a.The H-DRA keeps status of the assigned H-PCRF for a certain UE for Rx and S9 reference points. The V-DRA keeps the status of the assigned V-PCRF for a certain UE for the S9a and Sd (Unsolicited application reporting) reference points.\nThe BPCF, as a Diameter client of the DRA, shall support all procedures required to properly interoperate with the DRA in both the proxy and redirect modes.\nE.6.2\tDRA Definition\nFor the EPC-routed scenario, DRA is defined as specified in clause 7.2 with the additions described in this clause.\nThe DRA is a functional element that ensures that all Diameter sessions established over the Gx, S9, Gxx, Rx, S9a and for unsolicited application reporting, the Sd reference points for a certain IP-CAN session reach the same PCRF when multiple and separately addressable PCRFs have been deployed in a Diameter realm.\nFor the NSWO scenario, the DRA shall ensure that all Diameter sessions established over the Rx, S9a and for unsolicited application reporting, the Sd reference points for a certain UE reach the same PCRF. The H-DRA shall ensure that all Diameter sessions established over Rx and S9 reference points for a certain UE reach the same PCRF. The V-DRA shall ensure that all Diameter sessions established over S9a and for unsolicited application reporting, the Sd reference points for a certain UE reach the same V-PCRF.\nE.6.3\tDRA Procedure\nE.6.3.1\tDRA Information Storage\nFor EPC-routed traffic, DRA Information Storage shall be done according to clause 7.3.1 with the additions described in this subclause. The V-PCRF routing information (i.e. DRA binding) in the V-DRA is created when the S9 session establishment trigger is received.\nThe V-PCRF routing information stored in the V-DRA shall be removed when the S9 session termination notification is received.\nThe DRA has information about the user identity (UE NAI), the UE Local IP address/H(e)NB Local IP address, the PDN Id (if available) and the selected PCRF identity for a certain IP-CAN Session or a certain user.\nFor NSWO traffic, the DRA Information Storage shall be done as specified below:\n-\tThe DRA shall maintain PCRF routing information per UE-NAI and APN.\n-\tThe DRA has information about the user identity (UE NAI), the local UE Ipv4 address and/or the local UE Ipv6 address/prefix, the APN (i.e. NSWO_APN) and the selected PCRF identity for a certain UE.\n-\tThe PCRF routing information stored for an S9a* session in the DRA shall be removed after the S9a* session is terminated.\nWhen both EPC-routed and NSWO traffic exist, the DRA Information Storage shall be done as specified below:\n-\tThe DRA shall maintain PCRF routing information per UE-NAI or per UE-NAI and APN.\n-\tThe DRA has information received for both EPC-Routed and NSWO scenarios and the selected PCRF identity per UE-NAI or per UE-NAI and APN.\n-\tThe PCRF routing information stored per UE in the DRA shall be removed when no more S9a sessions and S9a* sessions are active for the UE.\nE.6.3.2\tCapabilities Exchange\nFor EPC-routed traffic, capabilities exchange shall be done according to clause 7.3.2.\nFor NSWO traffic, the Redirect DRA and Proxy DRA shall advertise the support of S9a*, Rx and Sd (for unsolicited application reporting) applications according to clause 7.3.3.\nE.6.3.3\tRedirect DRA\nRedirect DRA is specified in clause 7.3.4 with the additions described in this subclause.\nFor EPC-routed traffic, for case 1 (home routed case), the V-DRA shall behave as follows:\n-\tIf the request is an S9 session establishment trigger from the H-PCRF, it shall select a V-PCRF to handle the S9 session for that UE. It shall then send the redirect message including selected V-PCRF to the H-PCRF.\n-\tIf the request is an S9 session termination notification from H-PCRF, the V-DRA shall remove the PCRF routing information (i.e. DRA binding). If the V-DRA does not have a V-PCRF already selected, it shall reject the request.\nThe S9 session establishment trigger and the S9 session termination notification request shall have the same information of user identity (UE NAI), the UE Local IP address/H(e)NB Local IP address, the PDN Id(if available). The DRA shall remove the DRA binding based on the above information when the DRA receives the S9 session termination notification (i.e. a TER command including DRA- Binding AVP set to the value DRA_BINDING_DELETION).\nFor NSWO traffic, the DRA is maintaining PCRF routing information per UE-NAI and APN. The DRA shall be aware of the S9a* Diameter termination request as defined in 3GPP TS 29.215 [22] in order to release the DRA binding information.\nE.6.3.4\tProxy DRA\nProxy DRA is specified in clause 7.3.5 with the additions described in this subclause.\nFor EPC-routed traffic for case 1 (home routed case), when the V-DRA receives a message from the H-PCRF, it shall behave as follows:\n-\tIf the message is an S9 session establishment trigger from the H-PCRF, it shall select a V-PCRF to handle the S9 session for that UE. It shall then proxy the request to the selected V-PCRF. The V-DRA indicates that there is a V-DRA deployed in the visited PLMN by including the DRA-Deployment AVP in TEA command.\n-\tIf the message is an S9 session termination notification from the H-PCRF, the V-DRA shall remove the PCRF routing information (i.e. DRA binding). If the V-DRA does not have a V-PCRF already selected, it shall reject the request.\nThe S9 session establishment trigger and the S9 session termination notification shall have the same information of user identity (UE NAI), the UE Local IP address/H(e)NB Local IP address and the PDN Id (if available). The DRA shall remove the DRA binding based on the above information when the DRA receives the S9 session termination notification (i.e. a TER command including DRA-Binding AVP set to the value DRA_BINDING_DELETION).\nProxy DRA is specified in clause 7.3.5 with the additions described in this subclause.\nFor NSWO traffic in both non-roaming and roaming cases, when the (V-) DRA receives an S9a* request from the BPCF, it shall behave as follows:\n-\tIf the request is an S9a* session establishment, it shall select a V-PCRF to handle the S9 session for that UE and APN. It shall then proxy the request to the selected V-PCRF.\n-\tIf the request is an S9a* session termination, the (V-) DRA shall remove the PCRF routing information and proxy the request to the (V-) PCRF. If the (V-) DRA does not have a (V-) PCRF already selected, it shall reject the request.\n-\tIf the request is an S9a* session modification, the (V-) DRA shall proxy the request.\nThe BPCF shall be capable of sending every message of a session to the DRA. The BPCF may be configured to bypass the (V-) DRA on S9a* session modification messages by sending these types of messages directly to the (V-) PCRF.\nE.6.3.5\tPCRF selection by BPCF\nFor EPC-routed traffic, when the S9a Session Establishment request is triggered by the (V-) PCRF, the BPCF may use the (V-) PCRF identity provided within the PCRF-Address AVP in the S9a Session Establishment Trigger.\nThe BPCF may also use the DRA procedures as described in clause 7.3. In order to do so, the BPCF shall provide the DRA of the PCRF realm with identity parameters during the S9a Session Establishment procedure. The identity parameters from the BPCF may comprise the UE Local Ipv4 or UE local Ipv6 address in the UE-Local-IP-Address AVP (WLAN scenario), H(e)NB Local IP address in the HeNB-Local-IP-Address AVP (H(e)NB scenario), PDN information in the Called-Station-Id AVP if available and user identity in the Subscription-Id AVP. The BPCF obtains these data from the S9a Session Establishment Trigger procedure initiated by the (V-) PCRF.\nFor NSWO traffic, the BPCF finds the PCRF using the DRA procedures as described in clause 7.3. In order to do so, the BPCF shall provide the DRA of the PCRF realm with identity parameters during the S9a* Session Establishment procedure. The identity parameters from the BPCF shall comprise the UE local Ipv4 adress or UE local Ipv6 prefix/address in the UE-Local-IP-Address AVP or UE-Local-IP-Prefix AVP, the APN in the Called-Station-Id AVP and user identity in the Subscription-Id AVP.\nFor both EPC-routed traffic and NSWO traffic, if the redirect agent is used for DRA, the DRA shall use the redirecting requests procedure as specified in IETF RFC 6733 [61], and include the PCRF identity in the Redirect-Host AVP in the Diameter reply sent to the BPCF .\nIf proxy agent is used for DRA, the DRA should use the proxy procedure as specified in IETF RFC 6733 [61]. For PA2 solution (described in clause 7.1) only S9a/S9a* session establishment and S9a/S9a* session termination messages shall be sent through the DRA.\nFor NSWO traffic in a roaming scenario the selected V-PCRF shall belong to the same VPLMN selected during the 3GPP –based authentication procedure. The BPCF uses the VPLMN-Id to find the V-DRA in the VPLMN. The V-PCRF finds the DRA in the HPLMN according to clause 7.3.8.\nNOTE:\tThe BPCF will use the VPLMN-Id to obtain the Destination-Realm AVP used to find the V-DRA and then to find the V-PCRF using Diameter based procedures as described in IETF RFC 6733 [61].\nE.6.3.6\tPCRF selection by AF and TDF in Unsolicited application reporting mode for NSWO traffic\nPCRF selection by the AF shall be done according to clause 7.3.7.\nPCRF selection by the TDF shall be done according to clause 7.3.9.\nNOTE:\tThe DRA matches the received UE IP address received in either the Framed-IP-Address AVP or the Framed-Ipv6-Prefix AVP in the Rx and Sd reference point with the UE Local IP Address received in UE-Local-IP-Address AVP or UE Local Ipv6 Prefix in the UE-Local-IP-Prefix AVP in the S9a reference point in order to select the same PCRF.\nE.6.3.7\tPCRF selection in a roaming scenario\nFor both EPC-routed traffic and NSWO traffic, the V-PCRF uses the DRA procedures as described in clause 7.3.8 to address the H-PCRF. In order to do so, the V-PCRF shall provide the DRA of the H-PCRF realm with identity parameters during the S9 Session Establishment procedure.\nFor EPC-routed traffic, the identity parameters from the V-PCRF may comprise the UE Local Ipv4 or UE local Ipv6 address in the UE-Local-IP-Address AVP (WLAN scenario), H(e)NB Local IP address in the HeNB-Local-IP-Address AVP (H(e)NB scenario), PDN information in the Called-Station-Id AVP if available and user identity in the Subscription-Id AVP obtained from the S9 Session Establishment Trigger procedure initiated by the H-PCRF.\nFor NSWO traffic, the identity parameters from the V-PCRF may comprise the UE Local Ipv4 or Ipv6 address in the UE-Local-IP-Address AVP or UE local Ipv6 prefix in the UE-Local-IP-Prefix AVP, PDN information in the Called-Station-Id AVP and user identity in the Subscription-Id AVP obtained from the S9a* Session Establishment procedure.\nE.6.3.8\tPCRF selection for the HNB CS Service\nWhen the DRA receives a request for a certain S15 Session establishment from the HNB GW, the DRA selects a suitable PCRF for the S15 Session based on the HNB local IP address within the HeNB-Local-IP-Address AVP. When the S15 Session is terminated, the DRA shall remove the information about the S15 Session.\nE.6.4\tDRA flows\nE.6.4.1\tGeneral\nFor the EPC-routed traffic case and for the non-roaming case, the flows for the non-roaming case in the clauses 7.4.1 and 7.4.2 are applied with the following exception:\n-\tBPCF acts as a client and messages are S9a Diameter messages;\n-\tThe external trigger in the Establishment of Diameter Sessions is an S9a session establishment trigger message from the PCRF\nFor the EPC-routed traffic case and for the roaming case, the flows for the roaming case in clauses 7.4.1 and 7.4.2 are applied with the following exception:\n-\tThe external trigger in the Establishment of Diameter Sessions is an S9 session establishment trigger message from the PCRF for case 1 and home routed case.\nThe flows in clauses E.6.4.2 and E.6.4.3 are applicable to the EPC-routed traffic and for case 1 and UE roaming in the home routed scenario.\nFor the NSWO traffic case and for the non-roaming case, the flows for the non-roaming and roaming case in the clauses 7.4.1 and 7.4.2 are applied with following exception:\n-\tBPCF acts as a client and messages are S9a* Diameter messages for the non-roaming case.\nE.6.4.2\tProxy DRA\nE.6.4.2.1\tS9 session establishment trigger\nFigure E.6.4.2.1.1: S9 session establishment trigger using DRA (proxy) – Roaming case\n1.\tThe H-PCRF receives an external trigger (e.g. IP-CAN session establishment request) and determines that an S9 session shall be established.\n2.\tA TER command including user identity, PDN ID if available, UE Local IP address/H(e)NB Local IP address and UDP source port number(if NA(P)T is detected) is sent by the H-PCRF and received by a V-DRA (proxy) in the visited PLMN. The Auth-Session-State AVP set to NO_STATE_MAINTAINED shall be included in the TER.\n3.\tThe V-DRA (proxy) stores the user identity and creates a dynamic DRA binding for this user. (assignment of a PCRF node per UE).\n4.\tThe V-DRA (proxy) proxies the TER to the target PCRF in the visited PLMN.\n5.\tV-PCRF-1 returns a TEA to the V-DRA (proxy).\n6.\tV-DRA (proxy) proxies the TEA to the H-PCRF and indicates there is a DRA deployed in the visited PLMN by including the DRA-Deployment AVP in the TEA.\nNOTE: The H-PCRF is aware that there is a V-DRA (proxy) deployed in the network at this stage.\nE.6.4.2.2\tS9 session termination notification\nFigure E.6.4.2.2.1: S9 session termination notification using V-DRA (proxy) – Roaming cases\n1.\tThe H-PCRF receives an external trigger (e.g.IP-CAN session termination request from the BBERF or the PCEF) and initiates S9 session termination procedure.\n2.\tIf the V-DRA is deployed in the VPLMN as indicated in step 6 of clause E.6.4.2.1, a TER command including DRA-Binding AVP set to the value DRA_BINDING_DELETION is sent by the H-PCRF and received by the V-DRA (proxy) in the visited PLMN. The message includes the same user identity as the S9 session establishment trigger message.\n3.\tThe V-DRA (proxy) verifies that there is an active DRA binding for the user based on the user identity in the request and removes the DRA binding.\n4.\tV-DRA (proxy) returns the TEA to the H-PCRF.\nE.6.4.3\tRedirect DRA\nE.6.4.3.1\tS9 session establishment trigger\nFigure E.6.4.3.1.1: S9 session establishment trigger using DRA (Redirect) – Roaming case\n1.\tThe H-PCRF receives an external trigger (e.g. IP-CAN session establishment request) and determines that an S9 session shall be established.\n2.\tA TER command including user identity, PDN ID if available, UE Local IP address/H(e)NB Local IP address, UDP source port number(if NA(P)T is detected) and the FQDN of Fixed Broadband network where the H(e)NB is connected to if available is sent by the H-PCRF and received by a V-DRA (proxy) in the visited PLMN. The Auth-Session-State AVP set to NO_STATE_MAINTAINED shall be included in the TER.\n3.\tThe V-DRA (redirect) stores the user identity and creates a dynamic DRA binding for this user. (assignment of a PCRF node per UE).\n4.\tThe V-DRA (redirect) sends a TEA command indicating redirection as defined in IETF RFC 6733 [61]. The target V-PCRF identity is included in the Redirect-Host AVP.\nNOTE:\tThe H-PCRF is aware that there is a V-DRA (redirect) deployed in the network at this stage.\n5.\tThe H-PCRF re-sends the TER command of step 2 to the target V-PCRF-1.\n6.\tThe V-PCRF-1 returns a TEA vailab.\nE.6.4.3.2\tS9 session termination notification\nThe detailed procedure is the same as the S9 session termination notification using DRA (Proxy), which is described in clause E.6.4.2.2.\nIf the H-PCRF was aware that there is a V-DRA deployed in the V-PLMN (step 4 of S9 session establishment procedure according to clause E.6.4.3.1), this procedure shall apply.\nE.7\tBPCF Addressing\nE.7.1\tGeneral\nFor S9a session establishment trigger procedure initiated by the (V-)PCRF, the PCRF (for non-roaming case) and the V-PCRF (for roaming case) is configured with IP address range mappings { (Ipx..Ipy) ‑> BBF network entry point}. The PCRF (for non-roaming) and the V-PCRF (for roaming cases) selects the correct BBF network entry point based on UE Local IP address for WLAN scenario and based on H(e)NB IP address and FQDN if available for H(e)NB case received from the PCEF/BBERF/HNB GW for H(e)NB scenario. The implementation of a BBF network entry point is out-of-scope for 3GPP e.g. be a BPCF or a DRA.\nFor case 1 and roaming with home routed, for S9 session establishment trigger procedure initiated by the H-PCRF, H-PCRF finds the VPLMN according to the PLMN Id of the visited network in 3GPP-SGSN-MCC-MNC AVP if received at IP-CAN session establishment received over Gx reference point, and then discovers V-PCRF by V-DRA if there are more than one PCRF deployed in the visited network. The H-PCRF sends the H(e)NB Local IP address within HeNB-Local-IP-Address AVP and optionally the FQDN of BBF access network within the HeNB-BBF-FQDN AVP for H(e)NB scenario or the UE local IP address within the UE-Local-IP-Address AVP for WLAN scenario to the V-PCRF over the S9 reference point.\nE.8\tSession Linking Function\nPCRF and BPCF needs to support session linking function. The PCRF shall be able to perform the linking between multiple Gx and Gateway Control Session to the same S9a session.\nWhen receiving an IP-CAN Session Establishment request or an IP-CAN Session modification request with an UE local IP address or H(e)NB local IP address, the PCRF shall perform the session linking between the S9a session and the corresponding Gx session according to the UE Local IP address/ H(e)NB local IP address.\nWhen receiving a Gateway Control Session Establishment Request or a Gateway Control and QoS Rule Request with UE local IP Address or a H(e)NB local IP Address change, the PCRF shall perform the session linking between the S9a session and the Gateway Control Session according to the UE Local IP address/ H(e)NB local IP address.\nIf there is not an established S9a session which could be linked to the Gx or Gateway Control Session, the PCRF shall initiate the S9a Session Establishment trigger procedure.\nFor 3GPP HNB Procedures with CS support, the PCRF shall be able to perform the linking between S15 sessions and the S9a session.\nNOTE 1:\tThere is a single S15 session per HNB for CS calls for all Ues connected to the HNB in order to improve performance. In addition, for CS calls there are no UE specific policies and therefore a single PCRF can handle CS calls for all Ues.\nAnnex F (normative):Access specific aspects, Fixed Broadband Access network convergence\nF.1\tGeneral\nThis annex defines the enhancement to PCC framework for supporting policy and charging control in the fixed broadband access network in the convergent scenario where the PCRF controls directly the network element(s) in the fixed broadband access without the mediation of a different policy server, such as the Broadband Policy Control Function (BPCF).\nPolicy and charging control is provided for both Non-seamless WLAN offload traffic from a 3GPP UE and the traffic from fixed devices.\nF.2\tDefinitions and abbreviations\nF.2.1\tDefinitions\nThe definitions in the following are relevant for this Annex only.\nUE local IP address is defined as either the public IP address assigned to the UE by the Broadband Forum domain in the no-NAT case, or the public IP address assigned by the Broadband Forum domain to the NATed RG.\nIP-CAN session as defined in clause 3.1 applies with the following clarifications for fixed broadband access. The term UE corresponds to the device that accesses the services provided by the network (i.e. either RG, or 3GPP UE or fixed end-device), the PDN identifies the IP network where the device gets IP connectivity and the UE identity information may be the IMSI, the user-name or the access line identifier (if available). In a Fixed Broadband Access an IP-CAN session corresponds to a Subscriber IP Session defined in Broadband Forum TR-146.\nNOTE:\tThe PDN connection concept and APN are not applicable to a Subscriber IP session for a fixed device.\nF.2.2\tAbbreviations\nThe following abbreviations are relevant for this annex only:\nBBF\tBroadband Forum\nBPCF\tBroadband Policy Control Function\nNSWO\tNon-Seamless WLAN offload\nNSWO-APN\tNon-Seamless WLAN offload APN\nRG\tResidential Gateway\nF.3\tBinding Mechanisms\nF.3.1\tNSWO traffic\nThe binding mechanism in clause 5 applies, except that the QoS rule generation as described in clause 5.4 and the bearer binding as described in clause 5.4 do not apply since the Fixed Broadband Access network does not support the concept of a bearer and multiple bearers as defined in 3GPP network.\nThe following exceptions or modifications in PCC rule authorization also apply:\n-\tThe PCRF does not authorize traffic mapping information from the UE.\n-\tThe PCEF in the IP Edge would map the received QoS information over Gx into the relevant data as specified in Broadband Forum.\n-\tMPS, RLOS and emergency services are not supported.\n-\tBCM concept is not applied.\nF.3.2\tTraffic from fixed devices\nThe binding mechanism as described in Annex F.3.1 applies to the scenario of traffic from fixed devices with the following exceptions or modifications:\n-\tS9 reference point is not applicable.\n-\tThe Subscriber Identifier used by fixed device at establishment of Subscriber IP session in Fixed Broadband Access network can be the Access Line Identifier (Physical-Access-ID AVP and Logical-Access-ID AVP) or the username (Subscription-Id AVP), for example when the Subscriber IP session is a PPP Session.\nNOTE:\tIn case the Subscriber Identifier in the IP-CAN and the application level identity for the fixed device are of different kinds, the PCRF needs to map between them. Such mapping is not subject to specification within this TS.\nF.4\tPCC procedures\nF.4.1\tIntroduction\nThe PCC procedures specified in clause 4.1, 4.2 and 4.3 apply to the Fixed Broadband Access network convergence with the following exceptions or restrictions:\n-\tRoaming scenarios are not applicable to fixed devices and RGs.\n-\tGxx reference point is not used.\n-\tUE requested bearer resource initiation, modification or termination procedure is not supported.\n-\tBearer procedures are not supported in the fixed network.\n-\tBearer Control Mode (BCM) concept does not apply.\n-\tAuthorized QoS per bearer and authorized MBR per QCI are not applicable\n-\tMPS Services, RLOS and IMS Emergency Services are not supported.\nF.4.2\tIP-CAN Session Establishment\nThe PCEF in the IP Edge initiates the IP-CAN session establishment as specified in clause 4.1, with the exceptions as described in Annex F.4.1.The PCRF shall provide parameters to the PCEF in the IP Edge at IP-CAN session establishment as described in 3GPP TS 29.212 [9] Annex G.5.2.\nF.4.3\tIP-CAN Session Termination\nF.4.3.1\tUE-Initiated\nUE-initiated IP-CAN session termination is not applicable to convergent scenario.\nF.4.3.2\tPCEF-Initiated\nFor PCEF-Initiated IP-CAN session termination the procedures described in clause 4.2.2 apply, with the exceptions described in clause F.4.1.\nF.4.3.3\tPCRF-Initiated\nFor PCRF-Initiated IP-CAN session termination the procedures described in clause 4.2.3 apply, with the exceptions described in clause F.4.1.\nF.4.4\tIP-CAN Session Modification\nF.4.4.1\tPCRF-Initiated IP-CAN Session Modification\nFor PCRF-Initiated IP-CAN session modification, the procedures described in clause 4.3.1 apply, with the exceptions described in clause F.4.1. The PCRF shall provide parameters to the PCEF in the IP Edge at IP-CAN session modification as described in 3GPP TS 29.212 [9] Annex G.5.4.2.\nF.4.4.2\tPCEF-Initiated IP-CAN Session Modification\nFor PCEF-Initiated IP-CAN session modification, the procedures described in clause 4.3.2 apply, with the exceptions described in clause F.4.1. The PCRF shall provide parameters to the PCEF in the IP Edge at IP-CAN session modification as described in 3GPP TS 29.212 [9] Annex G.5.4.1.\nF.5\tPCRF Addressing\nF.5.1\tGeneral\nPCRF discovery and selection shall be done according to clause 7.1 with the modifications or exceptions described in this subclause.\n-\tGxx reference point is not used.\n-\tThe Subscriber Identifier specified in 3GPP TS 23.203 [2] clause S.5.1.2 is used as user identity.\n-\tFor a 3GPP UE, the NSWO-APN is also available.\n-\tThe IPv6 address within the Framed-IPv6-Prefix may be included in the CCR command in the case of bridge-mode RG.\nF.5.2\tDRA Definition\nThe DRA definition in clause 7.2 applies with the modifications or exceptions as described in Annex F.5.1.\nF.5.3\tDRA Procedure\nF.5.3.1\tRedirect DRA\nRedirect DRA is specified in clause 7.3.4 with the adaptions listed in F.5.1.\nF.5.3.2\tProxy DRA\nProxy DRA is specified in clause 7.3.5 with the adaptions listed in F.5.1.\nF.5.3.3\tPCRF selection by AF and TDF in unsolicited application reporting mode\nPCRF selection by the AF shall be done according to clause 7.3.7 with the modifications or exceptions as described in Annex F.5.1. PCRF selection by the TDF shall be done according to clause 7.3.9 with the modifications or exceptions as described in Annex F.5.1.\nF.5.3.4\tPCRF selection in a roaming scenario\nThe procedures as described in clause 7.3.8 for the V-PCRF to select the H-PCRF apply with the modifications or exceptions as described in Annex F.5.1.\nF.5.4\tDRA flows\nThe DRA procedures specified in clause 7.4.1 and 7.4.2 apply to the Fixed Broadband Access network convergence with the following exceptions or restrictions:\n-\tGxx reference point is not used.\n-\tRoaming scenarios are not applicable to fixed devices and RGs.\nAnnex G (normative):Diameter overload control mechanism\nG.1\tGeneral\nSupport for Diameter overload control by PCC functional elements is optional. Unless otherwise stated, the procedures defined in this Annex assume that a PCC functional element supports the Diameter overload control mechanism.\nIETF RFC 7683 [33] specifies the Diameter overload control mechanism. This includes the definition of Diameter overload related AVPs and the Diameter overload related behavior.\nTo indicate support of the Diameter overload control mechanism, each PCC functional element shall include the OC-Supported-Features AVP in every Diameter request and answer as defined in IETF RFC 7683 [33].\nEach PCC functional element (e.g. PCRF, PCEF, AF, etc) shall act asa reacting node and asa reporting node as defined in IETF RFC 7683 [33].\nG.2\tReporting Node\nWhen a PCC functional element determines the need to request a reduction in the traffic it is handling due to an overload condition, it shall include the OC-OLR AVP in answer messages, as defined in IETF RFC 7683 [33].\nHow it determines that it is in an overload situation and the severity of the overload is implementation dependent and based on operator policy.\nHow it determines the specific contents of the OC-OLR AVP is implementation dependent and based on operator policy.\nG.3\tReacting Node\nA PCC functional element acting as a reacting node applies the requested traffic reduction received in OC-OLR AVPs in answer messages to corresponding applicable requests, as per IETF RFC 7683 [33].\nHow it achieves the requested traffic reduction is implementation dependent.\nDiameter requests related to priority traffic (e.g. MPS) as described in 3GPP TS 22.153 [58] and emergency have the highest priority. If required by the regional/national regulatory and operator policies, and when the reacting node is able to detect priority traffic, priority traffic shall be exempted from throttling due to Diameter overload control up to the point where requested traffic reduction cannot be achieved without throttling the priority traffic. Relative priority amongst various priority traffic (e.g. MPS) and emergency traffic is subject to regional/national regulatory and operator policies.\nG.4\tDRA Diameter Overload Behavior\nThe DRA may optionally incorporate agent behavior specified in IETF RFC 7683 [33].\nG.4.1\tDRA reacting to Host Reports\nThe procedures defined in this clause are only applicable to the proxy DRA (PA1 and PA2) as the redirect DRA is not in the path of application answers and as such does not have access to overload reports from other nodes.\nThe proxy DRA shall use host reports as one of the inputs when making routing decisions for realm-routed requests, i.e. requests that do not contain a Destination-Host AVP. This is needed because entities sending such requests are not aware of the final recipient of the request (e.g. specific PCRF instance).\nThe following scenarios shall be addressed:\n-\tNo binding exists for the request and the request can result in a new binding (e.g. IP-CAN session establishment); in this case the DRA is selecting the PCRF that will handle the binding. The DRA should use any active and relevant Diameter overload host reports as one of the inputs to the selection of the PCRF. If all PCRFs are in an overload state, the DRA should reduce traffic sent to each of the PCRFs based on the individual host requested traffic reduction. This may result in the DRA rejecting the request.\n-\tA binding already exists for the request – In this case the DRA should reduce the traffic sent to the overloaded node by the host requested traffic reduction. This may result in the DRA rejecting the request.\nNOTE: \tResult-Code when rejecting a request in the above cases need to be used according to the IETF RFC 7683 [33].\nHow the DRA achieves any requested traffic reduction is implementation dependent and/or based on operator policy.\nAnnex H (normative):Access specific procedures for 3GPP EPS\nH.1\tGeneral\nThe present annex defines IP-CAN specific requirements for 3GPP Evolved Packet System (EPS).\nH.2\tBinding Mechanisms\nThe procedures defined in clause 5.4 apply.\nWhenever the PCRF modifies the Authorized QoS of the default bearer, the BBF shall re-evaluate the bearer binding taking into account the default bearer QoS change the default bearer binding indication in the PCC Rule if applicable and any PCC Rule/QoS Rule operation requested by the PCRF.\nAnnex I (normative):APN matching procedures\nA PCRF or DRA needs to compare APN information received over different interfaces, for instance within the Called-Station-Id AVP, for certain purposes such as session binding. To do so, the PCRF or DRA shall apply the procedures in the present Annex.\nThe PCRF or DRA shall consider the different possible encoding formats of the APN defined in 3GPP TS 23.003 [37], clause 9.1. When the PCRF or DRA needs to compare an APN only containing the APN Network Identifier, with an APN containing both APN Network Identifier and APN Operator Identifier, the PCRF shall consider those APNs as matching if their APN Network Identifiers match. The PCRF shall perform a case-insensitive comparison for APN Network Identifiers and APN Operator Identifiers.\nAnnex J (normative):Diameter message priority mechanism\nJ.1\tGeneral\nThe support of the Diameter message priority mechanism by PCC functional elements is optional.  PCC functional elements that support Diameter message priority mechanism shall comply with the procedures specified in this annex.\nIETF RFC 7944 [40] specifies the Diameter message priority mechanism that allows Diameter nodes to indicate the relative priority of Diameter messages. With this information, other Diameter nodes can leverage the relative priority of Diameter messages into routing, resource allocation, set the DSCP marking for transport of the associated Diameter message, and also abatement decisions when overload control is applied. This includes the definition of Diameter message priority related AVPs and the Diameter message priority related behaviour.\nJ.2\tPCC functional element behaviour\nA PCC functional entity supporting the Diameter message priority mechanism shall comply with IETF RFC 7944 [40].\nA PCC functional element sending a request shall determine the required priority according to its policies. When priority is required, the PCC functional element shall include the DRMP AVP indicating the required priority level in the request it sends, and shall prioritise the request according to the required priority level\nWhen the PCC functional element receives the corresponding response, it shall prioritise the received response according to the priority level received within the DRMP AVP if present in the response, otherwise according to the priority level of the corresponding request.\nWhen a PCC functional element receives a request, it shall handle the request according to the received DRMP AVP priority level. For the response, it may modify the priority level received in the DRMP AVP according to its policies and shall handle the response according to the required priority level. If the required priority level is different from the priority level received in the request, it shall include the DRMP AVP in the response.\nIf:\n-\ta PCC functional element supports using the Diameter message priority mechanism for DSCP marking purposes,\n-\tthe transport network utilizes DSCP marking, and\n-\tmessage-dependant DSCP marking is possible for the protocol stack transporting Diameter,\nthen the PCC functional element shall set the DSCP marking for transport of the request or response according to the required priority level.\nThe PCC functional element decisions for a required priority and the priority level value are implementation specific.\nDiameter requests related to high priority traffic (e.g. MPS, emergency) shall contain a DRMP AVP with a high priority of which the level is operator dependent.\nJ.3\tInteractions\nIf the PCC entity supporting the Diameter message priority mechanism receives the request message containing both the Reservation-Priority AVP and DRMP AVP, the PCC entity shall prioritise the request according to priority level received within the DRMP AVP. This procedure also applies for MPS.\nNOTE:\tUpon receipt of the request message containing the DRMP AVP, the PCRF will use the DRMP AVP to prioritize other PCC interfaces related to that IP-CAN session.\nAnnex K (normative):Diameter load control mechanism\nK.1\tGeneral\nIETF RFC 8583 [60] specifies the Diameter load control mechanism. This includes the definition of Diameter Load AVP and the Diameter load related behaviour.\nWhether Diameter load control mechanism is applicable for a specific interface is specified in the 3GPP specification for that interface. For PCC related interfaces where the Diameter load control mechanism is applicable, the procedures in this Annex apply.\nSupport for Diameter load control is optional for all PCC functional elements.\nNOTE:\tThe Diameter Load AVP will simply be ignored by peers not supporting Diameter load control.\nIf a PCC functional element supports the Diameter load control mechanism, it shall apply the procedures in the present Annex.\nThe PCC functional elements that are recipients of realm-routed requests (e.g. PCRF, H-PCRF, TDF for solicited application reporting, TSSF, OCS) shall for that interface act as Endpoint Reporting Node as defined in IETF RFC 8583 [60].\nThe PCC functional elements that send realm-routed requests (e.g. PCRF, V-PCRF, PCEF, AF) shall for that interface act as Reacting Node as defined in IETF RFC 8583 [60].\nK.2\tEndpoint or Agent Reporting Node\nThe reporting shall include load information in the Load AVP as defined in IETF RFC 8583 [60] in Diameter answer messages.\nWhen and in which frequency to include the Load AVP is implementation dependent and based on operator policy.\nHow the reporting node determines the specific contents of the Load-Value AVP within the Load AVP is also implementation dependent and based on operator policy.\nK.3\tReacting Node\nA PCC functional element acting as a Reacting Node may use the load information in implementation dependent manner, e.g. when deciding where to route requests for new Diameter sessions.\nK.4\tDRA Behaviour\nThe DRA may optionally incorporate Reacting Node behaviour as defined in IETF RFC 8583 [60]. Support of Agent Reporting Node behaviour as defined in IETF RFC 8583 [60] is not required.\nNOTE:\tOnly one logical DRA is specified in the PCC architecture. The Agent Reporting Node behaviour as defined in IETF RFC 8583 [60] is only useful if several Diameter routeing agents are deployed. i.e. not in the PCC architecture.\nThe procedures defined in this clause are only applicable to the proxy DRA (PA1 and PA2) as the redirect DRA is not in the path of application answers and as such does not have access to load reports from other nodes.\nThe proxy DRA should use load reports as one of the inputs when making routing decisions and selection of the PCRF for realm-routed requests, i.e. requests that do not contain a Destination-Host AVP. This is needed because entities sending such requests are not aware of the final recipient of the request (e.g. specific PCRF instance). If no binding exists for the request and the request can result in a new binding (e.g. IP-CAN session establishment), the DRA is selecting the PCRF that will handle the binding.\nAnnex L (informative):Change history\nDate\nTSG #\nTSG Doc.\nCR\nRev\nSubject/Comment\nOld\nNew\n12-2014\nCT-66\nCP-140922\n0575\n2\nCall flows over Np reference point\n12.5.0\n13.0.0\n12-2014\nCT-66\nCP-140935\n0576\n2\nDouble Resource Reuse procedures\n12.5.0\n13.0.0\n03-2015\nCT-67\nCP-150131\n0579\nIPCAN Session modification after bearer procedure\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150134\n0580\nP-CSCF Restoration Procedure for Local Breakout\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150136\n0581\nPriority Consideration for Diameter Overload Control\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150132\n0582\nCorrection to the Gateway Control Session establishment procedur\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150136\n0583\nPCRF discovery for the HNB CS Service\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150094\n0590\nCorrections to the Gateway Control and QoS rules Provision procedure\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150125\n0592\nAdd missing definition of RAN user plane congestion\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150125\n0593\n2\nDRA procedure to support PCRF selection by the RCAF\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150111\n0595\nRemove editor’s Note on access line identifier\n13.0.0\n13.1.0\n03-2015\nCT-67\nCP-150125\n0596\n2\nUE context removal in IP-CAN session termination procedure\n13.0.0\n13.1.0\n06-2015\nCT-68\nCP-150342\n0601\n1\nRemove the user identity from the intermediate spending limt report request\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150342\n0604\n2\nCorrection to the IP-CAN session termination for spending limit report\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150355\n0605\n1\nAlignment with the changes of 29.217\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150355\n0606\n1\nReference update to align with new title of TS 29.217\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150361\n0607\n1\nCorrection of the editorial errors in Network-iniated IP-CAN session modification\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150354\n0609\n2\nQoS change of default bearer\n13.1.0\n13.2.0\n06-2015\nCT-68\nCP-150362\n0610\n3\nAPN matching procedures\n13.1.0\n13.2.0\n09-2015\nCT-69\nCP-150480\n0612\n-\nProcedures for monitoring when using the PCC architecture\n13.2.0\n13.3.0\n09-2015\nCT-69\nCP-150482\n0614\n1\nProcedures to allow changing the chargeable party when sponsor connectivity applies\n13.2.0\n13.3.0\n09-2015\nCT-69\nCP-150490\n0616\n2\nCorrection on bearer binding on QoS rules\n13.2.0\n13.3.0\n09-2015\nCT-69\nCP-150477\n0617\n5\nClarification of the PCRF addressing for UPCON\n13.2.0\n13.3.0\n09-2015\nCT-69\nCP-150491\n0618\n2\nPCC signalling update to support NBIFOM\n13.2.0\n13.3.0\n09-2015\nCT-69\nCP-150485\n0619\n2\nClarification of PCRF address\n13.2.0\n13.3.0\n12-2015\nCT-70\nCP-150649\n0620\n1\nAuthorized QCI value in PCRF to avoid SRVCC\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150650\n0621\n6\nUpdate the procedures to support traffic steering control\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150809\n0622\n3\nInclude the PCC architecture figures in 29.213l\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150632\n0625\n2\nOverlapping transactions over Gx\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150666\n0626\n-\nRTP/RTCP transport multiplexing\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150730\n0629\n6\nDiameter message priority for PCC\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150663\n0630\n4\nSupport of new bandwidth information over Rx\n13.3.0\n13.4.0\n12-2015\nCT-70\nCP-150631\n0633\n1\nUpdate the reference of draft-ietf-dime-ovli\n13.3.0\n13.4.0\nChange history\nDate\nMeeting\nTDoc\nCR\nRev\nCat\nSubject/Comment\nNew version\n2016-03\nCT#71\nCP-160107\n0638\n-\nF\nNetwork-initiated removal of one access from the PDN connection\n13.5.0\n2016-03\nCT#71\nCP-160091\n0639\n2\nB\nADC rule error handling report initiated by the TSSF\n13.5.0\n2016-03\nCT#71\nCP-160091\n0640\n-\nF\nIPv4 address provisioning\n13.5.0\n2016-03\nCT#71\nCP-160095\n0641\n2\nF\nUpdate the scope to include the Nt interface\n13.5.0\n2016-03\nCT#71\nCP-160091\n0645\n2\nF\nUpdate the scope to include the St interface\n13.5.0\n2016-03\nCT#71\nCP-160101\n0646\n-\nD\nCorrection of command name for Rx session termination\n13.5.0\n2016-03\nCT#71\nCP-160101\n0648\n2\nF\nCompletion of RAN-NAS cause handling procedures\n13.5.0\n2016-03\nCT#71\nCP-160095\n0650\n-\nB\nSupport of background data transfer per UE in the PCRF\n13.5.0\n2016-03\nCT#71\nCP-160092\n0651\n1\nB\nUE-to-network relay PCC handling\n13.5.0\n2016-03\nCT#71\nCP-160106\n0652\n-\nD\nRemoval of the reference to draft-ietf-dime-ovli\n13.5.0\n2016-03\nCT#71\nCP-160095\n0653\n-\nB\nRx impact for background data transfer\n13.5.0\n2016-03\nCT#71\nCP-160093\n0654\n2\nB\nReservation-Priority AVP and DRMP AVP Interaction\n13.5.0\n2016-03\nCT#71\nCP-160101\n0656\n1\nF\nRemoval of references to TS 26.236\n13.5.0\n2016-03\nCT#71\nCP-160087\n0657\n1\nB\nThe value of ARP for MCPTT emergency\n13.5.0\n2016-03\nCT#71\nCP-160101\n0658\n-\nF\nCorrection to eMPS algorithm\n13.5.0\n2016-06\nCT#72\nCP-160270\n0660\n2\nF\nSupport of enhanced bandwidth mechanisms in MTSI sessions\n13.6.0\n2016-06\nCT#72\nCP-160265\n0661\n1\nF\nEditorial corrections\n13.6.0\n2016-06\nCT#72\nCP-160278\n0662\n2\nF\nPriority sharing for concurrent sessions\n13.6.0\n2016-06\nCT#72\nCP-160267\n0665\n-\nA\nP-CSCF restoration indication by Rx-Request-Type AVP\n13.6.0\n2016-06\nCT#72\nCP-160251\n0666\n-\nF\nCorrection to sponsor status change\n13.6.0\n2016-06\nCT#72\nCP-160265\n0667\n2\nF\nDelete the Editor's Note in subclause of DRA diameter overload behavior\n13.6.0\n2016-06\nCT#72\nCP-160253\n0669\n2\nA\nDiameter requests for priority traffic during overload control mechanism\n13.6.0\n2016-06\nCT#72\nCP-160274\n0659\n2\nB\nAdding the reference to the gate control procedure over Rx interface\n14.0.0\n2016-06\nCT#72\nCP-160265\n0661\n1\nF\nEditorial corrections\n14.0.0\n2016-09\nCT#73\nCP-160442\n0671\n-\nA\nCorrection of IETF drmp draft version\n14.1.0\n2016-09\nCT#73\nCP-160443\n0676\n-\nA\nCorrection to eMPS Algorithm\n14.1.0\n2016-09\nCT#73\nCP-160445\n0678\n-\nA\nUpdate the AF session procedures to support priority sharing\n14.1.0\n2016-09\nCT#73\nCP-160453\n0680\n1\nA\nCorrection to the PCRF addressing by RCAF\n14.1.0\n2016-09\nCT#73\nCP-160456\n0681\n3\nB\nFlows for Subscription to notification of PLMN id change in IMS\n14.1.0\n2016-09\nCT#73\nCP-160457\n0682\n2\nB\nCorrection to the PCRF addressing by RCAF\n14.1.0\n2016-12\nCT#74\nCP-160615\n0683\n4\nB\nDiameter Load Control Mechanism\n14.2.0\n2016-12\nCT#74\nCP-160614\n0685\n-\nA\nCorrection to change IETF drmp draft version to official RFC 7944\n14.2.0\n2016-12\nCT#74\nCP-160633\n0686\n3\nB\nProvision of EPC-level identities for IMS emergency sessions over Rx\n14.2.0\n2016-12\nCT#74\nCP-160625\n0687\n1\nB\nPCC impacts due to multi-stream multiparty conferencing media handling\n14.2.0\n2016-12\nCT#74\nCP-160630\n0688\n5\nF\nHandling of pending transactions for session termination requests\n14.2.0\n2016-12\nCT#74\nCP-160619\n0690\n-\nA\nCorrection to St session description in PCEF-initiated IP-CAN Session Modification\n14.2.0\n2016-12\nCT#74\nCP-160628\n0691\n1\nB\nSignalling for the sponsored data connectivity supported by the TDF\n14.2.0\n2016-12\nCT#74\nCP-160612\n0692\n2\nB\nSupport of Multiple PRAs\n14.2.0\n2016-12\nCT#74\nCP-160616\n0693\n1\nF\nDiameter base protocol specification update\n14.2.0\n2016-12\nCT#74\nCP-160627\n0695\n-\nA\nCorrection to information flow of PCEF-initiated IP-CAN Session Modification with AF located in HPLMN\n14.2.0\n2016-12\nCT#74\nCP-160628\n0697\n1\nB\nAdd specification references of Nu, Gw, Gwn\n14.2.0\n2017-03\nCT#75\nCP-170086\n0699\n1\nF\nBearer binding for PCC rules that have indicated to be bound to the default bearer\n14.3.0\n2017-03\nCT#75\nCP-170083\n0700\n1\nB\nQoS guidelines for MMCMH sessions\n14.3.0\n2017-03\nCT#75\nCP-170081\n0701\n1\nC\nPre-emption control for priority sharing\n14.3.0\n2017-03\nCT#75\nCP-170086\n0702\n1\nF\nCorrection in IP-CAN session termination procedure\n14.3.0\n2017-03\nCT#75\nCP-170086\n0703\n2\nF\nCorrection in DRA procedures\n14.3.0\n2017-06\nCT#76\nCP-171119\n0704\n1\nF\nReference update for draft-ietf-dime-load\n14.4.0\n2017-06\nCT#76\nCP-171132\n0707\n2\nA\nReferences update\n14.4.0\n2017-06\nCT#76\nCP-171133\n0714\n2\nA\nSupport for signaling transport level packet marking\n14.4.0\n2017-06\nCT#76\nCP-171126\n0715\n1\nF\nUpdating references to align with rel-14 MCPTT stage 1 and stage 2 restructuring\n14.4.0\n2017-06\nCT#76\nCP-171117\n0716\n1\nF\nImpacts of CUPS to PCC reference model\n14.4.0\n2017-06\nCT#76\nCP-171118\n0717\n-\nF\nCorrections of DRMP procedures\n14.4.0\n2017-06\nCT#76\nCP-171136\n0709\n2\nF\nCorrections in IP-CAN Session Establishment\n15.0.0\n2017-06\nCT#76\nCP-171136\n0710\n1\nF\nUpdate scope of 29.213\n15.0.0\n2017-06\nCT#76\nCP-171136\n0711\n3\nF\nClarifications on Diameter race condition\n15.0.0\n2017-09\nCT#77\nCP-172038\n0718\n1\nB\nExtension of QoS values\n15.1.0\n2017-09\nCT#77\nCP-172043\n0721\n2\nA\nClarification of Max-Requested-Bandwidth\n15.1.0\n2018-03\nCT#79\nCP-180056\n0722\n3\nB\nUpdate procedures to enhance VoLTE performance\n15.2.0\n2018-06\nCT#80\nCP-181023\n0723\n-\nD\nCorrecting heading levels\n15.3.0\n2018-06\nCT#80\nCP-181171\n0726\n1\nA\nSupport priority for MCVideo services\n15.3.0\n2018-09\nCT#81\nCP-182026\n0727\n1\nF\nCorrection of abbreviation \"SSID\" to \"SSD\"\n15.4.0\n2018-12\nCT#82\nCP-183119\n0735\n-\nA\nRemoval of editor's notes\n15.5.0\n2019-09\nCT#85\nCP-192154\n0739\n1\nA\ndraft-ietf-dime-load published as RFC 8583\n15.6.0\n2019-09\nCT#85\nCP-192164\n0737\n1\nB\nSupport for Restricted Local Operator Services\n16.0.0\n2019-12\nCT#86\nCP-193221\n0740\n6\nB\nCoverage and Handover Enhancements for Media (CHEM)\n16.1.0\n2020-03\nCT#87e\nCP-200215\n0741\n-\nB\nImpacts on QoS mapping to support FLUS functionality\n16.2.0\n2020-06\nCT#88e\nCP-201246\n0742\n-\nB\nSupport of applications with specific QoS hints\n16.3.0\n2021-06\nCT#92e\nCP-211226\n0743\n1\nB\nPCRF control of MPS for DTS\n17.0.0\n2021-09\nCT#93e\nCP-212212\n0744\n1\nB\n29.213 MPS for DTS note fix\n17.1.0\n2022-03\nCT#95e\nCP-220209\n0745\nB\nUpdate of IETF references for ICE\n17.2.0\n2022-03\nCT#95e\nCP-220196\n0747\nF\nCorrection to enable retrieval of Network Provided Location information in a MESSAGE request\n17.2.0\n2023-12\nCT#102\nCP-233275\n0748\nB\nData channel update for Rx interface\n18.0.0",
      "chunk_type": "procedure",
      "cross_references": [
        "clause_4",
        "clause_4.3.1.1.1",
        "clause_4.3.2.2.1",
        "clause_4.4.2.1.1",
        "clause_4.3.1.2.3",
        "clause_6.2",
        "clause_5.4",
        "clause_4.3.1.1",
        "ts_23.402_clause_4.1.5",
        "clause_5.1",
        "clause_5",
        "clause_4.0",
        "clause_4.1",
        "clause_4.6.1",
        "clause_4.6.2",
        "clause_4.3.1.2",
        "clause_4.3.2.1.1",
        "clause_7.1",
        "clause_7.2",
        "clause_7.3.1",
        "clause_7.3.2",
        "clause_7.3.3",
        "clause_7.3.4",
        "clause_7.3.5",
        "clause_7.3",
        "clause_7.3.8",
        "clause_7.3.7",
        "clause_7.3.9",
        "clause_3.1",
        "clause_4.2.2",
        "clause_4.2.3",
        "clause_4.3.1",
        "clause_4.3.2",
        "clause_7.4.1",
        "ts_23.003_clause_9.1",
        "table_6.2.2",
        "figure_4.3.1.1.1",
        "figure_4.3.1.2.3.1.1",
        "figure_4.3.1.2.3.2.1",
        "figure_5.2.2.2.1-1",
        "figure_4.3.1.2.1",
        "figure_4.1.1",
        "figure_4.2.1.1",
        "figure_4.2.2.1",
        "figure_4.2.3.1",
        "figure_4.2.1.2",
        "figure_4.3.2.1.1",
        "ts_29.212",
        "ts_29.215",
        "ts_29.214",
        "ts_23.380",
        "ts_23.221",
        "ts_24.229",
        "ts_23.060",
        "ts_23.402",
        "ts_23.203",
        "ts_22.153",
        "ts_23.003",
        "ts_29.217",
        "ts_26.236",
        "ts_14.2",
        "ts_16.3",
        "ts_17.0"
      ]
    }
  ]
}